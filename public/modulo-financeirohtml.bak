<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro Offline</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset e vari√°veis */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
            --topbar-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .logo {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo i {
            font-size: 24px;
            color: var(--secondary-color);
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
            flex: 1;
        }

        .nav-menu li {
            margin: 5px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(52, 152, 219, 0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .nav-menu i {
            width: 20px;
            text-align: center;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 25px;
        }

        .sync-status {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-indicator.offline {
            background: var(--danger-color);
        }

        .btn-sync {
            background: var(--secondary-color);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: auto;
            transition: background 0.3s;
        }

        .btn-sync:hover {
            background: #2980b9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            height: var(--topbar-height);
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light-color);
            padding: 10px 20px;
            border-radius: 25px;
            width: 400px;
        }

        .search-box input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: #7f8c8d;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
        }

        .user-role {
            font-size: 12px;
            color: #7f8c8d;
        }

        /* Dashboard */
        .dashboard {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .dashboard h2 {
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        /* Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .card-receber .card-icon {
            background: var(--success-color);
        }

        .card-pagar .card-icon {
            background: var(--danger-color);
        }

        .card-saldo .card-icon {
            background: var(--secondary-color);
        }

        .card-inadimplencia .card-icon {
            background: var(--warning-color);
        }

        .card-content h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .trend {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .trend.positive {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .trend.negative {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-container,
        .vencimentos-container,
        .recent-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-container {
            grid-row: span 2;
        }

        .vencimentos-list,
        .recent-list {
            margin-top: 15px;
        }

        .vencimento-item,
        .recent-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vencimento-item:last-child,
        .recent-item:last-child {
            border-bottom: none;
        }

        .vencimento-info h4,
        .recent-info h4 {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .vencimento-info span,
        .recent-info span {
            font-size: 12px;
            color: #7f8c8d;
        }

        .vencimento-valor,
        .recent-valor {
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #1da851;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .badge-danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .badge-info {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Formul√°rios */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid var(--success-color);
        }

        .toast-error {
            border-left: 4px solid var(--danger-color);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast-info {
            border-left: 4px solid var(--secondary-color);
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .logo h1,
            .nav-menu span,
            .sync-status span {
                display: none;
            }
            
            .nav-menu a {
                justify-content: center;
                padding: 15px;
            }
            
            .top-bar {
                padding: 0 15px;
            }
            
            .search-box {
                width: 200px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--secondary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Utilit√°rios */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .ml-auto {
            margin-left: auto;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i class="fas fa-chart-line"></i>
            <h1>Financeiro</h1>
        </div>
        
        <ul class="nav-menu">
            <li><a href="#dashboard" class="active" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i> <span>Dashboard</span>
            </a></li>
            <li><a href="#receber" onclick="showSection('receber')">
                <i class="fas fa-money-bill-wave"></i> <span>Contas a Receber</span>
            </a></li>
            <li><a href="#pagar" onclick="showSection('pagar')">
                <i class="fas fa-credit-card"></i> <span>Contas a Pagar</span>
            </a></li>
            <li><a href="#relatorios" onclick="showSection('relatorios')">
                <i class="fas fa-chart-bar"></i> <span>Relat√≥rios</span>
            </a></li>
            
            <li class="nav-divider"></li>
        </ul>
        
        <div class="sync-status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">Offline</span>
            <button class="btn-sync" onclick="syncManager.trySync()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="Buscar cliente, OS ou or√ßamento...">
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="user-name">Admin</span>
                    <span class="user-role">Financeiro</span>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div class="dashboard active" id="dashboard-section">
            <h2>Dashboard Financeiro</h2>
            
            <div class="summary-cards">
                <div class="card card-receber">
                    <div class="card-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="card-content">
                        <h3>Receber Hoje</h3>
                        <p class="amount" id="receber-hoje">R$ 0,00</p>
                        <span class="trend positive">+0% vs ontem</span>
                    </div>
                </div>
                
                <div class="card card-pagar">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-content">
                        <h3>Pagar Hoje</h3>
                        <p class="amount" id="pagar-hoje">R$ 0,00</p>
                        <span class="trend negative">-0% vs ontem</span>
                    </div>
                </div>
                
                <div class="card card-saldo">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-content">
                        <h3>Saldo do M√™s</h3>
                        <p class="amount" id="saldo-mes">R$ 0,00</p>
                        <span class="trend positive">+0% vs √∫ltimo m√™s</span>
                    </div>
                </div>
                
                <div class="card card-inadimplencia">
                    <div class="card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-content">
                        <h3>Inadimpl√™ncia</h3>
                        <p class="amount" id="inadimplencia">0%</p>
                        <span class="trend positive">-0% vs √∫ltimo m√™s</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <h3>Fluxo de Caixa (7 dias)</h3>
                    <canvas id="cashflow-chart"></canvas>
                </div>
                
                <div class="vencimentos-container">
                    <h3>Vencimentos Hoje</h3>
                    <div class="vencimentos-list" id="vencimentos-hoje">
                        <div class="vencimento-item">
                            <div class="vencimento-info">
                                <h4><span class="badge badge-warning">Aberto</span> Cliente Exemplo</h4>
                                <span>Vencimento: Hoje</span>
                            </div>
                            <div class="vencimento-valor">
                                R$ 1.250,00
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="recent-container">
                    <h3>√öltimos Recebimentos</h3>
                    <div class="recent-list" id="ultimos-recebimentos">
                        <!-- Carregado via JS -->
                    </div>
                </div>
                
                <div class="recent-container">
                    <h3>√öltimos Pagamentos</h3>
                    <div class="recent-list" id="ultimos-pagamentos">
                        <!-- Carregado via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Contas a Receber Section -->
        <div class="dashboard hidden" id="receber-section">
            <div class="d-flex justify-between align-center mb-20">
                <h2>Contas a Receber</h2>
                <button class="btn btn-success" onclick="showModal('modal-lancamento-receber')">
                    <i class="fas fa-plus"></i> Novo Recebimento
                </button>
            </div>

            <div class="filters mb-20">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="filter-cliente" placeholder="Filtrar por cliente...">
                    </div>
                    <div class="form-group">
                        <select id="filter-status-receber">
                            <option value="">Todos os status</option>
                            <option value="aberto">Aberto</option>
                            <option value="pago">Pago</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="filtrarReceber()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Descri√ß√£o</th>
                            <th>Parcela</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-receber">
                        <!-- Carregado via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Contas a Pagar Section -->
        <div class="dashboard hidden" id="pagar-section">
            <div class="d-flex justify-between align-center mb-20">
                <h2>Contas a Pagar</h2>
                <button class="btn btn-danger" onclick="showModal('modal-lancamento-pagar')">
                    <i class="fas fa-plus"></i> Novo Pagamento
                </button>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fornecedor</th>
                            <th>Descri√ß√£o</th>
                            <th>Parcela</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-pagar">
                        <!-- Carregado via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Relat√≥rios Section -->
        <div class="dashboard hidden" id="relatorios-section">
            <h2>Relat√≥rios</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('rel-duplicatas')">Duplicatas Parceladas</div>
                <div class="tab" onclick="showTab('rel-pagar')">Contas a Pagar</div>
                <div class="tab" onclick="showTab('rel-inadimplencia')">Inadimpl√™ncia</div>
            </div>

            <div class="tab-content active" id="rel-duplicatas">
                <div class="form-row mb-20">
                    <div class="form-group">
                        <label>Data In√≠cio</label>
                        <input type="date" id="rel-data-inicio">
                    </div>
                    <div class="form-group">
                        <label>Data Fim</label>
                        <input type="date" id="rel-data-fim">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="rel-status">
                            <option value="todos">Todos</option>
                            <option value="aberto">Aberto</option>
                            <option value="pago">Pago</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>
                    <div class="form-group align-center" style="align-self: flex-end;">
                        <button class="btn btn-primary" onclick="gerarRelatorio('duplicatas')">
                            <i class="fas fa-chart-bar"></i> Gerar Relat√≥rio
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="tabela-relatorio">
                        <!-- Carregado via JS -->
                    </table>
                </div>
            </div>

            <div class="tab-content" id="rel-pagar">
                <!-- Conte√∫do similar para contas a pagar -->
            </div>

            <div class="tab-content" id="rel-inadimplencia">
                <!-- Conte√∫do similar para inadimpl√™ncia -->
            </div>
        </div>

        <!-- Clientes e Configura√ß√µes foram removidos: gerenciados no m√≥dulo principal (index) -->
                <div class="form-row">
                    <button class="btn btn-secondary" onclick="exportarBackup()">
                        <i class="fas fa-download"></i> Exportar Backup
                    </button>
                    <button class="btn btn-secondary" onclick="document.getElementById('backup-file').click()">
                        <i class="fas fa-upload"></i> Importar Backup
                    </button>
                    <input type="file" id="backup-file" accept=".json" class="hidden" onchange="importarBackup(event)">
                </div>
            </div>
        </div>
    </main>

    <!-- Modais -->
    <div id="modal-vencimento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Aviso de Vencimento</h3>
                <button class="modal-close" onclick="hideModal('modal-vencimento')">&times;</button>
            </div>
            <div class="modal-body">
                <p id="vencimento-message"></p>
                <div class="modal-actions">
                    <button class="btn btn-success" onclick="marcarComoPago()">
                        <i class="fas fa-check"></i> Marcar como Pago
                    </button>
                    <button class="btn btn-whatsapp" onclick="enviarWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Enviar WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="hideModal('modal-vencimento')">
                        Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Lan√ßamento Receber -->
    <div id="modal-lancamento-receber" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>
                    <span style="margin-right: 8px;">+</span>
                    Nova Receita (Duplicata)
                </h3>
                <button class="modal-close" onclick="hideModal('modal-lancamento-receber')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-receber" onsubmit="salvarRecebimento(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tipo de Transa√ß√£o *</label>
                            <select id="tipo-transacao-receber" required>
                                <option value="receita">Receita</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Data *</label>
                            <input type="date" id="data-receber" required>
                        </div>
                    </div>

                    <!-- Campos espec√≠ficos para Receita -->
                    <div id="campos-receita-receber">
                        <div class="form-group">
                            <label>Buscar Cliente *</label>
                            <input type="text" id="cliente-receber" list="clientes-list-receber" 
                                   placeholder="Digite o nome do cliente..."
                                   onchange="buscarClientePorNomeReceber(this.value)"
                                   oninput="buscarClientePorNomeReceber(this.value)"
                                   autocomplete="off" required>
                            <datalist id="clientes-list-receber"></datalist>
                        </div>

                        <div class="form-group" id="campo-orcamento-receber" style="display: none;">
                            <label>Or√ßamentos Finalizados</label>
                            <select id="orcamento-receber" onchange="selecionarOrcamentoReceber(this.value)">
                                <option value="">Selecione um or√ßamento</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="check-entrada-receber" onchange="toggleEntradaReceber()">
                                Cliente pagou entrada?
                            </label>
                        </div>

                        <div id="campos-entrada-receber" style="display: none;">
                            <div class="form-group">
                                <label>Valor da Entrada (R$) *</label>
                                <input type="number" id="valor-entrada-receber" min="0" step="0.01" 
                                       placeholder="0,00" 
                                       oninput="atualizarResumoReceber()"
                                       onchange="atualizarResumoReceber()">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="check-parcelado-receber" onchange="toggleParceladoReceber()">
                                Pagamento parcelado?
                            </label>
                        </div>

                        <div id="campos-parcelas-receber" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>N√∫mero de Parcelas *</label>
                                    <input type="number" id="num-parcelas-receber" min="2" max="12" value="2" 
                                           oninput="atualizarResumoReceber()">
                                </div>
                                <div class="form-group">
                                    <label>Data da Primeira Parcela *</label>
                                    <input type="date" id="data-primeira-parcela-receber">
                                </div>
                            </div>
                        </div>

                        <!-- Resumo Financeiro -->
                        <div id="resumo-financeiro-receber" style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin-top: 15px; border: 1px solid #c3e6cb;">
                            <h4 style="margin: 0 0 10px 0; color: #155724; font-size: 14px; font-weight: bold;">Resumo Financeiro</h4>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 500;">Valor Total:</span>
                                    <span id="resumo-valor-total-receber" style="font-weight: bold;">R$ 0,00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="font-weight: 500;">Entrada:</span>
                                    <span id="resumo-entrada-receber" style="font-weight: bold;">R$ 0,00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; border-top: 1px solid #c3e6cb; padding-top: 8px; margin-top: 5px;">
                                    <span style="font-weight: 600;">Valor Restante:</span>
                                    <span id="resumo-valor-restante-receber" style="font-weight: bold; color: #155724;">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos ocultos para receita (preenchidos automaticamente) -->
                    <input type="hidden" id="descricao-receber">
                    <input type="hidden" id="valor-receber">
                    <input type="hidden" id="status-receber" value="pendente">
                    <textarea id="observacoes-receber" style="display: none;"></textarea>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('modal-lancamento-receber')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp -->
    <div id="modal-whatsapp" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enviar WhatsApp</h3>
                <button class="modal-close" onclick="hideModal('modal-whatsapp')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="mensagem-whatsapp">Mensagem:</label>
                    <textarea id="mensagem-whatsapp" rows="8"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-whatsapp" onclick="abrirWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Abrir WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="hideModal('modal-whatsapp')">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Banco de Dados
        class Database {
            constructor() {
                this.dbName = 'financeiroDB';
                this.version = 1;
                this.db = null;
                this.init();
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);

                    request.onerror = (event) => {
                        console.error('Erro ao abrir banco de dados:', event.target.error);
                        reject(event.target.error);
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('Banco de dados inicializado');
                        resolve();
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;

                        // Tabela de Clientes
                        if (!db.objectStoreNames.contains('clientes')) {
                            const clientesStore = db.createObjectStore('clientes', { keyPath: 'id' });
                            clientesStore.createIndex('nome', 'nome', { unique: false });
                            clientesStore.createIndex('telefone', 'telefone', { unique: false });
                        }

                        // Tabela de Duplicatas a Receber
                        if (!db.objectStoreNames.contains('receber')) {
                            const receberStore = db.createObjectStore('receber', { keyPath: 'id' });
                            receberStore.createIndex('cliente', 'cliente', { unique: false });
                            receberStore.createIndex('status', 'status', { unique: false });
                            receberStore.createIndex('vencimento', 'vencimento', { unique: false });
                        }

                        // Tabela de Duplicatas a Pagar
                        if (!db.objectStoreNames.contains('pagar')) {
                            const pagarStore = db.createObjectStore('pagar', { keyPath: 'id' });
                            pagarStore.createIndex('fornecedor', 'fornecedor', { unique: false });
                            pagarStore.createIndex('status', 'status', { unique: false });
                            pagarStore.createIndex('vencimento', 'vencimento', { unique: false });
                        }

                        // Tabela de Configura√ß√µes
                        if (!db.objectStoreNames.contains('config')) {
                            const configStore = db.createObjectStore('config', { keyPath: 'chave' });
                        }
                    };
                });
            }

            // M√©todos gen√©ricos
            async add(store, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.add(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async put(store, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.put(data);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async get(store, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readonly');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.get(key);

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async getAll(store, index = null, value = null) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readonly');
                    const objectStore = transaction.objectStore(store);
                    
                    let request;
                    if (index && value !== null) {
                        const idx = objectStore.index(index);
                        request = idx.getAll(value);
                    } else {
                        request = objectStore.getAll();
                    }

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            async delete(store, key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.delete(key);

                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            // M√©todos espec√≠ficos
            async gerarId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            async getTotalReceberHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const receber = await this.getAll('receber', 'vencimento', hoje);
                return receber
                    .filter(r => r.status === 'aberto')
                    .reduce((total, r) => total + r.valor, 0);
            }

            async getTotalPagarHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const pagar = await this.getAll('pagar', 'vencimento', hoje);
                return pagar
                    .filter(p => p.status === 'aberto')
                    .reduce((total, p) => total + p.valor, 0);
            }

            async getVencimentosHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const receber = await this.getAll('receber', 'vencimento', hoje);
                const pagar = await this.getAll('pagar', 'vencimento', hoje);
                
                return {
                    receber: receber.filter(r => r.status === 'aberto'),
                    pagar: pagar.filter(p => p.status === 'aberto')
                };
            }

            async getUltimosRecebimentos() {
                const receber = await this.getAll('receber');
                return receber
                    .filter(r => r.status === 'pago')
                    .sort((a, b) => new Date(b.dataPagamento) - new Date(a.dataPagamento))
                    .slice(0, 5);
            }

            async getUltimosPagamentos() {
                const pagar = await this.getAll('pagar');
                return pagar
                    .filter(p => p.status === 'pago')
                    .sort((a, b) => new Date(b.dataPagamento) - new Date(a.dataPagamento))
                    .slice(0, 5);
            }

            async getFluxoCaixa7Dias() {
                const hoje = new Date();
                const fluxo = [];
                
                for (let i = 0; i < 7; i++) {
                    const data = new Date(hoje);
                    data.setDate(hoje.getDate() + i);
                    const dataStr = data.toISOString().split('T')[0];
                    
                    const receber = await this.getAll('receber', 'vencimento', dataStr);
                    const pagar = await this.getAll('pagar', 'vencimento', dataStr);
                    
                    const totalReceber = receber
                        .filter(r => r.status === 'aberto')
                        .reduce((sum, r) => sum + r.valor, 0);
                        
                    const totalPagar = pagar
                        .filter(p => p.status === 'aberto')
                        .reduce((sum, p) => sum + p.valor, 0);
                    
                    fluxo.push({
                        data: dataStr,
                        receber: totalReceber,
                        pagar: totalPagar,
                        saldo: totalReceber - totalPagar
                    });
                }
                
                return fluxo;
            }
        }

        // Sync Manager
        class SyncManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.updateStatus();
            }

            updateStatus() {
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                if (this.isOnline) {
                    indicator.className = 'status-indicator';
                    text.textContent = 'Online';
                } else {
                    indicator.className = 'status-indicator offline';
                    text.textContent = 'Offline';
                }
            }

            async trySync() {
                if (!this.isOnline) {
                    showToast('Voc√™ est√° offline. Sincroniza√ß√£o adiada.', 'warning');
                    return;
                }

                showToast('Sincronizando...', 'info');
                // Simular sincroniza√ß√£o
                await new Promise(resolve => setTimeout(resolve, 1000));
                showToast('Sincroniza√ß√£o conclu√≠da!', 'success');
            }
        }

        // WhatsApp Manager
        class WhatsAppManager {
            getSaudacao() {
                const hora = new Date().getHours();
                
                if (hora >= 5 && hora < 12) return 'Bom dia';
                if (hora >= 12 && hora < 18) return 'Boa tarde';
                if (hora >= 18 && hora <= 23) return 'Boa noite';
                return 'Ol√°';
            }

            formatarTelefone(telefone) {
                if (!telefone) return '';
                return telefone.replace(/\D/g, '');
            }

            gerarMensagem(cliente, duplicata) {
                const saudacao = this.getSaudacao();
                const nomeCliente = cliente.nome.split(' ')[0];
                
                return `${saudacao}, ${nomeCliente}! Tudo bem?
Aqui √© da Oficina Mec√¢nica.
Passando para lembrar que hoje vence a parcela ${duplicata.parcela} referente a: ${duplicata.descricao}.

üìÖ Vencimento: ${this.formatarDataBR(duplicata.vencimento)}
üí∞ Valor: R$ ${duplicata.valor.toFixed(2)}

Se j√° realizou o pagamento, por favor nos avise.

Obrigado!`;
            }

            formatarDataBR(dataISO) {
                const [ano, mes, dia] = dataISO.split('-');
                return `${dia}/${mes}/${ano}`;
            }

            gerarLink(telefone, mensagem) {
                const tel = this.formatarTelefone(telefone);
                const msg = encodeURIComponent(mensagem);
                return `https://wa.me/55${tel}?text=${msg}`;
            }
        }

        // UI Manager
        class UIManager {
            constructor() {
                this.db = new Database();
                this.syncManager = new SyncManager();
                this.whatsappManager = new WhatsAppManager();
                this.duplicataAtual = null;
                this.clienteAtual = null;
            }

            async init() {
                await this.db.init();
                this.carregarDadosDashboard();
                this.carregarReceber();
                this.carregarPagar();
                // Clientes s√£o gerenciados pelo sistema pai (index). O m√≥dulo financeiro
                // solicita a lista via postMessage ao abrir. N√£o carregar clientes locais aqui.
                this.verificarVencimentos();
                this.iniciarChart();

                // Verificar vencimentos periodicamente
                setInterval(() => this.verificarVencimentos(), 300000); // 5 minutos
            }

            async carregarDadosDashboard() {
                const receberHoje = await this.db.getTotalReceberHoje();
                const pagarHoje = await this.db.getTotalPagarHoje();
                
                document.getElementById('receber-hoje').textContent = 
                    this.formatarMoeda(receberHoje);
                document.getElementById('pagar-hoje').textContent = 
                    this.formatarMoeda(pagarHoje);
                document.getElementById('saldo-mes').textContent = 
                    this.formatarMoeda(receberHoje - pagarHoje);
                
                // Carregar vencimentos hoje
                const vencimentos = await this.db.getVencimentosHoje();
                this.atualizarVencimentosHoje(vencimentos);
                
                // Carregar √∫ltimos recebimentos
                const ultimosRecebimentos = await this.db.getUltimosRecebimentos();
                this.atualizarUltimosRecebimentos(ultimosRecebimentos);
                
                // Carregar √∫ltimos pagamentos
                const ultimosPagamentos = await this.db.getUltimosPagamentos();
                this.atualizarUltimosPagamentos(ultimosPagamentos);
            }

            atualizarVencimentosHoje(vencimentos) {
                const container = document.getElementById('vencimentos-hoje');
                let html = '';
                
                vencimentos.receber.forEach(item => {
                    html += `
                        <div class="vencimento-item">
                            <div class="vencimento-info">
                                <h4><span class="badge badge-warning">A Receber</span> ${item.cliente}</h4>
                                <span>${item.descricao}</span>
                            </div>
                            <div class="vencimento-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                vencimentos.pagar.forEach(item => {
                    html += `
                        <div class="vencimento-item">
                            <div class="vencimento-info">
                                <h4><span class="badge badge-danger">A Pagar</span> ${item.fornecedor}</h4>
                                <span>${item.descricao}</span>
                            </div>
                            <div class="vencimento-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="text-center">Nenhum vencimento para hoje</div>';
                }
                
                container.innerHTML = html;
            }

            atualizarUltimosRecebimentos(recebimentos) {
                const container = document.getElementById('ultimos-recebimentos');
                let html = '';
                
                recebimentos.forEach(item => {
                    html += `
                        <div class="recent-item">
                            <div class="recent-info">
                                <h4>${item.cliente}</h4>
                                <span>${this.formatarData(item.dataPagamento)}</span>
                            </div>
                            <div class="recent-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="text-center">Nenhum recebimento recente</div>';
                }
                
                container.innerHTML = html;
            }

            atualizarUltimosPagamentos(pagamentos) {
                const container = document.getElementById('ultimos-pagamentos');
                let html = '';
                
                pagamentos.forEach(item => {
                    html += `
                        <div class="recent-item">
                            <div class="recent-info">
                                <h4>${item.fornecedor}</h4>
                                <span>${this.formatarData(item.dataPagamento)}</span>
                            </div>
                            <div class="recent-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="text-center">Nenhum pagamento recente</div>';
                }
                
                container.innerHTML = html;
            }

            async carregarReceber() {
                const receber = await this.db.getAll('receber');
                const tabela = document.getElementById('tabela-receber');
                let html = '';
                
                receber.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.cliente}</td>
                            <td>${item.descricao}</td>
                            <td>${item.parcela || '1/1'}</td>
                            <td>R$ ${item.valor.toFixed(2)}</td>
                            <td>${this.formatarData(item.vencimento)}</td>
                            <td>${this.criarBadgeStatus(item.status)}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="ui.marcarComoPago('${item.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-whatsapp btn-sm" onclick="ui.enviarWhatsAppDuplicata('${item.id}')">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tabela.innerHTML = html || '<tr><td colspan="7" class="text-center">Nenhuma conta a receber</td></tr>';
            }

            async carregarPagar() {
                const pagar = await this.db.getAll('pagar');
                const tabela = document.getElementById('tabela-pagar');
                let html = '';
                
                pagar.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.fornecedor}</td>
                            <td>${item.descricao}</td>
                            <td>${item.parcela || '1/1'}</td>
                            <td>R$ ${item.valor.toFixed(2)}</td>
                            <td>${this.formatarData(item.vencimento)}</td>
                            <td>${this.criarBadgeStatus(item.status)}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="ui.marcarComoPagoPagar('${item.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tabela.innerHTML = html || '<tr><td colspan="7" class="text-center">Nenhuma conta a pagar</td></tr>';
            }

            // A listagem de clientes √© solicitada ao `window.opener` via postMessage.
            // Caso n√£o haja opener, tenta utilizar o banco local como fallback.
            async carregarClientes() {
                // Implementado via carregarAutocompleteClientes quando necess√°rio.
                return;
            }

            criarBadgeStatus(status) {
                switch(status) {
                    case 'aberto': return '<span class="badge badge-warning">Aberto</span>';
                    case 'pago': return '<span class="badge badge-success">Pago</span>';
                    case 'atrasado': return '<span class="badge badge-danger">Atrasado</span>';
                    default: return '<span class="badge">' + status + '</span>';
                }
            }

            formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(valor);
            }

            formatarData(dataISO) {
                if (!dataISO) return '-';
                return new Date(dataISO).toLocaleDateString('pt-BR');
            }

            async verificarVencimentos() {
                const hoje = new Date().toISOString().split('T')[0];
                const receber = await this.db.getAll('receber', 'vencimento', hoje);
                
                const vencimentosHoje = receber.filter(r => r.status === 'aberto');
                
                if (vencimentosHoje.length > 0) {
                    const primeiro = vencimentosHoje[0];
                    const cliente = await this.db.get('clientes', primeiro.clienteId) || { nome: 'Cliente' };
                    
                    this.duplicataAtual = primeiro;
                    this.clienteAtual = cliente;
                    
                    document.getElementById('vencimento-message').innerHTML = `
                        <strong>${cliente.nome}</strong> tem uma duplicata vencendo hoje:<br><br>
                        <strong>Descri√ß√£o:</strong> ${primeiro.descricao}<br>
                        <strong>Valor:</strong> R$ ${primeiro.valor.toFixed(2)}<br>
                        <strong>Parcela:</strong> ${primeiro.parcela || '1/1'}
                    `;
                    
                    showModal('modal-vencimento');
                }
            }

            async marcarComoPago(id) {
                try {
                    const duplicata = await this.db.get('receber', id);
                    if (!duplicata) return;
                    
                    duplicata.status = 'pago';
                    duplicata.dataPagamento = new Date().toISOString().split('T')[0];
                    
                    await this.db.put('receber', duplicata);
                    
                    // Atualizar cliente
                    const cliente = await this.db.get('clientes', duplicata.clienteId);
                    if (cliente) {
                        cliente.ultimaMovimentacao = new Date().toISOString();
                        await this.db.put('clientes', cliente);
                    }
                    
                    showToast('Duplicata marcada como paga!', 'success');
                    this.carregarReceber();
                    this.carregarDadosDashboard();
                    
                } catch (error) {
                    console.error('Erro ao marcar como pago:', error);
                    showToast('Erro ao marcar como pago', 'error');
                }
            }

            async marcarComoPagoPagar(id) {
                try {
                    const duplicata = await this.db.get('pagar', id);
                    if (!duplicata) return;
                    
                    duplicata.status = 'pago';
                    duplicata.dataPagamento = new Date().toISOString().split('T')[0];
                    
                    await this.db.put('pagar', duplicata);
                    
                    showToast('Conta marcada como paga!', 'success');
                    this.carregarPagar();
                    this.carregarDadosDashboard();
                    
                } catch (error) {
                    console.error('Erro ao marcar como pago:', error);
                    showToast('Erro ao marcar como pago', 'error');
                }
            }

            async enviarWhatsAppDuplicata(id) {
                const duplicata = await this.db.get('receber', id);
                if (!duplicata) return;
                
                const cliente = await this.db.get('clientes', duplicata.clienteId);
                if (!cliente || !cliente.telefone) {
                    showToast('Cliente sem telefone cadastrado', 'warning');
                    return;
                }
                
                this.duplicataAtual = duplicata;
                this.clienteAtual = cliente;
                
                const mensagem = this.whatsappManager.gerarMensagem(cliente, duplicata);
                document.getElementById('mensagem-whatsapp').value = mensagem;
                
                showModal('modal-whatsapp');
            }

            async salvarRecebimento(formData) {
                try {
                    const nomeCliente = document.getElementById('cliente-receber')?.value?.trim();
                    const orcamentoId = document.getElementById('orcamento-receber')?.value;
                    const parcelado = document.getElementById('check-parcelado-receber')?.checked || false;
                    const numParcelas = parcelado ? parseInt(document.getElementById('num-parcelas-receber')?.value) : 1;
                    const dataPrimeiraParcela = document.getElementById('data-primeira-parcela-receber')?.value;
                    const data = document.getElementById('data-receber').value;
                    const descricao = document.getElementById('descricao-receber').value.trim();
                    const valor = parseFloat(document.getElementById('valor-receber').value);
                    const status = document.getElementById('status-receber').value;
                    const observacoes = document.getElementById('observacoes-receber').value.trim();

                    // Valida√ß√µes
                    if (!nomeCliente) throw new Error('Selecione um cliente para receita');
                    if (!descricao) throw new Error('Descri√ß√£o √© obrigat√≥ria');
                    if (!valor || valor <= 0) throw new Error('Valor deve ser maior que zero');
                    
                    // Buscar ou criar cliente
                    let cliente = await this.buscarOuCriarCliente(nomeCliente);
                    
                    const temEntrada = document.getElementById('check-entrada-receber')?.checked || false;
                    const valorEntrada = temEntrada ? parseFloat(document.getElementById('valor-entrada-receber')?.value || 0) : 0;
                    
                    // Valida√ß√µes de entrada
                    if (temEntrada) {
                        if (!valorEntrada || valorEntrada <= 0) throw new Error('Informe o valor da entrada');
                        if (valorEntrada >= valor) throw new Error('Valor da entrada n√£o pode ser maior ou igual ao valor total');
                    }
                    
                    if (parcelado) {
                        if (!numParcelas || numParcelas < 2) throw new Error('N√∫mero de parcelas deve ser pelo menos 2');
                        if (!dataPrimeiraParcela) throw new Error('Informe a data da primeira parcela');
                    }

                    // Se houver entrada, criar transa√ß√£o de entrada primeiro
                    if (temEntrada) {
                        const duplicataEntrada = {
                            id: await this.db.gerarId(),
                            clienteId: cliente.id,
                            cliente: cliente.nome,
                            descricao: `${descricao} - Entrada`,
                            valor: valorEntrada,
                            vencimento: data,
                            status: 'pago',
                            dataPagamento: data,
                            parcela: 'Entrada',
                            tipo: 'entrada',
                            orcamentoId: orcamentoId || null
                        };
                        await this.db.add('receber', duplicataEntrada);
                    }

                    // Calcular valor restante ap√≥s entrada
                    const valorRestante = temEntrada ? valor - valorEntrada : valor;

                    // Se for parcelado, criar m√∫ltiplas transa√ß√µes para o valor restante
                    if (parcelado && valorRestante > 0) {
                        const valorParcela = parseFloat((valorRestante / numParcelas).toFixed(2));
                        const valorUltimaParcela = valorRestante - (valorParcela * (numParcelas - 1));
                        
                        const dataBase = new Date(dataPrimeiraParcela + 'T00:00:00');
                        
                        for (let i = 0; i < numParcelas; i++) {
                            const dataParcela = new Date(dataBase);
                            dataParcela.setMonth(dataBase.getMonth() + i);
                            
                            const valorFinal = i === numParcelas - 1 ? valorUltimaParcela : valorParcela;
                            
                            const duplicata = {
                                id: await this.db.gerarId(),
                                clienteId: cliente.id,
                                cliente: cliente.nome,
                                descricao: `${descricao} - Parcela ${i + 1}/${numParcelas}`,
                                valor: valorFinal,
                                vencimento: dataParcela.toISOString().split('T')[0],
                                status: 'aberto',
                                parcela: `${i + 1}/${numParcelas}`,
                                tipo: 'parcelado',
                                orcamentoId: orcamentoId || null
                            };
                            
                            await this.db.add('receber', duplicata);
                        }
                    } else if (valorRestante > 0) {
                        // Transa√ß√£o √∫nica para o valor restante
                        const duplicata = {
                            id: await this.db.gerarId(),
                            clienteId: cliente.id,
                            cliente: cliente.nome,
                            descricao: temEntrada ? `${descricao} - Restante` : descricao,
                            valor: valorRestante,
                            vencimento: data,
                            status: status,
                            parcela: '1/1',
                            tipo: temEntrada ? 'parcelado' : 'avista',
                            orcamentoId: orcamentoId || null
                        };
                        
                        await this.db.add('receber', duplicata);
                    }
                    
                    showToast('Recebimento salvo com sucesso!', 'success');
                    hideModal('modal-lancamento-receber');
                    this.carregarReceber();
                    this.carregarDadosDashboard();
                    
                } catch (error) {
                    console.error('Erro ao salvar recebimento:', error);
                    showToast(error.message || 'Erro ao salvar recebimento', 'error');
                }
            }

            async buscarOuCriarCliente(nome) {
                const clientes = await this.db.getAll('clientes');
                const clienteExistente = clientes.find(c => c.nome === nome);
                
                if (clienteExistente) {
                    return clienteExistente;
                }
                
                const novoCliente = {
                    id: await this.db.gerarId(),
                    nome: nome,
                    telefone: '',
                    email: '',
                    criadoEm: new Date().toISOString(),
                    ultimaMovimentacao: new Date().toISOString()
                };
                
                await this.db.add('clientes', novoCliente);
                return novoCliente;
            }

            iniciarChart() {
                const ctx = document.getElementById('cashflow-chart').getContext('2d');
                
                // Dados de exemplo
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b', 'Dom'],
                        datasets: [
                            {
                                label: 'A Receber',
                                data: [1200, 1900, 1500, 2500, 2200, 3000, 2800],
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'A Pagar',
                                data: [800, 1200, 900, 1500, 1800, 1200, 1400],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Saldo',
                                data: [400, 700, 600, 1000, 400, 1800, 1400],
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }

            async exportarBackup() {
                const backup = {
                    clientes: await this.db.getAll('clientes'),
                    receber: await this.db.getAll('receber'),
                    pagar: await this.db.getAll('pagar'),
                    config: await this.db.getAll('config'),
                    dataBackup: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(backup, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `backup-financeiro-${new Date().toISOString().split('T')[0]}.json`);
                link.click();
                
                showToast('Backup exportado com sucesso!', 'success');
            }

            async importarBackup(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            
                            // Limpar banco de dados existente
                            await this.limparBanco();
                            
                            // Importar dados
                            for (const cliente of backup.clientes) {
                                await this.db.add('clientes', cliente);
                            }
                            
                            for (const receber of backup.receber) {
                                await this.db.add('receber', receber);
                            }
                            
                            for (const pagar of backup.pagar) {
                                await this.db.add('pagar', pagar);
                            }
                            
                            for (const config of backup.config) {
                                await this.db.add('config', config);
                            }
                            
                            showToast('Backup importado com sucesso!', 'success');
                            location.reload();
                            
                        } catch (error) {
                            showToast('Erro ao importar backup', 'error');
                            reject(error);
                        }
                    };
                    
                    reader.readAsText(file);
                });
            }

            async limparBanco() {
                // Para simplificar, vamos recriar o banco
                this.db.db.close();
                indexedDB.deleteDatabase(this.db.dbName);
                this.db = new Database();
                await this.db.init();
            }
        }

        // Fun√ß√µes globais
        const ui = new UIManager();
        const syncManager = new SyncManager();
        const whatsappManager = new WhatsAppManager();

        // Inicializar quando o DOM carregar
        document.addEventListener('DOMContentLoaded', async () => {
            await ui.init();
            
            // Configurar eventos
            window.addEventListener('online', () => {
                syncManager.isOnline = true;
                syncManager.updateStatus();
            });
            
            window.addEventListener('offline', () => {
                syncManager.isOnline = false;
                syncManager.updateStatus();
            });
            
            // Carregar lista de clientes para autocomplete
            carregarAutocompleteClientes();
        });

        // Fun√ß√µes de UI
        function showSection(sectionId) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.dashboard').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Mostrar se√ß√£o selecionada
            document.getElementById(sectionId + '-section').classList.remove('hidden');
            
            // Atualizar menu ativo
            document.querySelectorAll('.nav-menu a').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelector(`a[href="#${sectionId}"]`).classList.add('active');
            
            // Atualizar dados da se√ß√£o
            if (sectionId === 'dashboard') {
                ui.carregarDadosDashboard();
            } else if (sectionId === 'receber') {
                ui.carregarReceber();
            } else if (sectionId === 'pagar') {
                ui.carregarPagar();
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            // Configurar datas padr√£o
            if (modalId === 'modal-lancamento-receber') {
                const hoje = new Date();
                document.getElementById('data-receber').value = hoje.toISOString().split('T')[0];
                
                // Limpar campos
                clienteSelecionadoReceber = null;
                orcamentoSelecionadoReceber = null;
                document.getElementById('cliente-receber').value = '';
                document.getElementById('campo-orcamento-receber').style.display = 'none';
                document.getElementById('orcamento-receber').value = '';
                document.getElementById('check-entrada-receber').checked = false;
                document.getElementById('check-parcelado-receber').checked = false;
                document.getElementById('valor-entrada-receber').value = '';
                toggleEntradaReceber();
                toggleParceladoReceber();
                
                // Carregar clientes no datalist
                carregarAutocompleteClientesReceber();
            }
        }

        async function carregarAutocompleteClientesReceber() {
            const datalist = document.getElementById('clientes-list-receber');
            datalist.innerHTML = '';

            // Se aberto a partir do index (window.opener), solicitar lista de clientes
            if (window.opener && window.opener !== window) {
                const clientes = await new Promise((resolve) => {
                    function onMessage(e) {
                        if (!e.data) return;
                        if (e.data.type === 'clientsList') {
                            window.removeEventListener('message', onMessage);
                            resolve(e.data.clients || []);
                        }
                    }
                    window.addEventListener('message', onMessage);
                    try {
                        window.opener.postMessage({ type: 'requestClients' }, '*');
                    } catch (err) {
                        window.removeEventListener('message', onMessage);
                        resolve([]);
                    }
                    setTimeout(() => {
                        window.removeEventListener('message', onMessage);
                        resolve([]);
                    }, 1500);
                });

                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nome;
                    option.dataset.clienteId = cliente.id;
                    datalist.appendChild(option);
                });
                return;
            }

            // Fallback para banco local
            try {
                const clientesLocal = await ui.db.getAll('clientes');
                clientesLocal.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nome;
                    option.dataset.clienteId = cliente.id;
                    datalist.appendChild(option);
                });
            } catch (error) {
                console.debug('Erro ao carregar clientes locais:', error);
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showTab(tabId) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function showToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${getIconeTipo(tipo)}"></i>
                <span>${mensagem}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function getIconeTipo(tipo) {
            switch(tipo) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        // Vari√°veis globais para o modal de recebimento
        let clienteSelecionadoReceber = null;
        let orcamentoSelecionadoReceber = null;

        // Fun√ß√µes do modal de recebimento (igual ao index.html)
        async function buscarClientePorNomeReceber(nomeCliente) {
            const campoOrcamento = document.getElementById('campo-orcamento-receber');
            
            if (!nomeCliente || nomeCliente.trim() === '') {
                if (campoOrcamento) campoOrcamento.style.display = 'none';
                const selectOrcamento = document.getElementById('orcamento-receber');
                if (selectOrcamento) selectOrcamento.value = '';
                clienteSelecionadoReceber = null;
                return;
            }
            
            // Buscar cliente via API ou banco local
            try {
                const API_BASE = localStorage.getItem('api-url') || 'http://localhost:3000/api';
                const response = await fetch(`${API_BASE}/clientes`);
                if (response.ok) {
                    const clientes = await response.json();
                    const cliente = clientes.find(c => 
                        c.nome.toLowerCase().trim() === nomeCliente.toLowerCase().trim()
                    );
                    
                    if (cliente) {
                        console.log('Cliente encontrado:', cliente);
                        clienteSelecionadoReceber = cliente;
                        await carregarOrcamentosClienteReceber(cliente.id);
                    } else {
                        console.log('Cliente n√£o encontrado:', nomeCliente);
                        if (campoOrcamento) campoOrcamento.style.display = 'none';
                        const selectOrcamento = document.getElementById('orcamento-receber');
                        if (selectOrcamento) selectOrcamento.value = '';
                        clienteSelecionadoReceber = null;
                    }
                } else {
                    console.error('Erro na resposta da API de clientes:', response.status);
                }
            } catch (error) {
                console.error('Erro ao buscar cliente via API:', error);
                // Fallback para banco local
                try {
                    const clientesLocal = await ui.db.getAll('clientes');
                    const cliente = clientesLocal.find(c => 
                        c.nome.toLowerCase().trim() === nomeCliente.toLowerCase().trim()
                    );
                    
                    if (cliente) {
                        console.log('Cliente encontrado no banco local:', cliente);
                        clienteSelecionadoReceber = cliente;
                        await carregarOrcamentosClienteReceber(cliente.id);
                    } else {
                        console.log('Cliente n√£o encontrado no banco local:', nomeCliente);
                        if (campoOrcamento) campoOrcamento.style.display = 'none';
                        const selectOrcamento = document.getElementById('orcamento-receber');
                        if (selectOrcamento) selectOrcamento.value = '';
                        clienteSelecionadoReceber = null;
                    }
                } catch (err) {
                    console.error('Erro ao buscar cliente no banco local:', err);
                }
            }
        }

        async function carregarOrcamentosClienteReceber(clienteId) {
            console.log('carregarOrcamentosClienteReceber chamado com clienteId:', clienteId);
            const campoOrcamento = document.getElementById('campo-orcamento-receber');
            const selectOrcamento = document.getElementById('orcamento-receber');
            
            if (!campoOrcamento || !selectOrcamento) {
                console.error('Elementos do campo de or√ßamento n√£o encontrados');
                return;
            }
            
            selectOrcamento.innerHTML = '<option value="">Selecione um or√ßamento</option>';
            
            if (!clienteId) {
                console.log('ClienteId n√£o fornecido, ocultando campo');
                campoOrcamento.style.display = 'none';
                return;
            }
            
            // Sempre mostrar o campo quando h√° um cliente selecionado
            console.log('Mostrando campo de or√ßamentos');
            campoOrcamento.style.display = 'block';
            
            // Buscar or√ßamentos via API
            try {
                const API_BASE = localStorage.getItem('api-url') || 'http://localhost:3000/api';
                
                // Buscar or√ßamentos e O.S
                const [orcamentosRes, ordensRes] = await Promise.all([
                    fetch(`${API_BASE}/orcamentos`).catch(e => ({ ok: false, error: e })),
                    fetch(`${API_BASE}/ordens-servico`).catch(e => ({ ok: false, error: e }))
                ]);
                
                if (orcamentosRes.ok && ordensRes.ok) {
                    const orcamentos = await orcamentosRes.json();
                    const ordensServico = await ordensRes.json();
                    
                    // Filtrar or√ßamentos aprovados do cliente
                    const orcamentosCliente = orcamentos.filter(o => 
                        (o.clienteId === parseInt(clienteId) || o.cliente_id === parseInt(clienteId)) && 
                        o.status === 'aprovado'
                    );
                    
                    // Filtrar apenas or√ßamentos com O.S finalizadas
                    const orcamentosComOSFinalizada = orcamentosCliente.filter(orcamento => {
                        const os = ordensServico.find(os => 
                            (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                        );
                        return os && os.status === 'finalizada';
                    });
                    
                    if (orcamentosComOSFinalizada.length > 0) {
                        orcamentosComOSFinalizada.forEach(orcamento => {
                            const option = document.createElement('option');
                            option.value = orcamento.id;
                            const os = ordensServico.find(os => 
                                (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                            );
                            const numeroOS = os ? ` (O.S. #${os.numero})` : '';
                            option.textContent = `Or√ßamento #${orcamento.numero}${numeroOS} - R$ ${(orcamento.total || orcamento.valor_total || 0).toFixed(2)}`;
                            selectOrcamento.appendChild(option);
                        });
                    } else {
                        // Mostrar mensagem quando n√£o houver or√ßamentos dispon√≠veis
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = 'Nenhum or√ßamento aprovado com O.S finalizada dispon√≠vel';
                        option.disabled = true;
                        selectOrcamento.appendChild(option);
                    }
                } else {
                    // Se a API falhar, mostrar mensagem
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Erro ao carregar or√ßamentos. Verifique a conex√£o.';
                    option.disabled = true;
                    selectOrcamento.appendChild(option);
                    console.error('Erro ao buscar or√ßamentos:', orcamentosRes.error || ordensRes.error);
                }
            } catch (error) {
                console.error('Erro ao buscar or√ßamentos via API:', error);
                // Mostrar mensagem de erro no select
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Erro ao carregar or√ßamentos';
                option.disabled = true;
                selectOrcamento.appendChild(option);
            }
        }

        async function selecionarOrcamentoReceber(orcamentoId) {
            if (!orcamentoId) {
                document.getElementById('descricao-receber').value = '';
                document.getElementById('valor-receber').value = '';
                document.getElementById('check-entrada-receber').checked = false;
                document.getElementById('check-parcelado-receber').checked = false;
                toggleEntradaReceber();
                toggleParceladoReceber();
                atualizarResumoReceber();
                orcamentoSelecionadoReceber = null;
                return;
            }
            
            // Buscar or√ßamento e O.S via API
            const API_BASE = localStorage.getItem('api-url') || 'http://localhost:3000/api';
            try {
                const [orcamentoRes, ordensRes] = await Promise.all([
                    fetch(`${API_BASE}/orcamentos/${orcamentoId}`),
                    fetch(`${API_BASE}/ordens-servico`)
                ]);
                
                if (orcamentoRes.ok) {
                    const orcamento = await orcamentoRes.json();
                    orcamentoSelecionadoReceber = orcamento;
                    
                    // Buscar O.S vinculada
                    let os = null;
                    if (ordensRes.ok) {
                        const ordensServico = await ordensRes.json();
                        os = ordensServico.find(os => 
                            (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                        );
                    }
                    
                    // Preencher descri√ß√£o
                    const clienteNome = clienteSelecionadoReceber ? clienteSelecionadoReceber.nome : '';
                    let descricao = `Duplicata #${orcamento.numero}`;
                    if (clienteNome) {
                        descricao += ` - ${clienteNome}`;
                    }
                    if (os && os.numero) {
                        descricao += ` (O.S. #${os.numero})`;
                    }
                    document.getElementById('descricao-receber').value = descricao;
                    
                    // Preencher valor total
                    const valorTotal = orcamento.total || orcamento.valor_total || 0;
                    document.getElementById('valor-receber').value = valorTotal.toFixed(2);
                    
                    // Preencher data com data de finaliza√ß√£o da O.S ou data do or√ßamento
                    const dataReceber = document.getElementById('data-receber');
                    if (os && os.dataFinalizacao) {
                        const dataFinalizacao = new Date(os.dataFinalizacao);
                        dataReceber.value = dataFinalizacao.toISOString().split('T')[0];
                    } else if (orcamento.data) {
                        const dataOrcamento = new Date(orcamento.data);
                        dataReceber.value = dataOrcamento.toISOString().split('T')[0];
                    }
                    
                    // Preencher observa√ß√µes se existirem
                    if (orcamento.observacoes) {
                        document.getElementById('observacoes-receber').value = orcamento.observacoes;
                    }
                    
                    atualizarResumoReceber();
                }
            } catch (error) {
                console.error('Erro ao buscar or√ßamento:', error);
                showToast('Erro ao buscar informa√ß√µes do or√ßamento', 'error');
            }
        }

        function toggleEntradaReceber() {
            const entrada = document.getElementById('check-entrada-receber').checked;
            const camposEntrada = document.getElementById('campos-entrada-receber');
            
            if (entrada) {
                camposEntrada.style.display = 'block';
            } else {
                camposEntrada.style.display = 'none';
                document.getElementById('valor-entrada-receber').value = '';
            }
            atualizarResumoReceber();
        }

        function toggleParceladoReceber() {
            const parcelado = document.getElementById('check-parcelado-receber').checked;
            const camposParcelas = document.getElementById('campos-parcelas-receber');
            
            if (parcelado) {
                camposParcelas.style.display = 'block';
                const dataPrimeiraParcela = document.getElementById('data-primeira-parcela-receber');
                if (!dataPrimeiraParcela.value) {
                    dataPrimeiraParcela.value = new Date().toISOString().split('T')[0];
                }
            } else {
                camposParcelas.style.display = 'none';
            }
            atualizarResumoReceber();
        }

        function atualizarResumoReceber() {
            const resumoFinanceiro = document.getElementById('resumo-financeiro-receber');
            if (!resumoFinanceiro || resumoFinanceiro.offsetParent === null) {
                return;
            }

            const valorTotal = parseFloat(document.getElementById('valor-receber')?.value || 0);
            const entradaCheckbox = document.getElementById('check-entrada-receber');
            const valorEntradaInput = document.getElementById('valor-entrada-receber');
            const temEntrada = entradaCheckbox?.checked || false;
            const valorEntrada = temEntrada ? parseFloat(valorEntradaInput?.value || 0) : 0;
            const valorRestante = valorTotal - valorEntrada;

            document.getElementById('resumo-valor-total-receber').textContent = `R$ ${valorTotal.toFixed(2)}`;
            document.getElementById('resumo-entrada-receber').textContent = `R$ ${valorEntrada.toFixed(2)}`;
            document.getElementById('resumo-valor-restante-receber').textContent = `R$ ${Math.max(0, valorRestante).toFixed(2)}`;
        }

        function mudarTipoPagamento() {
            // Mantida para compatibilidade, mas n√£o √© mais usada
        }

        async function carregarAutocompleteClientes() {
            const datalist = document.getElementById('clientes-list');
            datalist.innerHTML = '';

            // Se aberto a partir do index (window.opener), solicitar lista de clientes
            if (window.opener && window.opener !== window) {
                // Preparar listener para resposta
                const clientes = await new Promise((resolve) => {
                    function onMessage(e) {
                        if (!e.data) return;
                        if (e.data.type === 'clientsList') {
                            window.removeEventListener('message', onMessage);
                            resolve(e.data.clients || []);
                        }
                    }
                    window.addEventListener('message', onMessage);

                    // Enviar pedido ao opener
                    try {
                        window.opener.postMessage({ type: 'requestClients' }, '*');
                    } catch (err) {
                        // fallback: resolve vazio
                        window.removeEventListener('message', onMessage);
                        resolve([]);
                    }
                    // Timeout fallback
                    setTimeout(() => {
                        window.removeEventListener('message', onMessage);
                        resolve([]);
                    }, 1500);
                });

                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nome;
                    datalist.appendChild(option);
                });
                return;
            }

            // Fallback para banco local
            const clientesLocal = await ui.db.getAll('clientes');
            clientesLocal.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.nome;
                datalist.appendChild(option);
            });
        }

        function salvarRecebimento(event) {
            event.preventDefault();
            ui.salvarRecebimento();
        }

        function marcarComoPago() {
            if (ui.duplicataAtual) {
                ui.marcarComoPago(ui.duplicataAtual.id);
                hideModal('modal-vencimento');
            }
        }

        function enviarWhatsApp() {
            if (ui.duplicataAtual && ui.clienteAtual) {
                const mensagem = whatsappManager.gerarMensagem(ui.clienteAtual, ui.duplicataAtual);
                document.getElementById('mensagem-whatsapp').value = mensagem;
                hideModal('modal-vencimento');
                showModal('modal-whatsapp');
            }
        }

        function abrirWhatsApp() {
            const mensagem = document.getElementById('mensagem-whatsapp').value;
            const telefone = ui.clienteAtual.telefone;
            
            if (telefone && mensagem) {
                const link = whatsappManager.gerarLink(telefone, mensagem);
                window.open(link, '_blank');
                hideModal('modal-whatsapp');
                showToast('WhatsApp aberto com sucesso!', 'success');
            } else {
                showToast('Telefone ou mensagem inv√°lidos', 'error');
            }
        }

        function filtrarReceber() {
            // Implementa√ß√£o b√°sica de filtro
            showToast('Filtro aplicado', 'info');
        }

        function gerarRelatorio(tipo) {
            showToast('Relat√≥rio gerado com sucesso!', 'success');
        }

        async function salvarConfiguracoes() {
            showToast('Configura√ß√µes salvas com sucesso!', 'success');
        }

        function exportarBackup() {
            ui.exportarBackup();
        }

        function importarBackup(event) {
            const file = event.target.files[0];
            if (file) {
                ui.importarBackup(file);
            }
        }

        // Inicializar sync status
        syncManager.updateStatus();
    </script>
</body>
</html>