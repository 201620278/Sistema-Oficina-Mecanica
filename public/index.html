<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nego Car System</title>
    <link rel="icon" href="/favicon.ico">
    <!-- alternativa: usar SVG embutido -->
    <!-- <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ctext y='26' font-size='26'%3Eüöó%3C/text%3E%3C/svg%3E"> -->
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <img id="login-logo-preview" src="" alt="Logo" style="display: none;">
                <div class="login-title" id="login-title">Nego Car</div>
            </div>
            <div id="login-form">
                <h3>Login</h3>
                <div class="form-group">
                    <label>PIN (4 d√≠gitos) *</label>
                    <div class="pin-input">
                        <input type="password" id="login-pin-1" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(1, event)">
                        <input type="password" id="login-pin-2" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(2, event)">
                        <input type="password" id="login-pin-3" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(3, event)">
                        <input type="password" id="login-pin-4" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(4, event)">
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="sistema.fazerLogin()" style="width: 100%; margin-top: 20px;">
                    Entrar
                </button>
                <button type="button" class="btn btn-warning" onclick="abrirModalAdminLogin()" style="width: 100%; margin-top: 10px;">
                    üîê Login Admin
                </button>
            </div>
            <div id="cadastro-form" style="display: none;">
                <h3>Primeiro Acesso - Cadastro</h3>
                <div class="form-group">
                    <label>Nome do Usu√°rio *</label>
                    <input type="text" id="cadastro-nome" required placeholder="Seu nome">
                </div>
                <div class="form-group">
                    <label>Logo da Empresa</label>
                    <div class="file-upload" onclick="document.getElementById('logo-upload').click()">
                        <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="sistema.carregarLogo(event)">
                        <p>Clique para fazer upload do logo</p>
                        <img id="logo-preview" src="" alt="Preview" style="display: none;">
                    </div>
                </div>
                <div class="form-group">
                    <label>Crie um PIN (4 d√≠gitos) *</label>
                    <div class="pin-input">
                        <input type="password" id="cadastro-pin-1" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(1, event, 'cadastro')">
                        <input type="password" id="cadastro-pin-2" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(2, event, 'cadastro')">
                        <input type="password" id="cadastro-pin-3" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(3, event, 'cadastro')">
                        <input type="password" id="cadastro-pin-4" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(4, event, 'cadastro')">
                    </div>
                </div>
                <div class="form-group">
                    <label>Confirme o PIN *</label>
                    <div class="pin-input">
                        <input type="password" id="cadastro-pin-confirm-1" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(1, event, 'confirm')">
                        <input type="password" id="cadastro-pin-confirm-2" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(2, event, 'confirm')">
                        <input type="password" id="cadastro-pin-confirm-3" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(3, event, 'confirm')">
                        <input type="password" id="cadastro-pin-confirm-4" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(4, event, 'confirm')">
                    </div>
                </div>
                <button type="button" class="btn btn-success" onclick="sistema.cadastrarUsuario()" style="width: 100%; margin-top: 20px;">
                    Cadastrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Login Admin -->
    <div id="modal-admin-login" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">üîê Login do Administrador</div>
                <div class="modal-actions">
                    <button class="close" onclick="fecharModalAdminLogin()">‚úï</button>
                </div>
            </div>
            <div class="form-group">
                <label>Usu√°rio *</label>
                <input type="text" id="admin-username" placeholder="Digite seu usu√°rio" required>
            </div>
            <div class="form-group">
                <label>Senha *</label>
                <input type="password" id="admin-password" placeholder="Digite sua senha" required>
            </div>
            <button type="button" class="btn btn-primary" onclick="fazerLoginAdmin()" style="width: 100%; margin-top: 20px;">
                Entrar como Admin
            </button>
            <button type="button" class="btn btn-danger" onclick="fecharModalAdminLogin()" style="width: 100%; margin-top: 10px;">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Modal Limpeza de Registros (Multi-m√≥dulo) -->
    <div id="modal-limpeza-financeiro" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <div class="modal-title">üóëÔ∏è Limpeza de Registros</div>
                <div class="modal-actions">
                    <button class="close" onclick="fecharModalLimpezaFinanceiro()">‚úï</button>
                </div>
            </div>
            <div style="padding: 20px;">
                <!-- Sele√ß√£o de M√≥dulo -->
                <div class="form-group">
                    <label><strong>Selecione o m√≥dulo:</strong></label>
                    <select id="cleanup-module" onchange="atualizarListaRegistrosLimpeza()">
                        <option value="">-- Escolha um m√≥dulo --</option>
                        <option value="clientes">üë• Clientes</option>
                        <option value="agendamentos">üìã Agendamentos</option>
                        <option value="orcamentos">üìÖ Or√ßamentos</option>
                        <option value="ordens_servico">üîß Ordens de Servi√ßo</option>
                        <option value="transacoes">üí∞ Transa√ß√µes (Financeiro)</option>
                    </select>
                </div>

                <!-- Filtros de Data -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label>Data de (de):</label>
                        <input type="date" id="cleanup-from-date">
                    </div>
                    <div class="form-group">
                        <label>Data at√©:</label>
                        <input type="date" id="cleanup-to-date">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="atualizarListaRegistrosLimpeza()" style="width: 100%; margin-bottom: 15px;">
                    üîç Carregar Registros
                </button>

                <!-- Lista de Registros -->
                <div id="cleanup-records-container" style="display: none;">
                    <h4>Registros encontrados:</h4>
                    <p id="cleanup-records-count" style="color: #666; margin-bottom: 10px;"></p>
                    
                    <!-- Modo Sele√ß√£o em Lote -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="cleanup-select-all" onchange="selecionarTodosRegistrosLimpeza()">
                            <strong>Selecionar todos</strong>
                        </label>
                    </div>

                    <div id="cleanup-records-list" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px; background: #f9f9f9;">
                        <!-- Registros aparecer√£o aqui -->
                    </div>

                    <div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <p style="margin: 0;"><strong>‚ö†Ô∏è Aten√ß√£o:</strong></p>
                        <p style="margin: 5px 0 0 0; font-size: 14px;">Digite <strong>DELETE</strong> abaixo para confirmar a exclus√£o dos registros selecionados.</p>
                    </div>

                    <div class="form-group" style="margin-top: 15px;">
                        <label>Confirma√ß√£o de exclus√£o:</label>
                        <input type="text" id="cleanup-confirm-admin" placeholder="Digite DELETE" 
                               onkeyup="if(event.key === 'Enter' && this.value === 'DELETE') executarLimpezaFinanceiro()">
                    </div>
                </div>

                <!-- Mensagem quando nenhum m√≥dulo √© selecionado -->
                <div id="cleanup-no-selection" style="padding: 20px; text-align: center; color: #999;">
                    <p>Selecione um m√≥dulo acima para come√ßar</p>
                </div>
            </div>

            <div style="padding: 20px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee;">
                <button class="btn btn-secondary" onclick="fecharModalLimpezaFinanceiro()">Cancelar</button>
                <button class="btn btn-danger" id="cleanup-delete-btn" onclick="executarLimpezaFinanceiro()" style="display: none;">
                    üóëÔ∏è Excluir Registros Selecionados
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <img id="sidebar-logo" src="" alt="Logo" style="display: none;">
                <div style="display: flex; flex-direction: column;">
                    <span>NegoCar</span>
                    <span id="admin-mode-badge" style="display: none; font-size: 11px; color: #ffeb3b; background: #ff6f00; padding: 3px 8px; border-radius: 3px; margin-top: 5px; text-align: center; font-weight: bold;">üîê Modo Administrador</span>
                </div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-section="dashboard">
                    <i>üìä</i> Dashboard
                </li>
                <li class="nav-item" data-section="clientes">
                    <i>üë•</i> Clientes
                </li>
                <li class="nav-item" data-section="veiculos">
                    <i>üöó</i> Ve√≠culos
                </li>
                <li class="nav-item" data-section="agendamentos">
                    <i>üìã</i> Agendamentos
                </li>
                <li class="nav-item" data-section="orcamentos">
                    <i>üìÖ</i> Or√ßamentos
                </li>
                <li class="nav-item" data-section="ordens-servico">
                    <i>üîß</i> Ordens de Servi√ßo
                </li>
                <li class="nav-item" onclick="openFinanceiro()" style="cursor: pointer;">
                    <i>üí∞</i> Financeiro (Nova Aba)
                </li>
                <li class="nav-item" data-section="configuracoes">
                    <i>‚öôÔ∏è</i> Configura√ß√µes
                </li>
                <li class="nav-item" id="btn-logout-admin" style="display: none; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; padding-top: 15px;" onclick="fazerLogoutAdmin()">
                    <i>üö™</i> Sair do Modo Admin
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-logo">
                    <img id="header-logo" src="" alt="Logo" style="display: none;">
                    <div>
                        <h1 id="section-title">Dashboard</h1>
                        <p id="section-description">Vis√£o geral do sistema NegoCar</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div class="section active" id="dashboard">
                <div class="cards-grid">
                    <div class="card">
                        <h3>Or√ßamentos Pendentes</h3>
                        <div class="value" id="orcamentos-pendentes-dash">0</div>
                    </div>
                    <div class="card">
                        <h3>Or√ßamentos Aprovados</h3>
                        <div class="value" id="orcamentos-aprovados-dash">0</div>
                    </div>
                    <div class="card">
                        <h3>Agendamentos Pendentes</h3>
                        <div class="value" id="agendamentos-pendentes-dash">0</div>
                    </div>
                    <div class="card">
                        <h3>Agendamentos em Servi√ßo</h3>
                        <div class="value" id="agendamentos-em-servico-dash">0</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <!-- Or√ßamentos Pendentes -->
                    <div class="table-container">
                        <h3 style="padding: 15px; background: var(--light-color); margin: 0;">Or√ßamentos Pendentes</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>N¬∫</th>
                                    <th>Cliente</th>
                                    <th>Ve√≠culo</th>
                                    <th>Valor</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentos-pendentes-table-dash">
                                <!-- Or√ßamentos pendentes ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Or√ßamentos Aprovados -->
                    <div class="table-container">
                        <h3 style="padding: 15px; background: var(--light-color); margin: 0;">Or√ßamentos Aprovados</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>N¬∫</th>
                                    <th>Cliente</th>
                                    <th>Ve√≠culo</th>
                                    <th>Valor</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentos-aprovados-table-dash">
                                <!-- Or√ßamentos aprovados ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Agendamentos Pendentes -->
                    <div class="table-container">
                        <h3 style="padding: 15px; background: var(--light-color); margin: 0;">Agendamentos Pendentes</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Cliente</th>
                                    <th>Ve√≠culo</th>
                                    <th>Servi√ßo</th>
                                </tr>
                            </thead>
                            <tbody id="agendamentos-pendentes-table-dash">
                                <!-- Agendamentos pendentes ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Agendamentos em Servi√ßo -->
                    <div class="table-container">
                        <h3 style="padding: 15px; background: var(--light-color); margin: 0;">Agendamentos em Servi√ßo</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Cliente</th>
                                    <th>Ve√≠culo</th>
                                    <th>Servi√ßo</th>
                                </tr>
                            </thead>
                            <tbody id="agendamentos-em-servico-table-dash">
                                <!-- Agendamentos em servi√ßo ser√£o carregados aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Clientes Section -->
            <div class="section" id="clientes">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gerenciar Clientes</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="sistema.gerarRelatorioClientes()">
                            üìä Relat√≥rio
                        </button>
                        <button class="btn btn-primary" onclick="abrirModalCliente()">
                            ‚ûï Novo Cliente
                        </button>
                    </div>
                </div>
                <div id="botoes-universais-clientes" style="display: flex; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <span style="font-weight: bold; margin-right: 10px;">A√ß√µes para item selecionado:</span>
                    <button class="btn btn-sm btn-primary" onclick="sistema.editarClienteSelecionado()">‚úèÔ∏è Editar</button>
                    <button class="btn btn-sm btn-danger" onclick="sistema.excluirClienteSelecionado()">üóëÔ∏è Excluir</button>
                    <button class="btn btn-sm btn-info" onclick="sistema.verDetalhesClienteSelecionado()">üëÅÔ∏è Ver Detalhes</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="text" id="busca-clientes" placeholder="üîç Buscar cliente por nome, WhatsApp..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                           onkeyup="sistema.filtrarClientes(this.value)">
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-clientes" onchange="sistema.toggleSelectAll('clientes', this.checked)"></th>
                                <th>Nome</th>
                                <th>Telefone/WhatsApp</th>
                                <th>Ve√≠culos</th>
                                <th>√öltimo Servi√ßo</th>
                            </tr>
                        </thead>
                        <tbody id="clientes-table">
                            <!-- Clientes ser√£o carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ve√≠culos Section -->
            <div class="section" id="veiculos">
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                    <h2>Frota de Ve√≠culos</h2>
                    <button class="btn btn-primary" onclick="abrirModalVeiculo()">
                        ‚ûï Novo Ve√≠culo
                    </button>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Placa</th>
                                <th>Marca/Modelo</th>
                                <th>Cliente</th>
                                <th>Ano</th>
                                <th>√öltimo Servi√ßo</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="veiculos-table">
                            <!-- Ve√≠culos ser√£o carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Or√ßamentos Section -->
            <div class="section" id="orcamentos">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Gerenciar Or√ßamentos</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="sistema.gerarRelatorioOrcamentos()">
                            üìä Relat√≥rio
                        </button>
                        <button class="btn btn-primary" onclick="abrirModalOrcamento()">
                            üìã Novo Or√ßamento
                        </button>
                    </div>
                </div>
                <div id="botoes-universais-orcamentos" style="display: flex; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <span style="font-weight: bold; margin-right: 10px;">A√ß√µes para item selecionado:</span>
                    <button class="btn btn-sm btn-primary" onclick="sistema.visualizarOrcamentoSelecionado()">üëÅÔ∏è Ver</button>
                    <button class="btn btn-sm btn-warning" onclick="sistema.editarOrcamentoSelecionado()">‚úèÔ∏è Editar</button>
                    <button class="btn btn-sm btn-info" id="btn-gerar-os-lista" onclick="sistema.gerarOSDoOrcamentoSelecionado()" style="display: none;">üîß Gerar O.S.</button>
                    <button class="btn btn-sm btn-danger" onclick="sistema.excluirOrcamentoSelecionado()">üóëÔ∏è Excluir</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="text" id="busca-orcamentos" placeholder="üîç Buscar or√ßamento por n√∫mero, cliente, ve√≠culo..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                           onkeyup="sistema.filtrarOrcamentos(this.value)">
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <label><strong>Filtros:</strong></label>
                        <button class="btn btn-sm" id="filtro-orcamento-pendentes" onclick="sistema.aplicarFiltroOrcamento('pendentes')" style="background: var(--primary-color); color: white;">Pendentes</button>
                        <button class="btn btn-sm" id="filtro-orcamento-aprovados" onclick="sistema.aplicarFiltroOrcamento('aprovados')">Aprovados</button>
                        <button class="btn btn-sm" id="filtro-orcamento-finalizados" onclick="sistema.aplicarFiltroOrcamento('finalizados')">Finalizados</button>
                        <button class="btn btn-sm" id="filtro-orcamento-todos" onclick="sistema.aplicarFiltroOrcamento('todos')">Todos</button>
                    </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <h3>Pendentes</h3>
                        <div class="value" id="orcamentos-pendentes-card">0</div>
                    </div>
                    <div class="card">
                        <h3>Aprovados</h3>
                        <div class="value" id="orcamentos-aprovados">0</div>
                    </div>
                    <div class="card">
                        <h3>Finalizados</h3>
                        <div class="value" id="orcamentos-finalizados">0</div>
                    </div>
                    <div class="card">
                        <h3>Valor Total Pendente</h3>
                        <div class="value" id="valor-total-pendente">R$ 0,00</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-orcamentos" onchange="sistema.toggleSelectAll('orcamentos', this.checked)"></th>
                                <th>N¬∫ Or√ßamento</th>
                                <th>Cliente</th>
                                <th>Ve√≠culo</th>
                                <th>Valor Total</th>
                                <th>Data</th>
                                <th>Validade</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="orcamentos-table">
                            <!-- Or√ßamentos ser√£o carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Ordens de Servi√ßo Section -->
            <div class="section" id="ordens-servico">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Ordens de Servi√ßo</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="sistema.gerarRelatorioOrdensServico()">
                            üìä Relat√≥rio
                        </button>
                    </div>
                </div>
                <div id="botoes-universais-ordens-servico" style="display: flex; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <span style="font-weight: bold; margin-right: 10px;">A√ß√µes para item selecionado:</span>
                    <button class="btn btn-sm btn-primary" onclick="sistema.visualizarOrdemServicoSelecionada()">üëÅÔ∏è Ver</button>
                    <button class="btn btn-sm btn-success" onclick="sistema.finalizarOrdemServicoSelecionada()">‚úÖ Finalizar</button>
                    <button class="btn btn-sm btn-danger" onclick="sistema.excluirOrdemServicoSelecionada()">üóëÔ∏è Excluir</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="text" id="busca-ordens-servico" placeholder="üîç Buscar O.S. por n√∫mero, cliente, ve√≠culo..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                           onkeyup="sistema.filtrarOrdensServico(this.value)">
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <label><strong>Filtros:</strong></label>
                        <button class="btn btn-sm" id="filtro-os-pendente" onclick="sistema.aplicarFiltroOS('pendente')" style="background: var(--primary-color); color: white;">Pendente</button>
                        <button class="btn btn-sm" id="filtro-os-em-servico" onclick="sistema.aplicarFiltroOS('em-servico')">Em Servi√ßo</button>
                        <button class="btn btn-sm" id="filtro-os-finalizada" onclick="sistema.aplicarFiltroOS('finalizada')">Finalizada</button>
                        <button class="btn btn-sm" id="filtro-os-todos" onclick="sistema.aplicarFiltroOS('todos')">Todos</button>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-ordens-servico" onchange="sistema.toggleSelectAll('ordens-servico', this.checked)"></th>
                                <th>N¬∫ O.S.</th>
                                <th>N¬∫ Or√ßamento</th>
                                <th>Cliente</th>
                                <th>Ve√≠culo</th>
                                <th>Data Abertura</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="ordens-servico-table">
                            <!-- Ordens de Servi√ßo ser√£o carregadas aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Agendamentos Section -->
            <div class="section" id="agendamentos">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Agendamentos</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="sistema.gerarRelatorioAgendamentos()">
                            üìä Relat√≥rio
                        </button>
                        <button class="btn btn-primary" onclick="abrirModalAgendamento()">
                            üìÖ Novo Agendamento
                        </button>
                    </div>
                </div>
                <div id="botoes-universais-agendamentos" style="display: flex; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <span style="font-weight: bold; margin-right: 10px;">A√ß√µes para item selecionado:</span>
                    <button class="btn btn-sm btn-primary" onclick="sistema.visualizarAgendamentoSelecionado()">üëÅÔ∏è Ver</button>
                    <button class="btn btn-sm btn-warning" onclick="sistema.editarAgendamentoSelecionado()">‚úèÔ∏è Editar</button>
                    <button class="btn btn-sm btn-success" onclick="sistema.irParaOrcamentoSelecionado()">üìã Or√ßamento</button>
                    <button class="btn btn-sm btn-danger" onclick="sistema.excluirAgendamentoSelecionado()">üóëÔ∏è Excluir</button>
                </div>

                <div style="margin-bottom: 15px;">
                    <input type="text" id="busca-agendamentos" placeholder="üîç Buscar agendamento por cliente, ve√≠culo, servi√ßo..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                           onkeyup="sistema.filtrarAgendamentos(this.value)">
                </div>

                <!-- Filtros -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <label><strong>Filtros:</strong></label>
                        <button class="btn btn-sm" id="filtro-agendamento-pendente" onclick="sistema.aplicarFiltroAgendamento('pendente')" style="background: var(--primary-color); color: white;">Pendente</button>
                        <button class="btn btn-sm" id="filtro-agendamento-em-servico" onclick="sistema.aplicarFiltroAgendamento('em-servico')">Em Servi√ßo</button>
                        <button class="btn btn-sm" id="filtro-agendamento-finalizado" onclick="sistema.aplicarFiltroAgendamento('finalizado')">Finalizado</button>
                        <button class="btn btn-sm" id="filtro-agendamento-todos" onclick="sistema.aplicarFiltroAgendamento('todos')">Todos</button> </div>
                </div>

                <div class="cards-grid">
                    <div class="card">
                        <h3>Hoje</h3>
                        <div class="value" id="agendamentos-hoje-detalhe">0</div>
                    </div>
                    <div class="card">
                        <h3>Esta Semana</h3>
                        <div class="value" id="agendamentos-semana">0</div>
                    </div>
                    <div class="card">
                        <h3>Pr√≥xima Semana</h3>
                        <div class="value" id="agendamentos-proxima-semana">0</div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="select-all-agendamentos" onchange="sistema.toggleSelectAll('agendamentos', this.checked)"></th>
                                <th>Data/Hora</th>
                                <th>Cliente</th>
                                <th>Ve√≠culo</th>
                                <th>Servi√ßo</th>
                                <th>Telefone</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="agendamentos-table">
                            <!-- Agendamentos ser√£o carregados aqui -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Financeiro agora abre em aba separada -->
            <div class="section" id="financeiro">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2>Financeiro (Aba separada)</h2>
                    <div>
                        <button class="btn btn-primary" onclick="openFinanceiro()">Abrir Financeiro (Nova Aba)</button>
                    </div>
                </div>
                <p style="margin-top:10px;color:#666;">O m√≥dulo financeiro foi movido para uma aba separada. Clique no bot√£o para abrir.</p>
            </div>
            
            <!-- Configura√ß√µes Section -->
            <div class="section" id="configuracoes">
                <h3>Configura√ß√µes do Sistema</h3>
                <div class="form-group">
                    <label>URL da API</label>
                    <input type="text" id="api-url" value="http://localhost:3000/api" placeholder="URL base da API">
                </div>
                <div class="form-group">
                    <label>Modo de Opera√ß√£o</label>
                    <select id="modo-operacao">
                        <option value="producao">Produ√ß√£o</option>
                        <option value="desenvolvimento">Desenvolvimento</option>
                        <option value="manutencao">Manuten√ß√£o</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="sistema.salvarConfiguracoes()">
                    Salvar Configura√ß√µes
                </button>

                <hr style="margin: 30px 0;">

                <h4 style="color: var(--danger-color); margin-bottom: 15px;">‚ö†Ô∏è Manuten√ß√£o e Limpeza</h4>
                <p style="margin-bottom: 15px; color: #666;">Ferramentas administrativas para manuten√ß√£o do sistema.</p>
                
                <div class="form-group">
                    <button class="btn btn-danger" onclick="abrirModalLimpezaFinanceiro()">
                        üóëÔ∏è Limpar Registros Antigos
                    </button>
                </div>

                <div class="console" id="system-console">
                    <div class="log-entry">
                        <span class="log-time">[12:00:00]</span>
                        <span class="log-info">Sistema NegoCar inicializado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="modal-cliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Cliente</h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-cliente')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalCliente()" title="Fechar">&times;</button>
                </div>
            </div>
            <form id="form-cliente">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="cliente-nome" required>
                    </div>
                    <div class="form-group">
                        <label>WhatsApp *</label>
                        <input type="tel" id="cliente-whatsapp" required placeholder="(00) 00000-0000">
                    </div>
                </div>

                <!-- Se√ß√£o de Endere√ßo -->
                <div class="form-group">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Endere√ßo</h4>
                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 200px;">
                            <label>CEP</label>
                            <input type="text" id="cliente-cep" placeholder="00000-000" 
                                   onblur="buscarCEP(this.value)"
                                   onkeydown="if(event.key === 'Enter') { event.preventDefault(); buscarCEP(this.value); }">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Logradouro</label>
                            <input type="text" id="cliente-logradouro">
                        </div>
                        <div class="form-group" style="flex: 0 0 100px;">
                            <label>N√∫mero</label>
                            <input type="text" id="cliente-numero">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Complemento</label>
                        <input type="text" id="cliente-complemento">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bairro</label>
                            <input type="text" id="cliente-bairro">
                        </div>
                        <div class="form-group">
                            <label>Cidade</label>
                            <input type="text" id="cliente-cidade">
                        </div>
                        <div class="form-group" style="flex: 0 0 100px;">
                            <label>Estado</label>
                            <input type="text" id="cliente-estado" maxlength="2">
                        </div>
                    </div>
                </div>

                <!-- Se√ß√£o de Ve√≠culos -->
                <div class="form-group">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Ve√≠culos do Cliente</h4>
                    <div id="veiculos-container">
                        <!-- Ve√≠culos ser√£o adicionados aqui -->
                    </div>
                    <button type="button" class="btn btn-warning btn-sm" onclick="adicionarVeiculo()" style="margin-top: 10px;">
                        ‚ûï Adicionar Ve√≠culo
                    </button>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Salvar Cliente</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalCliente()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Agendamento -->
    <div id="modal-agendamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Agendamento</h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-agendamento')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalAgendamento()" title="Fechar">&times;</button>
                </div>
            </div>
            <form id="form-agendamento">
                <div class="form-group">
                    <label>Cliente *</label>
                    <div style="position: relative;">
                        <input type="text" id="agendamento-cliente-search" 
                               placeholder="Digite o nome ou telefone do cliente..." 
                               style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
                               oninput="sistema.filtrarClientesAgendamento(this.value)">
                        <div id="agendamento-cliente-lista" 
                             style="position: absolute; top: 100%; left: 0; right: 0; background: white; 
                                    border: 1px solid #ccc; border-top: none; max-height: 250px; overflow-y: auto; 
                                    z-index: 1000; border-radius: 0 0 4px 4px; display: none;">
                            <!-- Lista de clientes ser√° preenchida aqui -->
                        </div>
                    </div>
                    <select id="agendamento-cliente" required style="display: none;">
                        <option value="">Selecione um cliente</option>
                    </select>
                    <div id="cliente-selecionado-badge" style="margin-top: 8px; display: none;">
                        <span style="background: #007bff; color: white; padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                            <span id="cliente-selecionado-nome"></span>
                            <button type="button" style="background: none; border: none; color: white; cursor: pointer; margin-left: 8px; font-weight: bold;" 
                                    onclick="sistema.limparClienteSelecionado()">√ó</button>
                        </span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Ve√≠culo *</label>
                    <select id="agendamento-veiculo" required>
                        <option value="">Selecione um ve√≠culo</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="agendamento-data" required>
                    </div>
                    <div class="form-group">
                        <label>Hora </label>
                        <input type="time" id="agendamento-hora">
                    </div>
                </div>

                <div class="form-group">
                    <label>Problema Relatado *</label>
                    <textarea id="agendamento-problema" rows="4" required
                        placeholder="Descreva o problema relatado pelo cliente..."></textarea>
                </div>

                <div class="form-group">
                    <label>Observa√ß√µes Adicionais</label>
                    <textarea id="agendamento-observacoes" rows="3" 
                        placeholder="Observa√ß√µes adicionais sobre o agendamento..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Agendar</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalAgendamento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
        <!-- Modal Visualizar Agendamento -->
        <div id="modal-visualizar-agendamento" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Agendamento #<span id="agendamento-numero-visualizar"></span></h3>
                    <button class="close" onclick="fecharModalVisualizarAgendamento()">&times;</button>
                </div>
                <div id="agendamento-preview">
                    <!-- Conte√∫do do agendamento ser√° carregado aqui -->
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                    <button class="btn btn-warning" onclick="sistema.marcarEmServico()" id="btn-em-servico">Marcar em Servi√ßo</button>
                    <button class="btn btn-success" onclick="sistema.finalizarAgendamento()" id="btn-finalizar">Finalizar</button>
                    <button class="btn btn-primary" onclick="sistema.enviarWhatsAppAgendamento()">üì± Enviar WhatsApp</button>
                    <button class="btn btn-secondary" onclick="fecharModalVisualizarAgendamento()">Fechar</button>
                </div>
            </div>
        </div>

    <!-- Modal Novo Ve√≠culo -->
    <div id="modal-veiculo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Ve√≠culo</h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-veiculo')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalVeiculo()" title="Fechar">&times;</button>
                </div>
            </div>
            <form id="form-veiculo">
                <div class="form-group">
                    <label>Cliente *</label>
                    <select id="veiculo-cliente" required>
                        <option value="">Selecione o propriet√°rio</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Placa *</label>
                        <input type="text" id="veiculo-placa" required placeholder="ABC-1234">
                    </div>
                    <div class="form-group">
                        <label>Marca</label>
                        <input type="text" id="veiculo-marca" placeholder="Fiat">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Modelo *</label>
                        <input type="text" id="veiculo-modelo" required placeholder="Uno">
                    </div>
                    <div class="form-group">
                        <label>Ano</label>
                        <input type="number" id="veiculo-ano" placeholder="2020" min="1990" max="2024">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Salvar Ve√≠culo</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalVeiculo()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Or√ßamento -->
    <div id="modal-orcamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Or√ßamento</h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-orcamento')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalOrcamento()" title="Fechar">&times;</button>
                </div>
            </div>
            <form id="form-orcamento">
                <div class="form-group">
                    <label>Cliente *</label>
                    <select id="orcamento-cliente" required onchange="sistema.carregarAgendamentosClienteOrcamento(this.value)">
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Agendamento *</label>
                    <select id="orcamento-agendamento" required onchange="sistema.carregarDadosAgendamentoOrcamento(this.value)">
                        <option value="">Selecione um agendamento</option>
                    </select>
                </div>

                <div class="form-group" id="orcamento-veiculo-info" style="display: none;">
                    <label>Ve√≠culo</label>
                    <input type="text" id="orcamento-veiculo-display" readonly style="background: #f0f0f0;">
                </div>

                <div class="form-group">
                    <label>Validade do Or√ßamento (dias) *</label>
                    <input type="number" id="orcamento-validade" value="7" min="1" max="30" required>
                </div>

                <div class="form-group">
                    <h4 style="margin-bottom: 10px; color: var(--primary-color);">Pe√ßas/Itens</h4>
                    <div id="pecas-lista-container" style="margin-bottom: 10px;">
                        <!-- Lista de pe√ßas adicionadas -->
                    </div>
                    <div class="form-row" style="margin-bottom: 5px;">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" id="peca-nome-input" placeholder="Nome da pe√ßa" onkeypress="if(event.key==='Enter') { event.preventDefault(); document.getElementById('peca-qtde-input').focus(); }">
                        </div>
                        <div class="form-group">
                            <input type="number" id="peca-qtde-input" min="1" value="1" placeholder="Qtde" onkeypress="if(event.key==='Enter') { event.preventDefault(); document.getElementById('peca-valor-unitario-input').focus(); }" oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <input type="number" id="peca-valor-unitario-input" step="0.01" min="0" placeholder="R$ Unit." onkeypress="if(event.key==='Enter') { event.preventDefault(); sistema.adicionarPecaRapido(); }" oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <input type="text" id="peca-total-input" readonly style="background: #e9ecef; font-weight: bold;" placeholder="R$ Total">
                        </div>
                    </div>
                    <small style="color: #666;">Preencha os campos e pressione Enter para adicionar</small>
                </div>

                <div class="form-group">
                    <h4 style="margin-bottom: 10px; color: var(--primary-color);">Servi√ßos</h4>
                    <div id="servicos-lista-container" style="margin-bottom: 10px;">
                        <!-- Lista de servi√ßos adicionados -->
                    </div>
                    <div class="form-row" style="margin-bottom: 5px;">
                        <div class="form-group" style="flex: 2;">
                            <input type="text" id="servico-descricao-input" placeholder="Descri√ß√£o do servi√ßo" onkeypress="if(event.key==='Enter') { event.preventDefault(); sistema.adicionarServicoRapido(); }">
                        </div>
                        <div class="form-group">
                            <input type="number" id="servico-valor-input" step="0.01" min="0" placeholder="R$ 0,00" onkeypress="if(event.key==='Enter') { event.preventDefault(); sistema.adicionarServicoRapido(); }">
                        </div>
                    </div>
                    <small style="color: #666;">Digite a descri√ß√£o e valor, pressione Enter para adicionar</small>
                </div>

                <div class="form-group">
                    <label>Observa√ß√µes</label>
                    <textarea id="orcamento-observacoes" rows="3" placeholder="Observa√ß√µes adicionais..."></textarea>
                </div>

                <div class="total-geral">
                    Total: <span id="orcamento-total">R$ 0,00</span>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Gerar Or√ßamento</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalOrcamento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Visualizar Or√ßamento -->
    <div id="modal-visualizar-orcamento" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Or√ßamento #<span id="orcamento-numero"></span></h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-visualizar-orcamento')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalVisualizarOrcamento()" title="Fechar">&times;</button>
                </div>
            </div>
            <div id="orcamento-preview">
                <!-- Conte√∫do do or√ßamento ser√° carregado aqui -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-success" onclick="sistema.aprovarOrcamento()" id="btn-aprovar-orcamento" style="display: none;">Aprovar</button>
                <button class="btn btn-danger" onclick="sistema.recusarOrcamento()" id="btn-recusar-orcamento" style="display: none;">Recusar</button>
                <button class="btn btn-info" onclick="sistema.gerarOSManual()" id="btn-gerar-os-orcamento" style="display: none;">üîß Gerar O.S.</button>
                <button class="btn btn-warning" onclick="sistema.enviarWhatsApp()" id="btn-whatsapp-orcamento">üì± Enviar WhatsApp</button>
                <button class="btn btn-primary" onclick="sistema.imprimirOrcamento()">Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Modal Visualizar Ordem de Servi√ßo -->
    <div id="modal-visualizar-os" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Ordem de Servi√ßo #<span id="os-numero"></span></h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-visualizar-os')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalVisualizarOS()" title="Fechar">&times;</button>
                </div>
            </div>
            <div id="os-preview">
                <!-- Conte√∫do da O.S. ser√° carregado aqui -->
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
                <button class="btn btn-info" onclick="sistema.colocarEmServicoOS()" id="btn-em-servico-os" style="display: none;">üîß Em Servi√ßo</button>
                <button class="btn btn-success" onclick="sistema.finalizarOrdemServico()" id="btn-finalizar-os" style="display: none;">‚úÖ Finalizar</button>
                <button class="btn btn-primary" onclick="sistema.imprimirOrdemServico()">üñ®Ô∏è Imprimir</button>
                <button class="btn btn-secondary" onclick="fecharModalVisualizarOS()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Transa√ß√£o -->
    <div id="modal-transacao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <span id="modal-transacao-icon" style="margin-right: 8px;">+</span>
                    <span id="modal-transacao-titulo">Nova Transa√ß√£o</span>
                </h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-transacao')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalTransacao()" title="Fechar">&times;</button>
                </div>
            </div>
            <form id="form-transacao">
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Transa√ß√£o *</label>
                        <select id="transacao-tipo" required onchange="sistema.alterarTipoTransacao()">
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data *</label>
                        <input type="date" id="transacao-data" required>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para Receita -->
                <div id="campos-receita" style="display: none;">
                    <div class="form-group">
                        <label>Buscar Cliente *</label>
                        <input type="text" id="transacao-cliente" list="transacao-clientes-list" 
                               placeholder="Digite o nome do cliente..."
                               onchange="sistema.buscarClientePorNome(this.value)"
                               oninput="sistema.buscarClientePorNome(this.value)"
                               autocomplete="off">
                        <datalist id="transacao-clientes-list"></datalist>
                    </div>

                    <div class="form-group" id="campo-orcamento" style="display: none;">
                        <label>Or√ßamentos Finalizados</label>
                        <select id="transacao-orcamento" onchange="sistema.selecionarOrcamento(this.value)">
                            <option value="">Selecione um or√ßamento</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="transacao-entrada" onchange="sistema.toggleEntrada()">
                            Cliente pagou entrada?
                        </label>
                    </div>

                    <div id="campos-entrada" style="display: none;">
                        <div class="form-group">
                            <label>Valor da Entrada (R$) *</label>
                            <input type="number" id="transacao-valor-entrada" min="0" step="0.01" 
                                   placeholder="0,00" 
                                   oninput="sistema.atualizarResumoFinanceiro()"
                                   onchange="sistema.atualizarResumoFinanceiro()">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="transacao-parcelado" onchange="sistema.toggleParcelado()">
                            Pagamento parcelado?
                        </label>
                    </div>

                    <div id="campos-parcelas" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>N√∫mero de Parcelas *</label>
                                <input type="number" id="transacao-num-parcelas" min="2" max="12" value="2" 
                                       oninput="sistema.atualizarResumoFinanceiro()">
                            </div>
                            <div class="form-group">
                                <label>Data da Primeira Parcela *</label>
                                <input type="date" id="transacao-data-primeira-parcela">
                            </div>
                        </div>
                    </div>

                    <!-- Resumo Financeiro -->
                    <div id="resumo-financeiro" style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin-top: 15px; border: 1px solid #c3e6cb;">
                        <h4 style="margin: 0 0 10px 0; color: #155724; font-size: 14px; font-weight: bold;">Resumo Financeiro</h4>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: 500;">Valor Total:</span>
                                <span id="resumo-valor-total" style="font-weight: bold;">R$ 0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="font-weight: 500;">Entrada:</span>
                                <span id="resumo-entrada" style="font-weight: bold;">R$ 0,00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; border-top: 1px solid #c3e6cb; padding-top: 8px; margin-top: 5px;">
                                <span style="font-weight: 600;">Valor Restante:</span>
                                <span id="resumo-valor-restante" style="font-weight: bold; color: #155724;">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Campos espec√≠ficos para Despesa -->
                <div id="campos-despesa" style="display: none;">
                    <div class="form-group">
                        <label>Categoria *</label>
                        <select id="transacao-categoria" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                <div class="form-group">
                    <label>Descri√ß√£o *</label>
                        <input type="text" id="transacao-descricao-despesa" 
                           placeholder="Ex: Pagamento servi√ßo #123">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Valor (R$) *</label>
                            <input type="number" id="transacao-valor-despesa" min="0" step="0.01"
                               placeholder="0,00">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                            <select id="transacao-status-despesa">
                            <option value="pendente">Pendente</option>
                            <option value="confirmado">Confirmado</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observa√ß√µes</label>
                        <textarea id="transacao-observacoes-despesa" rows="3" 
                            placeholder="Observa√ß√µes adicionais..."></textarea>
                    </div>
                </div>

                <!-- Campos ocultos para receita (preenchidos automaticamente) -->
                <input type="hidden" id="transacao-descricao">
                <input type="hidden" id="transacao-valor">
                <input type="hidden" id="transacao-status" value="pendente">
                <textarea id="transacao-observacoes" style="display: none;"></textarea>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">Salvar</button>
                    <button type="button" class="btn btn-danger" onclick="fecharModalTransacao()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Categorias -->
    <div id="modal-categorias" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Gerenciar Categorias de Despesas</h3>
                <div class="modal-actions">
                    <button class="minimize" onclick="minimizarModal('modal-categorias')" title="Minimizar">‚àí</button>
                    <button class="close" onclick="fecharModalCategorias()" title="Fechar">&times;</button>
                </div>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <h4>Adicionar Nova Categoria</h4>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="nova-categoria-nome" placeholder="Nome da categoria" 
                               style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                        <button class="btn btn-success" onclick="sistema.adicionarCategoria()">Adicionar</button>
                    </div>
                </div>
                <div>
                    <h4>Categorias Cadastradas</h4>
                    <div id="lista-categorias" style="max-height: 400px; overflow-y: auto;">
                        <!-- Categorias ser√£o carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sincroniza√ß√£o de armazenamento local com o servidor
        const storageSync = (() => {
            const API_URL = 'http://localhost:3000/api/storage';
            const originalSetItem = window.localStorage.setItem.bind(window.localStorage);
            const originalRemoveItem = window.localStorage.removeItem.bind(window.localStorage);
            const originalClear = window.localStorage.clear.bind(window.localStorage);
            let restaurando = false;

            async function salvarNoServidor(chave, valor) {
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chave, valor })
                    });
                } catch (error) {
                    console.error('Erro ao salvar dado persistente:', error);
                }
            }

            async function removerDoServidor(chave) {
                try {
                    await fetch(`${API_URL}/${encodeURIComponent(chave)}`, { method: 'DELETE' });
                } catch (error) {
                    console.error('Erro ao remover dado persistente:', error);
                }
            }

            async function limparServidor() {
                try {
                    await fetch(API_URL, { method: 'DELETE' });
                } catch (error) {
                    console.error('Erro ao limpar dados persistentes:', error);
                }
            }

            const ready = (async () => {
                try {
                    const response = await fetch(API_URL);
                    if (!response.ok) {
                        throw new Error('Falha ao carregar dados persistidos');
                    }
                    const dados = await response.json();
                    restaurando = true;
                    const chavesServidor = new Set();
                    dados.forEach(item => {
                        if (item && typeof item.chave === 'string') {
                            originalSetItem(item.chave, item.valor ?? '');
                            chavesServidor.add(item.chave);
                        }
                    });
                    const chavesLocaisParaSalvar = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const chaveLocal = localStorage.key(i);
                        if (chaveLocal && !chavesServidor.has(chaveLocal)) {
                            chavesLocaisParaSalvar.push(chaveLocal);
                        }
                    }
                    if (chavesLocaisParaSalvar.length) {
                        await Promise.all(
                            chavesLocaisParaSalvar.map(chave =>
                                salvarNoServidor(chave, localStorage.getItem(chave))
                            )
                        );
                    }
                } catch (error) {
                    console.error('Erro ao sincronizar storage inicial:', error);
                } finally {
                    restaurando = false;
                }
                return true;
            })();

            window.localStorage.setItem = function(chave, valor) {
                originalSetItem(chave, valor);
                if (!restaurando) {
                    salvarNoServidor(chave, valor);
                }
            };

            window.localStorage.removeItem = function(chave) {
                originalRemoveItem(chave);
                if (!restaurando) {
                    removerDoServidor(chave);
                }
            };

            window.localStorage.clear = function() {
                originalClear();
                if (!restaurando) {
                    limparServidor();
                }
            };

            return { ready };
        })();

        window.storageReady = storageSync.ready;

        // Helper para abrir WhatsApp: tenta esquema nativo e cai back para web.whatsapp.com
        function openWhatsAppFallback(telefone, mensagem) {
            const tel = String(telefone || '').replace(/\D/g, '');
            if (!tel) {
                alert('Telefone inv√°lido para WhatsApp');
                return;
            }
            const msgEncoded = encodeURIComponent(mensagem || '');

            // Tentar abrir app nativo via esquema
            try {
                const appLink = `whatsapp://send?phone=55${tel}&text=${msgEncoded}`;
                const a = document.createElement('a');
                a.href = appLink;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (e) {
                // ignore
            }

            // Fallback para web.whatsapp.com com texto pr√©-preenchido
            setTimeout(() => {
                const web = `https://web.whatsapp.com/send?phone=55${tel}&text=${msgEncoded}`;
                window.open(web, '_blank');
            }, 1100);
        }

        // Sistema de gerenciamento de estado
        const state = {
            currentUser: null,
            filtroFinanceiro: 'todos',
            filtroAgendamento: 'todos',
            filtroOrcamento: 'todos',
            filtroPeriodoFinanceiro: null, // { mes: 0-11, ano: 2024 }
            filtroClienteFinanceiro: null,
            dados: {
                clientes: JSON.parse(localStorage.getItem('clientes')) || [],
                veiculos: [],
                servicos: [],
                orcamentos: JSON.parse(localStorage.getItem('orcamentos')) || [],
                agendamentos: JSON.parse(localStorage.getItem('agendamentos')) || [],
                transacoes: JSON.parse(localStorage.getItem('transacoes')) || [],
                ordensServico: JSON.parse(localStorage.getItem('ordensServico')) || [],
                usuarios: JSON.parse(localStorage.getItem('usuarios')) || [],
                categoriasDespesas: JSON.parse(localStorage.getItem('categoriasDespesas')) || [
                    { id: 1, nome: 'Aluguel', padrao: true },
                    { id: 2, nome: '√Ågua', padrao: true },
                    { id: 3, nome: 'Luz', padrao: true }
                ],
                historicoTransacoes: JSON.parse(localStorage.getItem('historicoTransacoes')) || []
            },
            currentOrcamentoId: null,
            currentAgendamentoId: null,
            currentOSId: null,
            filtroOS: 'todos'
        };

        function sincronizarStateComLocalStorage() {
            if (!state?.dados) return;
            Object.keys(state.dados).forEach((key) => {
                const armazenado = localStorage.getItem(key);
                if (armazenado !== null) {
                    try {
                        state.dados[key] = JSON.parse(armazenado);
                    } catch (error) {
                        state.dados[key] = armazenado;
                    }
                }
            });
        }

        class NegoCarSystem {
            constructor() {
                this.config = {
                    apiBaseUrl: 'http://localhost:3000/api',
                    modoOperacao: 'desenvolvimento'
                };
                
                this.dados = state.dados;
                this.verificarAutenticacao();
            }

            async apiRequest(endpoint, options = {}) {
                try {
                    const method = options.method || 'GET';
                    const headers = {
                        'Content-Type': 'application/json',
                        ...(options.headers || {})
                    };

                    const url = `${this.config.apiBaseUrl}${endpoint.startsWith('/') ? '' : '/'}${endpoint}`;
                    const fetchOptions = { method, headers };

                    if (options.body !== undefined) {
                        fetchOptions.body = typeof options.body === 'string' ? options.body : JSON.stringify(options.body);
                    } else if (options.data !== undefined) {
                        fetchOptions.body = JSON.stringify(options.data);
                    }

                    if (method === 'GET' || method === 'HEAD') {
                        delete fetchOptions.body;
                    }

                    const response = await fetch(url, fetchOptions);
                    const text = await response.text();
                    let payload = null;
                    try {
                        payload = text ? JSON.parse(text) : null;
                    } catch {
                        payload = text;
                    }

                    if (!response.ok) {
                        const message = (payload && payload.error) ? payload.error : (typeof payload === 'string' && payload ? payload : `Erro ${response.status}`);
                        throw new Error(message);
                    }

                    return payload;
                } catch (error) {
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        throw new Error('N√£o foi poss√≠vel conectar ao servidor. Verifique se o servidor est√° rodando em http://localhost:3000');
                    }
                    throw error;
                }
            }

            formatarTelefone(valor) {
                if (!valor) return '';
                const digits = valor.replace(/\D/g, '');
                if (digits.length === 11) {
                    return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
                }
                if (digits.length === 10) {
                    return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
                }
                return digits;
            }

            gerarIdVeiculo(clienteId = 'novo', index = 0) {
                return `veh-${clienteId}-${Date.now()}-${index}-${Math.floor(Math.random() * 1000)}`;
            }

            normalizarCliente(cliente) {
                const enderecoNormalizado = cliente?.endereco && typeof cliente.endereco === 'string'
                    ? JSON.parse(cliente.endereco)
                    : (cliente?.endereco || null);

                const veiculosNormalizados = Array.isArray(cliente?.veiculos)
                    ? cliente.veiculos.map((veiculo, index) => ({
                        id: veiculo.id || veiculo.placa || this.gerarIdVeiculo(cliente.id, index),
                        placa: veiculo.placa || '',
                        marca: veiculo.marca || '',
                        modelo: veiculo.modelo || '',
                        ano: veiculo.ano || '',
                        ativo: veiculo.ativo !== false
                    }))
                    : [];

                const telefone = (cliente?.telefone || cliente?.whatsapp || '').toString();

                return {
                    id: cliente.id,
                    nome: cliente.nome || '',
                    whatsapp: this.formatarTelefone(telefone),
                    telefone: telefone.replace(/\D/g, ''),
                    endereco: enderecoNormalizado,
                    veiculos: veiculosNormalizados,
                    ativo: cliente.ativo !== 0
                };
            }

            reconstruirListaVeiculos() {
                const veiculos = [];
                (this.dados.clientes || []).forEach(cliente => {
                    (cliente.veiculos || []).forEach(veiculo => {
                        veiculos.push({
                                id: veiculo.id || veiculo.placa || `${cliente.id}-${(veiculo.placa || '').replace(/[^a-zA-Z0-9]/g,'')}`,
                            clienteId: cliente.id,
                            placa: veiculo.placa || '',
                            marca: veiculo.marca || '',
                            modelo: veiculo.modelo || '',
                            ano: veiculo.ano || '',
                            ativo: veiculo.ativo !== false
                        });
                    });
                });
                this.dados.veiculos = veiculos;
            }

            // Fun√ß√£o auxiliar para buscar ve√≠culo por ID com compara√ß√£o flex√≠vel
            buscarVeiculoPorId(veiculoId) {
                if (!veiculoId && veiculoId !== 0) return null;
                // Garantir que a lista est√° atualizada
                this.reconstruirListaVeiculos();
                // Buscar com compara√ß√£o flex√≠vel (n√∫mero ou string)
                    // Normalizar fun√ß√£o auxiliar
                    const normalize = val => (val === null || val === undefined) ? '' : String(val).toLowerCase().replace(/[^a-z0-9]/g, '');

                    const target = normalize(veiculoId);

                    // 1) procurar por id exato (string/number)
                    let found = this.dados.veiculos.find(v => {
                        if (v.id === veiculoId) return true;
                        const vid = normalize(v.id);
                        if (vid && vid === target) return true;
                        // tentar placa tamb√©m
                        const placa = normalize(v.placa);
                        if (placa && placa === target) return true;
                        return false;
                    }) || null;

                    // 2) se n√£o encontrou, tentar correspond√™ncia por placa sem m√°scara
                    if (!found && target) {
                        found = this.dados.veiculos.find(v => {
                            const placa = normalize(v.placa);
                            return placa && target.includes(placa) || placa.includes(target);
                        }) || null;
                    }

                    return found || null;
            }

            criarPayloadCliente({ id, nome, whatsapp, telefone, endereco, veiculos, ativo = true }) {
                const telefoneLimpo = (telefone || whatsapp || '').replace(/\D/g, '');
                const enderecoLimpo = endereco && Object.values(endereco).some(v => v && v.toString().trim() !== '')
                    ? endereco
                    : null;

                const veiculosPreparados = (veiculos || []).map((veiculo, index) => ({
                    id: veiculo.id || veiculo.placa || this.gerarIdVeiculo(id || 'novo', index),
                    placa: veiculo.placa || '',
                    marca: veiculo.marca || '',
                    modelo: veiculo.modelo || '',
                    ano: veiculo.ano || '',
                    ativo: veiculo.ativo !== false
                }));

                const payload = {
                    nome: nome || '',
                    telefone: telefoneLimpo,
                    endereco: enderecoLimpo,
                    veiculos: veiculosPreparados,
                    ativo: ativo ? 1 : 0
                };

                if (id !== undefined && id !== null) {
                    payload.id = id;
                }

                return payload;
            }

            async sincronizarClientesComServidor() {
                try {
                    let clientesServidor = await this.apiRequest('/clientes');
                    
                    // Criar um Set com os IDs dos clientes que j√° existem no servidor
                    const idsServidor = new Set((clientesServidor || []).map(c => String(c.id)));

                    // Sincronizar apenas clientes locais que n√£o existem no servidor
                    if (Array.isArray(this.dados.clientes) && this.dados.clientes.length > 0) {
                        for (const clienteLocal of this.dados.clientes) {
                            const clienteIdStr = String(clienteLocal.id);
                            const payload = this.criarPayloadCliente({
                                id: clienteLocal.id,
                                nome: clienteLocal.nome,
                                whatsapp: clienteLocal.whatsapp,
                                telefone: clienteLocal.telefone,
                                endereco: clienteLocal.endereco,
                                veiculos: clienteLocal.veiculos,
                                ativo: clienteLocal.ativo
                            });
                            
                            try {
                                if (idsServidor.has(clienteIdStr)) {
                                    // Cliente j√° existe, atualizar
                                    await this.apiRequest(`/clientes/${clienteLocal.id}`, { method: 'PUT', data: payload });
                                } else {
                                    // Cliente n√£o existe, criar
                                    await this.apiRequest('/clientes', { method: 'POST', data: payload });
                                }
                            } catch (error) {
                                // Se der erro de constraint, o cliente j√° existe, tentar atualizar
                                if (error.message && error.message.includes('UNIQUE constraint')) {
                                    console.warn(`Cliente ${clienteLocal.id} j√° existe, tentando atualizar...`);
                                    try {
                                        await this.apiRequest(`/clientes/${clienteLocal.id}`, { method: 'PUT', data: payload });
                                    } catch (updateError) {
                                        console.error(`Erro ao atualizar cliente ${clienteLocal.id}:`, updateError);
                                        // Continuar com os pr√≥ximos clientes mesmo se um falhar
                                    }
                                } else {
                                    console.error(`Erro ao sincronizar cliente ${clienteLocal.id}:`, error);
                                    // Continuar com os pr√≥ximos clientes mesmo se um falhar
                                }
                            }
                        }
                        
                        // Recarregar lista do servidor ap√≥s sincroniza√ß√£o
                        clientesServidor = await this.apiRequest('/clientes');
                    }

                    if (clientesServidor) {
                        this.dados.clientes = clientesServidor.map(cliente => this.normalizarCliente(cliente));
                        this.reconstruirListaVeiculos();
                        this.salvarDados('clientes');
                        this.salvarDados('veiculos');
                    }
                } catch (error) {
                    console.error('Falha ao sincronizar clientes com o servidor:', error);
                    this.log(`N√£o foi poss√≠vel sincronizar clientes com o servidor: ${error.message}`, 'error');
                }
            }

            gerarProximoNumeroAgendamento() {
                if (!Array.isArray(this.dados.agendamentos) || this.dados.agendamentos.length === 0) {
                    return 0;
                }
                const numeros = this.dados.agendamentos
                    .map(a => (a.numero !== undefined && a.numero !== null ? parseInt(a.numero) : -1))
                    .filter(n => !Number.isNaN(n) && n >= 0)
                    .sort((a, b) => b - a);
                return numeros.length > 0 ? numeros[0] + 1 : 0;
            }

            normalizarAgendamento(agendamento) {
                if (!agendamento) return null;
                const parseIntSafe = (valor) => {
                    if (valor === null || valor === undefined || valor === '') return null;
                    const parsed = parseInt(valor);
                    return Number.isNaN(parsed) ? null : parsed;
                };

                // Normalizar veiculoId - pode ser n√∫mero ou string
                const veiculoIdRaw = agendamento.veiculo_id ?? agendamento.veiculoId;
                let veiculoId = null;
                if (veiculoIdRaw !== null && veiculoIdRaw !== undefined && veiculoIdRaw !== '') {
                    const veiculoIdNum = parseInt(veiculoIdRaw);
                    // Se for um n√∫mero v√°lido, usar como n√∫mero, sen√£o manter como string
                    veiculoId = (!Number.isNaN(veiculoIdNum) && veiculoIdNum > 0) ? veiculoIdNum : String(veiculoIdRaw);
                }

                return {
                    id: parseIntSafe(agendamento.id) ?? agendamento.id,
                    numero: agendamento.numero !== undefined && agendamento.numero !== null
                        ? parseIntSafe(agendamento.numero)
                        : null,
                    clienteId: parseIntSafe(agendamento.cliente_id ?? agendamento.clienteId),
                    veiculoId: veiculoId, // Pode ser n√∫mero ou string
                    data: agendamento.data || null,
                    hora: agendamento.hora || '',
                    problema: agendamento.problema || agendamento.servico || '',
                    observacoes: agendamento.observacoes || '',
                    status: agendamento.status || 'pendente',
                    whatsappEnviado: agendamento.whatsapp_enviado === 1 || agendamento.whatsappEnviado === 1 || agendamento.whatsappEnviado === true,
                    lembreteEnviado: agendamento.lembrete_enviado === 1 || agendamento.lembreteEnviado === 1 || agendamento.lembreteEnviado === true,
                    dataFinalizacao: agendamento.data_finalizacao || agendamento.dataFinalizacao || null,
                    dataCriacao: agendamento.created_at || agendamento.dataCriacao || null,
                    dataAtualizacao: agendamento.updated_at || agendamento.dataAtualizacao || null
                };
            }

            criarPayloadAgendamento(dados) {
                // Garantir que veiculoId est√° presente e n√£o √© vazio
                const veiculoId = dados.veiculoId;
                if (!veiculoId && veiculoId !== 0) {
                    console.error('AVISO: veiculoId est√° vazio no payload!', dados);
                }

                const payload = {
                    clienteId: dados.clienteId,
                    veiculoId: veiculoId || null, // Garantir que sempre tem um valor (mesmo que null)
                    numero: dados.numero ?? null,
                    data: dados.data,
                    hora: dados.hora || '',
                    problema: dados.problema || '',
                    observacoes: dados.observacoes || '',
                    status: dados.status || 'pendente',
                    whatsappEnviado: dados.whatsappEnviado ? 1 : 0,
                    lembreteEnviado: dados.lembreteEnviado ? 1 : 0,
                    dataFinalizacao: dados.dataFinalizacao || null
                };

                if (dados.id !== undefined && dados.id !== null) {
                    payload.id = dados.id;
                }

                console.log('Payload criado:', payload);
                return payload;
            }

            async sincronizarAgendamentosComServidor() {
                try {
                    // Criar mapa de agendamentos locais por ID para preservar veiculoId
                    const agendamentosLocaisMap = new Map();
                    if (Array.isArray(this.dados.agendamentos)) {
                        this.dados.agendamentos.forEach(ag => {
                            if (ag.id && ag.veiculoId) {
                                agendamentosLocaisMap.set(ag.id, { veiculoId: ag.veiculoId });
                            }
                        });
                    }
                    
                    let agendamentosServidor = await this.apiRequest('/agendamentos');

                    if ((!agendamentosServidor || agendamentosServidor.length === 0) &&
                        Array.isArray(this.dados.agendamentos) &&
                        this.dados.agendamentos.length > 0) {

                        for (const agendamentoLocal of this.dados.agendamentos) {
                            const payload = this.criarPayloadAgendamento({
                                ...agendamentoLocal,
                                id: agendamentoLocal.id
                            });
                            await this.apiRequest('/agendamentos', { method: 'POST', data: payload });
                        }

                        agendamentosServidor = await this.apiRequest('/agendamentos');
                    }

                    if (Array.isArray(agendamentosServidor)) {
                        this.dados.agendamentos = agendamentosServidor
                            .map(agendamento => {
                                const normalizado = this.normalizarAgendamento(agendamento);
                                if (normalizado) {
                                    // Preservar veiculoId local se o servidor n√£o retornou ou retornou null
                                    const localData = agendamentosLocaisMap.get(normalizado.id);
                                    if (localData && localData.veiculoId && (!normalizado.veiculoId || normalizado.veiculoId === null)) {
                                        console.log(`Preservando veiculoId local para agendamento ${normalizado.id}:`, localData.veiculoId);
                                        normalizado.veiculoId = localData.veiculoId;
                                    }
                                }
                                return normalizado;
                            })
                            .filter(Boolean);
                        this.salvarDados('agendamentos');
                    }
                } catch (error) {
                    console.error('Falha ao sincronizar agendamentos com o servidor:', error);
                    this.log(`N√£o foi poss√≠vel sincronizar agendamentos: ${error.message}`, 'warning');
                }
            }

            async atualizarAgendamentoServidor(id, updates = {}) {
                const idx = this.dados.agendamentos.findIndex(a => a.id === id);
                if (idx === -1) {
                    throw new Error('Agendamento n√£o encontrado');
                }

                const agendamento = this.dados.agendamentos[idx];
                
                // Preservar veiculoId existente se n√£o foi fornecido nos updates
                if (!updates.veiculoId && agendamento.veiculoId) {
                    updates.veiculoId = agendamento.veiculoId;
                }
                
                Object.assign(agendamento, updates);
                agendamento.dataAtualizacao = new Date().toISOString();

                if (agendamento.status === 'finalizado' && !agendamento.dataFinalizacao) {
                    agendamento.dataFinalizacao = new Date().toISOString();
                }

                console.log('Atualizando agendamento no servidor:', {
                    id,
                    veiculoId: agendamento.veiculoId,
                    tipoVeiculoId: typeof agendamento.veiculoId
                });

                const payload = this.criarPayloadAgendamento(agendamento);
                const atualizado = await this.apiRequest(`/agendamentos/${id}`, { method: 'PUT', data: payload });
                
                // Garantir que o veiculoId est√° preservado ap√≥s atualiza√ß√£o
                if (atualizado) {
                    const agendamentoAtualizado = this.normalizarAgendamento(atualizado);
                    if (agendamentoAtualizado && agendamento.veiculoId && (!agendamentoAtualizado.veiculoId || agendamentoAtualizado.veiculoId === null)) {
                        agendamentoAtualizado.veiculoId = agendamento.veiculoId;
                    }
                    Object.assign(agendamento, agendamentoAtualizado);
                }
                
                this.salvarDados('agendamentos');
                return agendamento;
            }

            gerarProximoNumeroOrcamento() {
                if (!Array.isArray(this.dados.orcamentos) || this.dados.orcamentos.length === 0) {
                    return 0;
                }
                const numeros = this.dados.orcamentos
                    .map(o => (o.numero !== undefined && o.numero !== null ? parseInt(o.numero) : -1))
                    .filter(n => !Number.isNaN(n) && n >= 0)
                    .sort((a, b) => b - a);
                return numeros.length > 0 ? numeros[0] + 1 : 0;
            }

            gerarProximoNumeroOS() {
                if (!Array.isArray(this.dados.ordensServico) || this.dados.ordensServico.length === 0) {
                    return 1;
                }
                const numeros = this.dados.ordensServico
                    .map(os => (os.numero !== undefined && os.numero !== null ? parseInt(os.numero) : -1))
                    .filter(n => !Number.isNaN(n) && n >= 0)
                    .sort((a, b) => b - a);
                return numeros.length > 0 ? numeros[0] + 1 : 1;
            }

            normalizarOrcamento(orcamento) {
                if (!orcamento) return null;
                const parseIntSafe = (valor) => {
                    if (valor === null || valor === undefined || valor === '') return null;
                    const parsed = parseInt(valor);
                    return Number.isNaN(parsed) ? null : parsed;
                };
                const parseFloatSafe = (valor) => {
                    const parsed = parseFloat(valor);
                    return Number.isNaN(parsed) ? 0 : parsed;
                };

                // Normalizar veiculoId - pode ser n√∫mero ou string
                const veiculoIdRaw = orcamento.veiculo_id ?? orcamento.veiculoId;
                let veiculoId = null;
                if (veiculoIdRaw !== null && veiculoIdRaw !== undefined && veiculoIdRaw !== '') {
                    const veiculoIdNum = parseInt(veiculoIdRaw);
                    // Se for um n√∫mero v√°lido, usar como n√∫mero, sen√£o manter como string
                    veiculoId = (!Number.isNaN(veiculoIdNum) && veiculoIdNum > 0) ? veiculoIdNum : String(veiculoIdRaw);
                }

                return {
                    id: parseIntSafe(orcamento.id) ?? orcamento.id,
                    numero: parseIntSafe(orcamento.numero),
                    clienteId: parseIntSafe(orcamento.cliente_id ?? orcamento.clienteId),
                    veiculoId: veiculoId, // Pode ser n√∫mero ou string
                    agendamentoId: parseIntSafe(orcamento.agendamento_id ?? orcamento.agendamentoId),
                    servicos: Array.isArray(orcamento.servicos) ? orcamento.servicos : (orcamento.servicos ? JSON.parse(orcamento.servicos) : []),
                    pecas: Array.isArray(orcamento.pecas) ? orcamento.pecas : (orcamento.pecas ? JSON.parse(orcamento.pecas) : []),
                    observacoes: orcamento.observacoes || '',
                    validade: orcamento.validade !== undefined && orcamento.validade !== null ? parseIntSafe(orcamento.validade) : null,
                    data: orcamento.data || orcamento.created_at || new Date().toISOString().split('T')[0],
                    desconto: parseFloatSafe(orcamento.desconto),
                    total: orcamento.total !== undefined && orcamento.total !== null
                        ? parseFloatSafe(orcamento.total)
                        : parseFloatSafe(orcamento.valor_total),
                    status: orcamento.status || 'pendente',
                    statusFinanceiro: orcamento.statusFinanceiro ?? orcamento.status_financeiro ?? null,
                    dataDuplicata: orcamento.dataDuplicata ?? orcamento.data_duplicata ?? null,
                    dataLiquidacao: orcamento.dataLiquidacao ?? orcamento.data_liquidacao ?? null,
                    createdAt: orcamento.created_at || null,
                    updatedAt: orcamento.updated_at || null
                };
            }

            criarPayloadOrcamento(dados) {
                const payload = {
                    clienteId: dados.clienteId,
                    veiculoId: dados.veiculoId,
                    agendamentoId: dados.agendamentoId ?? null,
                    numero: dados.numero ?? null,
                    servicos: dados.servicos || [],
                    pecas: dados.pecas || [],
                    observacoes: dados.observacoes || '',
                    validade: dados.validade ?? null,
                    data: dados.data || new Date().toISOString().split('T')[0],
                    desconto: dados.desconto ?? 0,
                    total: dados.total ?? 0,
                    status: dados.status || 'pendente'
                };

                if (dados.statusFinanceiro !== undefined && dados.statusFinanceiro !== null) {
                    payload.statusFinanceiro = dados.statusFinanceiro;
                }
                if (dados.dataDuplicata !== undefined && dados.dataDuplicata !== null) {
                    payload.dataDuplicata = dados.dataDuplicata;
                }
                if (dados.dataLiquidacao !== undefined && dados.dataLiquidacao !== null) {
                    payload.dataLiquidacao = dados.dataLiquidacao;
                }

                if (dados.id !== undefined && dados.id !== null) {
                    payload.id = dados.id;
                }

                return payload;
            }

            async sincronizarOrcamentosComServidor() {
                try {
                    let orcamentosServidor = await this.apiRequest('/orcamentos');

                    if ((!orcamentosServidor || orcamentosServidor.length === 0) &&
                        Array.isArray(this.dados.orcamentos) &&
                        this.dados.orcamentos.length > 0) {

                        for (const orcLocal of this.dados.orcamentos) {
                            const payload = this.criarPayloadOrcamento({ ...orcLocal });
                            await this.apiRequest('/orcamentos', { method: 'POST', data: payload });
                        }

                        orcamentosServidor = await this.apiRequest('/orcamentos');
                    }

                    if (Array.isArray(orcamentosServidor)) {
                        this.dados.orcamentos = orcamentosServidor
                            .map(orc => this.normalizarOrcamento(orc))
                            .filter(Boolean);
                        this.salvarDados('orcamentos');
                    }
                } catch (error) {
                    console.error('Falha ao sincronizar or√ßamentos:', error);
                    this.log(`N√£o foi poss√≠vel sincronizar or√ßamentos: ${error.message}`, 'warning');
                }
            }

            async atualizarOrcamentoServidor(id, updates = {}) {
                const idx = this.dados.orcamentos.findIndex(o => o.id === id);
                if (idx === -1) {
                    throw new Error('Or√ßamento n√£o encontrado');
                }

                const atualizado = { ...this.dados.orcamentos[idx], ...updates, id };
                const payload = this.criarPayloadOrcamento(atualizado);
                const resposta = await this.apiRequest(`/orcamentos/${id}`, { method: 'PUT', data: payload });
                const normalizado = this.normalizarOrcamento(resposta);
                this.dados.orcamentos[idx] = normalizado;
                this.salvarDados('orcamentos');
                return normalizado;
            }

            normalizarOrdemServico(os) {
                if (!os) return null;
                const parseIntSafe = (valor) => {
                    const parsed = parseInt(valor);
                    return Number.isNaN(parsed) ? null : parsed;
                };

                return {
                    id: parseIntSafe(os.id) ?? os.id,
                    numero: parseIntSafe(os.numero),
                    orcamentoId: parseIntSafe(os.orcamento_id ?? os.orcamentoId),
                    clienteId: parseIntSafe(os.cliente_id ?? os.clienteId),
                    veiculoId: parseIntSafe(os.veiculo_id ?? os.veiculoId),
                    agendamentoId: parseIntSafe(os.agendamento_id ?? os.agendamentoId),
                    servicos: Array.isArray(os.servicos) ? os.servicos : (os.servicos ? JSON.parse(os.servicos) : []),
                    pecas: Array.isArray(os.pecas) ? os.pecas : (os.pecas ? JSON.parse(os.pecas) : []),
                    observacoes: os.observacoes || '',
                    status: os.status || 'pendente',
                    dataAbertura: os.data_abertura || os.dataAbertura || new Date().toISOString(),
                    dataFinalizacao: os.data_finalizacao || os.dataFinalizacao || null,
                    whatsappEnviado: os.whatsapp_enviado === 1 || os.whatsappEnviado === 1 || os.whatsappEnviado === true,
                    createdAt: os.created_at || null,
                    updatedAt: os.updated_at || null
                };
            }

            criarPayloadOrdemServico(dados) {
                const payload = {
                    numero: dados.numero ?? null,
                    orcamentoId: dados.orcamentoId,
                    clienteId: dados.clienteId ?? null,
                    veiculoId: dados.veiculoId ?? null,
                    agendamentoId: dados.agendamentoId ?? null,
                    servicos: dados.servicos || [],
                    pecas: dados.pecas || [],
                    observacoes: dados.observacoes || '',
                    status: dados.status || 'pendente',
                    dataAbertura: dados.dataAbertura || new Date().toISOString(),
                    dataFinalizacao: dados.dataFinalizacao || null,
                    whatsappEnviado: dados.whatsappEnviado ? 1 : 0
                };

                if (dados.id !== undefined && dados.id !== null) {
                    payload.id = dados.id;
                }

                return payload;
            }

            async sincronizarOrdensServicoComServidor() {
                try {
                    let ordensServidor = await this.apiRequest('/ordens-servico');

                    if ((!ordensServidor || ordensServidor.length === 0) &&
                        Array.isArray(this.dados.ordensServico) &&
                        this.dados.ordensServico.length > 0) {

                        for (const osLocal of this.dados.ordensServico) {
                            const payload = this.criarPayloadOrdemServico({ ...osLocal });
                            await this.apiRequest('/ordens-servico', { method: 'POST', data: payload });
                        }

                        ordensServidor = await this.apiRequest('/ordens-servico');
                    }

                    if (Array.isArray(ordensServidor)) {
                        this.dados.ordensServico = ordensServidor
                            .map(os => this.normalizarOrdemServico(os))
                            .filter(Boolean);
                        this.salvarDados('ordensServico');
                    }
                } catch (error) {
                    console.error('Falha ao sincronizar ordens de servi√ßo:', error);
                    this.log(`N√£o foi poss√≠vel sincronizar ordens de servi√ßo: ${error.message}`, 'warning');
                }
            }

            async atualizarOrdemServicoServidor(id, updates = {}) {
                const idx = this.dados.ordensServico.findIndex(o => o.id === id);
                if (idx === -1) {
                    throw new Error('Ordem de servi√ßo n√£o encontrada');
                }

                const atualizado = { ...this.dados.ordensServico[idx], ...updates, id };
                const payload = this.criarPayloadOrdemServico(atualizado);
                const resposta = await this.apiRequest(`/ordens-servico/${id}`, { method: 'PUT', data: payload });
                const normalizado = this.normalizarOrdemServico(resposta);
                this.dados.ordensServico[idx] = normalizado;
                this.salvarDados('ordensServico');
                return normalizado;
            }

            verificarAutenticacao() {
                const usuario = localStorage.getItem('usuario');
                if (!usuario) {
                    // Primeiro acesso - mostrar cadastro
                    document.getElementById('cadastro-form').style.display = 'block';
                    document.getElementById('login-form').style.display = 'none';
                } else {
                    // Usu√°rio j√° cadastrado - mostrar login
                    const usuarioData = JSON.parse(usuario);
                    if (usuarioData.logo) {
                        document.getElementById('login-logo-preview').src = usuarioData.logo;
                        document.getElementById('login-logo-preview').style.display = 'block';
                    }
                    document.getElementById('login-form').style.display = 'block';
                    document.getElementById('cadastro-form').style.display = 'none';
                }
            }

            carregarLogo(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const logoData = e.target.result;
                        document.getElementById('logo-preview').src = logoData;
                        document.getElementById('logo-preview').style.display = 'block';
                        // Salvar temporariamente para uso no cadastro
                        window.tempLogo = logoData;
                    };
                    reader.readAsDataURL(file);
                }
            }

            cadastrarUsuario() {
                const nome = document.getElementById('cadastro-nome').value.trim();
                const pin1 = document.getElementById('cadastro-pin-1').value;
                const pin2 = document.getElementById('cadastro-pin-2').value;
                const pin3 = document.getElementById('cadastro-pin-3').value;
                const pin4 = document.getElementById('cadastro-pin-4').value;
                const pinConfirm1 = document.getElementById('cadastro-pin-confirm-1').value;
                const pinConfirm2 = document.getElementById('cadastro-pin-confirm-2').value;
                const pinConfirm3 = document.getElementById('cadastro-pin-confirm-3').value;
                const pinConfirm4 = document.getElementById('cadastro-pin-confirm-4').value;

                if (!nome) {
                    alert('Por favor, preencha o nome do usu√°rio');
                    return;
                }

                const pin = pin1 + pin2 + pin3 + pin4;
                const pinConfirm = pinConfirm1 + pinConfirm2 + pinConfirm3 + pinConfirm4;

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    alert('O PIN deve conter exatamente 4 d√≠gitos num√©ricos');
                    return;
                }

                if (pin !== pinConfirm) {
                    alert('Os PINs n√£o coincidem');
                    return;
                }

                const usuario = {
                    nome: nome,
                    pin: pin,
                    logo: window.tempLogo || null
                };

                localStorage.setItem('usuario', JSON.stringify(usuario));
                this.carregarLogos();
                this.entrarNoSistema();
            }

            fazerLogin() {
                const pin1 = document.getElementById('login-pin-1').value;
                const pin2 = document.getElementById('login-pin-2').value;
                const pin3 = document.getElementById('login-pin-3').value;
                const pin4 = document.getElementById('login-pin-4').value;
                const pin = pin1 + pin2 + pin3 + pin4;

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    alert('Por favor, digite o PIN completo (4 d√≠gitos)');
                    return;
                }

                const usuario = JSON.parse(localStorage.getItem('usuario'));
                if (!usuario) {
                    alert('Usu√°rio n√£o encontrado. Por favor, fa√ßa o cadastro primeiro.');
                    return;
                }

                if (usuario.pin !== pin) {
                    alert('PIN incorreto');
                    // Limpar campos
                    document.getElementById('login-pin-1').value = '';
                    document.getElementById('login-pin-2').value = '';
                    document.getElementById('login-pin-3').value = '';
                    document.getElementById('login-pin-4').value = '';
                    document.getElementById('login-pin-1').focus();
                    return;
                }

                this.carregarLogos();
                this.entrarNoSistema();
            }

            carregarLogos() {
                const usuario = JSON.parse(localStorage.getItem('usuario'));
                if (usuario && usuario.logo) {
                    document.getElementById('sidebar-logo').src = usuario.logo;
                    document.getElementById('sidebar-logo').style.display = 'block';
                    document.getElementById('header-logo').src = usuario.logo;
                    document.getElementById('header-logo').style.display = 'block';
                    document.getElementById('login-logo-preview').src = usuario.logo;
                }
            }

            entrarNoSistema() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');
                this.init();
            }

            verificarPIN() {
                return new Promise((resolve) => {
                    // Criar modal para inserir PIN
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.display = 'block';
                    modal.id = 'pin-verificar-modal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 400px;">
                            <div class="modal-header">
                                <h3 class="modal-title">Digite o PIN</h3>
                                <button class="close" onclick="document.getElementById('pin-verificar-modal').remove(); if(window.pinVerificacaoResolve) { window.pinVerificacaoResolve(false); window.pinVerificacaoResolve = null; }">&times;</button>
                            </div>
                            <div style="padding: 20px;">
                                <div class="form-group">
                                    <label>PIN (4 d√≠gitos) *</label>
                                    <div class="pin-input">
                                        <input type="password" id="pin-verificar-1" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(1, event, 'verificar')">
                                        <input type="password" id="pin-verificar-2" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(2, event, 'verificar')">
                                        <input type="password" id="pin-verificar-3" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(3, event, 'verificar')">
                                        <input type="password" id="pin-verificar-4" maxlength="1" pattern="[0-9]" onkeyup="moverPinInput(4, event, 'verificar')">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 20px;">
                                    <button class="btn btn-success" onclick="sistema.validarPINModal(this)" style="flex: 1;">Confirmar</button>
                                    <button class="btn btn-danger" onclick="document.getElementById('pin-verificar-modal').remove(); if(window.pinVerificacaoResolve) { window.pinVerificacaoResolve(false); window.pinVerificacaoResolve = null; }" style="flex: 1;">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                    
                    // Focar no primeiro campo
                    setTimeout(() => {
                        const firstInput = document.getElementById('pin-verificar-1');
                        if (firstInput) firstInput.focus();
                    }, 100);
                    
                    // Salvar resolve para usar depois
                    window.pinVerificacaoResolve = resolve;
                });
            }

            validarPINModal(button) {
                const pin1 = document.getElementById('pin-verificar-1')?.value || '';
                const pin2 = document.getElementById('pin-verificar-2')?.value || '';
                const pin3 = document.getElementById('pin-verificar-3')?.value || '';
                const pin4 = document.getElementById('pin-verificar-4')?.value || '';
                const pin = pin1 + pin2 + pin3 + pin4;

                if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                    alert('Por favor, digite o PIN completo (4 d√≠gitos)');
                    return;
                }

                const usuario = JSON.parse(localStorage.getItem('usuario'));
                if (usuario && usuario.pin === pin) {
                    const modal = document.getElementById('pin-verificar-modal');
                    if (modal) {
                        modal.remove();
                    }
                    if (window.pinVerificacaoResolve) {
                        window.pinVerificacaoResolve(true);
                        window.pinVerificacaoResolve = null;
                    }
                } else {
                    alert('PIN incorreto');
                    const pin1El = document.getElementById('pin-verificar-1');
                    const pin2El = document.getElementById('pin-verificar-2');
                    const pin3El = document.getElementById('pin-verificar-3');
                    const pin4El = document.getElementById('pin-verificar-4');
                    if (pin1El) pin1El.value = '';
                    if (pin2El) pin2El.value = '';
                    if (pin3El) pin3El.value = '';
                    if (pin4El) pin4El.value = '';
                    if (pin1El) pin1El.focus();
                }
            }

            async init() {
                try {
                this.configurarNavegacao();
                    await this.carregarDadosIniciais();
                this.configurarEventListeners();
                this.log('Sistema NegoCar inicializado com sucesso', 'success');
                
                // Verificar lembretes de agendamentos
                this.verificarLembretesAgendamentos();
                
                // Verificar lembretes a cada hora
                setInterval(() => {
                    this.verificarLembretesAgendamentos();
                }, 3600000); // 1 hora
                } catch (error) {
                    console.error('Erro ao iniciar sistema:', error);
                    this.log(`Erro ao iniciar sistema: ${error.message}`, 'error');
                }
            }

            // M√©todo para salvar no localStorage
            salvarDados(key) {
                localStorage.setItem(key, JSON.stringify(this.dados[key]));
            }

            async salvarCliente() {
                try {
                    const form = document.getElementById('form-cliente');
                    const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;

                    const nome = document.getElementById('cliente-nome').value.trim();
                    const whatsapp = document.getElementById('cliente-whatsapp').value.trim();
                    
                    // Dados do endere√ßo
                    const endereco = {
                        cep: document.getElementById('cliente-cep').value.trim(),
                        logradouro: document.getElementById('cliente-logradouro').value.trim(),
                        numero: document.getElementById('cliente-numero').value.trim(),
                        complemento: document.getElementById('cliente-complemento').value.trim(),
                        bairro: document.getElementById('cliente-bairro').value.trim(),
                        cidade: document.getElementById('cliente-cidade').value.trim(),
                        estado: document.getElementById('cliente-estado').value.trim()
                    };
                    
                    // Valida√ß√µes b√°sicas
                    if (!nome || nome.length < 3) {
                        throw new Error('Nome deve ter pelo menos 3 caracteres');
                    }

                    if (!whatsapp || whatsapp.replace(/\D/g, '').length < 10) {
                        throw new Error('WhatsApp deve ser um n√∫mero v√°lido');
                    }

                    const veiculos = [];
                    const veiculosElements = document.querySelectorAll('.veiculo-item');
                    
                    veiculosElements.forEach((item, index) => {
                        const placa = item.querySelector('.veiculo-placa')?.value.trim();
                        const marca = item.querySelector('.veiculo-marca')?.value.trim();
                        const modelo = item.querySelector('.veiculo-modelo')?.value.trim();
                        const ano = item.querySelector('.veiculo-ano')?.value.trim();
                        
                        if (placa && modelo) {
                            const veiculoId = item.dataset.veiculoId || this.gerarIdVeiculo(editId || 'novo', index);
                            veiculos.push({
                                id: veiculoId,
                                placa,
                                marca: marca || '',
                                modelo,
                                ano: ano || '',
                                ativo: true
                            });
                        }
                    });

                    if (veiculos.length === 0) {
                        throw new Error('Adicione pelo menos um ve√≠culo');
                    }

                    const payload = this.criarPayloadCliente({
                        id: editId,
                            nome, 
                            whatsapp, 
                        endereco,
                        veiculos,
                        ativo: true
                    });

                    let mensagem = 'Cliente cadastrado com sucesso!';

                    if (editId) {
                        await this.apiRequest(`/clientes/${editId}`, { method: 'PUT', data: payload });
                        mensagem = 'Cliente atualizado com sucesso!';
                    } else {
                        await this.apiRequest('/clientes', { method: 'POST', data: payload });
                    }

                    await this.sincronizarClientesComServidor();

                    fecharModalCliente();
                    // remover flag de edi√ß√£o
                    delete form.dataset.editId;
                    this.atualizarTodosDados();
                    this.log(mensagem, 'success');
                    return true;

                } catch (error) {
                    this.log(`Erro ao salvar cliente: ${error.message}`, 'error');
                    alert(error.message);
                    return false;
                }
            }

            async salvarVeiculo() {
                try {
                    const clienteId = parseInt(document.getElementById('veiculo-cliente').value);
                    const placa = document.getElementById('veiculo-placa').value.trim().toUpperCase();
                    const marca = document.getElementById('veiculo-marca').value.trim();
                    const modelo = document.getElementById('veiculo-modelo').value.trim();
                    const ano = document.getElementById('veiculo-ano').value;

                    if (!clienteId) throw new Error('Selecione um cliente');
                    if (!placa) throw new Error('Placa √© obrigat√≥ria');
                    if (!modelo) throw new Error('Modelo √© obrigat√≥rio');

                    const cliente = this.dados.clientes.find(c => c.id === clienteId);
                    if (!cliente) throw new Error('Cliente n√£o encontrado');

                    const veiculosAtualizados = Array.isArray(cliente.veiculos) ? [...cliente.veiculos] : [];
                    const existenteIndex = veiculosAtualizados.findIndex(v => v.placa === placa);

                    const novoVeiculo = {
                        id: existenteIndex >= 0 ? veiculosAtualizados[existenteIndex].id : this.gerarIdVeiculo(clienteId, veiculosAtualizados.length),
                        placa,
                        marca: marca || '',
                        modelo,
                        ano: ano || '',
                        ativo: true
                    };

                    if (existenteIndex >= 0) {
                        veiculosAtualizados[existenteIndex] = novoVeiculo;
                    } else {
                        veiculosAtualizados.push(novoVeiculo);
                    }

                    // Atualizar o cliente localmente antes de sincronizar
                    const clienteIndex = this.dados.clientes.findIndex(c => c.id === clienteId);
                    if (clienteIndex >= 0) {
                        this.dados.clientes[clienteIndex].veiculos = veiculosAtualizados;
                    }

                    const payload = this.criarPayloadCliente({
                        id: cliente.id,
                        nome: cliente.nome,
                        whatsapp: cliente.telefone || cliente.whatsapp,
                        telefone: cliente.telefone,
                        endereco: cliente.endereco,
                        veiculos: veiculosAtualizados,
                        ativo: cliente.ativo
                    });

                    await this.apiRequest(`/clientes/${cliente.id}`, { method: 'PUT', data: payload });
                    
                    // Reconstruir lista de ve√≠culos com os dados atualizados localmente
                    this.reconstruirListaVeiculos();
                    this.salvarDados('clientes');
                    this.salvarDados('veiculos');
                    
                    await this.sincronizarClientesComServidor();
                    this.atualizarTodosDados();
                    fecharModalVeiculo();
                    this.log('Ve√≠culo salvo com sucesso!', 'success');
                    return novoVeiculo;

                } catch (error) {
                    this.log(`Erro ao salvar ve√≠culo: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            async adicionarOrcamento(dados) {
                const numeroOrcamento = dados.numero !== undefined && dados.numero !== null
                    ? dados.numero
                    : this.gerarProximoNumeroOrcamento();

                const totalServicos = (dados.servicos || []).reduce((sum, servico) => {
                    return sum + (parseFloat(servico.valor) * parseInt(servico.quantidade || 1));
                }, 0);
                
                const totalPecas = (dados.pecas || []).reduce((sum, peca) => {
                    return sum + (parseFloat(peca.valor) * parseInt(peca.quantidade || 1));
                }, 0);
                
                const total = dados.total !== undefined ? dados.total : (totalServicos + totalPecas);

                const payload = this.criarPayloadOrcamento({
                    ...dados,
                    numero: numeroOrcamento,
                    total,
                    data: dados.data || new Date().toISOString().split('T')[0],
                    status: dados.status || 'pendente'
                });

                const criado = await this.apiRequest('/orcamentos', { method: 'POST', data: payload });
                const normalizado = this.normalizarOrcamento(criado);
                this.dados.orcamentos.push(normalizado);
                this.salvarDados('orcamentos');
                this.log(`Or√ßamento #${normalizado.numero} gerado com sucesso`, 'success');
                return normalizado;
            }

            async gerarOrcamento() {
                try {
                    const form = document.getElementById('form-orcamento');
                    const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
                    const isEdit = !!editId;
                    
                    const clienteId = parseInt(document.getElementById('orcamento-cliente').value);
                    const agendamentoId = parseInt(document.getElementById('orcamento-agendamento').value);
                    const validade = parseInt(document.getElementById('orcamento-validade').value);
                    const observacoes = document.getElementById('orcamento-observacoes').value.trim();

                    if (!clienteId) throw new Error('Selecione um cliente');
                    if (!agendamentoId) throw new Error('Selecione um agendamento');
                    if (!validade || validade < 1) throw new Error('Validade deve ser de pelo menos 1 dia');

                    // Obter ve√≠culo do agendamento
                    const agendamento = this.dados.agendamentos.find(a => a.id === agendamentoId);
                    if (!agendamento) throw new Error('Agendamento n√£o encontrado');
                    
                    const veiculoId = agendamento.veiculoId;
                    if (!veiculoId || veiculoId === null || veiculoId === undefined || veiculoId === '') {
                        console.error('Agendamento sem ve√≠culo:', {
                            agendamentoId,
                            agendamento: agendamento
                        });
                        throw new Error('Ve√≠culo n√£o encontrado no agendamento. Verifique se o agendamento possui um ve√≠culo associado.');
                    }
                    
                    // Verificar se o ve√≠culo existe na lista usando busca flex√≠vel
                    const veiculoExiste = this.buscarVeiculoPorId(veiculoId);
                    
                    if (!veiculoExiste) {
                        // Tentar reconstruir a lista de ve√≠culos e buscar novamente
                        this.reconstruirListaVeiculos();
                        const veiculoExisteNovamente = this.buscarVeiculoPorId(veiculoId);
                        
                        if (!veiculoExisteNovamente) {
                            console.error('Ve√≠culo do agendamento n√£o encontrado na lista:', {
                                veiculoId,
                                tipoVeiculoId: typeof veiculoId,
                                veiculosDisponiveis: this.dados.veiculos.map(v => ({ id: v.id, tipo: typeof v.id }))
                            });
                            // Em vez de lan√ßar erro, permitir continuar mas avisar
                            console.warn('Ve√≠culo do agendamento n√£o encontrado, mas continuando com o or√ßamento...');
                            // N√£o lan√ßar erro, apenas avisar - o ve√≠culo pode estar em outro formato
                        }
                    }

                    // Coletar servi√ßos (nova estrutura)
                    const servicos = [];
                    const servicosLista = document.querySelectorAll('.servico-lista-item');
                    
                    servicosLista.forEach(item => {
                        const descricao = item.dataset.descricao || '';
                        const valor = parseFloat(item.dataset.valor) || 0;
                        if (descricao && valor > 0) {
                            servicos.push({
                                descricao: descricao,
                                quantidade: 1,
                                valor: valor
                            });
                        }
                    });

                    // Coletar pe√ßas (nova estrutura)
                    const pecas = [];
                    const pecasLista = document.querySelectorAll('.peca-lista-item');
                    
                    pecasLista.forEach(item => {
                        const itemNome = item.dataset.item || '';
                        const quantidade = parseInt(item.dataset.quantidade) || 0;
                        const valor = parseFloat(item.dataset.valor) || 0;
                        const valorTotal = parseFloat(item.dataset.valorTotal) || 0;
                        if (itemNome && quantidade > 0 && valor > 0) {
                            pecas.push({
                                item: itemNome,
                                quantidade: quantidade,
                                valor: valor,
                                valorTotal: valorTotal
                            });
                        }
                    });

                    if (servicos.length === 0 && pecas.length === 0) {
                        throw new Error('Adicione pelo menos um servi√ßo ou pe√ßa');
                    }

                    if (isEdit) {
                        const totalServicos = servicos.reduce((sum, s) => sum + (s.valor * s.quantidade), 0);
                        const totalPecas = pecas.reduce((sum, p) => sum + (p.valor * p.quantidade), 0);
                        const novoTotal = totalServicos + totalPecas;
                        
                        const orcamentoAtualizado = await this.atualizarOrcamentoServidor(editId, {
                            clienteId,
                            veiculoId,
                            agendamentoId,
                            servicos,
                            pecas,
                            observacoes,
                            validade,
                            total: novoTotal
                        });

                        this.atualizarTodosDados();
                        this.log(`Or√ßamento #${orcamentoAtualizado.numero} atualizado com sucesso!`, 'success');
                        
                        delete form.dataset.editId;
                        fecharModalOrcamento();
                        
                        if (state.currentOrcamentoId === editId) {
                            this.visualizarOrcamento(editId);
                        }
                        
                        return orcamentoAtualizado;
                    } else {
                        const novoOrcamento = await this.adicionarOrcamento({
                            clienteId, 
                            veiculoId, 
                            agendamentoId,
                            servicos, 
                            pecas,
                            observacoes, 
                            validade 
                        });
                        fecharModalOrcamento();
                        this.log('Or√ßamento gerado com sucesso!', 'success');
                        
                        this.atualizarTodosDados();
                        state.currentOrcamentoId = novoOrcamento.id;
                        this.visualizarOrcamento(novoOrcamento.id);
                        setTimeout(() => {
                            this.enviarWhatsApp();
                        }, 500);
                        
                        return novoOrcamento;
                    }

                } catch (error) {
                    this.log(`Erro ao gerar or√ßamento: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            sincronizarOSComOrcamento(orcamento) {
                // Buscar O.S. relacionada a este or√ßamento
                const os = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                if (!os) {
                    this.log(`Nenhuma O.S. encontrada para o or√ßamento #${orcamento.numero}`, 'info');
                    return;
                }
                
                // Sincronizar servi√ßos e pe√ßas da O.S. com o or√ßamento
                // Adicionar novos itens que n√£o existiam antes
                const servicosExistentes = new Set(os.servicos.map(s => s.descricao));
                const pecasExistentes = new Set(os.pecas.map(p => p.item));
                
                // Adicionar novos servi√ßos
                orcamento.servicos.forEach(servico => {
                    if (!servicosExistentes.has(servico.descricao)) {
                        os.servicos.push({
                            descricao: servico.descricao,
                            quantidade: servico.quantidade || 1
                        });
                    }
                });
                
                // Adicionar novas pe√ßas
                orcamento.pecas.forEach(peca => {
                    if (!pecasExistentes.has(peca.item)) {
                        os.pecas.push({
                            item: peca.item,
                            quantidade: peca.quantidade
                        });
                    }
                });
                
                // Atualizar observa√ß√µes se mudaram
                if (orcamento.observacoes !== os.observacoes) {
                    os.observacoes = orcamento.observacoes;
                }
                
                this.salvarDados('ordensServico');
                this.log(`O.S. #${os.numero} sincronizada com o or√ßamento #${orcamento.numero}`, 'success');
            }

            editarOrcamento(id) {
                const orcamento = this.dados.orcamentos.find(o => o.id === id);
                if (!orcamento) {
                    alert('Or√ßamento n√£o encontrado');
                    return;
                }
                
                // Verificar se pode editar (apenas pendentes podem ser editados)
                if (orcamento.status === 'aprovado') {
                    alert('Or√ßamentos aprovados n√£o podem ser editados para garantir a integridade e confian√ßa entre cliente e oficina.');
                    return;
                }
                
                if (orcamento.status === 'recusado') {
                    alert('Or√ßamentos recusados n√£o podem ser editados');
                    return;
                }
                
                // Preencher formul√°rio com dados do or√ßamento
                const form = document.getElementById('form-orcamento');
                form.dataset.editId = id;
                
                // Atualizar t√≠tulo do modal
                document.querySelector('#modal-orcamento .modal-title').textContent = `Editar Or√ßamento #${orcamento.numero}`;
                
                // Preencher campos b√°sicos
                document.getElementById('orcamento-cliente').value = orcamento.clienteId;
                document.getElementById('orcamento-agendamento').value = orcamento.agendamentoId || '';
                document.getElementById('orcamento-validade').value = orcamento.validade;
                document.getElementById('orcamento-observacoes').value = orcamento.observacoes || '';
                
                // Carregar agendamentos do cliente
                if (orcamento.clienteId) {
                    sistema.carregarAgendamentosClienteOrcamento(orcamento.clienteId);
                }
                
                // Limpar listas
                document.getElementById('servicos-lista-container').innerHTML = '';
                document.getElementById('pecas-lista-container').innerHTML = '';
                
                // Adicionar servi√ßos existentes
                if (orcamento.servicos && orcamento.servicos.length > 0) {
                    orcamento.servicos.forEach(servico => {
                        const servicoHTML = `
                            <div class="servico-lista-item" data-descricao="${servico.descricao}" data-valor="${servico.valor}">
                                <span>${servico.descricao}</span>
                                <span>R$ ${servico.valor.toFixed(2)}</span>
                                <button type="button" class="btn btn-sm btn-danger" onclick="sistema.removerServicoLista(this)">Remover</button>
                            </div>
                        `;
                        document.getElementById('servicos-lista-container').insertAdjacentHTML('beforeend', servicoHTML);
                    });
                }
                
                // Adicionar pe√ßas existentes
                if (orcamento.pecas && orcamento.pecas.length > 0) {
                    orcamento.pecas.forEach(peca => {
                        const pecaHTML = `
                            <div class="peca-lista-item" data-item="${peca.item}" data-quantidade="${peca.quantidade}" data-valor="${peca.valor}" data-valor-total="${peca.valor * peca.quantidade}">
                                <span>${peca.item}</span>
                                <span>${peca.quantidade}x</span>
                                <span>R$ ${peca.valor.toFixed(2)}</span>
                                <span>R$ ${(peca.valor * peca.quantidade).toFixed(2)}</span>
                                <button type="button" class="btn btn-sm btn-danger" onclick="sistema.removerPecaLista(this)">Remover</button>
                            </div>
                        `;
                        document.getElementById('pecas-lista-container').insertAdjacentHTML('beforeend', pecaHTML);
                    });
                }
                
                // Atualizar total
                this.atualizarTotalOrcamento();
                
                // Abrir modal
                abrirModalOrcamento();
            }

            visualizarOrcamento(id) {
                const orcamento = this.dados.orcamentos.find(o => o.id === id);
                if (!orcamento) {
                    this.log('Or√ßamento n√£o encontrado', 'error');
                    return;
                }

                const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                
                // Garantir lista atualizada
                this.reconstruirListaVeiculos();
                
                // Buscar ve√≠culo: primeiro tentar pelo veiculoId do or√ßamento, depois pelo agendamento
                let veiculo = null;
                if (orcamento.veiculoId) {
                    veiculo = this.buscarVeiculoPorId(orcamento.veiculoId);
                }
                
                // Se n√£o encontrou pelo veiculoId do or√ßamento, tentar pelo agendamento
                if (!veiculo && orcamento.agendamentoId) {
                    const agendamento = this.dados.agendamentos.find(a => a.id === orcamento.agendamentoId);
                    if (agendamento && agendamento.veiculoId) {
                        veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                        console.log('Ve√≠culo encontrado atrav√©s do agendamento:', {
                            agendamentoId: orcamento.agendamentoId,
                            veiculoId: agendamento.veiculoId,
                            veiculo: veiculo ? { id: veiculo.id, placa: veiculo.placa } : null
                        });
                    }
                }

                if (!cliente) {
                    this.log('Cliente do or√ßamento n√£o encontrado', 'error');
                    return;
                }

                if (!veiculo) {
                    console.warn('Ve√≠culo do or√ßamento n√£o encontrado. O ve√≠culo pode ter sido removido.', {
                        orcamentoVeiculoId: orcamento.veiculoId,
                        agendamentoId: orcamento.agendamentoId,
                        veiculosDisponiveis: this.dados.veiculos.map(v => ({ id: v.id, placa: v.placa }))
                    });
                }

                state.currentOrcamentoId = id;

                document.getElementById('orcamento-numero').textContent = orcamento.numero;

                // Mostrar/ocultar bot√µes de acordo com o status
                const btnAprovar = document.getElementById('btn-aprovar-orcamento');
                const btnRecusar = document.getElementById('btn-recusar-orcamento');
                const btnGerarOS = document.getElementById('btn-gerar-os-orcamento');
                
                if (orcamento.status === 'pendente') {
                    btnAprovar.style.display = 'inline-block';
                    btnRecusar.style.display = 'inline-block';
                    if (btnGerarOS) btnGerarOS.style.display = 'none';
                } else if (orcamento.status === 'aprovado') {
                    btnAprovar.style.display = 'none';
                    btnRecusar.style.display = 'none';
                    // Verificar se j√° existe O.S. para este or√ßamento
                    const osExistente = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                    if (btnGerarOS) {
                        if (osExistente) {
                            btnGerarOS.style.display = 'none';
                        } else {
                            btnGerarOS.style.display = 'inline-block';
                        }
                    }
                } else {
                    btnAprovar.style.display = 'none';
                    btnRecusar.style.display = 'none';
                    if (btnGerarOS) btnGerarOS.style.display = 'none';
                }
                
                const preview = document.getElementById('orcamento-preview');
                const statusBadge = orcamento.status === 'finalizado'
                    ? '<span class="badge badge-success" style="font-size: 16px; padding: 8px 15px;">FINALIZADO</span>'
                    : orcamento.status === 'em-servico' 
                    ? '<span class="badge badge-info" style="font-size: 16px; padding: 8px 15px;">EM SERVI√áO</span>'
                    : orcamento.status === 'aprovado' 
                    ? '<span class="badge badge-success" style="font-size: 16px; padding: 8px 15px;">APROVADO</span>'
                    : orcamento.status === 'recusado'
                    ? '<span class="badge badge-danger" style="font-size: 16px; padding: 8px 15px;">RECUSADO</span>'
                    : '<span class="badge badge-warning" style="font-size: 16px; padding: 8px 15px;">PENDENTE</span>';
                
                preview.innerHTML = `
                    <div class="orcamento-header">
                        <h2>OR√áAMENTO #${orcamento.numero}</h2>
                        <p>Data: ${new Date(orcamento.data).toLocaleDateString('pt-BR')}</p>
                        <p>Validade: ${new Date(new Date(orcamento.data).getTime() + orcamento.validade * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')}</p>
                        <p style="margin-top: 10px;">Status: ${statusBadge}</p>
                    </div>

                    <div class="orcamento-info">
                        <div>
                            <h4>Cliente</h4>
                            <p><strong>Nome:</strong> ${cliente.nome}</p>
                            <p><strong>WhatsApp:</strong> ${cliente.whatsapp}</p>
                        </div>
                        <div>
                            <h4>Ve√≠culo</h4>
                            ${veiculo ? `
                            <p><strong>Placa:</strong> ${veiculo.placa}</p>
                            <p><strong>Marca/Modelo:</strong> ${veiculo.marca} ${veiculo.modelo}</p>
                            <p><strong>Ano:</strong> ${veiculo.ano || 'N/A'}</p>
                            ` : `
                                <p style="color: #dc3545;"><strong>‚ö†Ô∏è Ve√≠culo n√£o encontrado</strong></p>
                                <p>O ve√≠culo pode ter sido removido do sistema.</p>
                            `}
                        </div>
                    </div>

                    ${orcamento.servicos && orcamento.servicos.length > 0 ? `
                    <div class="servicos-lista">
                        <h4>Servi√ßos Propostos</h4>
                        ${orcamento.servicos.map(servico => `
                            <div class="servico-linha">
                                <div class="servico-descricao">${servico.descricao}</div>
                                <div class="servico-quantidade">${servico.quantidade}x</div>
                                <div class="servico-valor">R$ ${servico.valor.toFixed(2)}</div>
                                <div class="servico-total">R$ ${(servico.quantidade * servico.valor).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${orcamento.pecas && orcamento.pecas.length > 0 ? `
                    <div class="servicos-lista" style="margin-top: 20px;">
                        <h4>Pe√ßas/Itens</h4>
                        ${orcamento.pecas.map(peca => `
                            <div class="servico-linha">
                                <div class="servico-descricao">${peca.item}</div>
                                <div class="servico-quantidade">${peca.quantidade}x</div>
                                <div class="servico-valor">R$ ${peca.valor.toFixed(2)}</div>
                                <div class="servico-total">R$ ${(peca.quantidade * peca.valor).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    <div class="total-geral">
                        <strong>TOTAL: R$ ${orcamento.total.toFixed(2)}</strong>
                    </div>

                    ${orcamento.observacoes ? `
                        <div class="observacoes">
                            <h4>Observa√ß√µes</h4>
                            <p>${orcamento.observacoes}</p>
                        </div>
                    ` : ''}

                    <div class="assinatura">
                        <p>_________________________________________</p>
                        <p>Assinatura do Cliente</p>
                    </div>
                `;

                abrirModalVisualizarOrcamento();
            }

            async aprovarOrcamento() {
                if (!state.currentOrcamentoId) return;
                
                const orcamento = this.dados.orcamentos.find(o => o.id === state.currentOrcamentoId);
                if (orcamento) {
                    const atualizado = await this.atualizarOrcamentoServidor(orcamento.id, { status: 'aprovado' });
                    // criar lan√ßamento financeiro pendente (receita) baseado no or√ßamento aprovado
                    this.criarLancamentoDeOrcamento(atualizado);
                    // Gerar Ordem de Servi√ßo automaticamente
                    await this.gerarOrdemServicoDoOrcamento(atualizado);
                    this.atualizarTodosDados();
                    this.log(`Or√ßamento #${atualizado.numero} aprovado e O.S. gerada`, 'success');
                    // Atualizar visualiza√ß√£o do or√ßamento
                    this.visualizarOrcamento(state.currentOrcamentoId);
                }
            }

            async criarLancamentoDeOrcamento(orcamento) {
                // Verificar se j√° existe uma transa√ß√£o (duplicata) para este or√ßamento
                const transacaoExistente = this.dados.transacoes.find(t => 
                    t.orcamentoId === orcamento.id && !t.parcelaDe
                );
                
                if (transacaoExistente) {
                    this.log(`J√° existe uma duplicata para o or√ßamento #${orcamento.numero}`, 'warning');
                    alert(`Este or√ßamento j√° possui uma duplicata no financeiro. N√£o √© poss√≠vel criar outra.`);
                    return;
                }
                
                // Marcar or√ßamento como convertido em duplicata
                orcamento.statusFinanceiro = 'duplicata';
                orcamento.dataDuplicata = new Date().toISOString().split('T')[0];
                await this.atualizarOrcamentoServidor(orcamento.id, {
                    statusFinanceiro: 'duplicata',
                    dataDuplicata: orcamento.dataDuplicata
                });
                
                // Criar duplicata pendente baseada no or√ßamento
                const dados = {
                    tipo: 'receita',
                    data: new Date().toISOString().split('T')[0],
                    descricao: `Duplicata #${orcamento.numero}`,
                    valor: orcamento.total,
                    status: 'pendente',
                    observacoes: `Duplicata gerada do or√ßamento #${orcamento.numero}`,
                    orcamentoId: orcamento.id,
                    clienteId: orcamento.clienteId,
                    isDuplicata: true,
                    numeroDuplicata: orcamento.numero
                };
                
                await this.adicionarTransacao(dados);
                this.log(`Duplicata criada para o or√ßamento #${orcamento.numero}`, 'success');
            }

            async recusarOrcamento() {
                if (!state.currentOrcamentoId) return;
                
                const orcamento = this.dados.orcamentos.find(o => o.id === state.currentOrcamentoId);
                if (orcamento) {
                    try {
                        await this.atualizarOrcamentoServidor(orcamento.id, { status: 'recusado' });
                    this.atualizarTodosDados();
                    this.log(`Or√ßamento #${orcamento.numero} recusado`, 'warning');
                    this.visualizarOrcamento(state.currentOrcamentoId);
                    } catch (error) {
                        this.log(`Erro ao recusar or√ßamento: ${error.message}`, 'error');
                        alert(error.message);
                    }
                }
            }

            async enviarWhatsApp() {
                if (!state.currentOrcamentoId) return;
                
                const orcamento = this.dados.orcamentos.find(o => o.id === state.currentOrcamentoId);
                if (!orcamento) return;
                
                const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                if (!cliente || !cliente.whatsapp) {
                    alert('Cliente n√£o possui WhatsApp cadastrado');
                    return;
                }
                
                // Garantir lista atualizada
                this.reconstruirListaVeiculos();
                
                // Buscar ve√≠culo: primeiro tentar pelo veiculoId do or√ßamento, depois pelo agendamento
                let veiculo = null;
                if (orcamento.veiculoId) {
                    veiculo = this.buscarVeiculoPorId(orcamento.veiculoId);
                }
                
                // Se n√£o encontrou pelo veiculoId do or√ßamento, tentar pelo agendamento
                if (!veiculo && orcamento.agendamentoId) {
                    const agendamento = this.dados.agendamentos.find(a => a.id === orcamento.agendamentoId);
                    if (agendamento && agendamento.veiculoId) {
                        veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                    }
                }
                
                const veiculoInfo = veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A';
                
                // Montar mensagem
                const statusTexto = orcamento.status === 'aprovado' ? 'APROVADO' 
                    : orcamento.status === 'recusado' ? 'RECUSADO'
                    : orcamento.status === 'em-servico' ? 'EM SERVI√áO'
                    : orcamento.status === 'finalizado' ? 'FINALIZADO'
                    : 'PENDENTE';
                
                let mensagem = `*OR√áAMENTO #${orcamento.numero}*\n`;
                mensagem += `*Status: ${statusTexto}*\n\n`;
                mensagem += `Ol√° ${cliente.nome}!\n\n`;
                mensagem += `Segue o or√ßamento para o ve√≠culo: ${veiculoInfo}\n\n`;
                
                if (orcamento.servicos && orcamento.servicos.length > 0) {
                    mensagem += `*SERVI√áOS:*\n`;
                    orcamento.servicos.forEach(servico => {
                        const quantidade = servico.quantidade || 1;
                        const valorUnitario = servico.valor || 0;
                        const valorTotal = valorUnitario * quantidade;
                        if (quantidade > 1) {
                            mensagem += `‚Ä¢ ${servico.descricao} - ${quantidade}x - R$ ${valorUnitario.toFixed(2)} = R$ ${valorTotal.toFixed(2)}\n`;
                        } else {
                            mensagem += `‚Ä¢ ${servico.descricao} - R$ ${valorUnitario.toFixed(2)}\n`;
                        }
                    });
                    mensagem += `\n`;
                }
                
                if (orcamento.pecas && orcamento.pecas.length > 0) {
                    mensagem += `*PE√áAS/ITENS:*\n`;
                    orcamento.pecas.forEach(peca => {
                        mensagem += `‚Ä¢ ${peca.item} - ${peca.quantidade}x - R$ ${peca.valor.toFixed(2)} = R$ ${peca.valorTotal.toFixed(2)}\n`;
                    });
                    mensagem += `\n`;
                }
                
                mensagem += `*TOTAL: R$ ${orcamento.total.toFixed(2)}*\n\n`;
                mensagem += `Validade: ${new Date(new Date(orcamento.data).getTime() + orcamento.validade * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')}\n\n`;
                
                if (orcamento.observacoes) {
                    mensagem += `Observa√ß√µes: ${orcamento.observacoes}\n\n`;
                }
                
                mensagem += `Aguardamos sua aprova√ß√£o!`;
                
                // Remover caracteres especiais do WhatsApp
                const whatsappLimpo = cliente.whatsapp.replace(/\D/g, '');
                const mensagemEncoded = encodeURIComponent(mensagem);
                
                // Tentar abrir app nativo com fallback para web
                openWhatsAppFallback(whatsappLimpo, mensagem);
            }

            async excluirOrcamento(id) {
                const orcamento = this.dados.orcamentos.find(o => o.id === id);
                if (!orcamento) return;

                // Impedir exclus√£o se o or√ßamento estiver aprovado, em servi√ßo ou finalizado
                if (orcamento.status === 'aprovado' || orcamento.status === 'em-servico' || orcamento.status === 'finalizado') {
                    alert('N√£o √© poss√≠vel excluir um or√ßamento que est√° aprovado, em servi√ßo ou finalizado.');
                    return;
                }

                // Se o or√ßamento estiver confirmado no financeiro, sempre solicitar PIN
                if (orcamento.statusFinanceiro === 'liquidado') {
                    const pinValido = await this.verificarPIN();
                    if (!pinValido) {
                        return;
                    }
                } else {
                    if (!confirm('Deseja realmente excluir este or√ßamento?')) {
                        return;
                    }
                }

                // Verificar se h√° transa√ß√µes vinculadas
                const transacoesVinculadas = this.dados.transacoes.filter(t => t.orcamentoId === id);
                if (transacoesVinculadas.length > 0) {
                    if (!confirm(`Este or√ßamento possui ${transacoesVinculadas.length} transa√ß√£o(√µes) vinculada(s). Deseja excluir mesmo assim?`)) {
                        return;
                    }
                }

                try {
                    await this.apiRequest(`/orcamentos/${id}`, { method: 'DELETE' });
                this.dados.orcamentos = this.dados.orcamentos.filter(o => o.id !== id);
                this.salvarDados('orcamentos');
                this.atualizarTodosDados();
                this.log('Or√ßamento exclu√≠do com sucesso', 'warning');
                } catch (error) {
                    this.log(`Erro ao excluir or√ßamento: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            imprimirOrcamento() {
                const preview = document.getElementById('orcamento-preview').innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Or√ßamento NegoCar</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .orcamento-header { background: #2c3e50; color: white; padding: 20px; border-radius: 10px; }
                            .servico-linha { display: flex; justify-content: space-between; margin: 5px 0; }
                            .total-geral { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }
                            .assinatura { margin-top: 50px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        ${preview}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            }

            carregarVeiculosCliente(clienteId) {
                const select = document.getElementById('agendamento-veiculo');
                if (!select) {
                    console.error('Select de ve√≠culo n√£o encontrado');
                    return;
                }
                
                select.innerHTML = '<option value="">Selecione um ve√≠culo</option>';
                
                if (!clienteId || clienteId === '' || clienteId === '0') {
                    return;
                }
                
                const clienteIdNum = parseInt(clienteId);
                if (Number.isNaN(clienteIdNum)) {
                    console.error('ID de cliente inv√°lido:', clienteId);
                    return;
                }
                
                // Garantir que a lista de ve√≠culos est√° atualizada
                this.reconstruirListaVeiculos();
                
                const veiculos = this.dados.veiculos.filter(v => {
                    const vClienteId = parseInt(v.clienteId);
                    return !Number.isNaN(vClienteId) && vClienteId === clienteIdNum && v.ativo !== false;
                });
                
                if (veiculos.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhum ve√≠culo cadastrado';
                    option.disabled = true;
                    select.appendChild(option);
                    return;
                }
                
                veiculos.forEach(veiculo => {
                    const option = document.createElement('option');
                    // Garantir que o valor seja uma string e que o ID exista
                    if (!veiculo.id && veiculo.id !== 0) {
                        console.warn('Ve√≠culo sem ID:', veiculo);
                        return; // Pular ve√≠culos sem ID
                    }
                    // Usar o ID do ve√≠culo (pode ser n√∫mero ou string)
                    option.value = String(veiculo.id);
                    option.textContent = `${veiculo.placa || 'N/A'} - ${veiculo.marca || ''} ${veiculo.modelo || ''}`.trim();
                    option.dataset.veiculoId = veiculo.id; // Armazenar tamb√©m no dataset para refer√™ncia
                    select.appendChild(option);
                });
                
                console.log('Ve√≠culos carregados no select:', veiculos.length, veiculos.map(v => ({ id: v.id, placa: v.placa })));
            }

            filtrarClientesAgendamento(termo) {
                const lista = document.getElementById('agendamento-cliente-lista');
                const searchInput = document.getElementById('agendamento-cliente-search');
                
                console.log('Filtrando clientes:', termo, 'Total de clientes:', state.dados.clientes.length);
                
                if (!termo || termo.trim().length < 1) {
                    lista.style.display = 'none';
                    return;
                }

                const termoLower = termo.toLowerCase();
                const clientesFiltrados = state.dados.clientes.filter(c => 
                    (c.nome && c.nome.toLowerCase().includes(termoLower)) ||
                    (c.telefone && c.telefone.includes(termo))
                ).slice(0, 15); // Limitar a 15 resultados
                
                console.log('Clientes filtrados:', clientesFiltrados.length);

                if (clientesFiltrados.length === 0) {
                    lista.innerHTML = '<div style="padding: 10px; color: #999;">Nenhum cliente encontrado</div>';
                    lista.style.display = 'block';
                    return;
                }

                lista.innerHTML = clientesFiltrados.map(cliente => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;"
                         onmouseover="this.style.backgroundColor = '#f5f5f5';"
                         onmouseout="this.style.backgroundColor = 'transparent';"
                         onclick="sistema.selecionarClienteAgendamento(${cliente.id}, '${cliente.nome.replace(/'/g, "\\'")}', '${cliente.telefone || ''}')">
                        <div style="font-weight: bold;">${cliente.nome}</div>
                        <div style="font-size: 12px; color: #666;">
                            ${cliente.telefone ? 'üì± ' + cliente.telefone : ''}
                            ${cliente.email ? 'üìß ' + cliente.email : ''}
                        </div>
                    </div>
                `).join('');
                
                lista.style.display = 'block';
            }

            selecionarClienteAgendamento(clienteId, clienteNome, clienteTelefone) {
                // Atualizar o select hidden com o valor
                document.getElementById('agendamento-cliente').value = clienteId;
                
                // Desabilitar e limpar o input de busca
                const searchInput = document.getElementById('agendamento-cliente-search');
                searchInput.value = '';
                searchInput.disabled = true;
                searchInput.style.opacity = '0.6';
                searchInput.style.cursor = 'not-allowed';
                searchInput.placeholder = 'Cliente selecionado - clique o X para mudar';
                
                // Mostrar badge com cliente selecionado
                const badge = document.getElementById('cliente-selecionado-badge');
                document.getElementById('cliente-selecionado-nome').textContent = clienteNome;
                badge.style.display = 'block';
                
                // Fechar a lista
                document.getElementById('agendamento-cliente-lista').style.display = 'none';
                
                // Carregar ve√≠culos do cliente
                this.carregarVeiculosCliente(clienteId);
                
                console.log('Cliente selecionado:', clienteId, clienteNome);
            }

            limparClienteSelecionado() {
                const searchInput = document.getElementById('agendamento-cliente-search');
                
                document.getElementById('agendamento-cliente').value = '';
                searchInput.value = '';
                searchInput.disabled = false;
                searchInput.style.opacity = '1';
                searchInput.style.cursor = 'text';
                searchInput.placeholder = 'Digite o nome ou telefone do cliente...';
                document.getElementById('cliente-selecionado-badge').style.display = 'none';
                document.getElementById('agendamento-veiculo').innerHTML = '<option value="">Selecione um ve√≠culo</option>';
                searchInput.focus();
            }

            carregarAgendamentosClienteOrcamento(clienteId) {
                const select = document.getElementById('orcamento-agendamento');
                select.innerHTML = '<option value="">Selecione um agendamento</option>';
                
                if (!clienteId) {
                    document.getElementById('orcamento-veiculo-info').style.display = 'none';
                    return;
                }
                
                // Buscar apenas agendamentos n√£o finalizados do cliente
                const agendamentos = this.dados.agendamentos.filter(a => 
                    a.clienteId === parseInt(clienteId) && 
                    a.status !== 'finalizado' && 
                    a.status !== 'concluido'
                );
                
                if (agendamentos.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhum agendamento dispon√≠vel';
                    select.appendChild(option);
                    document.getElementById('orcamento-veiculo-info').style.display = 'none';
                    return;
                }
                
                agendamentos.forEach(agendamento => {
                    const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                    const dataHora = agendamento.data 
                        ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                          (agendamento.hora ? ' ' + agendamento.hora.substring(0, 5) : '')
                        : '-';
                    const veiculoInfo = veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A';
                    
                    const option = document.createElement('option');
                    option.value = agendamento.id;
                    option.textContent = `${dataHora} - ${veiculoInfo} - ${agendamento.problema || 'Sem descri√ß√£o'}`;
                    select.appendChild(option);
                });
            }

            carregarDadosAgendamentoOrcamento(agendamentoId) {
                if (!agendamentoId) {
                    document.getElementById('orcamento-veiculo-info').style.display = 'none';
                    return;
                }
                
                const agendamento = this.dados.agendamentos.find(a => a.id === parseInt(agendamentoId));
                if (!agendamento) {
                    document.getElementById('orcamento-veiculo-info').style.display = 'none';
                    return;
                }
                
                const veiculo = this.dados.veiculos.find(v => v.id === agendamento.veiculoId);
                if (veiculo) {
                    document.getElementById('orcamento-veiculo-display').value = 
                        `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo} (${veiculo.ano || 'N/A'})`;
                    document.getElementById('orcamento-veiculo-info').style.display = 'block';
                }
                
                // Preencher observa√ß√µes com o problema do agendamento se estiver vazio
                const observacoes = document.getElementById('orcamento-observacoes');
                if (!observacoes.value.trim() && agendamento.problema) {
                    observacoes.value = `Problema relatado: ${agendamento.problema}\n${agendamento.observacoes || ''}`;
                }
            }

            async salvarAgendamento() {
                try {
                    const form = document.getElementById('form-agendamento');
                    const editId = form.dataset.editId ? parseInt(form.dataset.editId) : null;
                    const isEditing = !!editId;

                    const clienteSelect = document.getElementById('agendamento-cliente');
                    const veiculoSelect = document.getElementById('agendamento-veiculo');
                    
                    if (!clienteSelect) throw new Error('Campo cliente n√£o encontrado');
                    if (!veiculoSelect) throw new Error('Campo ve√≠culo n√£o encontrado');
                    
                    const clienteIdRaw = clienteSelect.value;
                    const veiculoIdRaw = veiculoSelect.value;
                    const data = document.getElementById('agendamento-data').value;
                    const hora = document.getElementById('agendamento-hora').value;
                    
                    // Capturar e validar problema
                    const problemaElement = document.getElementById('agendamento-problema');
                    if (!problemaElement) {
                        throw new Error('Campo "Problema Relatado" n√£o encontrado no formul√°rio');
                    }
                    const problema = problemaElement.value.trim();
                    if (!problema || problema === '') {
                        throw new Error('Problema relatado √© obrigat√≥rio');
                    }
                    
                    const observacoes = document.getElementById('agendamento-observacoes').value.trim();

                    // Validar cliente
                    if (!clienteIdRaw || clienteIdRaw.trim() === '' || clienteIdRaw === '0') {
                        throw new Error('Selecione um cliente');
                    }
                    const clienteId = parseInt(clienteIdRaw);
                    if (Number.isNaN(clienteId) || clienteId <= 0) {
                        throw new Error('Cliente inv√°lido');
                    }

                    // Validar ve√≠culo - IDs podem ser n√∫meros ou strings
                    let veiculoId = null;
                    
                    // Primeiro, tentar pegar o valor diretamente do select
                    const veiculoIdValue = veiculoSelect.value;
                    if (veiculoIdValue && veiculoIdValue.trim() !== '' && veiculoIdValue !== '0') {
                        const veiculoIdTrimmed = veiculoIdValue.trim();
                        // Tentar como n√∫mero primeiro
                        const veiculoIdNum = parseInt(veiculoIdTrimmed);
                        if (!Number.isNaN(veiculoIdNum) && veiculoIdNum > 0) {
                            veiculoId = veiculoIdNum;
                        } else {
                            // Se n√£o for n√∫mero, aceitar como string (pode ser ID customizado)
                            veiculoId = veiculoIdTrimmed;
                        }
                    }
                    
                    // Se ainda n√£o tem veiculoId v√°lido, tentar da op√ß√£o selecionada
                    if (!veiculoId && veiculoSelect.selectedIndex > 0) {
                        const selectedOption = veiculoSelect.options[veiculoSelect.selectedIndex];
                        if (selectedOption && selectedOption.value && selectedOption.value.trim() !== '' && selectedOption.value !== '0') {
                            const veiculoIdValue = selectedOption.value.trim();
                            const veiculoIdNum = parseInt(veiculoIdValue);
                            if (!Number.isNaN(veiculoIdNum) && veiculoIdNum > 0) {
                                veiculoId = veiculoIdNum;
                            } else {
                                veiculoId = veiculoIdValue;
                            }
                        }
                    }
                    
                    // Se ainda n√£o tem veiculoId v√°lido, tentar do veiculoIdRaw
                    if (!veiculoId && veiculoIdRaw && veiculoIdRaw.trim() !== '' && veiculoIdRaw !== '0') {
                        const veiculoIdValue = veiculoIdRaw.trim();
                        const veiculoIdNum = parseInt(veiculoIdValue);
                        if (!Number.isNaN(veiculoIdNum) && veiculoIdNum > 0) {
                            veiculoId = veiculoIdNum;
                        } else {
                            veiculoId = veiculoIdValue;
                        }
                    }
                    
                    // Se ainda n√£o tem veiculoId v√°lido, lan√ßar erro
                    if (!veiculoId || veiculoId === '0' || veiculoId === '') {
                        console.error('Erro na valida√ß√£o do ve√≠culo:', {
                            veiculoIdRaw,
                            veiculoSelectValue: veiculoSelect.value,
                            selectedIndex: veiculoSelect.selectedIndex,
                            selectedOption: veiculoSelect.selectedIndex > 0 ? veiculoSelect.options[veiculoSelect.selectedIndex] : null,
                            todasOpcoes: Array.from(veiculoSelect.options).map(opt => ({ value: opt.value, text: opt.text, selected: opt.selected }))
                        });
                        throw new Error('Selecione um ve√≠culo v√°lido');
                    }
                    
                    console.log('Ve√≠culo selecionado:', {
                        veiculoId,
                        tipo: typeof veiculoId,
                        veiculoSelectValue: veiculoSelect.value
                    });

                    if (!data) throw new Error('Data √© obrigat√≥ria');
                    // Problema j√° foi validado acima

                    if (isEditing) {
                        // Garantir que veiculoId est√° sendo enviado na atualiza√ß√£o
                        console.log('Atualizando agendamento:', {
                            editId,
                            veiculoId,
                            tipoVeiculoId: typeof veiculoId
                        });
                        
                        await this.atualizarAgendamentoServidor(editId, {
                            clienteId,
                            veiculoId: veiculoId || null, // Garantir que sempre tem um valor
                            data,
                            hora: hora || '',
                            problema,
                            observacoes: observacoes || ''
                        });

                        this.atualizarAgendamentos();
                        this.atualizarAgendamentosRecentes();
                        fecharModalAgendamento();
                        delete form.dataset.editId;
                        this.log('Agendamento atualizado com sucesso!', 'success');
                        return true;
                    } else {
                        // Validar veiculoId antes de criar payload
                        if (!veiculoId || veiculoId === '0' || veiculoId === '') {
                            throw new Error('Ve√≠culo √© obrigat√≥rio. Selecione um ve√≠culo v√°lido.');
                        }

                        console.log('Criando agendamento com dados:', {
                            clienteId,
                            veiculoId,
                            tipoVeiculoId: typeof veiculoId,
                            data,
                            problema
                        });

                        const numeroAgendamento = this.gerarProximoNumeroAgendamento();
                        const payload = this.criarPayloadAgendamento({
                            clienteId,
                            veiculoId: veiculoId, // Garantir que est√° sendo passado
                            numero: numeroAgendamento,
                            data,
                            hora: hora || '',
                            problema,
                            observacoes: observacoes || '',
                            status: 'pendente',
                            whatsappEnviado: false,
                            lembreteEnviado: false,
                            dataFinalizacao: null
                        });

                        console.log('Payload do agendamento:', payload);

                        const criado = await this.apiRequest('/agendamentos', { method: 'POST', data: payload });
                        console.log('Agendamento criado no servidor:', criado);
                        console.log('VeiculoId enviado no payload:', veiculoId);
                        
                        const agendamentoNormalizado = this.normalizarAgendamento(criado);
                        console.log('Agendamento normalizado:', agendamentoNormalizado);
                        console.log('VeiculoId no agendamento normalizado:', agendamentoNormalizado?.veiculoId);
                        
                        // Garantir que o veiculoId est√° preservado ap√≥s normaliza√ß√£o
                        if (agendamentoNormalizado && (!agendamentoNormalizado.veiculoId || agendamentoNormalizado.veiculoId === null) && veiculoId) {
                            console.log('Restaurando veiculoId no agendamento normalizado:', veiculoId);
                            agendamentoNormalizado.veiculoId = veiculoId;
                        }
                        
                        if (agendamentoNormalizado) {
                            this.dados.agendamentos.push(agendamentoNormalizado);
                            this.salvarDados('agendamentos');
                        }
                        
                        this.atualizarAgendamentos();
                        this.atualizarAgendamentosRecentes();
                        fecharModalAgendamento();
                        delete form.dataset.editId;
                        this.log('Agendamento salvo com sucesso!', 'success');

                        // Aguardar um pouco para garantir que o agendamento foi adicionado ao array e dados sincronizados
                        if (agendamentoNormalizado?.id) {
                            setTimeout(() => {
                                // Garantir que ve√≠culos est√£o atualizados
                                this.reconstruirListaVeiculos();
                                
                                // Verificar se o agendamento existe antes de enviar
                                const agendamentoParaWhatsApp = this.dados.agendamentos.find(a => a.id === agendamentoNormalizado.id);
                                if (agendamentoParaWhatsApp) {
                                    // Verificar se cliente e ve√≠culo existem antes de tentar enviar
                                    const clienteExiste = this.dados.clientes.find(c => c.id === agendamentoParaWhatsApp.clienteId);
                                    const veiculoExiste = this.buscarVeiculoPorId(agendamentoParaWhatsApp.veiculoId);
                                    
                                    if (clienteExiste && veiculoExiste) {
                                        this.enviarWhatsAppAgendamento(agendamentoNormalizado.id);
                                    } else {
                                        console.warn('Dados incompletos para enviar WhatsApp ap√≥s salvar agendamento:', {
                                            agendamentoId: agendamentoNormalizado.id,
                                            clienteExiste: !!clienteExiste,
                                            veiculoExiste: !!veiculoExiste,
                                            clienteId: agendamentoParaWhatsApp.clienteId,
                                            veiculoId: agendamentoParaWhatsApp.veiculoId
                                        });
                                        // N√£o mostrar alerta aqui, apenas log - o agendamento foi salvo com sucesso
                                    }
                                } else {
                                    console.warn('Agendamento n√£o encontrado para enviar WhatsApp:', agendamentoNormalizado.id);
                                }
                            }, 500);
                        }

                        return agendamentoNormalizado;
                    }
                } catch (error) {
                    console.error('Erro ao salvar agendamento:', error);
                    this.log(`Erro ao salvar agendamento: ${error.message}`, 'error');
                    alert(`Erro ao salvar agendamento: ${error.message}`);
                    return false;
                }
            }

            atualizarTodosDados() {
                this.atualizarDashboard();
                this.atualizarClientes();
                this.atualizarVeiculos();
                this.aplicarFiltroOrcamento('pendentes');
                this.atualizarOrcamentos();
                this.aplicarFiltroAgendamento('pendente');
                this.atualizarAgendamentos();
                this.aplicarFiltroOS('pendente');
                this.atualizarOrdensServico();
                this.atualizarServicos();
                this.atualizarFinanceiro(); // <-- adicionado
            }

            atualizarDashboard() {
                // Atualizar cards
                const orcamentosPendentes = this.dados.orcamentos.filter(o => o.status === 'pendente');
                const orcamentosAprovados = this.dados.orcamentos.filter(o => o.status === 'aprovado');
                const agendamentosPendentes = this.dados.agendamentos.filter(a => a.status === 'pendente');
                const agendamentosEmServico = this.dados.agendamentos.filter(a => a.status === 'em-servico');
                
                document.getElementById('orcamentos-pendentes-dash').textContent = orcamentosPendentes.length;
                document.getElementById('orcamentos-aprovados-dash').textContent = orcamentosAprovados.length;
                document.getElementById('agendamentos-pendentes-dash').textContent = agendamentosPendentes.length;
                document.getElementById('agendamentos-em-servico-dash').textContent = agendamentosEmServico.length;
                
                // Atualizar tabela de or√ßamentos pendentes
                const tbodyPendentes = document.getElementById('orcamentos-pendentes-table-dash');
                if (tbodyPendentes) {
                    if (orcamentosPendentes.length === 0) {
                        tbodyPendentes.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum or√ßamento pendente</td></tr>';
                    } else {
                        tbodyPendentes.innerHTML = orcamentosPendentes.slice(0, 10).map(orcamento => {
                            const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                            const veiculo = this.dados.veiculos.find(v => v.id === orcamento.veiculoId);
                            return `
                                <tr onclick="sistema.visualizarOrcamento(${orcamento.id})" style="cursor: pointer;">
                                    <td>#${orcamento.numero}</td>
                                    <td>${cliente?.nome || 'N/A'}</td>
                                    <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                                    <td>R$ ${orcamento.total.toFixed(2)}</td>
                                    <td>${new Date(orcamento.data).toLocaleDateString('pt-BR')}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Atualizar tabela de or√ßamentos aprovados
                const tbodyAprovados = document.getElementById('orcamentos-aprovados-table-dash');
                if (tbodyAprovados) {
                    if (orcamentosAprovados.length === 0) {
                        tbodyAprovados.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum or√ßamento aprovado</td></tr>';
                    } else {
                        tbodyAprovados.innerHTML = orcamentosAprovados.slice(0, 10).map(orcamento => {
                            const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                            const veiculo = this.dados.veiculos.find(v => v.id === orcamento.veiculoId);
                            return `
                                <tr onclick="sistema.visualizarOrcamento(${orcamento.id})" style="cursor: pointer;">
                                    <td>#${orcamento.numero}</td>
                                    <td>${cliente?.nome || 'N/A'}</td>
                                    <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                                    <td>R$ ${orcamento.total.toFixed(2)}</td>
                                    <td>${new Date(orcamento.data).toLocaleDateString('pt-BR')}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Atualizar tabela de agendamentos pendentes
                const tbodyAgendPendentes = document.getElementById('agendamentos-pendentes-table-dash');
                if (tbodyAgendPendentes) {
                    if (agendamentosPendentes.length === 0) {
                        tbodyAgendPendentes.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum agendamento pendente</td></tr>';
                    } else {
                        tbodyAgendPendentes.innerHTML = agendamentosPendentes.slice(0, 10).map(agendamento => {
                            const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                            const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                            const dataHora = agendamento.data 
                                ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                                  (agendamento.hora ? ' ' + agendamento.hora.substring(0, 5) : '')
                                : '-';
                            return `
                                <tr onclick="sistema.visualizarAgendamento(${agendamento.id})" style="cursor: pointer;">
                                    <td>${dataHora}</td>
                                    <td>${cliente?.nome || 'N/A'}</td>
                                    <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                                    <td>${agendamento.problema || '-'}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Atualizar tabela de agendamentos em servi√ßo
                const tbodyAgendServico = document.getElementById('agendamentos-em-servico-table-dash');
                if (tbodyAgendServico) {
                    if (agendamentosEmServico.length === 0) {
                        tbodyAgendServico.innerHTML = '<tr><td colspan="4" class="text-center">Nenhum agendamento em servi√ßo</td></tr>';
                    } else {
                        tbodyAgendServico.innerHTML = agendamentosEmServico.slice(0, 10).map(agendamento => {
                            const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                            const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                            const dataHora = agendamento.data 
                                ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                                  (agendamento.hora ? ' ' + agendamento.hora.substring(0, 5) : '')
                                : '-';
                            return `
                                <tr onclick="sistema.visualizarAgendamento(${agendamento.id})" style="cursor: pointer;">
                                    <td>${dataHora}</td>
                                    <td>${cliente?.nome || 'N/A'}</td>
                                    <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                                    <td>${agendamento.problema || '-'}</td>
                                </tr>
                            `;
                        }).join('');
                    }
                }
                
                // Verificar avisos de parcelas
                this.verificarAvisosParcelas();
            }

            verificarAvisosParcelas() {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const amanha = new Date(hoje);
                amanha.setDate(hoje.getDate() + 1);

                const parcelasVencendo = this.dados.transacoes.filter(t => {
                    if (t.status !== 'pendente' || !t.data) return false;
                    const dataVencimento = new Date(t.data);
                    dataVencimento.setHours(0, 0, 0, 0);
                    return dataVencimento.getTime() === amanha.getTime();
                });

                if (parcelasVencendo.length > 0) {
                    const total = parcelasVencendo.reduce((sum, t) => sum + t.valor, 0);
                    const avisoHTML = `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Aviso: Parcelas Vencendo Amanh√£</h4>
                            <p style="margin: 0; color: #856404;">
                                ${parcelasVencendo.length} parcela(s) vence(m) amanh√£. Total: R$ ${total.toFixed(2)}
                            </p>
                        </div>
                    `;
                    const dashboard = document.getElementById('dashboard');
                    const existingAviso = dashboard.querySelector('.aviso-parcelas');
                    if (existingAviso) {
                        existingAviso.remove();
                    }
                    const avisoDiv = document.createElement('div');
                    avisoDiv.className = 'aviso-parcelas';
                    avisoDiv.innerHTML = avisoHTML;
                    dashboard.insertBefore(avisoDiv, dashboard.firstChild);
                } else {
                    const existingAviso = document.querySelector('.aviso-parcelas');
                    if (existingAviso) {
                        existingAviso.remove();
                    }
                }
            }
            
            atualizarAgendamentosRecentes() {
                const tbody = document.getElementById('agendamentos-recentes');
                if (!tbody) return;
                
                // Filtrar apenas agendamentos n√£o finalizados e ordenar por data mais recente
                const agendamentosRecentes = this.dados.agendamentos
                    .filter(a => a.status !== 'finalizado' && a.status !== 'concluido')
                    .sort((a, b) => {
                        const dataA = new Date(a.data + ' ' + (a.hora || '00:00'));
                        const dataB = new Date(b.data + ' ' + (b.hora || '00:00'));
                        return dataB - dataA; // Mais recentes primeiro
                    })
                    .slice(0, 10); // Limitar a 10 mais recentes
                
                if (agendamentosRecentes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum agendamento recente</td></tr>';
                    return;
                }
                
                tbody.innerHTML = agendamentosRecentes.map(agendamento => {
                    const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                    const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                    
                    const dataHora = agendamento.data 
                        ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                          (agendamento.hora ? ' ' + agendamento.hora.substring(0, 5) : '')
                        : '-';
                    
                    let statusBadge = 'badge-info';
                    if (agendamento.status === 'agendado') statusBadge = 'badge-success';
                    if (agendamento.status === 'cancelado') statusBadge = 'badge-danger';
                    if (agendamento.status === 'concluido' || agendamento.status === 'finalizado') statusBadge = 'badge-secondary';
                    
                    return `
                        <tr>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>${agendamento.problema || '-'}</td>
                            <td>${dataHora}</td>
                            <td><span class="badge ${statusBadge}">${agendamento.status || 'agendado'}</span></td>
                        </tr>
                    `;
                }).join('');
            }

            atualizarClientes() {
                const selectCliente = document.getElementById('agendamento-cliente');
                const selectClienteOrcamento = document.getElementById('orcamento-cliente');
                const selectVeiculoCliente = document.getElementById('veiculo-cliente');
                
                // Limpar selects
                [selectCliente, selectClienteOrcamento, selectVeiculoCliente].forEach(select => {
                    select.innerHTML = '<option value="">Selecione um cliente</option>';
                });

                // Popular selects
                this.dados.clientes.forEach(cliente => {
                    [selectCliente, selectClienteOrcamento, selectVeiculoCliente].forEach(select => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = cliente.nome;
                        select.appendChild(option);
                    });
                });

                // Atualizar tabela de clientes
                const tbody = document.getElementById('clientes-table');
                tbody.innerHTML = this.dados.clientes.map(cliente => {
                    // Contar ve√≠culos do cliente no array global de ve√≠culos
                    const veiculosCount = this.dados.veiculos.filter(v => v.clienteId === cliente.id).length;
                    
                    return `
                        <tr onclick="sistema.selectRow('clientes', ${cliente.id}, this)" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${cliente.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('clientes', ${cliente.id})"></td>
                            <td><a href="#" onclick="sistema.verDetalhesCliente(${cliente.id}); return false; event.stopPropagation();" style="color: var(--primary-color); text-decoration: underline; cursor: pointer;">${cliente.nome}</a></td>
                            <td>${cliente.whatsapp}</td>
                            <td>${veiculosCount} ve√≠culo(s)</td>
                            <td>-</td>
                        </tr>
                    `;
                }).join('');
                // Limpar sele√ß√£o ap√≥s atualizar
                this.updateUniversalButtons('clientes');
                
                // Manter busca se houver termo
                const buscaInput = document.getElementById('busca-clientes');
                if (buscaInput && buscaInput.value.trim()) {
                    this.filtrarClientes(buscaInput.value);
                }
            }

            verDetalhesCliente(id) {
                const cliente = this.dados.clientes.find(c => c.id === id);
                if (!cliente) return;

                // Buscar hist√≥rico do cliente
                const veiculos = this.dados.veiculos.filter(v => v.clienteId === id);
                const agendamentos = this.dados.agendamentos.filter(a => a.clienteId === id);
                const orcamentos = this.dados.orcamentos.filter(o => o.clienteId === id);
                const transacoes = this.dados.transacoes.filter(t => t.clienteId === id);

                // Criar modal de detalhes
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-detalhes-cliente';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">Detalhes do Cliente: ${cliente.nome}</h3>
                            <div class="modal-actions">
                                <button class="minimize" onclick="minimizarModal('modal-detalhes-cliente')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-detalhes-cliente').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 30px;">
                                <h4>Informa√ß√µes do Cliente</h4>
                                <p><strong>Nome:</strong> ${cliente.nome}</p>
                                <p><strong>WhatsApp:</strong> ${cliente.whatsapp || 'N√£o informado'}</p>
                                ${cliente.endereco ? `
                                    <p><strong>Endere√ßo:</strong> ${cliente.endereco.logradouro || ''}, ${cliente.endereco.numero || ''} - ${cliente.endereco.bairro || ''}, ${cliente.endereco.cidade || ''} - ${cliente.endereco.estado || ''}</p>
                                ` : ''}
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h4>Ve√≠culos (${veiculos.length})</h4>
                                ${veiculos.length > 0 ? `
                                    <table style="width: 100%; margin-top: 10px;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 10px; text-align: left;">Placa</th>
                                                <th style="padding: 10px; text-align: left;">Marca/Modelo</th>
                                                <th style="padding: 10px; text-align: left;">Ano</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${veiculos.map(v => `
                                                <tr>
                                                    <td style="padding: 8px;">${v.placa}</td>
                                                    <td style="padding: 8px;">${v.marca} ${v.modelo}</td>
                                                    <td style="padding: 8px;">${v.ano || 'N/A'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p>Nenhum ve√≠culo cadastrado</p>'}
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h4>Agendamentos (${agendamentos.length})</h4>
                                ${agendamentos.length > 0 ? `
                                    <table style="width: 100%; margin-top: 10px;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 10px; text-align: left;">Data/Hora</th>
                                                <th style="padding: 10px; text-align: left;">Problema</th>
                                                <th style="padding: 10px; text-align: left;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${agendamentos.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 10).map(a => {
                                                const veiculo = this.dados.veiculos.find(v => v.id === a.veiculoId);
                                                const dataHora = a.data ? new Date(a.data).toLocaleDateString('pt-BR') + (a.hora ? ' ' + a.hora.substring(0, 5) : '') : '-';
                                                return `
                                                    <tr>
                                                        <td style="padding: 8px;">${dataHora}</td>
                                                        <td style="padding: 8px;">${a.problema || '-'}</td>
                                                        <td style="padding: 8px;"><span class="badge badge-${a.status === 'agendado' ? 'success' : a.status === 'cancelado' ? 'danger' : 'secondary'}">${a.status || 'agendado'}</span></td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p>Nenhum agendamento</p>'}
                            </div>

                            <div style="margin-bottom: 30px;">
                                <h4>Or√ßamentos (${orcamentos.length})</h4>
                                ${orcamentos.length > 0 ? `
                                    <table style="width: 100%; margin-top: 10px;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 10px; text-align: left;">N¬∫</th>
                                                <th style="padding: 10px; text-align: left;">Data</th>
                                                <th style="padding: 10px; text-align: left;">Valor</th>
                                                <th style="padding: 10px; text-align: left;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${orcamentos.sort((a, b) => b.numero - a.numero).map(o => `
                                                <tr>
                                                    <td style="padding: 8px;">#${o.numero}</td>
                                                    <td style="padding: 8px;">${new Date(o.data).toLocaleDateString('pt-BR')}</td>
                                                    <td style="padding: 8px;">R$ ${o.total.toFixed(2)}</td>
                                                    <td style="padding: 8px;"><span class="badge badge-${o.status === 'aprovado' ? 'success' : o.status === 'recusado' ? 'danger' : 'warning'}">${o.status}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p>Nenhum or√ßamento</p>'}
                            </div>

                            <div>
                                <h4>Hist√≥rico Financeiro</h4>
                                ${transacoes.length > 0 ? `
                                    <table style="width: 100%; margin-top: 10px;">
                                        <thead>
                                            <tr style="background: #f8f9fa;">
                                                <th style="padding: 10px; text-align: left;">Data</th>
                                                <th style="padding: 10px; text-align: left;">Descri√ß√£o</th>
                                                <th style="padding: 10px; text-align: left;">Tipo</th>
                                                <th style="padding: 10px; text-align: left;">Valor</th>
                                                <th style="padding: 10px; text-align: left;">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${transacoes.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 10).map(t => `
                                                <tr>
                                                    <td style="padding: 8px;">${new Date(t.data).toLocaleDateString('pt-BR')}</td>
                                                    <td style="padding: 8px;">${t.descricao}</td>
                                                    <td style="padding: 8px;">${t.tipo === 'receita' ? 'Receita' : 'Despesa'}</td>
                                                    <td style="padding: 8px;">R$ ${t.valor.toFixed(2)}</td>
                                                    <td style="padding: 8px;"><span class="badge badge-${t.status === 'confirmado' ? 'success' : 'warning'}">${t.status}</span></td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                ` : '<p>Nenhuma transa√ß√£o</p>'}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            atualizarVeiculos() {
                const tbody = document.getElementById('veiculos-table');
                
                // Agrupar ve√≠culos por cliente (dono)
                const veiculosPorCliente = {};
                this.dados.veiculos.forEach(veiculo => {
                    const clienteId = veiculo.clienteId;
                    if (!veiculosPorCliente[clienteId]) {
                        veiculosPorCliente[clienteId] = [];
                    }
                    veiculosPorCliente[clienteId].push(veiculo);
                });
                
                // Ordenar clientes por nome
                const clientesOrdenados = Object.keys(veiculosPorCliente).sort((a, b) => {
                    const clienteA = this.dados.clientes.find(c => c.id === parseInt(a));
                    const clienteB = this.dados.clientes.find(c => c.id === parseInt(b));
                    const nomeA = clienteA?.nome || '';
                    const nomeB = clienteB?.nome || '';
                    return nomeA.localeCompare(nomeB);
                });
                
                // Gerar HTML agrupado
                let html = '';
                clientesOrdenados.forEach(clienteId => {
                    const cliente = this.dados.clientes.find(c => c.id === parseInt(clienteId));
                    const veiculos = veiculosPorCliente[clienteId];
                    
                    // Linha de cabe√ßalho do grupo
                    html += `
                        <tr style="background-color: #f0f0f0; font-weight: bold;">
                            <td colspan="6" style="padding: 10px;">
                                üë§ ${cliente?.nome || 'N/A'} (${veiculos.length} ve√≠culo${veiculos.length > 1 ? 's' : ''})
                            </td>
                        </tr>
                    `;
                    
                    // Linhas dos ve√≠culos deste cliente
                    veiculos.forEach(veiculo => {
                        html += `
                            <tr>
                                <td>${veiculo.placa}</td>
                                <td>${veiculo.marca} ${veiculo.modelo}</td>
                                <td>${cliente?.nome || 'N/A'}</td>
                                <td>${veiculo.ano || '-'}</td>
                                <td>-</td>
                                <td><span class="badge badge-success">Ativo</span></td>
                            </tr>
                        `;
                    });
                });
                
                if (html === '') {
                    html = '<tr><td colspan="6" class="text-center">Nenhum ve√≠culo cadastrado</td></tr>';
                }
                
                tbody.innerHTML = html;
            }

            atualizarOrcamentos() {
                const orcamentosPendentes = this.dados.orcamentos.filter(o => o.status === 'pendente');
                const orcamentosEmServico = this.dados.orcamentos.filter(o => o.status === 'em-servico');
                const orcamentosAprovados = this.dados.orcamentos.filter(o => o.status === 'aprovado');
                const orcamentosFinalizados = this.dados.orcamentos.filter(o => o.status === 'finalizado');
                const valorTotalPendente = orcamentosPendentes.reduce((sum, o) => sum + o.total, 0);

                document.getElementById('orcamentos-pendentes-card').textContent = orcamentosPendentes.length;
                document.getElementById('orcamentos-aprovados').textContent = orcamentosAprovados.length;
                document.getElementById('orcamentos-finalizados').textContent = orcamentosFinalizados.length;
                document.getElementById('valor-total-pendente').textContent = `R$ ${valorTotalPendente.toFixed(2)}`;

                const tbody = document.getElementById('orcamentos-table');
                if (!tbody) return;

                let orcamentosParaExibir = [...this.dados.orcamentos];

                if (state.filtroOrcamento === 'pendentes') {
                    orcamentosParaExibir = orcamentosParaExibir.filter(o => o.status === 'pendente');
                } else if (state.filtroOrcamento === 'aprovados') {
                    orcamentosParaExibir = orcamentosParaExibir.filter(o => o.status === 'aprovado');
                } else if (state.filtroOrcamento === 'finalizados') {
                    orcamentosParaExibir = orcamentosParaExibir.filter(o => o.status === 'finalizado');
                }

                orcamentosParaExibir = orcamentosParaExibir.sort((a, b) => {
                    const dataA = new Date(a.data || 0);
                    const dataB = new Date(b.data || 0);
                    return dataB - dataA;
                });

                if (orcamentosParaExibir.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum or√ßamento encontrado</td></tr>';
                    return;
                }

                tbody.innerHTML = orcamentosParaExibir.map(orcamento => {
                    const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                    const veiculo = this.dados.veiculos.find(v => v.id === orcamento.veiculoId);
                    
                    let statusBadge = '';
                    if (orcamento.status === 'pendente') statusBadge = 'badge-warning';
                    if (orcamento.status === 'em-servico') statusBadge = 'badge-info';
                    if (orcamento.status === 'aprovado') statusBadge = 'badge-success';
                    if (orcamento.status === 'finalizado') statusBadge = 'badge-success';
                    if (orcamento.status === 'recusado') statusBadge = 'badge-danger';

                    return `
                        <tr onclick="sistema.visualizarOrcamento(${orcamento.id}); sistema.selectRow('orcamentos', ${orcamento.id}, this);" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${orcamento.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('orcamentos', ${orcamento.id})"></td>
                            <td>#${orcamento.numero}</td>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>R$ ${orcamento.total.toFixed(2)}</td>
                            <td>${new Date(orcamento.data).toLocaleDateString('pt-BR')}</td>
                            <td>${new Date(new Date(orcamento.data).getTime() + orcamento.validade * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')}</td>
                            <td><span class="badge ${statusBadge}">${orcamento.status}</span></td>
                        </tr>
                    `;
                }).join('');
                // Limpar sele√ß√£o ap√≥s atualizar
                this.updateUniversalButtons('orcamentos');
                
                // Manter busca se houver termo
                const buscaInput = document.getElementById('busca-orcamentos');
                if (buscaInput && buscaInput.value.trim()) {
                    this.filtrarOrcamentos(buscaInput.value);
                }
            }

            aplicarFiltroAgendamento(filtro) {
                state.filtroAgendamento = filtro;
                
                // Atualizar bot√µes de filtro
                ['todos', 'pendente', 'em-servico', 'finalizado'].forEach(f => {
                    const btn = document.getElementById(`filtro-agendamento-${f}`);
                    if (btn) {
                        if (f === filtro) {
                            btn.style.background = 'var(--primary-color)';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '';
                            btn.style.color = '';
                        }
                    }
                });
                
                // Manter busca se houver termo
                const buscaInput = document.getElementById('busca-agendamentos');
                if (buscaInput && buscaInput.value.trim()) {
                    this.filtrarAgendamentos(buscaInput.value);
                } else {
                    this.atualizarAgendamentos();
                }
            }

            aplicarFiltroOrcamento(filtro) {
                state.filtroOrcamento = filtro;
                
                // Atualizar bot√µes de filtro
                ['todos', 'pendentes', 'aprovados', 'finalizados'].forEach(f => {
                    const btn = document.getElementById(`filtro-orcamento-${f}`);
                    if (btn) {
                        if (f === filtro) {
                            btn.style.background = 'var(--primary-color)';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '';
                            btn.style.color = '';
                        }
                    }
                });
                
                // Manter busca se houver termo
                const buscaInput = document.getElementById('busca-orcamentos');
                if (buscaInput && buscaInput.value.trim()) {
                    this.filtrarOrcamentos(buscaInput.value);
                } else {
                    this.atualizarOrcamentos();
                }
            }

            async gerarOrdemServicoDoOrcamento(orcamento) {
                // Verificar se j√° existe uma O.S. para este or√ßamento
                const osExistente = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                if (osExistente) {
                    this.log(`J√° existe uma O.S. para o or√ßamento #${orcamento.numero}`, 'warning');
                    return osExistente;
                }

                const numeroOS = this.gerarProximoNumeroOS();
                const payload = this.criarPayloadOrdemServico({
                    numero: numeroOS,
                    orcamentoId: orcamento.id,
                    clienteId: orcamento.clienteId,
                    veiculoId: orcamento.veiculoId,
                    agendamentoId: orcamento.agendamentoId,
                    servicos: orcamento.servicos ? orcamento.servicos.map(s => ({
                        descricao: s.descricao,
                        quantidade: s.quantidade || 1
                    })) : [],
                    pecas: orcamento.pecas ? orcamento.pecas.map(p => ({
                        item: p.item,
                        quantidade: p.quantidade
                    })) : [],
                    observacoes: orcamento.observacoes || '',
                    status: 'pendente',
                    dataAbertura: new Date().toISOString()
                });

                const criada = await this.apiRequest('/ordens-servico', { method: 'POST', data: payload });
                const novaOS = this.normalizarOrdemServico(criada);
                this.dados.ordensServico.push(novaOS);
                this.salvarDados('ordensServico');
                
                // Atualizar status do agendamento para "em-servico" se existir
                if (orcamento.agendamentoId) {
                    const agendamento = this.dados.agendamentos.find(a => a.id === orcamento.agendamentoId);
                    if (agendamento) {
                        try {
                            await this.atualizarAgendamentoServidor(agendamento.id, { status: 'em-servico' });
                        this.log(`Agendamento #${agendamento.numero || agendamento.id} atualizado para Em Servi√ßo`, 'info');
                        } catch (error) {
                            this.log(`N√£o foi poss√≠vel atualizar o agendamento vinculado: ${error.message}`, 'warning');
                        }
                    }
                }
                
                this.log(`Ordem de Servi√ßo #${novaOS.numero} gerada do or√ßamento #${orcamento.numero}`, 'success');
                return novaOS;
            }

            atualizarOrdensServico() {
                if (!state.filtroOS) state.filtroOS = 'todos';
                
                // Garantir que a lista de ve√≠culos est√° atualizada
                this.reconstruirListaVeiculos();
                
                const tbody = document.getElementById('ordens-servico-table');
                if (!tbody) return;

                let ordensParaExibir = [...this.dados.ordensServico];

                // Aplicar filtro
                if (state.filtroOS === 'pendente') {
                    ordensParaExibir = ordensParaExibir.filter(os => os.status === 'pendente');
                } else if (state.filtroOS === 'em-servico') {
                    ordensParaExibir = ordensParaExibir.filter(os => os.status === 'em-servico');
                } else if (state.filtroOS === 'finalizada') {
                    ordensParaExibir = ordensParaExibir.filter(os => os.status === 'finalizada');
                }

                // Ordenar por data mais recente
                ordensParaExibir = ordensParaExibir.sort((a, b) => {
                    const dataA = new Date(a.dataAbertura || 0);
                    const dataB = new Date(b.dataAbertura || 0);
                    return dataB - dataA;
                });

                if (ordensParaExibir.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma ordem de servi√ßo encontrada</td></tr>';
                    return;
                }

                tbody.innerHTML = ordensParaExibir.map(os => {
                    const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);
                    const cliente = this.dados.clientes.find(c => c.id === os.clienteId);
                    let veiculo = this.buscarVeiculoPorId(os.veiculoId);
                    
                    // Se n√£o encontrou, tentar pelo or√ßamento
                    if (!veiculo && orcamento && orcamento.veiculoId) {
                        veiculo = this.buscarVeiculoPorId(orcamento.veiculoId);
                    }
                    
                    let statusBadge = 'badge-warning';
                    let statusTexto = 'Pendente';
                    if (os.status === 'em-servico') {
                        statusBadge = 'badge-info';
                        statusTexto = 'Em Servi√ßo';
                    } else if (os.status === 'finalizada') {
                        statusBadge = 'badge-success';
                        statusTexto = 'Finalizada';
                    }

                    return `
                        <tr onclick="sistema.visualizarOrdemServico(${os.id}); sistema.selectRow('ordens-servico', ${os.id}, this);" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${os.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('ordens-servico', ${os.id})"></td>
                            <td>#${os.numero}</td>
                            <td>#${orcamento?.numero || 'N/A'}</td>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>${new Date(os.dataAbertura).toLocaleDateString('pt-BR')}</td>
                            <td><span class="badge ${statusBadge}">${statusTexto}</span></td>
                        </tr>
                    `;
                }).join('');

                this.updateUniversalButtons('ordens-servico');
            }

            aplicarFiltroOS(filtro) {
                state.filtroOS = filtro;
                
                ['todos', 'pendente', 'em-servico', 'finalizada'].forEach(f => {
                    const btn = document.getElementById(`filtro-os-${f}`);
                    if (btn) {
                        if (f === filtro) {
                            btn.style.background = 'var(--primary-color)';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '';
                            btn.style.color = '';
                        }
                    }
                });
                
                const buscaInput = document.getElementById('busca-ordens-servico');
                if (buscaInput && buscaInput.value.trim()) {
                    this.filtrarOrdensServico(buscaInput.value);
                } else {
                    this.atualizarOrdensServico();
                }
            }

            filtrarOrdensServico(termo) {
                const tbody = document.getElementById('ordens-servico-table');
                if (!tbody) return;
                
                const termoLower = termo.toLowerCase().trim();
                let ordensParaExibir = [...this.dados.ordensServico];
                
                // Aplicar filtro de status se existir
                if (state.filtroOS === 'pendente') {
                    ordensParaExibir = ordensParaExibir.filter(os => os.status === 'pendente');
                } else if (state.filtroOS === 'em-servico') {
                    ordensParaExibir = ordensParaExibir.filter(os => os.status === 'em-servico');
                } else if (state.filtroOS === 'finalizada') {
                    ordensParaExibir = ordensParaExibir.filter(os => os.status === 'finalizada');
                }
                
                // Aplicar busca
                if (termoLower) {
                    ordensParaExibir = ordensParaExibir.filter(os => {
                        const numero = `#${os.numero}`.toLowerCase();
                        const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);
                        const numeroOrcamento = orcamento ? `#${orcamento.numero}`.toLowerCase() : '';
                        const cliente = this.dados.clientes.find(c => c.id === os.clienteId);
                        const nomeCliente = cliente?.nome.toLowerCase() || '';
                        const veiculo = this.dados.veiculos.find(v => v.id === os.veiculoId);
                        const placaVeiculo = veiculo?.placa.toLowerCase() || '';
                        const marcaVeiculo = veiculo?.marca.toLowerCase() || '';
                        const modeloVeiculo = veiculo?.modelo.toLowerCase() || '';
                        
                        return numero.includes(termoLower) ||
                               numeroOrcamento.includes(termoLower) ||
                               nomeCliente.includes(termoLower) ||
                               placaVeiculo.includes(termoLower) ||
                               marcaVeiculo.includes(termoLower) ||
                               modeloVeiculo.includes(termoLower);
                    });
                }

                // Ordenar por data mais recente
                ordensParaExibir = ordensParaExibir.sort((a, b) => {
                    const dataA = new Date(a.dataAbertura || 0);
                    const dataB = new Date(b.dataAbertura || 0);
                    return dataB - dataA;
                });

                if (ordensParaExibir.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma ordem de servi√ßo encontrada</td></tr>';
                    return;
                }

                tbody.innerHTML = ordensParaExibir.map(os => {
                    const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);
                    const cliente = this.dados.clientes.find(c => c.id === os.clienteId);
                    let veiculo = this.buscarVeiculoPorId(os.veiculoId);
                    
                    // Se n√£o encontrou, tentar pelo or√ßamento
                    if (!veiculo && orcamento && orcamento.veiculoId) {
                        veiculo = this.buscarVeiculoPorId(orcamento.veiculoId);
                    }
                    
                    let statusBadge = 'badge-warning';
                    let statusTexto = 'Pendente';
                    if (os.status === 'em-servico') {
                        statusBadge = 'badge-info';
                        statusTexto = 'Em Servi√ßo';
                    } else if (os.status === 'finalizada') {
                        statusBadge = 'badge-success';
                        statusTexto = 'Finalizada';
                    }

                    return `
                        <tr onclick="sistema.visualizarOrdemServico(${os.id}); sistema.selectRow('ordens-servico', ${os.id}, this);" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${os.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('ordens-servico', ${os.id})"></td>
                            <td>#${os.numero}</td>
                            <td>#${orcamento?.numero || 'N/A'}</td>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>${new Date(os.dataAbertura).toLocaleDateString('pt-BR')}</td>
                            <td><span class="badge ${statusBadge}">${statusTexto}</span></td>
                        </tr>
                    `;
                }).join('');

                this.updateUniversalButtons('ordens-servico');
            }

            visualizarOrdemServico(id) {
                console.debug('visualizarOrdemServico called with id=', id);
                const os = this.dados.ordensServico.find(o => o.id === id);
                if (!os) {
                    this.log('Ordem de Servi√ßo n√£o encontrada', 'error');
                    return;
                }

                const cliente = this.dados.clientes.find(c => c.id === os.clienteId);
                
                // Garantir lista atualizada e buscar ve√≠culo de forma flex√≠vel
                this.reconstruirListaVeiculos();
                let veiculo = this.buscarVeiculoPorId(os.veiculoId);
                
                // Se n√£o encontrou pelo veiculoId da O.S, tentar pelo or√ßamento
                if (!veiculo && os.orcamentoId) {
                    const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);
                    if (orcamento && orcamento.veiculoId) {
                        veiculo = this.buscarVeiculoPorId(orcamento.veiculoId);
                    }
                    // Se ainda n√£o encontrou, tentar pelo agendamento do or√ßamento
                    if (!veiculo && orcamento && orcamento.agendamentoId) {
                        const agendamento = this.dados.agendamentos.find(a => a.id === orcamento.agendamentoId);
                        if (agendamento && agendamento.veiculoId) {
                            veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                        }
                    }
                }
                
                const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);

                if (!cliente) {
                    this.log('Cliente da O.S. n√£o encontrado', 'error');
                    return;
                }

                if (!veiculo) {
                    console.warn('Ve√≠culo da O.S. n√£o encontrado. O ve√≠culo pode ter sido removido.', {
                        osVeiculoId: os.veiculoId,
                        orcamentoId: os.orcamentoId,
                        veiculosDisponiveis: this.dados.veiculos.map(v => ({ id: v.id, placa: v.placa }))
                    });
                }

                state.currentOSId = id;

                document.getElementById('os-numero').textContent = os.numero;

                const preview = document.getElementById('os-preview');
                let statusBadge = '<span class="badge badge-warning" style="font-size: 16px; padding: 8px 15px;">PENDENTE</span>';
                if (os.status === 'em-servico') {
                    statusBadge = '<span class="badge badge-info" style="font-size: 16px; padding: 8px 15px;">EM SERVI√áO</span>';
                } else if (os.status === 'finalizada') {
                    statusBadge = '<span class="badge badge-success" style="font-size: 16px; padding: 8px 15px;">FINALIZADA</span>';
                }

                preview.innerHTML = `
                    <div class="orcamento-header">
                        <h2>ORDEM DE SERVI√áO #${os.numero}</h2>
                        <p>Data Abertura: ${new Date(os.dataAbertura).toLocaleDateString('pt-BR')}</p>
                        ${os.dataFinalizacao ? `<p>Data e Hora Finaliza√ß√£o: ${new Date(os.dataFinalizacao).toLocaleString('pt-BR')}</p>` : ''}
                        <p style="margin-top: 10px;">Status: ${statusBadge}</p>
                    </div>

                    <div class="orcamento-info">
                        <div>
                            <h4>Cliente</h4>
                            <p><strong>Nome:</strong> ${cliente.nome}</p>
                            <p><strong>WhatsApp:</strong> ${cliente.whatsapp}</p>
                        </div>
                        <div>
                            <h4>Ve√≠culo</h4>
                            ${veiculo ? `
                            <p><strong>Placa:</strong> ${veiculo.placa}</p>
                            <p><strong>Marca/Modelo:</strong> ${veiculo.marca} ${veiculo.modelo}</p>
                            <p><strong>Ano:</strong> ${veiculo.ano || 'N/A'}</p>
                            ` : `
                            <p style="color: #ff9800;">‚ö†Ô∏è Ve√≠culo n√£o encontrado</p>
                            <p style="font-size: 12px; color: #666;">O ve√≠culo pode ter sido removido do sistema.</p>
                            `}
                        </div>
                    </div>

                    ${orcamento ? `
                    <div class="orcamento-info" style="margin-top: 20px;">
                        <div>
                            <h4>Or√ßamento Relacionado</h4>
                            <p><strong>N√∫mero:</strong> #${orcamento.numero}</p>
                            <p><strong>Valor Total:</strong> R$ ${orcamento.total.toFixed(2)}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${os.servicos && os.servicos.length > 0 ? `
                    <div class="servicos-lista">
                        <h4>Servi√ßos a Realizar</h4>
                        ${os.servicos.map(servico => `
                            <div class="servico-linha">
                                <div class="servico-descricao">${servico.descricao}</div>
                                <div class="servico-quantidade">${servico.quantidade}x</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${os.pecas && os.pecas.length > 0 ? `
                    <div class="servicos-lista" style="margin-top: 20px;">
                        <h4>Pe√ßas/Itens</h4>
                        ${os.pecas.map(peca => `
                            <div class="servico-linha">
                                <div class="servico-descricao">${peca.item}</div>
                                <div class="servico-quantidade">${peca.quantidade}x</div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}

                    ${os.observacoes ? `
                        <div class="observacoes">
                            <h4>Observa√ß√µes</h4>
                            <p>${os.observacoes}</p>
                        </div>
                    ` : ''}

                    <div class="assinatura">
                        <p>_________________________________________</p>
                        <p>Assinatura do Mec√¢nico</p>
                    </div>
                `;

                // Abrir o modal de visualiza√ß√£o
                abrirModalVisualizarOS();
                
                // Mostrar/ocultar bot√µes
                const btnFinalizar = document.getElementById('btn-finalizar-os');
                const btnEmServico = document.getElementById('btn-em-servico-os');
                if (btnFinalizar && btnEmServico) {
                    if (os.status === 'finalizada') {
                        btnFinalizar.style.display = 'none';
                        btnEmServico.style.display = 'none';
                    } else if (os.status === 'em-servico') {
                        btnFinalizar.style.display = 'inline-block';
                        btnEmServico.style.display = 'none'; // J√° est√° em servi√ßo
                    } else {
                        // Status pendente
                        btnFinalizar.style.display = 'inline-block';
                        btnEmServico.style.display = 'inline-block';
                    }
                }

                abrirModalVisualizarOS();
            }

            visualizarOrdemServicoSelecionada() {
                const id = this.getSelectedId('ordens-servico');
                if (id) this.visualizarOrdemServico(id);
            }

            finalizarOrdemServicoSelecionada() {
                const id = this.getSelectedId('ordens-servico');
                if (id) this.finalizarOrdemServico(id);
            }

            async excluirOrdemServico(id) {
                const os = this.dados.ordensServico.find(o => o.id === id);
                if (!os) return;

                // Impedir exclus√£o se a O.S estiver em servi√ßo ou finalizada
                if (os.status === 'em-servico' || os.status === 'finalizada') {
                    alert('N√£o √© poss√≠vel excluir uma Ordem de Servi√ßo que est√° em servi√ßo ou finalizada.');
                    return;
                }

                if (!confirm(`Deseja realmente excluir a Ordem de Servi√ßo #${os.numero}?`)) {
                    return;
                }

                try {
                    await this.apiRequest(`/ordens-servico/${id}`, { method: 'DELETE' });
                    this.dados.ordensServico = this.dados.ordensServico.filter(o => o.id !== id);
                    this.salvarDados('ordensServico');
                    this.atualizarTodosDados();
                    this.log(`Ordem de Servi√ßo #${os.numero} exclu√≠da com sucesso`, 'warning');
                } catch (error) {
                    this.log(`Erro ao excluir O.S.: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            excluirOrdemServicoSelecionada() {
                const id = this.getSelectedId('ordens-servico');
                if (id) this.excluirOrdemServico(id);
            }

            async mudarStatusOS(status) {
                if (!state.currentOSId) return;
                
                const os = this.dados.ordensServico.find(o => o.id === state.currentOSId);
                if (!os) return;

                if (os.status === 'finalizada' && status !== 'finalizada') {
                    alert('N√£o √© poss√≠vel alterar o status de uma O.S. finalizada');
                    return;
                }

                const statusTexto = status === 'em-servico' ? 'mover para Em Servi√ßo' : 
                                   status === 'finalizada' ? 'finalizar' : 'mudar para Pendente';
                
                if (!confirm(`Deseja ${statusTexto} a Ordem de Servi√ßo #${os.numero}?`)) {
                    return;
                }

                let dataFinalizacao = os.dataFinalizacao || null;
                if (status === 'finalizada') {
                    dataFinalizacao = new Date().toISOString();
                } else if (status === 'pendente') {
                    dataFinalizacao = null;
                }

                let osAtualizada;
                try {
                    osAtualizada = await this.atualizarOrdemServicoServidor(os.id, {
                        status,
                        dataFinalizacao
                    });
                } catch (error) {
                    this.log(`Erro ao atualizar ordem de servi√ßo: ${error.message}`, 'error');
                    alert(error.message);
                    return;
                }

                if (status === 'finalizada') {
                    // Atualizar agendamento para finalizado
                    if (os.agendamentoId) {
                        const agendamento = this.dados.agendamentos.find(a => a.id === os.agendamentoId);
                        if (agendamento) {
                            try {
                                await this.atualizarAgendamentoServidor(agendamento.id, {
                                    status: 'finalizado',
                                    dataFinalizacao
                                });
                            this.log(`Agendamento #${agendamento.numero || agendamento.id} atualizado para Finalizado`, 'info');
                            } catch (error) {
                                this.log(`N√£o foi poss√≠vel atualizar o agendamento #${agendamento.numero || agendamento.id}: ${error.message}`, 'warning');
                            }
                        }
                    }
                    
                    // Atualizar or√ßamento para finalizado
                    if (os.orcamentoId) {
                        const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);
                        if (orcamento) {
                            try {
                                await this.atualizarOrcamentoServidor(orcamento.id, { status: 'finalizado' });
                            this.log(`Or√ßamento #${orcamento.numero} atualizado para Finalizado`, 'info');
                            } catch (error) {
                                this.log(`N√£o foi poss√≠vel atualizar o or√ßamento #${orcamento.numero}: ${error.message}`, 'warning');
                            }
                        }
                    }
                    
                    // Enviar mensagem autom√°tica para o cliente
                    setTimeout(() => {
                        this.enviarWhatsAppOS(os.id);
                    }, 500);
                } else if (status === 'em-servico') {
                    // Atualizar agendamento para em-servico
                    if (os.agendamentoId) {
                        const agendamento = this.dados.agendamentos.find(a => a.id === os.agendamentoId);
                        if (agendamento) {
                            try {
                                await this.atualizarAgendamentoServidor(agendamento.id, { status: 'em-servico' });
                            this.log(`Agendamento #${agendamento.numero || agendamento.id} atualizado para Em Servi√ßo`, 'info');
                            } catch (error) {
                                this.log(`N√£o foi poss√≠vel atualizar o agendamento #${agendamento.numero || agendamento.id}: ${error.message}`, 'warning');
                            }
                        }
                    }
                }
                
                this.atualizarTodosDados();
                this.log(`Ordem de Servi√ßo #${osAtualizada.numero} ${status === 'em-servico' ? 'em servi√ßo' : 'finalizada'}`, 'success');
                
                // Atualizar visualiza√ß√£o se estiver aberta
                this.visualizarOrdemServico(state.currentOSId);
            }

            async finalizarOrdemServico(id) {
                if (!id) id = state.currentOSId;
                if (!id) return;
                await this.mudarStatusOS('finalizada');
            }

            async colocarEmServicoOS() {
                if (!state.currentOSId) return;
                await this.mudarStatusOS('em-servico');
            }

            async gerarOSManual() {
                if (!state.currentOrcamentoId) return;
                
                const orcamento = this.dados.orcamentos.find(o => o.id === state.currentOrcamentoId);
                if (!orcamento) return;
                
                if (orcamento.status !== 'aprovado') {
                    alert('Apenas or√ßamentos aprovados podem gerar Ordem de Servi√ßo');
                    return;
                }
                
                // Verificar se j√° existe O.S.
                const osExistente = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                if (osExistente) {
                    alert(`J√° existe uma Ordem de Servi√ßo (#${osExistente.numero}) para este or√ßamento`);
                    return;
                }
                
                await this.gerarOrdemServicoDoOrcamento(orcamento);
                this.atualizarTodosDados();
                this.log(`Ordem de Servi√ßo gerada manualmente do or√ßamento #${orcamento.numero}`, 'success');
                
                // Atualizar visualiza√ß√£o do or√ßamento
                this.visualizarOrcamento(state.currentOrcamentoId);
            }

            gerarRelatorioOrdensServico() {
                // Implementar gera√ß√£o de relat√≥rio se necess√°rio
                alert('Funcionalidade de relat√≥rio ser√° implementada em breve');
            }

            imprimirOrdemServico() {
                if (!state.currentOSId) return;
                
                const os = this.dados.ordensServico.find(o => o.id === state.currentOSId);
                if (!os) return;

                const cliente = this.dados.clientes.find(c => c.id === os.clienteId);
                const veiculo = this.dados.veiculos.find(v => v.id === os.veiculoId);
                const orcamento = this.dados.orcamentos.find(o => o.id === os.orcamentoId);

                const printWindow = window.open('', '_blank');
                let statusTexto = 'PENDENTE';
                if (os.status === 'em-servico') {
                    statusTexto = 'EM SERVI√áO';
                } else if (os.status === 'finalizada') {
                    statusTexto = 'FINALIZADA';
                }
                
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Ordem de Servi√ßo #${os.numero}</title>
                            <style>
                                body { font-family: Arial, sans-serif; padding: 20px; }
                                h1 { text-align: center; color: #333; }
                                .header { margin-bottom: 30px; text-align: center; }
                                .info { margin: 20px 0; }
                                .info h3 { border-bottom: 2px solid #333; padding-bottom: 5px; }
                                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                                th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                                th { background-color: #f2f2f2; }
                                .total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 20px; }
                                .assinatura { margin-top: 50px; text-align: center; }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>ORDEM DE SERVI√áO #${os.numero}</h1>
                                <p><strong>Data Abertura:</strong> ${new Date(os.dataAbertura).toLocaleDateString('pt-BR')}</p>
                                ${os.dataFinalizacao ? `<p><strong>Data e Hora Finaliza√ß√£o:</strong> ${new Date(os.dataFinalizacao).toLocaleString('pt-BR')}</p>` : ''}
                                <p><strong>Status:</strong> ${statusTexto}</p>
                            </div>
                            
                            <div class="info">
                                <h3>Cliente</h3>
                                <p><strong>Nome:</strong> ${cliente?.nome || 'N/A'}</p>
                                <p><strong>WhatsApp:</strong> ${cliente?.whatsapp || 'N/A'}</p>
                            </div>
                            
                            <div class="info">
                                <h3>Ve√≠culo</h3>
                                <p><strong>Placa:</strong> ${veiculo?.placa || 'N/A'}</p>
                                <p><strong>Marca/Modelo:</strong> ${veiculo ? `${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</p>
                                <p><strong>Ano:</strong> ${veiculo?.ano || 'N/A'}</p>
                            </div>
                            
                            ${orcamento ? `
                            <div class="info">
                                <h3>Or√ßamento Relacionado</h3>
                                <p><strong>N√∫mero:</strong> #${orcamento.numero}</p>
                                <p><strong>Valor Total:</strong> R$ ${orcamento.total.toFixed(2)}</p>
                            </div>
                            ` : ''}
                            
                            ${os.servicos && os.servicos.length > 0 ? `
                            <div class="info">
                                <h3>Servi√ßos a Realizar</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Descri√ß√£o</th>
                                            <th>Quantidade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${os.servicos.map(s => `
                                            <tr>
                                                <td>${s.descricao}</td>
                                                <td>${s.quantidade}x</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ` : ''}
                            
                            ${os.pecas && os.pecas.length > 0 ? `
                            <div class="info">
                                <h3>Pe√ßas/Itens</h3>
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantidade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${os.pecas.map(p => `
                                            <tr>
                                                <td>${p.item}</td>
                                                <td>${p.quantidade}x</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            ` : ''}
                            
                            ${os.observacoes ? `
                            <div class="info">
                                <h3>Observa√ß√µes</h3>
                                <p>${os.observacoes}</p>
                            </div>
                            ` : ''}
                            
                            <div class="assinatura">
                                <p>_________________________________________</p>
                                <p>Assinatura do Mec√¢nico</p>
                            </div>
                        </body>
                    </html>
                `);
                
                printWindow.document.close();
                printWindow.print();
            }

            atualizarAgendamentos() {
                // Garantir que a lista de ve√≠culos est√° atualizada
                this.reconstruirListaVeiculos();
                
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const fimSemana = new Date(hoje);
                fimSemana.setDate(hoje.getDate() + 7);
                const fimProximaSemana = new Date(hoje);
                fimProximaSemana.setDate(hoje.getDate() + 14);

                // Filtrar agendamentos baseado no filtro
                let agendamentosParaExibir = [...this.dados.agendamentos];

                if (state.filtroAgendamento === 'pendente') {
                    agendamentosParaExibir = agendamentosParaExibir.filter(a => a.status === 'pendente');
                } else if (state.filtroAgendamento === 'em-servico') {
                    agendamentosParaExibir = agendamentosParaExibir.filter(a => a.status === 'em-servico');
                } else if (state.filtroAgendamento === 'finalizado') {
                    agendamentosParaExibir = agendamentosParaExibir.filter(a => a.status === 'finalizado');
                }

                // Contar agendamentos (apenas n√£o finalizados para os cards)
                const agendamentosAtivos = agendamentosParaExibir.filter(a => 
                    a.status !== 'finalizado'
                );

                const agendamentosHoje = agendamentosAtivos.filter(a => {
                    const dataAgendamento = new Date(a.data);
                    dataAgendamento.setHours(0, 0, 0, 0);
                    return dataAgendamento.getTime() === hoje.getTime();
                });

                const agendamentosSemana = agendamentosAtivos.filter(a => {
                    const dataAgendamento = new Date(a.data);
                    dataAgendamento.setHours(0, 0, 0, 0);
                    return dataAgendamento >= hoje && dataAgendamento < fimSemana;
                });

                const agendamentosProximaSemana = agendamentosAtivos.filter(a => {
                    const dataAgendamento = new Date(a.data);
                    dataAgendamento.setHours(0, 0, 0, 0);
                    return dataAgendamento >= fimSemana && dataAgendamento < fimProximaSemana;
                });

                // Atualizar cards
                document.getElementById('agendamentos-hoje-detalhe').textContent = agendamentosHoje.length;
                document.getElementById('agendamentos-semana').textContent = agendamentosSemana.length;
                document.getElementById('agendamentos-proxima-semana').textContent = agendamentosProximaSemana.length;

                // Atualizar tabela
                const tbody = document.getElementById('agendamentos-table');
                const agendamentosOrdenados = agendamentosParaExibir
                    .sort((a, b) => {
                        const dataA = new Date(a.data + ' ' + (a.hora || '00:00'));
                        const dataB = new Date(b.data + ' ' + (b.hora || '00:00'));
                        return dataA - dataB;
                    });
                
                if (agendamentosOrdenados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = agendamentosOrdenados.map(agendamento => {
                    const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                    const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                    
                    const dataHora = agendamento.data 
                        ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                          (agendamento.hora ? ' ' + agendamento.hora.substring(0, 5) : '')
                        : '-';
                    
                    let statusBadge = 'badge-warning';
                    let statusTexto = 'Pendente';
                    if (agendamento.status === 'em-servico') {
                        statusBadge = 'badge-info';
                        statusTexto = 'Em Servi√ßo';
                    } else if (agendamento.status === 'finalizado') {
                        statusBadge = 'badge-success';
                        statusTexto = 'Finalizado';
                    } else {
                        statusTexto = 'Pendente';
                    }

                    return `
                        <tr onclick="sistema.visualizarAgendamento(${agendamento.id}); sistema.selectRow('agendamentos', ${agendamento.id}, this);" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${agendamento.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('agendamentos', ${agendamento.id})"></td>
                            <td>${dataHora}</td>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>${agendamento.problema || '-'}</td>
                            <td>${cliente?.whatsapp || '-'}</td>
                            <td><span class="badge ${statusBadge}">${statusTexto}</span></td>
                        </tr>
                    `;
                }).join('');
                // Limpar sele√ß√£o ap√≥s atualizar
                this.updateUniversalButtons('agendamentos');
                
                // Manter busca se houver termo
                const buscaInput = document.getElementById('busca-agendamentos');
                if (buscaInput && buscaInput.value.trim()) {
                    this.filtrarAgendamentos(buscaInput.value);
                }
            }

            editarAgendamento(id) {
                const agendamento = this.dados.agendamentos.find(a => a.id === id);
                if (!agendamento) {
                    this.log('Agendamento n√£o encontrado', 'error');
                    return;
                }

                // Preencher modal com dados do agendamento
                document.getElementById('agendamento-cliente').value = agendamento.clienteId;
                this.carregarVeiculosCliente(agendamento.clienteId);
                
                // Aguardar um pouco para carregar os ve√≠culos
                setTimeout(() => {
                    document.getElementById('agendamento-veiculo').value = agendamento.veiculoId;
                }, 100);
                
                document.getElementById('agendamento-data').value = agendamento.data;
                document.getElementById('agendamento-hora').value = agendamento.hora || '';
                document.getElementById('agendamento-problema').value = agendamento.problema || '';
                document.getElementById('agendamento-observacoes').value = agendamento.observacoes || '';

                // Marcar formul√°rio como edi√ß√£o
                const form = document.getElementById('form-agendamento');
                form.dataset.editId = id;
                
                // Atualizar t√≠tulo do modal
                document.querySelector('#modal-agendamento .modal-title').textContent = 'Editar Agendamento';
                
                abrirModalAgendamento();
            }

            irParaOrcamento(agendamentoId) {
                const agendamento = this.dados.agendamentos.find(a => a.id === agendamentoId);
                if (!agendamento) {
                    this.log('Agendamento n√£o encontrado', 'error');
                    return;
                }

                // Mudar para aba de or√ßamentos primeiro
                document.querySelector('[data-section="orcamentos"]').click();
                
                // Abrir modal de or√ßamento
                abrirModalOrcamento();
                
                // Aguardar um pouco para o modal abrir e ent√£o preencher os dados
                setTimeout(() => {
                    // Preencher dados do or√ßamento com informa√ß√µes do agendamento
                    document.getElementById('orcamento-cliente').value = agendamento.clienteId;
                    
                    // Carregar agendamentos do cliente
                    this.carregarAgendamentosClienteOrcamento(agendamento.clienteId);
                    
                    // Selecionar o agendamento atual
                    setTimeout(() => {
                        document.getElementById('orcamento-agendamento').value = agendamentoId;
                        this.carregarDadosAgendamentoOrcamento(agendamentoId);
                    }, 100);
                }, 100);
            }

            async excluirAgendamento(id) {
                const agendamento = this.dados.agendamentos.find(a => a.id === id);
                if (!agendamento) return;

                // Impedir exclus√£o se o agendamento estiver em servi√ßo ou finalizado
                if (agendamento.status === 'em-servico' || agendamento.status === 'finalizado') {
                    alert('N√£o √© poss√≠vel excluir um agendamento que est√° em servi√ßo ou finalizado.');
                    return;
                }

                if (!confirm('Deseja excluir este agendamento?')) return;

                try {
                    await this.apiRequest(`/agendamentos/${id}`, { method: 'DELETE' });
                this.dados.agendamentos = this.dados.agendamentos.filter(a => a.id !== id);
                this.salvarDados('agendamentos');
                this.atualizarAgendamentos();
                this.atualizarAgendamentosRecentes();
                this.log('Agendamento exclu√≠do com sucesso', 'warning');
                } catch (error) {
                    this.log(`Erro ao excluir agendamento: ${error.message}`, 'error');
                    alert(error.message);
                }
            }
            visualizarAgendamento(id) {
                const agendamento = this.dados.agendamentos.find(a => a.id === id);
                if (!agendamento) {
                    this.log('Agendamento n√£o encontrado', 'error');
                    return;
                }

                const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                
                // Garantir que a lista de ve√≠culos est√° atualizada antes de buscar
                this.reconstruirListaVeiculos();
                // Usar buscarVeiculoPorId que faz a busca correta mesmo se ve√≠culos n√£o estiverem carregados
                const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);

                if (!cliente) {
                    this.log('Cliente do agendamento n√£o encontrado', 'error');
                    return;
                }

                if (!veiculo) {
                    this.log('Ve√≠culo do agendamento n√£o encontrado. O ve√≠culo pode ter sido removido.', 'warning');
                    // Continuar mesmo sem ve√≠culo para permitir visualiza√ß√£o
                }

                state.currentAgendamentoId = id;

                document.getElementById('agendamento-numero-visualizar').textContent = agendamento.numero !== undefined ? agendamento.numero : agendamento.id;

                const preview = document.getElementById('agendamento-preview');
                const dataHora = agendamento.data 
                    ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                      (agendamento.hora ? ' √†s ' + agendamento.hora.substring(0, 5) : '')
                    : '-';

                let statusBadge = 'badge-warning';
                let statusTexto = 'Pendente';
                if (agendamento.status === 'em-servico') {
                    statusBadge = 'badge-info';
                    statusTexto = 'Em Servi√ßo';
                } else if (agendamento.status === 'finalizado') {
                    statusBadge = 'badge-success';
                    statusTexto = 'Finalizado';
                }

                const numeroAgendamento = agendamento.numero !== undefined ? agendamento.numero : agendamento.id;
                preview.innerHTML = `
                    <div class="orcamento-header">
                        <h2>AGENDAMENTO #${numeroAgendamento}</h2>
                        <p>Status: <span class="badge ${statusBadge}">${statusTexto}</span></p>
                    </div>

                    <div class="orcamento-info">
                        <div>
                            <h4>Cliente</h4>
                            <p><strong>Nome:</strong> ${cliente.nome}</p>
                            <p><strong>WhatsApp:</strong> ${cliente.whatsapp}</p>
                        </div>
                        <div>
                            <h4>Ve√≠culo</h4>
                            ${veiculo ? `
                            <p><strong>Placa:</strong> ${veiculo.placa}</p>
                            <p><strong>Marca/Modelo:</strong> ${veiculo.marca} ${veiculo.modelo}</p>
                            <p><strong>Ano:</strong> ${veiculo.ano || 'N/A'}</p>
                            ` : `
                                <p style="color: #dc3545;"><strong>‚ö†Ô∏è Ve√≠culo n√£o encontrado</strong></p>
                                <p>O ve√≠culo pode ter sido removido do sistema.</p>
                            `}
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4>Data e Hora do Agendamento</h4>
                        <p style="font-size: 18px; font-weight: bold;">${dataHora}</p>
                    </div>

                    <div style="margin: 20px 0;">
                        <h4>Problema Relatado</h4>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                            <p>${agendamento.problema || 'N√£o informado'}</p>
                        </div>
                    </div>

                    ${agendamento.observacoes ? `
                        <div style="margin: 20px 0;">
                            <h4>Observa√ß√µes</h4>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px;">
                                <p>${agendamento.observacoes}</p>
                            </div>
                        </div>
                    ` : ''}

                    <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 5px;">
                        <p><strong>Data de Cria√ß√£o:</strong> ${new Date(agendamento.dataCriacao).toLocaleString('pt-BR')}</p>
                        ${agendamento.dataAtualizacao ? `<p><strong>√öltima Atualiza√ß√£o:</strong> ${new Date(agendamento.dataAtualizacao).toLocaleString('pt-BR')}</p>` : ''}
                    </div>
                `;

                // Mostrar/ocultar bot√µes baseado no status
                const btnEmServico = document.getElementById('btn-em-servico');
                const btnFinalizar = document.getElementById('btn-finalizar');
                
                if (agendamento.status === 'pendente') {
                    btnEmServico.style.display = 'inline-block';
                    btnFinalizar.style.display = 'none';
                } else if (agendamento.status === 'em-servico') {
                    btnEmServico.style.display = 'none';
                    btnFinalizar.style.display = 'inline-block';
                } else {
                    btnEmServico.style.display = 'none';
                    btnFinalizar.style.display = 'none';
                }

                abrirModalVisualizarAgendamento();
            }

            async marcarEmServico() {
                if (!state.currentAgendamentoId) return;
                
                try {
                    const agendamento = await this.atualizarAgendamentoServidor(state.currentAgendamentoId, { status: 'em-servico' });
                    this.atualizarAgendamentos();
                    this.visualizarAgendamento(state.currentAgendamentoId);
                    const numeroAgendamento = agendamento.numero !== undefined ? agendamento.numero : agendamento.id;
                    this.log(`Agendamento #${numeroAgendamento} marcado como Em Servi√ßo`, 'success');
                } catch (error) {
                    this.log(`Erro ao atualizar agendamento: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            async finalizarAgendamento() {
                if (!state.currentAgendamentoId) return;
                
                if (!confirm('Deseja finalizar este agendamento? O servi√ßo foi conclu√≠do?')) return;
                
                try {
                    const dataFinalizacao = new Date().toISOString();
                    const agendamento = await this.atualizarAgendamentoServidor(state.currentAgendamentoId, {
                        status: 'finalizado',
                        dataFinalizacao
                    });
                    this.atualizarAgendamentos();
                    this.atualizarAgendamentosRecentes();
                    this.visualizarAgendamento(state.currentAgendamentoId);
                    const numeroAgendamento = agendamento.numero !== undefined ? agendamento.numero : agendamento.id;
                    this.log(`Agendamento #${numeroAgendamento} finalizado`, 'success');
                } catch (error) {
                    this.log(`Erro ao finalizar agendamento: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            async enviarWhatsAppAgendamento(agendamentoId) {
                const id = agendamentoId || state.currentAgendamentoId;
                if (!id) {
                    console.warn('ID do agendamento n√£o fornecido para enviar WhatsApp');
                    return;
                }

                const agendamento = this.dados.agendamentos.find(a => a.id === id);
                if (!agendamento) {
                    console.warn('Agendamento n√£o encontrado para enviar WhatsApp:', id);
                    return;
                }

                // Garantir que a lista de ve√≠culos est√° atualizada
                this.reconstruirListaVeiculos();

                const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                
                if (!cliente) {
                    console.error('Cliente n√£o encontrado para enviar WhatsApp:', {
                        clienteId: agendamento.clienteId,
                        agendamentoId: id,
                        clientesDisponiveis: this.dados.clientes.map(c => ({ id: c.id, nome: c.nome }))
                    });
                    alert('Cliente n√£o encontrado. Verifique se o cliente est√° cadastrado.');
                    return;
                }

                if (!veiculo) {
                    console.error('Ve√≠culo n√£o encontrado para enviar WhatsApp:', {
                        veiculoId: agendamento.veiculoId,
                        tipoVeiculoId: typeof agendamento.veiculoId,
                        agendamentoId: id,
                        veiculosDisponiveis: this.dados.veiculos.map(v => ({ id: v.id, tipo: typeof v.id, placa: v.placa }))
                    });
                    alert('Ve√≠culo n√£o encontrado. Verifique se o ve√≠culo est√° cadastrado.');
                    return;
                }

                const dataHora = agendamento.data 
                    ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                      (agendamento.hora ? ' √†s ' + agendamento.hora.substring(0, 5) : '')
                    : '-';

                const mensagem = `Ol√° ${cliente.nome}! üëã

Seu agendamento foi confirmado:

üìÖ *Data/Hora:* ${dataHora}
üöó *Ve√≠culo:* ${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}
üîß *Problema:* ${agendamento.problema}

Aguardamos voc√™ na data e hora agendadas!

Obrigado pela confian√ßa! üôè`;

                const numero = cliente.whatsapp.replace(/\D/g, '');
                openWhatsAppFallback(numero, mensagem);
                
                try {
                    await this.atualizarAgendamentoServidor(agendamento.id, { whatsappEnviado: true });
                } catch (error) {
                    this.log(`N√£o foi poss√≠vel registrar o envio do WhatsApp: ${error.message}`, 'warning');
                }
                this.log('Mensagem WhatsApp preparada', 'success');
            }

            async enviarWhatsAppOS(osId) {
                const id = osId || state.currentOSId;
                if (!id) return;

                const os = this.dados.ordensServico.find(o => o.id === id);
                if (!os) return;

                const cliente = this.dados.clientes.find(c => c.id === os.clienteId);
                const veiculo = this.buscarVeiculoPorId(os.veiculoId);
                
                if (!cliente || !veiculo) {
                    console.error('Dados incompletos para enviar WhatsApp OS:', {
                        clienteId: os.clienteId,
                        veiculoId: os.veiculoId,
                        clienteEncontrado: !!cliente,
                        veiculoEncontrado: !!veiculo
                    });
                    this.log('Dados incompletos para enviar WhatsApp ao cliente. Verifique se o cliente e ve√≠culo est√£o cadastrados.', 'warning');
                    return;
                }

                if (!cliente.whatsapp) {
                    this.log('Cliente n√£o possui WhatsApp cadastrado', 'warning');
                    return;
                }

                const veiculoInfo = `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}`;
                const dataFinalizacao = os.dataFinalizacao 
                    ? new Date(os.dataFinalizacao).toLocaleString('pt-BR')
                    : new Date().toLocaleString('pt-BR');

                const mensagem = `Ol√° ${cliente.nome}! üëã

‚úÖ *SEU VE√çCULO EST√Å PRONTO!*

üöó *Ve√≠culo:* ${veiculoInfo}
üìã *O.S. N¬∫:* #${os.numero}
üìÖ *Finalizado em:* ${dataFinalizacao}

Seu carro est√° pronto e voc√™ j√° pode vir busc√°-lo! üéâ

Caso tenha alguma d√∫vida ou precise de mais informa√ß√µes, entre em contato conosco.

Aguardamos voc√™! üòä

Obrigado pela confian√ßa! üôè`;

                const numero = cliente.whatsapp.replace(/\D/g, '');
                openWhatsAppFallback(numero, mensagem);
                
                try {
                    await this.atualizarOrdemServicoServidor(os.id, { whatsappEnviado: true });
                } catch (error) {
                    this.log(`N√£o foi poss√≠vel registrar o envio do WhatsApp da O.S.: ${error.message}`, 'warning');
                }
                this.log(`Mensagem WhatsApp enviada para ${cliente.nome} - O.S. #${os.numero}`, 'success');
            }

            async verificarLembretesAgendamentos() {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const amanha = new Date(hoje);
                amanha.setDate(hoje.getDate() + 1);

                const agendamentosParaLembrar = this.dados.agendamentos.filter(a => {
                    if (!a.data || a.lembreteEnviado || a.status === 'finalizado') return false;
                    
                    const dataAgendamento = new Date(a.data);
                    dataAgendamento.setHours(0, 0, 0, 0);
                    
                    return dataAgendamento.getTime() === amanha.getTime();
                });

                if (agendamentosParaLembrar.length > 0) {
                    const mensagem = `Voc√™ tem ${agendamentosParaLembrar.length} agendamento(s) para amanh√£. Deseja enviar lembretes via WhatsApp?`;
                    
                    if (confirm(mensagem)) {
                        for (const agendamento of agendamentosParaLembrar) {
                            await this.enviarLembreteAgendamento(agendamento.id);
                        }
                    }
                }
            }

            async enviarLembreteAgendamento(agendamentoId) {
                const agendamento = this.dados.agendamentos.find(a => a.id === agendamentoId);
                if (!agendamento) return;

                const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                
                // Garantir lista atualizada e buscar ve√≠culo de forma flex√≠vel
                this.reconstruirListaVeiculos();
                const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                
                if (!cliente || !veiculo) return;

                const dataHora = agendamento.data 
                    ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                      (agendamento.hora ? ' √†s ' + agendamento.hora.substring(0, 5) : '')
                    : '-';

                const mensagem = `Ol√° ${cliente.nome}! üëã

                ‚è∞ *Lembrete de Agendamento*

                    Seu agendamento est√° marcado para *AMANH√É*:

                üìÖ *Data/Hora:* ${dataHora}
                üöó *Ve√≠culo:* ${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}
                üîß *Problema:* ${agendamento.problema}

                Nos vemos amanh√£! üòä`;

                const numero = cliente.whatsapp.replace(/\D/g, '');
                openWhatsAppFallback(numero, mensagem);
                
                try {
                    await this.atualizarAgendamentoServidor(agendamento.id, { lembreteEnviado: true });
                } catch (error) {
                    this.log(`N√£o foi poss√≠vel registrar o lembrete do agendamento #${agendamento.numero || agendamento.id}: ${error.message}`, 'warning');
                }
                this.log(`Lembrete enviado para ${cliente.nome}`, 'success');
            }

            atualizarServicos() {
                // Implementar atualiza√ß√£o de servi√ßos
            }

            configurarNavegacao() {
                const navItems = document.querySelectorAll('.nav-item');
                const sections = document.querySelectorAll('.section');
                const sectionTitle = document.getElementById('section-title');
                const sectionDescription = document.getElementById('section-description');

                const sectionTitles = {
                    dashboard: { title: 'Dashboard', desc: 'Vis√£o geral do sistema NegoCar' },
                    clientes: { title: 'Gerenciar Clientes', desc: 'Cadastro e gest√£o de clientes' },
                    veiculos: { title: 'Frota de Ve√≠culos', desc: 'Gest√£o da frota de ve√≠culos' },
                    orcamentos: { title: 'Gerenciar Or√ßamentos', desc: 'Cria√ß√£o e acompanhamento de or√ßamentos' },
                    agendamentos: { title: 'Agendamentos', desc: 'Gest√£o de agendamentos de servi√ßos' },
                    financeiro: { title: 'Financeiro', desc: 'Controle financeiro e relat√≥rios' },
                    configuracoes: { title: 'Configura√ß√µes', desc: 'Configura√ß√µes do sistema' }
                };

                navItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const sectionId = item.getAttribute('data-section');

                        // Se for o m√≥dulo financeiro, abrimos em nova aba (m√≥dulo separado)
                        if (sectionId === 'financeiro') {
                            // Marca o item como ativo visualmente
                            navItems.forEach(nav => nav.classList.remove('active'));
                            item.classList.add('active');
                            // Abrir o m√≥dulo financeiro em nova aba (arquivo separado)
                            window.open('/modulo-financeiro.html', '_blank');
                            // Atualiza t√≠tulo/descri√ß√£o localmente
                            const sectionInfo = sectionTitles[sectionId];
                            if (sectionInfo) {
                                sectionTitle.textContent = sectionInfo.title;
                                sectionDescription.textContent = sectionInfo.desc;
                            }
                            return; // n√£o tenta alternar se√ß√µes internas
                        }

                        // Atualizar navega√ß√£o (para se√ß√µes internas)
                        navItems.forEach(nav => nav.classList.remove('active'));
                        item.classList.add('active');

                        // Atualizar conte√∫do
                        sections.forEach(section => section.classList.remove('active'));
                        const targetSection = document.getElementById(sectionId);
                        if (targetSection) {
                            targetSection.classList.add('active');
                        }

                        // Atualizar t√≠tulo e descri√ß√£o
                        const sectionInfo = sectionTitles[sectionId];
                        if (sectionInfo) {
                            sectionTitle.textContent = sectionInfo.title;
                            sectionDescription.textContent = sectionInfo.desc;
                        }

                        // Atualizar dados espec√≠ficos da se√ß√£o
                        if (sectionId === 'orcamentos') {
                            this.aplicarFiltroOrcamento('pendentes');
                            this.atualizarOrcamentos();
                        }

                        if (sectionId === 'financeiro') {
                            this.atualizarFinanceiro();
                        }

                        if (sectionId === 'agendamentos') {
                            this.aplicarFiltroAgendamento('pendente');
                            this.atualizarAgendamentos();
                        }

                        if (sectionId === 'ordens-servico') {
                            this.aplicarFiltroOS('pendente');
                            this.atualizarOrdensServico();
                        }
                    });
                });
            }

            configurarEventListeners() {
                // Formul√°rio de cliente
                document.getElementById('form-cliente').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.salvarCliente();
                });

                // Formul√°rio de ve√≠culo
                document.getElementById('form-veiculo').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.salvarVeiculo();
                });

                // Formul√°rio de or√ßamento
                document.getElementById('form-orcamento').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.gerarOrcamento();
                });

                // Formul√°rio de agendamento
                document.getElementById('form-agendamento').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.salvarAgendamento();
                });

                // Formul√°rio de transa√ß√£o
                document.getElementById('form-transacao').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.salvarTransacao();
                });
            }

            atualizarTotalOrcamento() {
                let total = 0;
                
                // Calcular total de servi√ßos (nova estrutura)
                const servicosLista = document.querySelectorAll('.servico-lista-item');
                servicosLista.forEach(item => {
                    const valor = parseFloat(item.dataset.valor) || 0;
                    total += valor;
                });
                
                // Calcular total de pe√ßas (nova estrutura)
                const pecasLista = document.querySelectorAll('.peca-lista-item');
                pecasLista.forEach(item => {
                    const valorTotal = parseFloat(item.dataset.valorTotal) || 0;
                    total += valorTotal;
                });
                
                // Atualizar total da pe√ßa quando digita
                const qtdeInput = document.getElementById('peca-qtde-input');
                const valorUnitarioInput = document.getElementById('peca-valor-unitario-input');
                const totalInput = document.getElementById('peca-total-input');
                
                if (qtdeInput && valorUnitarioInput && totalInput) {
                    const qtde = parseFloat(qtdeInput.value) || 0;
                    const valorUnit = parseFloat(valorUnitarioInput.value) || 0;
                    const totalPeca = qtde * valorUnit;
                    totalInput.value = totalPeca > 0 ? `R$ ${totalPeca.toFixed(2)}` : '';
                }

                document.getElementById('orcamento-total').textContent = `R$ ${total.toFixed(2)}`;
            }

            adicionarServicoRapido() {
                const descricao = document.getElementById('servico-descricao-input').value.trim();
                const valor = parseFloat(document.getElementById('servico-valor-input').value) || 0;

                if (!descricao || valor <= 0) {
                    alert('Preencha a descri√ß√£o e o valor do servi√ßo');
                    return;
                }

                const container = document.getElementById('servicos-lista-container');
                const servicoHTML = `
                    <div class="servico-lista-item" data-descricao="${descricao.replace(/"/g, '&quot;')}" data-valor="${valor}" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--warning-color);">
                        <span>${descricao} - R$ ${valor.toFixed(2)}</span>
                        <button type="button" class="btn btn-danger btn-sm" onclick="sistema.removerServicoLista(this)" style="padding: 2px 8px; font-size: 12px;">√ó</button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', servicoHTML);

                // Limpar campos
                document.getElementById('servico-descricao-input').value = '';
                document.getElementById('servico-valor-input').value = '';
                document.getElementById('servico-descricao-input').focus();

                this.atualizarTotalOrcamento();
            }

            removerServicoLista(button) {
                button.closest('.servico-lista-item').remove();
                this.atualizarTotalOrcamento();
            }

            adicionarPecaRapido() {
                const nome = document.getElementById('peca-nome-input').value.trim();
                const qtde = parseFloat(document.getElementById('peca-qtde-input').value) || 0;
                const valorUnit = parseFloat(document.getElementById('peca-valor-unitario-input').value) || 0;

                if (!nome || qtde <= 0 || valorUnit <= 0) {
                    alert('Preencha todos os campos da pe√ßa');
                    return;
                }

                const valorTotal = qtde * valorUnit;
                const container = document.getElementById('pecas-lista-container');
                const pecaHTML = `
                    <div class="peca-lista-item" data-item="${nome.replace(/"/g, '&quot;')}" data-quantidade="${qtde}" data-valor="${valorUnit}" data-valor-total="${valorTotal}" style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #f0f8ff; border-radius: 4px; margin-bottom: 5px; border-left: 3px solid var(--secondary-color);">
                        <span>${nome} - ${qtde}x - R$ ${valorUnit.toFixed(2)} = R$ ${valorTotal.toFixed(2)}</span>
                        <button type="button" class="btn btn-danger btn-sm" onclick="sistema.removerPecaLista(this)" style="padding: 2px 8px; font-size: 12px;">√ó</button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', pecaHTML);

                // Limpar campos
                document.getElementById('peca-nome-input').value = '';
                document.getElementById('peca-qtde-input').value = '1';
                document.getElementById('peca-valor-unitario-input').value = '';
                document.getElementById('peca-total-input').value = '';
                document.getElementById('peca-nome-input').focus();

                this.atualizarTotalOrcamento();
            }

            removerPecaLista(button) {
                button.closest('.peca-lista-item').remove();
                this.atualizarTotalOrcamento();
            }

            async carregarDadosIniciais() {
                // Carregar dados do localStorage
                Object.keys(this.dados).forEach(key => {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            this.dados[key] = JSON.parse(stored);
                        } catch (error) {
                            console.error(`Erro ao carregar ${key} do localStorage:`, error);
                            this.dados[key] = Array.isArray(this.dados[key]) ? [] : {};
                        }
                    }
                });

                // Sincronizar clientes primeiro e reconstruir lista de ve√≠culos
                await this.sincronizarClientesComServidor();
                this.reconstruirListaVeiculos();
                
                // Sincronizar agendamentos (que dependem de ve√≠culos)
                await this.sincronizarAgendamentosComServidor();
                // Reconstruir lista novamente ap√≥s sincronizar agendamentos
                this.reconstruirListaVeiculos();
                
                // Sincronizar or√ßamentos e O.S.
                await this.sincronizarOrcamentosComServidor();
                await this.sincronizarOrdensServicoComServidor();
                await this.sincronizarTransacoesComServidor();
                
                // Reconstruir lista de ve√≠culos uma √∫ltima vez para garantir consist√™ncia
                this.reconstruirListaVeiculos();
                
                // Atualizar todas as visualiza√ß√µes
                this.atualizarTodosDados();
                this.log('Dados iniciais carregados', 'info');
            }

            salvarConfiguracoes() {
                const apiUrl = document.getElementById('api-url').value;
                const modoOperacao = document.getElementById('modo-operacao').value;
                
                this.config.apiBaseUrl = apiUrl;
                this.config.modoOperacao = modoOperacao;
                
                localStorage.setItem('config', JSON.stringify(this.config));
                this.log('Configura√ß√µes salvas com sucesso', 'success');
            }

            log(message, type = 'info') {
                const console = document.getElementById('system-console');
                const time = new Date().toLocaleTimeString();
                const typeClass = `log-${type}`;
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <span class="log-time">[${time}]</span>
                    <span class="${typeClass}">${message}</span>
                `;
                
                console.appendChild(logEntry);
                console.scrollTop = console.scrollHeight;
            }

            editarCliente(id) {
                const cliente = this.dados.clientes.find(c => c.id === id);
                if (!cliente) {
                    this.log('Cliente n√£o encontrado', 'error');
                    return;
                }

                // preencher modal com dados do cliente
                document.getElementById('cliente-nome').value = cliente.nome;
                document.getElementById('cliente-whatsapp').value = cliente.whatsapp;
                if (cliente.endereco) {
                    document.getElementById('cliente-cep').value = cliente.endereco.cep || '';
                    document.getElementById('cliente-logradouro').value = cliente.endereco.logradouro || '';
                    document.getElementById('cliente-numero').value = cliente.endereco.numero || '';
                    document.getElementById('cliente-complemento').value = cliente.endereco.complemento || '';
                    document.getElementById('cliente-bairro').value = cliente.endereco.bairro || '';
                    document.getElementById('cliente-cidade').value = cliente.endereco.cidade || '';
                    document.getElementById('cliente-estado').value = cliente.endereco.estado || '';
                }

                // popular ve√≠culos no modal
                const container = document.getElementById('veiculos-container');
                container.innerHTML = '';
                (cliente.veiculos || []).forEach((v, i) => {
                    adicionarVeiculo(); // cria um bloco novo
                    const last = container.lastElementChild;
                    if (last) {
                        last.dataset.veiculoId = v.id || '';
                    }
                    last.querySelector('.veiculo-placa').value = v.placa || '';
                    last.querySelector('.veiculo-marca').value = v.marca || '';
                    last.querySelector('.veiculo-modelo').value = v.modelo || '';
                    last.querySelector('.veiculo-ano').value = v.ano || '';
                });

                // marcar formul√°rio como edi√ß√£o
                const form = document.getElementById('form-cliente');
                form.dataset.editId = id;
                abrirModalCliente();
            }

            async excluirCliente(id) {
                if (!confirm('Deseja realmente excluir este cliente e todos os ve√≠culos relacionados?')) return;
                try {
                    await this.apiRequest(`/clientes/${id}`, { method: 'DELETE' });
                    await this.sincronizarClientesComServidor();
                this.atualizarTodosDados();
                this.log('Cliente e ve√≠culos removidos com sucesso', 'warning');
                } catch (error) {
                    this.log(`Erro ao excluir cliente: ${error.message}`, 'error');
                    alert(error.message);
                }
            }

            // ---------- FINANCEIRO ----------
            normalizarTransacao(transacao) {
                return {
                    ...transacao,
                    orcamentoId: transacao.orcamentoId ?? transacao.orcamento_id ?? null,
                    clienteId: transacao.clienteId ?? transacao.cliente_id ?? null,
                    categoriaId: transacao.categoriaId ?? transacao.categoria_id ?? null,
                    parcelaDe: transacao.parcelaDe ?? transacao.parcela_de ?? null,
                    numeroParcela: transacao.numeroParcela ?? transacao.numero_parcela ?? null,
                    totalParcelas: transacao.totalParcelas ?? transacao.total_parcelas ?? null,
                    isDuplicata: transacao.isDuplicata ?? transacao.is_duplicata ?? false,
                    numeroDuplicata: transacao.numeroDuplicata ?? transacao.numero_duplicata ?? null,
                    formaPagamento: transacao.formaPagamento ?? transacao.forma_pagamento ?? null,
                    parcelado: transacao.parcelado ?? false,
                    numParcelas: transacao.numParcelas ?? transacao.num_parcelas ?? null,
                    confirmadoEm: transacao.confirmadoEm ?? transacao.confirmado_em ?? null,
                    criadoEm: transacao.criadoEm ?? transacao.criado_em ?? new Date().toISOString()
                };
            }

            criarPayloadTransacao(transacao) {
                return {
                    id: transacao.id,
                    orcamentoId: transacao.orcamentoId || null,
                    clienteId: transacao.clienteId || null,
                    categoriaId: transacao.categoriaId || null,
                    descricao: transacao.descricao || '',
                    tipo: transacao.tipo || 'receita',
                    valor: parseFloat(transacao.valor) || 0,
                    data: transacao.data || new Date().toISOString().split('T')[0],
                    status: transacao.status || 'pendente',
                    observacoes: transacao.observacoes || '',
                    parcelaDe: transacao.parcelaDe || null,
                    numeroParcela: transacao.numeroParcela || null,
                    totalParcelas: transacao.totalParcelas || null,
                    isDuplicata: transacao.isDuplicata || false,
                    numeroDuplicata: transacao.numeroDuplicata || null,
                    formaPagamento: transacao.formaPagamento || null,
                    parcelado: transacao.parcelado || false,
                    numParcelas: transacao.numParcelas || null,
                    confirmadoEm: transacao.confirmadoEm || null,
                    criadoEm: transacao.criadoEm || new Date().toISOString()
                };
            }

            async sincronizarTransacoesComServidor() {
                try {
                    let transacoesServidor = await this.apiRequest('/transacoes');

                    if ((!transacoesServidor || transacoesServidor.length === 0) && Array.isArray(this.dados.transacoes) && this.dados.transacoes.length > 0) {
                        for (const transacaoLocal of this.dados.transacoes) {
                            const payload = this.criarPayloadTransacao(transacaoLocal);
                            await this.apiRequest('/transacoes', { method: 'POST', data: payload });
                        }
                        transacoesServidor = await this.apiRequest('/transacoes');
                    }

                    if (transacoesServidor) {
                        this.dados.transacoes = transacoesServidor.map(t => this.normalizarTransacao(t));
                        this.salvarDados('transacoes');
                    }
                } catch (error) {
                    console.error('Falha ao sincronizar transa√ß√µes com o servidor:', error);
                    this.log(`N√£o foi poss√≠vel sincronizar transa√ß√µes: ${error.message}`, 'warning');
                }
            }

            async atualizarTransacaoServidor(id, updates = {}) {
                try {
                    const transacao = this.dados.transacoes.find(t => t.id === id);
                    if (!transacao) {
                        throw new Error('Transa√ß√£o n√£o encontrada');
                    }

                    const payload = this.criarPayloadTransacao({ ...transacao, ...updates });
                    await this.apiRequest(`/transacoes/${id}`, { method: 'PUT', data: payload });
                    await this.sincronizarTransacoesComServidor();
                    return true;
                } catch (error) {
                    console.error('Erro ao atualizar transa√ß√£o no servidor:', error);
                    throw error;
                }
            }

            async adicionarTransacao(dados) {
                try {
                // Gerar ID √∫nico para cada transa√ß√£o (especialmente importante para parcelas)
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 1000000);
                const id = timestamp * 1000 + random;
                
                const transacao = {
                    id: id,
                    orcamentoId: dados.orcamentoId || null,
                    clienteId: dados.clienteId || null,
                    descricao: dados.descricao,
                    tipo: dados.tipo || 'receita',
                    valor: parseFloat(dados.valor) || 0,
                    data: dados.data || new Date().toISOString().split('T')[0],
                    status: dados.status || 'pendente',
                    observacoes: dados.observacoes || '',
                        categoriaId: dados.categoriaId || null,
                        parcelaDe: dados.parcelaDe || null,
                        numeroParcela: dados.numeroParcela || null,
                        totalParcelas: dados.totalParcelas || null,
                        isDuplicata: dados.isDuplicata || false,
                        numeroDuplicata: dados.numeroDuplicata || null,
                        formaPagamento: dados.formaPagamento || null,
                        parcelado: dados.parcelado || false,
                        numParcelas: dados.numParcelas || null,
                        confirmadoEm: dados.confirmadoEm || null,
                    criadoEm: new Date().toISOString()
                };

                    // Registrar hist√≥rico
                    this.registrarHistoricoTransacao({
                        acao: 'criacao',
                        transacaoId: id,
                        dados: { ...transacao }
                    });

                    // Salvar no servidor
                    const payload = this.criarPayloadTransacao(transacao);
                    await this.apiRequest('/transacoes', { method: 'POST', data: payload });
                    
                    // Sincronizar para atualizar estado local
                    await this.sincronizarTransacoesComServidor();
                this.atualizarFinanceiro();
                this.log(`Transa√ß√£o criada: ${transacao.descricao}`, 'success');
                return transacao;
                } catch (error) {
                    console.error('Erro ao adicionar transa√ß√£o:', error);
                    this.log(`Erro ao criar transa√ß√£o: ${error.message}`, 'error');
                    throw error;
                }
            }

            registrarHistoricoTransacao(registro) {
                const historico = {
                    id: Date.now(),
                    data: new Date().toISOString(),
                    ...registro
                };
                
                this.dados.historicoTransacoes.push(historico);
                // Manter apenas √∫ltimos 1000 registros
                if (this.dados.historicoTransacoes.length > 1000) {
                    this.dados.historicoTransacoes = this.dados.historicoTransacoes.slice(-1000);
                }
                this.salvarDados('historicoTransacoes');
            }

            async salvarTransacao() {
                try {
                    const tipo = document.getElementById('transacao-tipo').value;
                    const nomeCliente = document.getElementById('transacao-cliente')?.value?.trim();
                    const orcamentoId = document.getElementById('transacao-orcamento')?.value;
                    const parcelado = document.getElementById('transacao-parcelado')?.checked || false;
                    const numParcelas = parcelado ? parseInt(document.getElementById('transacao-num-parcelas')?.value) : 1;
                    const dataPrimeiraParcela = document.getElementById('transacao-data-primeira-parcela')?.value;
                    const data = document.getElementById('transacao-data').value;
                    const descricao = document.getElementById('transacao-descricao').value.trim();
                    const valor = parseFloat(document.getElementById('transacao-valor').value);
                    const status = document.getElementById('transacao-status').value;
                    const observacoes = document.getElementById('transacao-observacoes').value.trim();

                    // Valida√ß√µes
                    if (!descricao) throw new Error('Descri√ß√£o √© obrigat√≥ria');
                    if (!valor || valor <= 0) throw new Error('Valor deve ser maior que zero');
                    
                    let clienteId = null;
                    const temEntrada = document.getElementById('transacao-entrada')?.checked || false;
                    const valorEntrada = temEntrada ? parseFloat(document.getElementById('transacao-valor-entrada')?.value || 0) : 0;
                    
                    if (tipo === 'receita') {
                        if (!nomeCliente) throw new Error('Selecione um cliente para receita');
                        
                        // Buscar cliente pelo nome
                        const cliente = this.dados.clientes.find(c => 
                            c.nome.toLowerCase().trim() === nomeCliente.toLowerCase().trim()
                        );
                        
                        if (!cliente) {
                            throw new Error(`Cliente "${nomeCliente}" n√£o encontrado. Por favor, selecione um cliente da lista.`);
                        }
                        
                        clienteId = cliente.id;
                        
                        // Verificar se est√° tentando criar duplicata para or√ßamento que j√° tem
                        if (orcamentoId) {
                            const duplicataExistente = this.dados.transacoes.find(t => 
                                t.orcamentoId === parseInt(orcamentoId) && !t.parcelaDe
                            );
                            if (duplicataExistente) {
                                throw new Error(`Este or√ßamento j√° possui uma duplicata no financeiro (${duplicataExistente.descricao}). N√£o √© poss√≠vel criar outra.`);
                            }
                        }
                        
                        // Valida√ß√µes de entrada
                        if (temEntrada) {
                            if (!valorEntrada || valorEntrada <= 0) throw new Error('Informe o valor da entrada');
                            if (valorEntrada >= valor) throw new Error('Valor da entrada n√£o pode ser maior ou igual ao valor total');
                        }
                        
                        if (parcelado) {
                            if (!numParcelas || numParcelas < 2) throw new Error('N√∫mero de parcelas deve ser pelo menos 2');
                            if (!dataPrimeiraParcela) throw new Error('Informe a data da primeira parcela');
                        }
                    }

                    // Se for receita com entrada, criar transa√ß√£o de entrada primeiro
                    if (tipo === 'receita' && temEntrada) {
                        const dadosEntrada = {
                            tipo: 'receita',
                            data: data,
                            descricao: `${descricao} - Entrada`,
                            valor: valorEntrada,
                            status: 'confirmado', // Entrada geralmente j√° √© confirmada
                            observacoes: observacoes ? `${observacoes}\nEntrada paga` : 'Entrada paga',
                            orcamentoId: orcamentoId || null,
                            clienteId: clienteId || null
                        };
                        await this.adicionarTransacao(dadosEntrada);
                    }

                    // Calcular valor restante ap√≥s entrada
                    const valorRestante = tipo === 'receita' && temEntrada ? valor - valorEntrada : valor;

                    // Se for parcelado, criar m√∫ltiplas transa√ß√µes para o valor restante
                    if (parcelado && tipo === 'receita' && valorRestante > 0) {
                        const valorParcela = parseFloat((valorRestante / numParcelas).toFixed(2));
                        // Ajustar √∫ltima parcela para compensar poss√≠veis arredondamentos
                        const valorUltimaParcela = valorRestante - (valorParcela * (numParcelas - 1));

                        const dataBase = new Date(dataPrimeiraParcela + 'T00:00:00');

                        // Criar duplicata-mestre para agrupar parcelas
                        const masterDescricao = `${descricao} - Parcelado (${numParcelas}x)`;
                        const masterDados = {
                            tipo: 'receita',
                            data: data, // data da duplicata pode ser a data inicial
                            descricao: masterDescricao,
                            valor: valorRestante,
                            status: 'parcelado',
                            observacoes: observacoes ? `${observacoes}\nParcelado em ${numParcelas}x` : `Parcelado em ${numParcelas}x`,
                            orcamentoId: orcamentoId || null,
                            clienteId: clienteId || null,
                            isDuplicata: true,
                            totalParcelas: numParcelas
                        };

                        const master = await this.adicionarTransacao(masterDados);

                        for (let i = 0; i < numParcelas; i++) {
                            // Calcular data da parcela (adicionar meses de forma segura)
                            const dataParcela = new Date(dataBase);
                            dataParcela.setMonth(dataParcela.getMonth() + i);

                            // Usar valor da √∫ltima parcela ajustado
                            const valorFinal = i === numParcelas - 1 ? valorUltimaParcela : valorParcela;

                            const dadosParcela = {
                                tipo,
                                data: dataParcela.toISOString().split('T')[0],
                                descricao: `${descricao} - Parcela ${i + 1}/${numParcelas}`,
                                valor: valorFinal,
                                status: 'pendente',
                                observacoes: observacoes ? `${observacoes}\nParcela ${i + 1} de ${numParcelas}` : `Parcela ${i + 1} de ${numParcelas}`,
                                orcamentoId: orcamentoId || null,
                                clienteId: clienteId || null,
                                parcelaDe: master.id,
                                numeroParcela: i + 1,
                                totalParcelas: numParcelas
                            };

                            await this.adicionarTransacao(dadosParcela);
                        }

                        const mensagem = temEntrada 
                            ? `Entrada e ${numParcelas} parcelas criadas com sucesso!`
                            : `${numParcelas} parcelas criadas com sucesso!`;
                        this.log(mensagem, 'success');
                    } else if (tipo === 'receita' && valorRestante > 0) {
                        // Transa√ß√£o √∫nica para o valor restante (se houver entrada, sen√£o √© o valor total)
                        const dados = {
                            tipo,
                            data,
                            descricao: temEntrada ? `${descricao} - Restante` : descricao,
                            valor: valorRestante,
                            status,
                            observacoes,
                            orcamentoId: orcamentoId || null,
                            clienteId: clienteId || null
                        };
                        
                        await this.adicionarTransacao(dados);
                    } else if (tipo === 'despesa') {
                        // Transa√ß√£o de despesa
                        const categoriaId = document.getElementById('transacao-categoria')?.value;
                        const descricaoDespesa = document.getElementById('transacao-descricao-despesa')?.value.trim();
                        const valorDespesa = parseFloat(document.getElementById('transacao-valor-despesa')?.value || 0);
                        const statusDespesa = document.getElementById('transacao-status-despesa')?.value || 'pendente';
                        const observacoesDespesa = document.getElementById('transacao-observacoes-despesa')?.value.trim() || '';
                        
                        if (!descricaoDespesa) throw new Error('Descri√ß√£o √© obrigat√≥ria');
                        if (!valorDespesa || valorDespesa <= 0) throw new Error('Valor deve ser maior que zero');
                        
                        const dados = {
                            tipo,
                            data,
                            descricao: descricaoDespesa,
                            valor: valorDespesa,
                            status: statusDespesa,
                            observacoes: observacoesDespesa,
                            categoriaId: categoriaId ? parseInt(categoriaId) : null
                        };
                        
                        await this.adicionarTransacao(dados);
                    }
                    
                    fecharModalTransacao();
                    this.log('Transa√ß√£o(s) salva(s) com sucesso!', 'success');
                    return true;
                } catch (error) {
                    this.log(`Erro ao salvar transa√ß√£o: ${error.message}`, 'error');
                    alert(error.message);
                    return false;
                }
            }

            alterarTipoTransacao() {
                const tipo = document.getElementById('transacao-tipo').value;
                const camposReceita = document.getElementById('campos-receita');
                const camposDespesa = document.getElementById('campos-despesa');
                const inputCliente = document.getElementById('transacao-cliente');
                const selectCategoria = document.getElementById('transacao-categoria');
                const tituloModal = document.getElementById('modal-transacao-titulo');
                const iconModal = document.getElementById('modal-transacao-icon');
                
                if (tipo === 'receita') {
                    camposReceita.style.display = 'block';
                    camposDespesa.style.display = 'none';
                    // Atualizar t√≠tulo do modal
                    tituloModal.textContent = 'Nova Receita (Duplicata)';
                    iconModal.textContent = '+';
                    // Tornar campo cliente obrigat√≥rio
                    inputCliente.required = true;
                    selectCategoria.required = false;
                    // Carregar clientes no datalist
                    this.carregarClientesTransacao();
                    // Atualizar resumo financeiro
                    this.atualizarResumoFinanceiro();
                } else {
                    camposReceita.style.display = 'none';
                    camposDespesa.style.display = 'block';
                    // Atualizar t√≠tulo do modal
                    tituloModal.textContent = 'Nova Transa√ß√£o';
                    iconModal.textContent = '';
                    // Remover obrigatoriedade do campo cliente
                    inputCliente.required = false;
                    selectCategoria.required = true;
                    // Limpar campos de receita
                    inputCliente.value = '';
                    document.getElementById('campo-orcamento').style.display = 'none';
                    document.getElementById('transacao-orcamento').value = '';
                    document.getElementById('transacao-parcelado').checked = false;
                    document.getElementById('transacao-entrada').checked = false;
                    this.toggleParcelado();
                    this.toggleEntrada();
                    // Carregar categorias
                    this.carregarCategoriasTransacao();
                }
            }

            toggleEntrada() {
                const entrada = document.getElementById('transacao-entrada').checked;
                const camposEntrada = document.getElementById('campos-entrada');
                
                if (entrada) {
                    camposEntrada.style.display = 'block';
                } else {
                    camposEntrada.style.display = 'none';
                    document.getElementById('transacao-valor-entrada').value = '';
                }
                this.atualizarResumoFinanceiro();
            }

            atualizarResumoFinanceiro() {
                const resumoFinanceiro = document.getElementById('resumo-financeiro');
                if (!resumoFinanceiro || resumoFinanceiro.offsetParent === null) {
                    return; // Se o resumo n√£o estiver vis√≠vel, n√£o atualizar
                }

                // Obter valor total do or√ßamento
                const valorTotalInput = document.getElementById('transacao-valor');
                const valorTotal = parseFloat(valorTotalInput?.value || 0);

                // Obter valor da entrada
                const entradaCheckbox = document.getElementById('transacao-entrada');
                const valorEntradaInput = document.getElementById('transacao-valor-entrada');
                const temEntrada = entradaCheckbox?.checked || false;
                const valorEntrada = temEntrada ? parseFloat(valorEntradaInput?.value || 0) : 0;

                // Calcular valor restante
                const valorRestante = valorTotal - valorEntrada;

                // Atualizar exibi√ß√£o
                document.getElementById('resumo-valor-total').textContent = `R$ ${valorTotal.toFixed(2)}`;
                document.getElementById('resumo-entrada').textContent = `R$ ${valorEntrada.toFixed(2)}`;
                document.getElementById('resumo-valor-restante').textContent = `R$ ${Math.max(0, valorRestante).toFixed(2)}`;
            }

            carregarCategoriasTransacao() {
                const select = document.getElementById('transacao-categoria');
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                this.dados.categoriasDespesas.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.id;
                    option.textContent = categoria.nome;
                    select.appendChild(option);
                });
            }

            abrirModalCategorias() {
                document.getElementById('modal-categorias').style.display = 'block';
                this.atualizarListaCategorias();
            }

            fecharModalCategorias() {
                document.getElementById('modal-categorias').style.display = 'none';
                document.getElementById('nova-categoria-nome').value = '';
            }

            atualizarListaCategorias() {
                const container = document.getElementById('lista-categorias');
                container.innerHTML = '';
                
                if (this.dados.categoriasDespesas.length === 0) {
                    container.innerHTML = '<p style="color: #666; padding: 10px;">Nenhuma categoria cadastrada</p>';
                    return;
                }
                
                this.dados.categoriasDespesas.forEach(categoria => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;';
                    
                    const nome = document.createElement('span');
                    nome.textContent = categoria.nome;
                    if (categoria.padrao) {
                        nome.style.fontWeight = 'bold';
                        nome.textContent += ' (Padr√£o)';
                    }
                    
                    const botoes = document.createElement('div');
                    botoes.style.cssText = 'display: flex; gap: 5px;';
                    
                    if (!categoria.padrao) {
                        const btnExcluir = document.createElement('button');
                        btnExcluir.className = 'btn btn-sm btn-danger';
                        btnExcluir.textContent = 'üóëÔ∏è Excluir';
                        btnExcluir.onclick = () => this.excluirCategoria(categoria.id);
                        botoes.appendChild(btnExcluir);
                    }
                    
                    div.appendChild(nome);
                    div.appendChild(botoes);
                    container.appendChild(div);
                });
            }

            adicionarCategoria() {
                const nome = document.getElementById('nova-categoria-nome').value.trim();
                if (!nome) {
                    alert('Informe o nome da categoria');
                    return;
                }
                
                // Verificar se j√° existe
                if (this.dados.categoriasDespesas.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                    alert('Esta categoria j√° existe');
                    return;
                }
                
                // Gerar ID √∫nico
                const novoId = this.dados.categoriasDespesas.length > 0 
                    ? Math.max(...this.dados.categoriasDespesas.map(c => c.id)) + 1 
                    : 4;
                
                this.dados.categoriasDespesas.push({
                    id: novoId,
                    nome: nome,
                    padrao: false
                });
                
                this.salvarDados('categoriasDespesas');
                document.getElementById('nova-categoria-nome').value = '';
                this.atualizarListaCategorias();
                this.log(`Categoria "${nome}" adicionada`, 'success');
            }

            excluirCategoria(id) {
                const categoria = this.dados.categoriasDespesas.find(c => c.id === id);
                if (!categoria) return;
                
                if (categoria.padrao) {
                    alert('N√£o √© poss√≠vel excluir categorias padr√£o');
                    return;
                }
                
                // Verificar se h√° transa√ß√µes usando esta categoria
                const transacoesComCategoria = this.dados.transacoes.filter(t => 
                    t.categoriaId === id && t.tipo === 'despesa'
                );
                
                if (transacoesComCategoria.length > 0) {
                    alert(`N√£o √© poss√≠vel excluir esta categoria. Existem ${transacoesComCategoria.length} transa√ß√£o(√µes) vinculada(s) a ela.`);
                    return;
                }
                
                if (!confirm(`Deseja realmente excluir a categoria "${categoria.nome}"?`)) {
                    return;
                }
                
                this.dados.categoriasDespesas = this.dados.categoriasDespesas.filter(c => c.id !== id);
                this.salvarDados('categoriasDespesas');
                this.atualizarListaCategorias();
                this.log(`Categoria "${categoria.nome}" exclu√≠da`, 'warning');
            }

            carregarClientesTransacao() {
                const datalist = document.getElementById('transacao-clientes-list');
                datalist.innerHTML = '';
                
                // Filtrar apenas clientes que tenham or√ßamentos aprovados com O.S finalizadas e que ainda n√£o foram lan√ßados no financeiro
                const clientesComOrcamentosDisponiveis = this.dados.clientes.filter(cliente => {
                    // Buscar or√ßamentos aprovados do cliente
                    const orcamentosAprovados = this.dados.orcamentos.filter(o => 
                        (o.clienteId === cliente.id || o.cliente_id === cliente.id) && 
                        o.status === 'aprovado'
                    );
                    
                    if (orcamentosAprovados.length === 0) {
                        return false; // Cliente n√£o tem or√ßamentos aprovados
                    }
                    
                    // Verificar se algum or√ßamento tem O.S finalizada e ainda n√£o foi lan√ßado no financeiro
                    const temOrcamentoDisponivel = orcamentosAprovados.some(orcamento => {
                        // Buscar O.S vinculada a este or√ßamento
                        const os = this.dados.ordensServico.find(os => 
                            (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                        );
                        
                        // Verificar se a O.S existe e est√° finalizada
                        if (!os || os.status !== 'finalizada') {
                            return false; // N√£o incluir se n√£o tiver O.S ou se a O.S n√£o estiver finalizada
                        }
                        
                        // Verificar se j√° existe transa√ß√£o vinculada a este or√ßamento
                        const temTransacao = this.dados.transacoes.some(t => 
                            (t.orcamentoId === orcamento.id || t.orcamento_id === orcamento.id) && !t.parcelaDe
                        );
                        
                        return !temTransacao; // Retorna true se N√ÉO tem transa√ß√£o (n√£o foi lan√ßado)
                    });
                    
                    return temOrcamentoDisponivel; // Incluir cliente apenas se tiver or√ßamento dispon√≠vel
                });
                
                // Popular datalist com nomes dos clientes dispon√≠veis
                clientesComOrcamentosDisponiveis.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nome;
                    option.dataset.clienteId = cliente.id; // Armazenar ID para uso posterior
                    datalist.appendChild(option);
                });
            }

            buscarClientePorNome(nomeCliente) {
                const campoOrcamento = document.getElementById('campo-orcamento');
                
                if (!nomeCliente || nomeCliente.trim() === '') {
                    // Limpar campo de or√ßamentos se n√£o houver cliente selecionado
                    if (campoOrcamento) {
                        campoOrcamento.style.display = 'none';
                    }
                    const selectOrcamento = document.getElementById('transacao-orcamento');
                    if (selectOrcamento) {
                        selectOrcamento.value = '';
                    }
                    return;
                }
                
                // Buscar cliente pelo nome (busca case-insensitive e parcial)
                const cliente = this.dados.clientes.find(c => 
                    c.nome.toLowerCase().trim() === nomeCliente.toLowerCase().trim()
                );
                
                if (cliente) {
                    // Cliente encontrado, exibir campo imediatamente e carregar or√ßamentos
                    if (campoOrcamento) {
                        campoOrcamento.style.display = 'block';
                        campoOrcamento.style.visibility = 'visible';
                        campoOrcamento.classList.remove('hidden');
                    }
                    // Carregar or√ßamentos automaticamente
                    this.carregarOrcamentosCliente(cliente.id);
                } else {
                    // Cliente n√£o encontrado, ocultar campo de or√ßamentos
                    if (campoOrcamento) {
                        campoOrcamento.style.display = 'none';
                    }
                    const selectOrcamento = document.getElementById('transacao-orcamento');
                    if (selectOrcamento) {
                        selectOrcamento.value = '';
                    }
                }
            }

            carregarOrcamentosCliente(clienteId) {
                const campoOrcamento = document.getElementById('campo-orcamento');
                const selectOrcamento = document.getElementById('transacao-orcamento');
                
                if (!campoOrcamento || !selectOrcamento) {
                    console.error('Elementos do campo de or√ßamento n√£o encontrados');
                    return;
                }
                
                selectOrcamento.innerHTML = '<option value="">Selecione um or√ßamento</option>';
                
                if (!clienteId) {
                    campoOrcamento.style.display = 'none';
                    return;
                }
                
                // SEMPRE mostrar o campo quando h√° um cliente selecionado
                campoOrcamento.style.display = 'block';
                campoOrcamento.style.visibility = 'visible';
                campoOrcamento.classList.remove('hidden');
                
                // Buscar or√ßamentos aprovados do cliente
                const orcamentosAprovados = this.dados.orcamentos.filter(o => 
                    (o.clienteId === parseInt(clienteId) || o.cliente_id === parseInt(clienteId)) && 
                    o.status === 'aprovado'
                );
                
                // Filtrar apenas or√ßamentos que tenham O.S finalizadas e que ainda n√£o foram lan√ßados no financeiro
                const orcamentosComOSFinalizada = orcamentosAprovados.filter(orcamento => {
                    // Buscar O.S vinculada a este or√ßamento
                    const os = this.dados.ordensServico.find(os => 
                        (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                    );
                    
                    // Verificar se a O.S existe e est√° finalizada
                    if (!os || os.status !== 'finalizada') {
                        return false; // N√£o incluir se n√£o tiver O.S ou se a O.S n√£o estiver finalizada
                    }
                    
                    // Verificar se j√° existe transa√ß√£o vinculada a este or√ßamento
                    const temTransacao = this.dados.transacoes.some(t => 
                        (t.orcamentoId === orcamento.id || t.orcamento_id === orcamento.id) && !t.parcelaDe
                    );
                    
                    return !temTransacao; // Incluir apenas se N√ÉO tiver transa√ß√£o (n√£o foi lan√ßado)
                });
                
                if (orcamentosComOSFinalizada.length > 0) {
                    orcamentosComOSFinalizada.forEach(orcamento => {
                        const option = document.createElement('option');
                        option.value = orcamento.id;
                        // Buscar O.S para mostrar n√∫mero da O.S tamb√©m
                        const os = this.dados.ordensServico.find(os => 
                            (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                        );
                        const numeroOS = os ? ` (O.S. #${os.numero})` : '';
                        option.textContent = `Or√ßamento #${orcamento.numero}${numeroOS} - R$ ${(orcamento.total || orcamento.valor_total || 0).toFixed(2)}`;
                        selectOrcamento.appendChild(option);
                    });
                } else {
                    // Mostrar campo mesmo sem or√ßamentos, mas com mensagem
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhum or√ßamento aprovado com O.S finalizada dispon√≠vel';
                    option.disabled = true;
                    selectOrcamento.appendChild(option);
                }
                
                // Garantir que o campo est√° vis√≠vel
                campoOrcamento.style.display = 'block';
            }

            selecionarOrcamento(orcamentoId) {
                if (!orcamentoId) {
                    // Limpar campos se nenhum or√ßamento selecionado
                    document.getElementById('transacao-descricao').value = '';
                    document.getElementById('transacao-valor').value = '';
                    document.getElementById('transacao-observacoes').value = '';
                    document.getElementById('transacao-parcelado').checked = false;
                    document.getElementById('transacao-entrada').checked = false;
                    this.toggleParcelado();
                    this.toggleEntrada();
                    this.atualizarResumoFinanceiro();
                    return;
                }
                
                const orcamento = this.dados.orcamentos.find(o => o.id === parseInt(orcamentoId));
                if (!orcamento) return;
                
                // Verificar se j√° existe duplicata para este or√ßamento
                const duplicataExistente = this.dados.transacoes.find(t => 
                    (t.orcamentoId === orcamento.id || t.orcamento_id === orcamento.id) && !t.parcelaDe
                );
                
                if (duplicataExistente) {
                    alert(`Este or√ßamento j√° possui uma duplicata no financeiro (${duplicataExistente.descricao}). N√£o √© poss√≠vel criar outra manualmente.`);
                    document.getElementById('transacao-orcamento').value = '';
                    return;
                }
                
                // Buscar O.S vinculada para obter informa√ß√µes adicionais
                const os = this.dados.ordensServico.find(os => 
                    (os.orcamentoId === orcamento.id || os.orcamento_id === orcamento.id)
                );
                
                // Buscar cliente para incluir nome na descri√ß√£o
                const cliente = this.dados.clientes.find(c => 
                    c.id === (orcamento.clienteId || orcamento.cliente_id)
                );
                const nomeCliente = cliente ? cliente.nome : '';
                
                // Preencher descri√ß√£o com informa√ß√µes completas
                let descricao = `Duplicata #${orcamento.numero}`;
                if (nomeCliente) {
                    descricao += ` - ${nomeCliente}`;
                }
                if (os && os.numero) {
                    descricao += ` (O.S. #${os.numero})`;
                }
                document.getElementById('transacao-descricao').value = descricao;
                
                // Preencher valor total do or√ßamento
                const valorTotal = orcamento.total || orcamento.valor_total || 0;
                document.getElementById('transacao-valor').value = valorTotal.toFixed(2);
                
                // Preencher observa√ß√µes do or√ßamento se existirem
                if (orcamento.observacoes) {
                    document.getElementById('transacao-observacoes').value = orcamento.observacoes;
                }
                
                // Preencher data com a data do or√ßamento ou data de finaliza√ß√£o da O.S
                const dataTransacao = document.getElementById('transacao-data');
                if (os && os.dataFinalizacao) {
                    // Usar data de finaliza√ß√£o da O.S se dispon√≠vel
                    const dataFinalizacao = new Date(os.dataFinalizacao);
                    dataTransacao.value = dataFinalizacao.toISOString().split('T')[0];
                } else if (orcamento.data) {
                    // Usar data do or√ßamento como fallback
                    const dataOrcamento = new Date(orcamento.data);
                    dataTransacao.value = dataOrcamento.toISOString().split('T')[0];
                }
                
                // Atualizar resumo financeiro
                this.atualizarResumoFinanceiro();
            }

            toggleParcelado() {
                const parcelado = document.getElementById('transacao-parcelado').checked;
                const camposParcelas = document.getElementById('campos-parcelas');
                
                if (parcelado) {
                    camposParcelas.style.display = 'block';
                    // Definir data da primeira parcela como hoje se n√£o estiver definida
                    const dataPrimeiraParcela = document.getElementById('transacao-data-primeira-parcela');
                    if (!dataPrimeiraParcela.value) {
                        dataPrimeiraParcela.value = new Date().toISOString().split('T')[0];
                    }
                } else {
                    camposParcelas.style.display = 'none';
                }
                this.atualizarResumoFinanceiro();
            }

            async checkAdminStatusIndex() {
                try {
                    const resp = await fetch('/api/admin/status');
                    if (!resp.ok) return { isAdmin: false };
                    const data = await resp.json();
                    // Mostrar/ocultar bot√µes marcados com classe .btn-admin
                    const adminBtns = document.querySelectorAll('.btn-admin');
                    adminBtns.forEach(b => { b.style.display = data.isAdmin ? 'none' : ''; });
                    return data;
                } catch (e) {
                    return { isAdmin: false };
                }
            }

            async confirmarTransacao(id) {
                const t = this.dados.transacoes.find(tx => tx.id === id);
                if (!t) return;

                // Verificar se j√° foi confirmado (evitar duplica√ß√£o)
                if (t.status === 'confirmado') {
                    alert('Esta transa√ß√£o j√° foi confirmada');
                    return;
                }

                // Verificar se √© receita e est√° vinculada a or√ßamento
                if (t.tipo === 'receita' && t.orcamentoId) {
                    const orcamento = this.dados.orcamentos.find(o => o.id === t.orcamentoId);
                    if (orcamento && orcamento.statusFinanceiro === 'liquidado') {
                        alert('Esta duplicata j√° foi liquidada');
                        return;
                    }
                    
                    // Verificar se j√° est√° parcelada
                    if (t.parcelado || t.status === 'parcelado') {
                        alert('Esta duplicata j√° est√° parcelada. N√£o √© poss√≠vel confirmar novamente.');
                        return;
                    }
                }

                // Modal para escolher forma de pagamento
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-confirmar-pagamento';
                modal.dataset.transacaoId = id;
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Confirmar ${t.tipo === 'receita' ? 'Recebimento' : 'Pagamento'}</h3>
                            <div class="modal-actions">
                                <button class="minimize" onclick="minimizarModal('modal-confirmar-pagamento')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-confirmar-pagamento').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;">
                            <p><strong>Valor:</strong> R$ ${t.valor.toFixed(2)}</p>
                            <p><strong>Descri√ß√£o:</strong> ${t.descricao}</p>
                            <div class="form-group" style="margin-top: 20px;">
                                <label>Forma de Pagamento *</label>
                                <select id="forma-pagamento" required onchange="sistema.alterarFormaPagamento()">
                                    <option value="">Selecione...</option>
                                    <option value="vista">√Ä Vista</option>
                                    <option value="prazo">A Prazo</option>
                                </select>
                            </div>
                            <div id="campos-parcelas" style="display: none; margin-top: 15px;">
                                <div class="form-group">
                                    <label>N√∫mero de Parcelas *</label>
                                    <input type="number" id="num-parcelas" min="2" max="12" value="2" onchange="sistema.calcularParcelas()">
                                </div>
                                <div id="preview-parcelas" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; max-height: 200px; overflow-y: auto;">
                                    <!-- Preview das parcelas -->
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-success" onclick="sistema.processarConfirmacaoTransacao(${id})" style="flex: 1;">Confirmar</button>
                                <button class="btn btn-danger" onclick="document.getElementById('modal-confirmar-pagamento').remove()" style="flex: 1;">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                // Calcular parcelas inicialmente se necess√°rio
                setTimeout(() => {
                    if (document.getElementById('forma-pagamento').value === 'prazo') {
                        this.calcularParcelas();
                    }
                }, 100);
            }

            alterarFormaPagamento() {
                const forma = document.getElementById('forma-pagamento').value;
                const camposParcelas = document.getElementById('campos-parcelas');
                if (forma === 'prazo') {
                    camposParcelas.style.display = 'block';
                    setTimeout(() => {
                        this.calcularParcelas();
                    }, 50);
                } else {
                    camposParcelas.style.display = 'none';
                }
            }

            calcularParcelas() {
                const modal = document.getElementById('modal-confirmar-pagamento');
                if (!modal) return;
                
                const transacaoId = parseInt(modal.dataset.transacaoId);
                const t = this.dados.transacoes.find(tx => tx.id === transacaoId);
                if (!t) {
                    // Tentar pegar do bot√£o onclick
                    const btn = document.querySelector('#modal-confirmar-pagamento .btn-success');
                    if (btn) {
                        const onclick = btn.getAttribute('onclick');
                        const match = onclick.match(/processarConfirmacaoTransacao\((\d+)\)/);
                        if (match) {
                            const id = parseInt(match[1]);
                            const trans = this.dados.transacoes.find(tx => tx.id === id);
                            if (trans) {
                                this.calcularParcelasParaTransacao(trans);
                                return;
                            }
                        }
                    }
                    return;
                }
                this.calcularParcelasParaTransacao(t);
            }

            calcularParcelasParaTransacao(t) {
                const numParcelas = parseInt(document.getElementById('num-parcelas').value) || 2;
                const valorParcela = t.valor / numParcelas;
                const preview = document.getElementById('preview-parcelas');
                
                let html = '<strong>Parcelas:</strong><br>';
                const hoje = new Date();
                for (let i = 0; i < numParcelas; i++) {
                    const dataParcela = new Date(hoje);
                    dataParcela.setMonth(hoje.getMonth() + i);
                    const valorFinal = i === numParcelas - 1 ? t.valor - (valorParcela * (numParcelas - 1)) : valorParcela;
                    html += `Parcela ${i + 1}/${numParcelas}: R$ ${valorFinal.toFixed(2)} - Vencimento: ${dataParcela.toLocaleDateString('pt-BR')}<br>`;
                }
                preview.innerHTML = html;
            }

            async processarConfirmacaoTransacao(id) {
                const t = this.dados.transacoes.find(tx => tx.id === id);
                if (!t) return;

                const forma = document.getElementById('forma-pagamento').value;
                if (!forma) {
                    alert('Selecione a forma de pagamento');
                    return;
                }

                if (forma === 'prazo') {
                    const numParcelas = parseInt(document.getElementById('num-parcelas').value) || 2;
                    if (numParcelas < 2) {
                        alert('N√∫mero de parcelas deve ser pelo menos 2');
                        return;
                    }

                    // Verificar se j√° existem parcelas para esta duplicata
                    const parcelasExistentes = this.dados.transacoes.filter(tx => 
                        tx.parcelaDe === id || (tx.orcamentoId === t.orcamentoId && tx.parcelaDe)
                    );

                    if (parcelasExistentes.length > 0) {
                        alert('Esta duplicata j√° possui parcelas. N√£o √© poss√≠vel parcelar novamente.');
                        document.getElementById('modal-confirmar-pagamento').remove();
                        return;
                    }

                    // Registrar hist√≥rico antes de alterar
                    this.registrarHistoricoTransacao({
                        acao: 'alteracao',
                        transacaoId: id,
                        dadosAntigos: { ...t },
                        dadosNovos: { ...t, parcelado: true, numParcelas: numParcelas, status: 'parcelado' },
                        motivo: 'Parcelamento'
                    });

                    // Marcar transa√ß√£o original como parcelada
                    await this.atualizarTransacaoServidor(id, {
                        parcelado: true,
                        numParcelas: numParcelas,
                        status: 'parcelado'
                    });

                    // Criar parcelas vinculadas √† duplicata original
                    const valorParcela = t.valor / numParcelas;
                    const hoje = new Date();
                    const idOriginal = t.id;

                    for (let i = 0; i < numParcelas; i++) {
                        const dataParcela = new Date(hoje);
                        dataParcela.setMonth(hoje.getMonth() + i);
                        const valorFinal = i === numParcelas - 1 ? t.valor - (valorParcela * (numParcelas - 1)) : valorParcela;
                        
                        const parcela = {
                            id: Date.now() + i,
                            orcamentoId: t.orcamentoId || null,
                            clienteId: t.clienteId || null,
                            descricao: `${t.descricao} - Parcela ${i + 1}/${numParcelas}`,
                            tipo: t.tipo,
                            valor: valorFinal,
                            data: dataParcela.toISOString().split('T')[0],
                            status: 'pendente',
                            observacoes: `Parcela ${i + 1} de ${numParcelas} da duplicata #${t.numeroDuplicata || t.orcamentoId}`,
                            criadoEm: new Date().toISOString(),
                            parcelaDe: idOriginal,
                            numeroParcela: i + 1,
                            totalParcelas: numParcelas,
                            isDuplicata: t.isDuplicata || false,
                            numeroDuplicata: t.numeroDuplicata || null
                        };

                        await this.adicionarTransacao(parcela);
                    }
                } else {
                    // Registrar hist√≥rico antes de alterar
                    this.registrarHistoricoTransacao({
                        acao: 'alteracao',
                        transacaoId: id,
                        dadosAntigos: { ...t },
                        dadosNovos: { ...t, status: 'confirmado', formaPagamento: 'vista' },
                        motivo: 'Confirma√ß√£o de pagamento √† vista'
                    });

                    // √Ä vista - atualizar no servidor
                    await this.atualizarTransacaoServidor(id, {
                        status: 'confirmado',
                        confirmadoEm: new Date().toISOString(),
                        formaPagamento: 'vista'
                    });
                    
                    // Se for receita de or√ßamento, marcar como liquidado
                    if (t.tipo === 'receita' && t.orcamentoId) {
                        const orcamento = this.dados.orcamentos.find(o => o.id === t.orcamentoId);
                        if (orcamento) {
                            orcamento.statusFinanceiro = 'liquidado';
                            orcamento.dataLiquidacao = new Date().toISOString().split('T')[0];
                            await this.atualizarOrcamentoServidor(orcamento.id, {
                                statusFinanceiro: 'liquidado',
                                dataLiquidacao: orcamento.dataLiquidacao
                            });
                            // Emitir recibo
                            this.emitirRecibo(t, orcamento);
                        }
                    }
                }

                document.getElementById('modal-confirmar-pagamento').remove();
                this.atualizarTodosDados();
                this.log(`Transa√ß√£o confirmada: ${t.descricao}`, 'success');
            }

            emitirRecibo(transacao, orcamento) {
                const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                const veiculo = this.dados.veiculos.find(v => v.id === orcamento.veiculoId);
                
                const reciboHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Recibo - Or√ßamento #${orcamento.numero}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 40px; }
                            .recibo-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px; }
                            .recibo-info { margin: 20px 0; }
                            .recibo-info p { margin: 5px 0; }
                            .recibo-total { font-size: 18px; font-weight: bold; text-align: right; margin-top: 30px; padding-top: 20px; border-top: 2px solid #000; }
                            .assinatura { margin-top: 60px; text-align: center; }
                        </style>
                    </head>
                    <body>
                        <div class="recibo-header">
                            <h1>RECIBO DE PAGAMENTO</h1>
                            <p>N¬∫ ${Date.now()}</p>
                        </div>
                        <div class="recibo-info">
                            <p><strong>Recebi de:</strong> ${cliente?.nome || 'N/A'}</p>
                            <p><strong>CPF/CNPJ:</strong> ${cliente?.cpf || 'N√£o informado'}</p>
                            <p><strong>Endere√ßo:</strong> ${cliente?.endereco ? `${cliente.endereco.logradouro}, ${cliente.endereco.numero} - ${cliente.endereco.bairro}, ${cliente.endereco.cidade}` : 'N√£o informado'}</p>
                            <p><strong>Referente a:</strong> Pagamento do Or√ßamento #${orcamento.numero}</p>
                            <p><strong>Ve√≠culo:</strong> ${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</p>
                            <p><strong>Data do Pagamento:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                            <p><strong>Forma de Pagamento:</strong> √Ä Vista</p>
                        </div>
                        <div class="recibo-total">
                            <p>VALOR RECEBIDO: R$ ${transacao.valor.toFixed(2)}</p>
                        </div>
                        <div class="assinatura">
                            <p>_________________________________________</p>
                            <p>Assinatura</p>
                        </div>
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(reciboHTML);
                printWindow.document.close();
                printWindow.print();
            }

            async excluirTransacao(id) {
                const t = this.dados.transacoes.find(tx => tx.id === id);
                if (!t) return;

                // Se for uma duplicata (vinculada a or√ßamento), solicitar PIN
                if (t.isDuplicata || (t.orcamentoId && t.tipo === 'receita')) {
                    const pinValido = await this.verificarPIN();
                    if (!pinValido) {
                        return;
                    }
                } else {
                    if (!confirm('Deseja excluir esta transa√ß√£o?')) return;
                }

                // Registrar hist√≥rico antes de excluir
                this.registrarHistoricoTransacao({
                    acao: 'exclusao',
                    transacaoId: id,
                    dados: { ...t }
                });

                try {
                // Verificar se √© uma parcela e remover todas as parcelas relacionadas
                if (t.parcelaDe) {
                    const todasParcelas = this.dados.transacoes.filter(tx => 
                        tx.parcelaDe === t.parcelaDe || tx.id === t.parcelaDe
                    );
                    if (confirm(`Esta √© uma parcela. Deseja excluir todas as ${todasParcelas.length} parcela(s) relacionada(s)?`)) {
                            // Registrar hist√≥rico das parcelas tamb√©m
                            todasParcelas.forEach(parcela => {
                                this.registrarHistoricoTransacao({
                                    acao: 'exclusao',
                                    transacaoId: parcela.id,
                                    dados: { ...parcela },
                                    motivo: 'Exclus√£o em lote com parcela principal'
                                });
                            });
                            // Excluir todas as parcelas do servidor
                            for (const parcela of todasParcelas) {
                                await this.apiRequest(`/transacoes/${parcela.id}`, { method: 'DELETE' });
                            }
                    } else {
                        // Remover apenas esta parcela
                            await this.apiRequest(`/transacoes/${id}`, { method: 'DELETE' });
                    }
                } else {
                    // Verificar se h√° parcelas vinculadas
                    const parcelasVinculadas = this.dados.transacoes.filter(tx => tx.parcelaDe === id);
                    if (parcelasVinculadas.length > 0) {
                        if (confirm(`Esta duplicata possui ${parcelasVinculadas.length} parcela(s). Deseja excluir todas?`)) {
                                // Registrar hist√≥rico das parcelas tamb√©m
                                parcelasVinculadas.forEach(parcela => {
                                    this.registrarHistoricoTransacao({
                                        acao: 'exclusao',
                                        transacaoId: parcela.id,
                                        dados: { ...parcela },
                                        motivo: 'Exclus√£o em lote com duplicata principal'
                                    });
                                });
                                // Excluir todas as parcelas e a duplicata do servidor
                                for (const parcela of parcelasVinculadas) {
                                    await this.apiRequest(`/transacoes/${parcela.id}`, { method: 'DELETE' });
                                }
                                await this.apiRequest(`/transacoes/${id}`, { method: 'DELETE' });
                        } else {
                            return;
                        }
                    } else {
                            await this.apiRequest(`/transacoes/${id}`, { method: 'DELETE' });
                    }
                }

                    // Sincronizar para atualizar estado local
                    await this.sincronizarTransacoesComServidor();
                this.atualizarFinanceiro();
                this.log('Transa√ß√£o exclu√≠da com sucesso', 'warning');
                } catch (error) {
                    console.error('Erro ao excluir transa√ß√£o:', error);
                    this.log(`Erro ao excluir transa√ß√£o: ${error.message}`, 'error');
                    alert(`Erro ao excluir transa√ß√£o: ${error.message}`);
                }
            }

            atualizarFinanceiro() {
                // Usar o novo m√≥dulo financeiro para calcular m√©tricas
                const metricas = this.financeiro.calcularMetricas();
                
                // Atualizar cards do dashboard financeiro
                const saldoTotalEl = document.getElementById('saldo-total');
                const totalReceitasEl = document.getElementById('total-receitas');
                const totalDespesasEl = document.getElementById('total-despesas');
                const totalPendenteEl = document.getElementById('total-pendente');
                const ticketMedioEl = document.getElementById('ticket-medio');
                const totalInadimplenciaEl = document.getElementById('total-inadimplencia');
                
                if (saldoTotalEl) saldoTotalEl.textContent = `R$ ${metricas.saldoTotal.toFixed(2)}`;
                if (totalReceitasEl) totalReceitasEl.textContent = `R$ ${metricas.totalReceitas.toFixed(2)}`;
                if (totalDespesasEl) totalDespesasEl.textContent = `R$ ${metricas.totalDespesas.toFixed(2)}`;
                if (totalPendenteEl) totalPendenteEl.textContent = `R$ ${metricas.totalPendente.toFixed(2)}`;
                if (ticketMedioEl) ticketMedioEl.textContent = `R$ ${metricas.ticketMedio.toFixed(2)}`;
                if (totalInadimplenciaEl) totalInadimplenciaEl.textContent = `R$ ${metricas.totalInadimplencia.toFixed(2)}`;

                // Atualizar gr√°fico
                this.atualizarGraficoReceitasDespesas();

                // Carregar filtros de per√≠odo e cliente
                this.carregarFiltrosPeriodoCliente();

                // Verificar avisos de parcelas
                this.verificarAvisosParcelasFinanceiro();

                // Aplicar filtro atual
                this.aplicarFiltroFinanceiro(state.filtroFinanceiro || 'todos');
            }

            // M√≥dulo Financeiro Completo
            get financeiro() {
                const self = this;
                return {
                // M√©todo para adicionar transa√ß√£o
                async adicionarTransacao(dados) {
                    try {
                        const payload = {
                            tipo: dados.tipo,
                            data: dados.data,
                            descricao: dados.descricao,
                            valor: parseFloat(dados.valor),
                            status: dados.status || 'pendente',
                            observacoes: dados.observacoes || '',
                            categoria: dados.categoria || null,
                            clienteId: dados.clienteId || null,
                            orcamentoId: dados.orcamentoId || null,
                            isDuplicata: dados.isDuplicata || false,
                            numeroDuplicata: dados.numeroDuplicata || null,
                            parcelaDe: dados.parcelaDe || null,
                            numeroParcela: dados.numeroParcela || null,
                            totalParcelas: dados.totalParcelas || null
                        };

                        const criada = await self.apiRequest('/transacoes', { 
                            method: 'POST', 
                            data: payload 
                        });

                        self.dados.transacoes.push(criada);
                        self.salvarDados('transacoes');
                        self.log(`Transa√ß√£o "${dados.descricao}" adicionada com sucesso`, 'success');
                        
                        return criada;
                    } catch (error) {
                        self.log(`Erro ao adicionar transa√ß√£o: ${error.message}`, 'error');
                        throw error;
                    }
                },

                // M√©todo para atualizar transa√ß√£o
                async atualizarTransacao(id, updates) {
                    try {
                        const atualizada = await self.apiRequest(`/transacoes/${id}`, {
                            method: 'PUT',
                            data: updates
                        });

                        const index = self.dados.transacoes.findIndex(t => t.id === id);
                        if (index !== -1) {
                            self.dados.transacoes[index] = { ...self.dados.transacoes[index], ...atualizada };
                            self.salvarDados('transacoes');
                        }

                        self.log(`Transa√ß√£o #${id} atualizada com sucesso`, 'success');
                        return atualizada;
                    } catch (error) {
                        self.log(`Erro ao atualizar transa√ß√£o: ${error.message}`, 'error');
                        throw error;
                    }
                },

                // M√©todo para excluir transa√ß√£o
                async excluirTransacao(id) {
                    try {
                        await self.apiRequest(`/transacoes/${id}`, { method: 'DELETE' });
                        self.dados.transacoes = self.dados.transacoes.filter(t => t.id !== id);
                        self.salvarDados('transacoes');
                        self.log(`Transa√ß√£o #${id} exclu√≠da com sucesso`, 'warning');
                    } catch (error) {
                        self.log(`Erro ao excluir transa√ß√£o: ${error.message}`, 'error');
                        throw error;
                    }
                },

                // M√©todo para criar parcelas
                async criarParcelas(dados) {
                    const parcelas = [];
                    const valorParcela = dados.valor / dados.numeroParcelas;
                    const dataBase = new Date(dados.dataPrimeiraParcela);

                    for (let i = 0; i < dados.numeroParcelas; i++) {
                        const dataParcela = new Date(dataBase);
                        dataParcela.setMonth(dataBase.getMonth() + i);

                        const parcela = {
                            tipo: 'receita',
                            data: dataParcela.toISOString().split('T')[0],
                            descricao: `${dados.descricao} (${i + 1}/${dados.numeroParcelas})`,
                            valor: valorParcela,
                            status: 'pendente',
                            observacoes: `Parcela ${i + 1} de ${dados.numeroParcelas} - ${dados.observacoes || ''}`,
                            clienteId: dados.clienteId,
                            orcamentoId: dados.orcamentoId,
                            isDuplicata: true,
                            numeroDuplicata: dados.numeroDuplicata,
                            parcelaDe: dados.id || null,
                            numeroParcela: i + 1,
                            totalParcelas: dados.numeroParcelas
                        };

                        parcelas.push(parcela);
                    }

                    // Adicionar parcelas
                    for (const parcela of parcelas) {
                        await self.financeiro.adicionarTransacao(parcela);
                    }

                    return parcelas;
                },

                // M√©todo para calcular m√©tricas financeiras
                calcularMetricas(transacoesFiltradas = null) {
                    const transacoes = transacoesFiltradas || self.dados.transacoes;
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();

                    // Transa√ß√µes do m√™s atual
                    const transacoesMesAtual = transacoes.filter(t => {
                        const dataTransacao = new Date(t.data);
                        return dataTransacao.getMonth() === mesAtual && 
                               dataTransacao.getFullYear() === anoAtual;
                    });

                    // Receitas confirmadas
                    const receitasConfirmadas = transacoesMesAtual
                        .filter(t => t.tipo === 'receita' && t.status === 'confirmado')
                        .reduce((sum, t) => sum + t.valor, 0);

                    // Despesas confirmadas
                    const despesasConfirmadas = transacoesMesAtual
                        .filter(t => t.tipo === 'despesa' && t.status === 'confirmado')
                        .reduce((sum, t) => sum + t.valor, 0);

                    // Pendentes a receber
                    const pendentesReceber = transacoes
                        .filter(t => t.tipo === 'receita' && t.status === 'pendente')
                        .reduce((sum, t) => sum + t.valor, 0);

                    // Inadimpl√™ncia (pendentes vencidas)
                    const hojeStr = hoje.toISOString().split('T')[0];
                    const inadimplencia = transacoes
                        .filter(t => t.tipo === 'receita' && 
                                    t.status === 'pendente' && 
                                    t.data < hojeStr)
                        .reduce((sum, t) => sum + t.valor, 0);

                    // Ticket m√©dio
                    const receitasConcluidas = transacoes
                        .filter(t => t.tipo === 'receita' && t.status === 'confirmado');
                    const ticketMedio = receitasConcluidas.length > 0 
                        ? receitasConcluidas.reduce((sum, t) => sum + t.valor, 0) / receitasConcluidas.length
                        : 0;

                    return {
                        saldoTotal: receitasConfirmadas - despesasConfirmadas,
                        totalReceitas: receitasConfirmadas,
                        totalDespesas: despesasConfirmadas,
                        totalPendente: pendentesReceber,
                        totalInadimplencia: inadimplencia,
                        ticketMedio: ticketMedio,
                        quantidadeTransacoes: transacoesMesAtual.length
                    };
                },

                // M√©todo para gerar relat√≥rio
                gerarRelatorioFinanceiro() {
                    const dataInicio = document.getElementById('relatorio-data-inicio')?.value;
                    const dataFim = document.getElementById('relatorio-data-fim')?.value;
                    const tipo = document.getElementById('relatorio-tipo')?.value;
                    const status = document.getElementById('relatorio-status')?.value;
                    const cliente = document.getElementById('relatorio-cliente')?.value;
                    const categoria = document.getElementById('relatorio-categoria')?.value;

                    // Filtrar transa√ß√µes
                    let transacoesFiltradas = [...self.dados.transacoes];

                    if (dataInicio) {
                        transacoesFiltradas = transacoesFiltradas.filter(t => t.data >= dataInicio);
                    }

                    if (dataFim) {
                        transacoesFiltradas = transacoesFiltradas.filter(t => t.data <= dataFim);
                    }

                    if (tipo && tipo !== 'todos') {
                        transacoesFiltradas = transacoesFiltradas.filter(t => t.tipo === tipo);
                    }

                    if (status && status !== 'todos') {
                        transacoesFiltradas = transacoesFiltradas.filter(t => t.status === status);
                    }

                    if (cliente && cliente !== 'todos') {
                        transacoesFiltradas = transacoesFiltradas.filter(t => t.clienteId === parseInt(cliente));
                    }

                    if (categoria && categoria !== 'todos') {
                        transacoesFiltradas = transacoesFiltradas.filter(t => t.categoria === categoria);
                    }

                    // Ordenar por data
                    transacoesFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));

                    // Calcular m√©tricas do relat√≥rio
                    const metricas = this.calcularMetricas(transacoesFiltradas);

                    // Atualizar resumo
                    const resumoTotalReceitas = document.getElementById('resumo-total-receitas');
                    const resumoTotalDespesas = document.getElementById('resumo-total-despesas');
                    const resumoSaldoLiquido = document.getElementById('resumo-saldo-liquido');
                    const resumoQuantidade = document.getElementById('resumo-quantidade');
                    
                    if (resumoTotalReceitas) resumoTotalReceitas.textContent = `R$ ${metricas.totalReceitas.toFixed(2)}`;
                    if (resumoTotalDespesas) resumoTotalDespesas.textContent = `R$ ${metricas.totalDespesas.toFixed(2)}`;
                    if (resumoSaldoLiquido) resumoSaldoLiquido.textContent = `R$ ${metricas.saldoTotal.toFixed(2)}`;
                    if (resumoQuantidade) resumoQuantidade.textContent = transacoesFiltradas.length;

                    // Atualizar tabela
                    const tbody = document.getElementById('tabela-relatorio');
                    if (tbody) {
                        tbody.innerHTML = transacoesFiltradas.map(transacao => {
                            const cliente = self.dados.clientes.find(c => c.id === transacao.clienteId);
                            return `
                                <tr onclick="verDetalhesTransacao(${transacao.id})" style="cursor: pointer;">
                                    <td>${new Date(transacao.data).toLocaleDateString('pt-BR')}</td>
                                    <td>${transacao.descricao}</td>
                                    <td>${transacao.tipo === 'receita' ? 'üí∞ Receita' : 'üí∏ Despesa'}</td>
                                    <td>${transacao.categoria || '-'}</td>
                                    <td style="color: ${transacao.tipo === 'receita' ? '#27ae60' : '#e74c3c'}; font-weight: bold;">
                                        R$ ${transacao.valor.toFixed(2)}
                                    </td>
                                    <td>
                                        <span class="badge ${transacao.status === 'confirmado' ? 'badge-success' : 'badge-warning'}">
                                            ${transacao.status === 'confirmado' ? '‚úÖ Confirmado' : '‚è≥ Pendente'}
                                        </span>
                                    </td>
                                    <td>${cliente?.nome || '-'}</td>
                                </tr>
                            `;
                        }).join('');
                    }

                    // Mostrar se√ß√£o de resumo
                    const resumoRelatorio = document.getElementById('resumo-relatorio');
                    if (resumoRelatorio) resumoRelatorio.style.display = 'block';

                    // Gerar gr√°ficos
                    this.gerarGraficosRelatorio(transacoesFiltradas);
                },

                // M√©todo para gerar gr√°ficos do relat√≥rio
                gerarGraficosRelatorio(transacoes) {
                    // Gr√°fico comparativo Receitas vs Despesas
                    const receitas = transacoes.filter(t => t.tipo === 'receita' && t.status === 'confirmado')
                        .reduce((sum, t) => sum + t.valor, 0);
                    const despesas = transacoes.filter(t => t.tipo === 'despesa' && t.status === 'confirmado')
                        .reduce((sum, t) => sum + t.valor, 0);

                    const graficoComparativo = document.getElementById('grafico-comparativo');
                    if (graficoComparativo) {
                        const ctxComparativo = graficoComparativo.getContext('2d');
                        new Chart(ctxComparativo, {
                            type: 'bar',
                            data: {
                                labels: ['Receitas', 'Despesas'],
                                datasets: [{
                                    label: 'Valores (R$)',
                                    data: [receitas, despesas],
                                    backgroundColor: ['#27ae60', '#e74c3c']
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }

                    // Gr√°fico de categorias de despesas
                    const despesasPorCategoria = {};
                    transacoes.filter(t => t.tipo === 'despesa' && t.categoria).forEach(t => {
                        despesasPorCategoria[t.categoria] = (despesasPorCategoria[t.categoria] || 0) + t.valor;
                    });

                    const graficoCategorias = document.getElementById('grafico-categorias');
                    if (graficoCategorias) {
                        const ctxCategorias = graficoCategorias.getContext('2d');
                        new Chart(ctxCategorias, {
                            type: 'pie',
                            data: {
                                labels: Object.keys(despesasPorCategoria),
                                datasets: [{
                                    data: Object.values(despesasPorCategoria),
                                    backgroundColor: ['#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#1abc9c', '#34495e']
                                }]
                            },
                            options: {
                                responsive: true
                            }
                        });
                    }
                },

                // M√©todo para exportar relat√≥rio
                exportarRelatorio() {
                    const tabela = document.getElementById('tabela-relatorio');
                    if (!tabela) return;
                    
                    let csv = 'Data,Descri√ß√£o,Tipo,Categoria,Valor,Status,Cliente\n';

                    Array.from(tabela.rows).forEach(row => {
                        const cells = Array.from(row.cells);
                        const linha = cells.map(cell => {
                            let texto = cell.textContent.trim();
                            // Escapar v√≠rgulas e aspas
                            if (texto.includes(',') || texto.includes('"')) {
                                texto = '"' + texto.replace(/"/g, '""') + '"';
                            }
                            return texto;
                        }).join(',');
                        csv += linha + '\n';
                    });

                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `relatorio_financeiro_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                };
            }

            carregarFiltrosPeriodoCliente() {
                // Carregar meses
                const selectMes = document.getElementById('filtro-mes-financeiro');
                if (selectMes && selectMes.children.length <= 1) {
                    const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                                   'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                    meses.forEach((mes, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = mes;
                        selectMes.appendChild(option);
                    });
                }

                // Carregar anos
                const selectAno = document.getElementById('filtro-ano-financeiro');
                if (selectAno && selectAno.children.length <= 1) {
                    const anos = [];
                    const hoje = new Date();
                    const anoAtual = hoje.getFullYear();
                    // Pegar anos das transa√ß√µes
                    const anosTransacoes = new Set();
                    this.dados.transacoes.forEach(t => {
                        if (t.data) {
                            const ano = new Date(t.data).getFullYear();
                            anosTransacoes.add(ano);
                        }
                    });
                    // Adicionar anos de transa√ß√µes e pr√≥ximos 2 anos
                    for (let i = anoAtual - 2; i <= anoAtual + 2; i++) {
                        anosTransacoes.add(i);
                    }
                    Array.from(anosTransacoes).sort((a, b) => b - a).forEach(ano => {
                        const option = document.createElement('option');
                        option.value = ano;
                        option.textContent = ano;
                        selectAno.appendChild(option);
                    });
                }

                // Carregar clientes
                const selectCliente = document.getElementById('filtro-cliente-financeiro');
                if (selectCliente && selectCliente.children.length <= 1) {
                    this.dados.clientes.forEach(cliente => {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = cliente.nome;
                        selectCliente.appendChild(option);
                    });
                }
            }

            aplicarFiltroPeriodoFinanceiro() {
                const mes = document.getElementById('filtro-mes-financeiro')?.value;
                const ano = document.getElementById('filtro-ano-financeiro')?.value;
                
                if (mes && ano) {
                    state.filtroPeriodoFinanceiro = { mes: parseInt(mes), ano: parseInt(ano) };
                } else {
                    state.filtroPeriodoFinanceiro = null;
                }
                
                this.aplicarFiltroFinanceiro(state.filtroFinanceiro || 'todos');
            }

            aplicarFiltroClienteFinanceiro() {
                const clienteId = document.getElementById('filtro-cliente-financeiro')?.value;
                state.filtroClienteFinanceiro = clienteId ? parseInt(clienteId) : null;
                this.aplicarFiltroFinanceiro(state.filtroFinanceiro || 'todos');
            }

            atualizarGraficoReceitasDespesas() {
                const canvas = document.getElementById('grafico-receitas-despesas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                // Filtrar transa√ß√µes do m√™s atual confirmadas
                const transacoesMes = this.dados.transacoes.filter(t => {
                    if (t.status !== 'confirmado') return false;
                    if (t.status === 'parcelado') return false;
                    const data = new Date(t.data);
                    return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                });

                let receitasMes = 0;
                let despesasMes = 0;

                transacoesMes.forEach(t => {
                    const valor = parseFloat(t.valor);
                    if (t.tipo === 'receita') receitasMes += valor;
                    else despesasMes += valor;
                });

                // Limpar canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Configurar tamanho
                canvas.width = canvas.offsetWidth;
                canvas.height = 200;

                const maxValor = Math.max(receitasMes, despesasMes, 100);
                const alturaMax = canvas.height - 60;
                const larguraBarra = 80;
                const espacamento = 40;
                const inicioX = (canvas.width - (larguraBarra * 2 + espacamento)) / 2;

                // Desenhar receitas
                const alturaReceitas = (receitasMes / maxValor) * alturaMax;
                ctx.fillStyle = '#28a745';
                ctx.fillRect(inicioX, canvas.height - alturaReceitas - 40, larguraBarra, alturaReceitas);
                ctx.fillStyle = '#333';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Receitas', inicioX + larguraBarra / 2, canvas.height - 10);
                ctx.fillText(`R$ ${receitasMes.toFixed(2)}`, inicioX + larguraBarra / 2, canvas.height - alturaReceitas - 45);

                // Desenhar despesas
                const alturaDespesas = (despesasMes / maxValor) * alturaMax;
                ctx.fillStyle = '#dc3545';
                ctx.fillRect(inicioX + larguraBarra + espacamento, canvas.height - alturaDespesas - 40, larguraBarra, alturaDespesas);
                ctx.fillStyle = '#333';
                ctx.fillText('Despesas', inicioX + larguraBarra + espacamento + larguraBarra / 2, canvas.height - 10);
                ctx.fillText(`R$ ${despesasMes.toFixed(2)}`, inicioX + larguraBarra + espacamento + larguraBarra / 2, canvas.height - alturaDespesas - 45);
            }

            aplicarFiltroFinanceiro(filtro) {
                state.filtroFinanceiro = filtro;
                
                // Atualizar bot√µes de filtro
                ['todos', 'vista', 'prazo', 'vencer', 'vencidas', 'inadimplentes', 'liquidadas'].forEach(f => {
                    const btn = document.getElementById(`filtro-financeiro-${f}`);
                    if (btn) {
                        if (f === filtro) {
                            btn.style.background = 'var(--primary-color)';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '';
                            btn.style.color = '';
                        }
                    }
                });

                const transacoes = this.dados.transacoes;
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                const primeiroDiaMes = new Date(anoAtual, mesAtual, 1);
                const ultimoDiaMes = new Date(anoAtual, mesAtual + 1, 0);

                // Filtrar transa√ß√µes para exibi√ß√£o
                let transacoesParaExibir = transacoes.filter(t => {
                    // Se for uma parcela, sempre considerar
                    if (t.parcelaDe) {
                        return true;
                    }
                    // Se for duplicata principal, mostrar apenas se n√£o estiver parcelada
                    if (t.status === 'parcelado') {
                        return false; // N√£o mostrar duplicata parcelada, apenas suas parcelas
                    }
                    // N√£o mostrar duplicatas liquidadas (confirmadas) na lista principal
                    if (t.status === 'confirmado' && t.isDuplicata && filtro !== 'liquidadas') {
                        return false;
                    }
                    return true;
                });

                // Aplicar filtros espec√≠ficos
                if (filtro === 'vista') {
                    transacoesParaExibir = transacoesParaExibir.filter(t => 
                        t.formaPagamento === 'vista' || (!t.parcelaDe && !t.parcelado)
                    );
                } else if (filtro === 'prazo') {
                    transacoesParaExibir = transacoesParaExibir.filter(t => 
                        t.parcelaDe || t.parcelado
                    );
                } else if (filtro === 'vencer') {
                    const amanha = new Date(hoje);
                    amanha.setDate(hoje.getDate() + 1);
                    const fimMes = new Date(anoAtual, mesAtual + 1, 0);
                    transacoesParaExibir = transacoesParaExibir.filter(t => {
                        if (t.status === 'confirmado') return false;
                        const dataVenc = new Date(t.data);
                        dataVenc.setHours(0, 0, 0, 0);
                        return dataVenc >= amanha && dataVenc <= fimMes;
                    });
                } else if (filtro === 'vencidas') {
                    transacoesParaExibir = transacoesParaExibir.filter(t => {
                        if (t.status === 'confirmado') return false;
                        const dataVenc = new Date(t.data);
                        dataVenc.setHours(0, 0, 0, 0);
                        return dataVenc < hoje;
                    });
                } else if (filtro === 'inadimplentes') {
                    const clientesInadimplentes = new Set();
                    transacoesParaExibir.forEach(t => {
                        if (t.status === 'pendente' && t.tipo === 'receita') {
                            const dataVenc = new Date(t.data);
                            dataVenc.setHours(0, 0, 0, 0);
                            if (dataVenc < hoje && t.clienteId) {
                                clientesInadimplentes.add(t.clienteId);
                            }
                        }
                    });
                    transacoesParaExibir = transacoesParaExibir.filter(t => 
                        t.clienteId && clientesInadimplentes.has(t.clienteId)
                    );
                } else if (filtro === 'liquidadas') {
                    transacoesParaExibir = transacoesParaExibir.filter(t => 
                        t.status === 'confirmado' && t.isDuplicata
                    );
                }

                // Filtrar duplicatas do m√™s seguinte (s√≥ aparecem no m√™s seguinte)
                transacoesParaExibir = transacoesParaExibir.filter(t => {
                    if (t.parcelaDe || !t.isDuplicata) return true;
                    const dataVenc = new Date(t.data);
                    const mesVenc = dataVenc.getMonth();
                    const anoVenc = dataVenc.getFullYear();
                    // S√≥ mostrar se for do m√™s atual ou anterior
                    if (anoVenc > anoAtual || (anoVenc === anoAtual && mesVenc > mesAtual)) {
                        return false;
                    }
                    return true;
                });

                transacoesParaExibir = transacoesParaExibir.filter(t => {
                    if (!t.data) return false;
                    const dataVenc = new Date(t.data);
                    dataVenc.setHours(0, 0, 0, 0);
                    const isMesAtual = dataVenc.getFullYear() === anoAtual && dataVenc.getMonth() === mesAtual;
                    const estaAtrasado = dataVenc < primeiroDiaMes;
                    return isMesAtual || estaAtrasado;
                });

                // Aplicar filtro de per√≠odo
                if (state.filtroPeriodoFinanceiro) {
                    const { mes, ano } = state.filtroPeriodoFinanceiro;
                    transacoesParaExibir = transacoesParaExibir.filter(t => {
                        if (!t.data) return false;
                        const data = new Date(t.data);
                        return data.getMonth() === mes && data.getFullYear() === ano;
                    });
                }

                // Aplicar filtro de cliente
                if (state.filtroClienteFinanceiro) {
                transacoesParaExibir = transacoesParaExibir.filter(t => 
                        t.clienteId === state.filtroClienteFinanceiro
                    );
                }

                // Apenas duplicatas (receitas provenientes de or√ßamento) e despesas devem aparecer no m√≥dulo financeiro
                transacoesParaExibir = transacoesParaExibir.filter(t => 
                    (t.tipo === 'receita' && (t.isDuplicata || t.parcelaDe || t.orcamentoId)) || t.tipo === 'despesa'
                );

                // Se a tabela financeira n√£o existir na p√°gina atual, n√£o tentar renderizar
                const tbody = document.getElementById('transacoes-table');
                if (!tbody) {
                    return;
                }

                tbody.innerHTML = transacoesParaExibir
                    .sort((a, b) => {
                        // Ordenar por data, mas agrupar parcelas com suas duplicatas
                        if (a.parcelaDe && b.parcelaDe && a.parcelaDe === b.parcelaDe) {
                            return (a.numeroParcela || 0) - (b.numeroParcela || 0);
                        }
                        return new Date(b.data) - new Date(a.data);
                    })
                    .map(t => {
                        let statusBadge = 'badge-info';
                        const dataVenc = new Date(t.data);
                        dataVenc.setHours(0, 0, 0, 0);
                        const estaAtrasado = t.status !== 'confirmado' && dataVenc < hoje;

                        if (t.status === 'confirmado') statusBadge = 'badge-success';
                        if (t.status === 'pendente') statusBadge = estaAtrasado ? 'badge-danger' : 'badge-warning';
                        if (t.status === 'parcelado') statusBadge = 'badge-secondary';

                        // Indicador visual para duplicatas e parcelas (melhorado)
                        let indicador = '';
                        let estiloLinha = '';
                        if (t.isDuplicata && !t.parcelaDe) {
                            indicador = '<span style="color: #2c3e50; font-weight: bold;">üìÑ</span> ';
                            estiloLinha = 'border-left: 3px solid #2c3e50;';
                        } else if (t.parcelaDe) {
                            indicador = '<span style="color: #17a2b8;">üìã</span> ';
                            estiloLinha = 'border-left: 3px solid #17a2b8; padding-left: 8px; background-color: #f8f9fa;';
                            // Agrupar parcelas visualmente
                            const todasParcelas = this.dados.transacoes.filter(tx => 
                                tx.parcelaDe === t.parcelaDe || tx.id === t.parcelaDe
                            ).sort((a, b) => (a.numeroParcela || 0) - (b.numeroParcela || 0));
                            if (t.numeroParcela === 1) {
                                estiloLinha += ' border-top: 2px solid #17a2b8;';
                            }
                            if (t.numeroParcela === todasParcelas.length) {
                                estiloLinha += ' border-bottom: 2px solid #17a2b8;';
                            }
                        }

                        // Melhorar descri√ß√£o: n√∫mero da duplicata + nome do cliente
                        let descricao = t.descricao;
                        if (t.isDuplicata || t.parcelaDe) {
                            const cliente = this.dados.clientes.find(c => String(c.id) === String(t.clienteId));
                            const nomeCliente = cliente ? cliente.nome : 'Cliente n√£o encontrado';
                            const numDuplicata = t.numeroDuplicata || (t.parcelaDe ? this.dados.transacoes.find(tx => tx.id === t.parcelaDe)?.numeroDuplicata : null);
                            if (numDuplicata) {
                                descricao = `Duplicata #${numDuplicata} - ${nomeCliente}${t.parcelaDe ? ` - Parcela ${t.numeroParcela}/${t.totalParcelas}` : ''}`;
                            } else {
                                descricao = `Duplicata - ${nomeCliente}${t.parcelaDe ? ` - Parcela ${t.numeroParcela}/${t.totalParcelas}` : ''}`;
                            }
                        } else if (t.tipo === 'despesa' && t.categoriaId) {
                            const categoria = this.dados.categoriasDespesas.find(c => c.id === t.categoriaId);
                            if (categoria) {
                                descricao = `[${categoria.nome}] ${descricao}`;
                            }
                        }

                        const acoes = [];
                        // S√≥ permitir confirmar se n√£o estiver parcelado e for pendente
                        if (t.status === 'pendente' && !t.parcelado) {
                            acoes.push(`<button class="btn btn-sm btn-success" onclick="sistema.confirmarTransacao(${t.id})">Confirmar</button>`);
                        }
                        acoes.push(`<button class="btn btn-sm btn-danger" onclick="sistema.excluirTransacao(${t.id})">Excluir</button>`);

                        const linhaAtrasada = estaAtrasado ? 'background-color: #fdecea;' : (t.parcelaDe ? 'background-color: #f8f9fa;' : '');

                        return `
                            <tr style="${linhaAtrasada}${estiloLinha ? '; ' + estiloLinha : ''}">
                                <td>${new Date(t.data).toLocaleDateString('pt-BR')}</td>
                                <td>${indicador}${descricao}</td>
                                <td>${t.tipo === 'receita' ? 'Receita' : 'Despesa'}</td>
                                <td>R$ ${t.valor.toFixed(2)}</td>
                                <td><span class="badge ${statusBadge}">${t.status === 'parcelado' ? 'Aberto/Parcelado' : t.status}</span></td>
                                <td>${acoes.join(' ')}</td>
                            </tr>
                        `;
                    }).join('') || '<tr><td colspan="6" class="text-center">Nenhuma transa√ß√£o encontrada</td></tr>';
            }

            verificarAvisosParcelasFinanceiro() {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const amanha = new Date(hoje);
                amanha.setDate(hoje.getDate() + 1);
                const em3Dias = new Date(hoje);
                em3Dias.setDate(hoje.getDate() + 3);
                const em7Dias = new Date(hoje);
                em7Dias.setDate(hoje.getDate() + 7);

                const parcelasVencendo1Dia = [];
                const parcelasVencendo3Dias = [];
                const parcelasVencendo7Dias = [];

                this.dados.transacoes.forEach(t => {
                    if (t.status !== 'pendente' || !t.data || t.tipo !== 'receita') return;
                    const dataVencimento = new Date(t.data);
                    dataVencimento.setHours(0, 0, 0, 0);
                    const diasAteVencimento = Math.floor((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasAteVencimento === 1) {
                        parcelasVencendo1Dia.push(t);
                    } else if (diasAteVencimento >= 2 && diasAteVencimento <= 3) {
                        parcelasVencendo3Dias.push(t);
                    } else if (diasAteVencimento >= 4 && diasAteVencimento <= 7) {
                        parcelasVencendo7Dias.push(t);
                    }
                });

                const financeiroSection = document.getElementById('financeiro');
                if (!financeiroSection) return;

                // Remover avisos existentes
                financeiroSection.querySelectorAll('.aviso-parcelas-financeiro').forEach(aviso => aviso.remove());

                // Aviso 1 dia (cr√≠tico)
                if (parcelasVencendo1Dia.length > 0) {
                    const total = parcelasVencendo1Dia.reduce((sum, t) => sum + parseFloat(t.valor), 0);
                    const avisoHTML = `
                        <div class="aviso-parcelas-financeiro" style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 20px 0; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #721c24;">üö® URGENTE: Parcelas Vencendo Amanh√£</h4>
                            <p style="margin: 0; color: #721c24;">
                                ${parcelasVencendo1Dia.length} parcela(s) vence(m) amanh√£. Total: R$ ${total.toFixed(2)}
                            </p>
                        </div>
                    `;
                    const avisoDiv = document.createElement('div');
                    avisoDiv.className = 'aviso-parcelas-financeiro';
                    avisoDiv.innerHTML = avisoHTML;
                    const cardsGrid = financeiroSection.querySelector('.cards-grid');
                    if (cardsGrid && cardsGrid.nextSibling) {
                        financeiroSection.insertBefore(avisoDiv, cardsGrid.nextSibling);
                }
                }

                // Aviso 3 dias
                if (parcelasVencendo3Dias.length > 0) {
                    const total = parcelasVencendo3Dias.reduce((sum, t) => sum + parseFloat(t.valor), 0);
                    const avisoHTML = `
                        <div class="aviso-parcelas-financeiro" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #856404;">‚ö†Ô∏è Aten√ß√£o: Parcelas Vencendo em 2-3 Dias</h4>
                            <p style="margin: 0; color: #856404;">
                                ${parcelasVencendo3Dias.length} parcela(s) vence(m) em breve. Total: R$ ${total.toFixed(2)}
                            </p>
                        </div>
                    `;
                    const avisoDiv = document.createElement('div');
                    avisoDiv.className = 'aviso-parcelas-financeiro';
                    avisoDiv.innerHTML = avisoHTML;
                    const cardsGrid = financeiroSection.querySelector('.cards-grid');
                    if (cardsGrid && cardsGrid.nextSibling) {
                        financeiroSection.insertBefore(avisoDiv, cardsGrid.nextSibling);
                    }
                }

                // Aviso 7 dias
                if (parcelasVencendo7Dias.length > 0) {
                    const total = parcelasVencendo7Dias.reduce((sum, t) => sum + parseFloat(t.valor), 0);
                    const avisoHTML = `
                        <div class="aviso-parcelas-financeiro" style="background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 15px; margin: 20px 0; border-radius: 5px;">
                            <h4 style="margin: 0 0 10px 0; color: #0c5460;">‚ÑπÔ∏è Informa√ß√£o: Parcelas Vencendo em 4-7 Dias</h4>
                            <p style="margin: 0; color: #0c5460;">
                                ${parcelasVencendo7Dias.length} parcela(s) vence(m) esta semana. Total: R$ ${total.toFixed(2)}
                            </p>
                        </div>
                    `;
                    const avisoDiv = document.createElement('div');
                    avisoDiv.className = 'aviso-parcelas-financeiro';
                    avisoDiv.innerHTML = avisoHTML;
                    const cardsGrid = financeiroSection.querySelector('.cards-grid');
                    if (cardsGrid && cardsGrid.nextSibling) {
                        financeiroSection.insertBefore(avisoDiv, cardsGrid.nextSibling);
                    }
                }
            }

            gerarRelatorioClientes() {
                this.abrirModalFiltrosRelatorio('clientes');
            }

            abrirModalFiltrosRelatorio(tipo) {
                const hoje = new Date();
                const primeiroDiaMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-filtros-relatorio';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Filtros do Relat√≥rio</h3>
                            <div class="modal-actions">
                                <button class="minimize" onclick="minimizarModal('modal-filtros-relatorio')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-filtros-relatorio').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group">
                                <label>Per√≠odo</label>
                                <select id="filtro-periodo" onchange="sistema.alterarPeriodoRelatorio()">
                                    <option value="todos">Todos</option>
                                    <option value="hoje">Hoje</option>
                                    <option value="mes" selected>Este M√™s</option>
                                    <option value="personalizado">Personalizado</option>
                                </select>
                            </div>
                            <div id="campos-datas-personalizadas" style="display: none; margin-top: 15px;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Data Inicial</label>
                                        <input type="date" id="data-inicial" value="${primeiroDiaMes.toISOString().split('T')[0]}">
                                    </div>
                                    <div class="form-group">
                                        <label>Data Final</label>
                                        <input type="date" id="data-final" value="${ultimoDiaMes.toISOString().split('T')[0]}">
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn btn-primary" onclick="sistema.gerarRelatorioComFiltros('${tipo}')" style="flex: 1;">Gerar Relat√≥rio</button>
                                <button class="btn btn-danger" onclick="document.getElementById('modal-filtros-relatorio').remove()" style="flex: 1;">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            alterarPeriodoRelatorio() {
                const periodo = document.getElementById('filtro-periodo').value;
                const camposPersonalizados = document.getElementById('campos-datas-personalizadas');
                
                if (periodo === 'personalizado') {
                    camposPersonalizados.style.display = 'block';
                } else {
                    camposPersonalizados.style.display = 'none';
                }
            }

            gerarRelatorioComFiltros(tipo) {
                const periodo = document.getElementById('filtro-periodo').value;
                let dataInicial, dataFinal;
                
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                if (periodo === 'hoje') {
                    dataInicial = new Date(hoje);
                    dataFinal = new Date(hoje);
                } else if (periodo === 'mes') {
                    dataInicial = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    dataFinal = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                } else if (periodo === 'personalizado') {
                    dataInicial = new Date(document.getElementById('data-inicial').value);
                    dataFinal = new Date(document.getElementById('data-final').value);
                } else {
                    dataInicial = null;
                    dataFinal = null;
                }

                document.getElementById('modal-filtros-relatorio').remove();
                
                if (tipo === 'clientes') {
                    this.exibirRelatorioClientes(dataInicial, dataFinal);
                } else if (tipo === 'orcamentos') {
                    this.exibirRelatorioOrcamentos(dataInicial, dataFinal);
                } else if (tipo === 'agendamentos') {
                    this.exibirRelatorioAgendamentos(dataInicial, dataFinal);
                } else if (tipo === 'financeiro') {
                    this.exibirRelatorioFinanceiro(dataInicial, dataFinal);
                }
            }

            exibirRelatorioClientes(dataInicial, dataFinal) {
                let clientesFiltrados = this.dados.clientes;
                
                // Filtrar por per√≠odo se necess√°rio (baseado em ve√≠culos, agendamentos, etc)
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-relatorio-clientes';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">Relat√≥rio de Clientes</h3>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="sistema.imprimirRelatorio('clientes')">üñ®Ô∏è Imprimir</button>
                                <button class="minimize" onclick="minimizarModal('modal-relatorio-clientes')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-relatorio-clientes').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;" id="conteudo-relatorio-clientes">
                            <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                            ${dataInicial && dataFinal ? `<p><strong>Per√≠odo:</strong> ${dataInicial.toLocaleDateString('pt-BR')} a ${dataFinal.toLocaleDateString('pt-BR')}</p>` : ''}
                            <p><strong>Total de Clientes:</strong> ${clientesFiltrados.length}</p>
                            <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Nome</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">WhatsApp</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Ve√≠culos</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${clientesFiltrados.map(c => {
                                        const veiculosCount = this.dados.veiculos.filter(v => v.clienteId === c.id).length;
                                        return `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${c.nome}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${c.whatsapp || 'N√£o informado'}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${veiculosCount}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            gerarRelatorioOrcamentos() {
                this.abrirModalFiltrosRelatorio('orcamentos');
            }

            exibirRelatorioOrcamentos(dataInicial, dataFinal) {
                let orcamentosFiltrados = this.dados.orcamentos;
                
                if (dataInicial && dataFinal) {
                    orcamentosFiltrados = orcamentosFiltrados.filter(o => {
                        const dataOrcamento = new Date(o.data);
                        return dataOrcamento >= dataInicial && dataOrcamento <= dataFinal;
                    });
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-relatorio-orcamentos';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">Relat√≥rio de Or√ßamentos</h3>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="sistema.imprimirRelatorio('orcamentos')">üñ®Ô∏è Imprimir</button>
                                <button class="minimize" onclick="minimizarModal('modal-relatorio-orcamentos')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-relatorio-orcamentos').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;" id="conteudo-relatorio-orcamentos">
                            <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                            ${dataInicial && dataFinal ? `<p><strong>Per√≠odo:</strong> ${dataInicial.toLocaleDateString('pt-BR')} a ${dataFinal.toLocaleDateString('pt-BR')}</p>` : ''}
                            <p><strong>Total de Or√ßamentos:</strong> ${orcamentosFiltrados.length}</p>
                            <p><strong>Pendentes:</strong> ${orcamentosFiltrados.filter(o => o.status === 'pendente').length}</p>
                            <p><strong>Aprovados:</strong> ${orcamentosFiltrados.filter(o => o.status === 'aprovado').length}</p>
                            <p><strong>Recusados:</strong> ${orcamentosFiltrados.filter(o => o.status === 'recusado').length}</p>
                            <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">N¬∫</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cliente</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Data</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Valor</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${orcamentosFiltrados.sort((a, b) => b.numero - a.numero).map(o => {
                                        const cliente = this.dados.clientes.find(c => c.id === o.clienteId);
                                        return `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">#${o.numero}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${cliente?.nome || 'N/A'}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${new Date(o.data).toLocaleDateString('pt-BR')}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">R$ ${o.total.toFixed(2)}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${o.status}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            gerarRelatorioAgendamentos() {
                this.abrirModalFiltrosRelatorio('agendamentos');
            }

            exibirRelatorioAgendamentos(dataInicial, dataFinal) {
                let agendamentosFiltrados = this.dados.agendamentos;
                
                if (dataInicial && dataFinal) {
                    agendamentosFiltrados = agendamentosFiltrados.filter(a => {
                        const dataAgendamento = new Date(a.data);
                        return dataAgendamento >= dataInicial && dataAgendamento <= dataFinal;
                    });
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-relatorio-agendamentos';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">Relat√≥rio de Agendamentos</h3>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="sistema.imprimirRelatorio('agendamentos')">üñ®Ô∏è Imprimir</button>
                                <button class="minimize" onclick="minimizarModal('modal-relatorio-agendamentos')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-relatorio-agendamentos').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;" id="conteudo-relatorio-agendamentos">
                            <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                            ${dataInicial && dataFinal ? `<p><strong>Per√≠odo:</strong> ${dataInicial.toLocaleDateString('pt-BR')} a ${dataFinal.toLocaleDateString('pt-BR')}</p>` : ''}
                            <p><strong>Total de Agendamentos:</strong> ${agendamentosFiltrados.length}</p>
                            <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Data/Hora</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cliente</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Ve√≠culo</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Problema</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${agendamentosFiltrados.sort((a, b) => new Date(b.data) - new Date(a.data)).map(a => {
                                        const cliente = this.dados.clientes.find(c => c.id === a.clienteId);
                                        const veiculo = this.dados.veiculos.find(v => v.id === a.veiculoId);
                                        const dataHora = a.data ? new Date(a.data).toLocaleDateString('pt-BR') + (a.hora ? ' ' + a.hora.substring(0, 5) : '') : '-';
                                        return `
                                            <tr>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${dataHora}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${cliente?.nome || 'N/A'}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${a.problema || '-'}</td>
                                                <td style="padding: 8px; border: 1px solid #ddd;">${a.status || 'agendado'}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            gerarRelatorioFinanceiro() {
                this.abrirModalFiltrosRelatorio('financeiro');
            }

            exibirRelatorioFinanceiro(dataInicial, dataFinal) {
                let transacoesFiltradas = this.dados.transacoes;
                
                if (dataInicial && dataFinal) {
                    transacoesFiltradas = transacoesFiltradas.filter(t => {
                        const dataTransacao = new Date(t.data);
                        return dataTransacao >= dataInicial && dataTransacao <= dataFinal;
                    });
                }
                
                const receitasConfirmadas = transacoesFiltradas.filter(t => t.tipo === 'receita' && t.status === 'confirmado');
                const despesasConfirmadas = transacoesFiltradas.filter(t => t.tipo === 'despesa' && t.status === 'confirmado');
                const totalReceitas = receitasConfirmadas.reduce((sum, t) => sum + parseFloat(t.valor), 0);
                const totalDespesas = despesasConfirmadas.reduce((sum, t) => sum + parseFloat(t.valor), 0);
                const saldo = totalReceitas - totalDespesas;
                
                // Calcular ticket m√©dio
                const receitasComCliente = receitasConfirmadas.filter(t => t.clienteId);
                const ticketMedio = receitasComCliente.length > 0
                    ? receitasComCliente.reduce((sum, t) => sum + parseFloat(t.valor), 0) / receitasComCliente.length
                    : 0;
                
                // Agrupar despesas por categoria
                const despesasPorCategoria = {};
                despesasConfirmadas.forEach(t => {
                    if (t.categoriaId) {
                        const categoria = this.dados.categoriasDespesas.find(c => c.id === t.categoriaId);
                        const nomeCategoria = categoria ? categoria.nome : 'Sem categoria';
                        if (!despesasPorCategoria[nomeCategoria]) {
                            despesasPorCategoria[nomeCategoria] = 0;
                        }
                        despesasPorCategoria[nomeCategoria] += parseFloat(t.valor);
                    }
                });
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.id = 'modal-relatorio-financeiro';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3 class="modal-title">Relat√≥rio Financeiro</h3>
                            <div class="modal-actions">
                                <button class="btn btn-secondary" onclick="sistema.imprimirRelatorio('financeiro')">üñ®Ô∏è Imprimir</button>
                                <button class="minimize" onclick="minimizarModal('modal-relatorio-financeiro')" title="Minimizar">‚àí</button>
                                <button class="close" onclick="document.getElementById('modal-relatorio-financeiro').remove()" title="Fechar">&times;</button>
                            </div>
                        </div>
                        <div style="padding: 20px;" id="conteudo-relatorio-financeiro">
                            <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                            ${dataInicial && dataFinal ? `<p><strong>Per√≠odo:</strong> ${dataInicial.toLocaleDateString('pt-BR')} a ${dataFinal.toLocaleDateString('pt-BR')}</p>` : ''}
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                                <h3 style="margin-top: 0;">Resumo Financeiro</h3>
                                <p><strong>Total de Receitas:</strong> R$ ${totalReceitas.toFixed(2)}</p>
                                <p><strong>Total de Despesas:</strong> R$ ${totalDespesas.toFixed(2)}</p>
                                <p><strong>Saldo Total:</strong> R$ ${saldo.toFixed(2)}</p>
                                <p><strong>Ticket M√©dio:</strong> R$ ${ticketMedio.toFixed(2)}</p>
                                <p><strong>Quantidade de Receitas:</strong> ${receitasConfirmadas.length}</p>
                                <p><strong>Quantidade de Despesas:</strong> ${despesasConfirmadas.length}</p>
                            </div>
                            ${Object.keys(despesasPorCategoria).length > 0 ? `
                            <div style="background: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0;">
                                <h3 style="margin-top: 0;">Despesas por Categoria</h3>
                                ${Object.entries(despesasPorCategoria).map(([categoria, valor]) => `
                                    <p><strong>${categoria}:</strong> R$ ${valor.toFixed(2)}</p>
                                `).join('')}
                            </div>
                            ` : ''}
                            <table style="width: 100%; margin-top: 20px; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #2c3e50; color: white;">
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Data</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Descri√ß√£o</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Cliente</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Categoria</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Tipo</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Valor</th>
                                        <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transacoesFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data)).map(t => {
                                        const cliente = t.clienteId ? this.dados.clientes.find(c => c.id === t.clienteId) : null;
                                        const categoria = t.categoriaId ? this.dados.categoriasDespesas.find(c => c.id === t.categoriaId) : null;
                                        return `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${new Date(t.data).toLocaleDateString('pt-BR')}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${t.descricao}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${cliente ? cliente.nome : '-'}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${categoria ? categoria.nome : '-'}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${t.tipo === 'receita' ? 'Receita' : 'Despesa'}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">R$ ${parseFloat(t.valor).toFixed(2)}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${t.status}</td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            imprimirRelatorio(tipo) {
                const modalId = `modal-relatorio-${tipo}`;
                const conteudoId = `conteudo-relatorio-${tipo}`;
                const conteudo = document.getEleme
                ntById(conteudoId).innerHTML;
                
                const relatorioHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Relat√≥rio ${tipo}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            h1 { color: #2c3e50; }
                            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                            th { background-color: #2c3e50; color: white; }
                        </style>
                    </head>
                    <body>
                        ${conteudo}
                    </body>
                    </html>
                `;
                
                const printWindow = window.open('', '_blank');
                printWindow.document.write(relatorioHTML);
                printWindow.document.close();
                printWindow.print();
            }

            // Fun√ß√µes de sele√ß√£o para bot√µes universais
            toggleSelectAll(tipo, checked) {
                const checkboxes = document.querySelectorAll(`#${tipo}-table .row-checkbox`);
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    const id = parseInt(cb.getAttribute('data-id'));
                    if (checked) {
                        cb.closest('tr').style.backgroundColor = '#e3f2fd';
                    } else {
                        cb.closest('tr').style.backgroundColor = '';
                    }
                });
                this.updateUniversalButtons(tipo);
            }

            toggleRowSelection(tipo, id) {
                const checkbox = document.querySelector(`#${tipo}-table .row-checkbox[data-id="${id}"]`);
                const row = checkbox.closest('tr');
                if (checkbox.checked) {
                    row.style.backgroundColor = '#e3f2fd';
                } else {
                    row.style.backgroundColor = '';
                }
                this.updateUniversalButtons(tipo);
            }

            selectRow(tipo, id, rowElement) {
                const checkbox = rowElement.querySelector('.row-checkbox');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    this.toggleRowSelection(tipo, id);
                }
            }

            getSelectedId(tipo, mostrarAlerta = true) {
                const checkbox = document.querySelector(`#${tipo}-table .row-checkbox:checked`);
                if (!checkbox) {
                    if (mostrarAlerta) {
                        alert('Por favor, selecione um item da lista primeiro.');
                    }
                    return null;
                }
                return parseInt(checkbox.getAttribute('data-id'));
            }

            updateUniversalButtons(tipo) {
                // Bot√µes sempre vis√≠veis, n√£o precisam ser ocultados
                // Atualizar checkbox "selecionar todos"
                const selectedCount = document.querySelectorAll(`#${tipo}-table .row-checkbox:checked`).length;
                const selectAllCheckbox = document.getElementById(`select-all-${tipo}`);
                if (selectAllCheckbox) {
                    const totalCheckboxes = document.querySelectorAll(`#${tipo}-table .row-checkbox`).length;
                    selectAllCheckbox.checked = selectedCount === totalCheckboxes && totalCheckboxes > 0;
                }
                
                // L√≥gica especial para or√ßamentos: mostrar/ocultar bot√µes conforme status
                if (tipo === 'orcamentos') {
                    const btnGerarOS = document.getElementById('btn-gerar-os-lista');
                    const btnEditar = document.querySelector('#botoes-universais-orcamentos button[onclick*="editarOrcamentoSelecionado"]');
                    const selectedId = this.getSelectedId('orcamentos', false); // N√£o mostrar alerta aqui
                    
                    if (selectedId) {
                        const orcamento = this.dados.orcamentos.find(o => o.id === selectedId);
                        if (orcamento) {
                            // Ocultar bot√£o "Editar" se or√ßamento estiver aprovado ou recusado
                            if (btnEditar) {
                                if (orcamento.status === 'aprovado' || orcamento.status === 'recusado') {
                                    btnEditar.style.display = 'none';
                                } else {
                                    btnEditar.style.display = 'inline-block';
                                }
                            }
                            
                            // Mostrar bot√£o "Gerar O.S." apenas se or√ßamento estiver aprovado e n√£o tiver O.S.
                            if (btnGerarOS) {
                                if (orcamento.status === 'aprovado') {
                                    const osExistente = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                                    if (!osExistente) {
                                        btnGerarOS.style.display = 'inline-block';
                                    } else {
                                        btnGerarOS.style.display = 'none';
                                    }
                                } else {
                                    btnGerarOS.style.display = 'none';
                                }
                            }
                        }
                    } else {
                        // Nenhum or√ßamento selecionado - ocultar bot√µes condicionais
                        if (btnGerarOS) btnGerarOS.style.display = 'none';
                        if (btnEditar) btnEditar.style.display = 'inline-block'; // Mostrar por padr√£o quando n√£o h√° sele√ß√£o
                    }
                }
            }

            // Bot√µes universais para Clientes
            editarClienteSelecionado() {
                const id = this.getSelectedId('clientes');
                if (id) this.editarCliente(id);
            }

            excluirClienteSelecionado() {
                const id = this.getSelectedId('clientes');
                if (id) this.excluirCliente(id);
            }

            verDetalhesClienteSelecionado() {
                const id = this.getSelectedId('clientes');
                if (id) this.verDetalhesCliente(id);
            }

            // Bot√µes universais para Or√ßamentos
            visualizarOrcamentoSelecionado() {
                const id = this.getSelectedId('orcamentos');
                if (id) this.visualizarOrcamento(id);
            }

            editarOrcamentoSelecionado() {
                const id = this.getSelectedId('orcamentos');
                if (id) this.editarOrcamento(id);
            }

            async gerarOSDoOrcamentoSelecionado() {
                const id = this.getSelectedId('orcamentos');
                if (!id) return;
                
                const orcamento = this.dados.orcamentos.find(o => o.id === id);
                if (!orcamento) {
                    alert('Or√ßamento n√£o encontrado');
                    return;
                }
                
                if (orcamento.status !== 'aprovado') {
                    alert('Apenas or√ßamentos aprovados podem gerar Ordem de Servi√ßo');
                    return;
                }
                
                // Verificar se j√° existe O.S. para este or√ßamento
                const osExistente = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                if (osExistente) {
                    alert(`J√° existe uma Ordem de Servi√ßo (#${osExistente.numero}) para este or√ßamento`);
                    return;
                }
                
                // Gerar O.S. a partir do or√ßamento
                await this.gerarOrdemServicoDoOrcamento(orcamento);
                this.atualizarTodosDados();
                this.log(`Ordem de Servi√ßo gerada do or√ßamento #${orcamento.numero}`, 'success');
            }

            excluirOrcamentoSelecionado() {
                const id = this.getSelectedId('orcamentos');
                if (id) this.excluirOrcamento(id);
            }

            // Bot√µes universais para Agendamentos
            visualizarAgendamentoSelecionado() {
                const id = this.getSelectedId('agendamentos');
                if (id) this.visualizarAgendamento(id);
            }

            editarAgendamentoSelecionado() {
                const id = this.getSelectedId('agendamentos');
                if (id) this.editarAgendamento(id);
            }

            async gerarOSDoAgendamento() {
                const id = this.getSelectedId('agendamentos');
                if (!id) return;
                
                const agendamento = this.dados.agendamentos.find(a => a.id === id);
                if (!agendamento) {
                    alert('Agendamento n√£o encontrado');
                    return;
                }
                
                // Buscar or√ßamento aprovado relacionado a este agendamento
                const orcamento = this.dados.orcamentos.find(o => 
                    o.agendamentoId === agendamento.id && o.status === 'aprovado'
                );
                
                if (!orcamento) {
                    alert('Este agendamento n√£o possui um or√ßamento aprovado. √â necess√°rio ter um or√ßamento aprovado para gerar a O.S.');
                    return;
                }
                
                // Verificar se j√° existe O.S. para este or√ßamento
                const osExistente = this.dados.ordensServico.find(os => os.orcamentoId === orcamento.id);
                if (osExistente) {
                    alert(`J√° existe uma Ordem de Servi√ßo (#${osExistente.numero}) para este agendamento`);
                    return;
                }
                
                // Gerar O.S. a partir do or√ßamento
                await this.gerarOrdemServicoDoOrcamento(orcamento);
                this.atualizarTodosDados();
                this.log(`Ordem de Servi√ßo gerada do agendamento #${agendamento.numero || agendamento.id}`, 'success');
            }

            irParaOrcamentoSelecionado() {
                const id = this.getSelectedId('agendamentos');
                if (id) this.irParaOrcamento(id);
            }

            excluirAgendamentoSelecionado() {
                const id = this.getSelectedId('agendamentos');
                if (id) this.excluirAgendamento(id);
            }

            // Fun√ß√µes de busca/filtro
            filtrarClientes(termo) {
                const tbody = document.getElementById('clientes-table');
                if (!tbody) return;
                
                const termoLower = termo.toLowerCase().trim();
                let clientesFiltrados = this.dados.clientes;
                
                if (termoLower) {
                    clientesFiltrados = this.dados.clientes.filter(cliente => {
                        const nome = (cliente.nome || '').toLowerCase();
                        const whatsapp = (cliente.whatsapp || '').toLowerCase();
                        return nome.includes(termoLower) || whatsapp.includes(termoLower);
                    });
                }
                
                tbody.innerHTML = clientesFiltrados.map(cliente => {
                    const veiculosCount = this.dados.veiculos.filter(v => v.clienteId === cliente.id).length;
                    return `
                        <tr onclick="sistema.selectRow('clientes', ${cliente.id}, this)" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${cliente.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('clientes', ${cliente.id})"></td>
                            <td><a href="#" onclick="sistema.verDetalhesCliente(${cliente.id}); return false; event.stopPropagation();" style="color: var(--primary-color); text-decoration: underline; cursor: pointer;">${cliente.nome}</a></td>
                            <td>${cliente.whatsapp}</td>
                            <td>${veiculosCount} ve√≠culo(s)</td>
                            <td>-</td>
                        </tr>
                    `;
                }).join('');
                
                if (clientesFiltrados.length === 0 && termoLower) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Nenhum cliente encontrado</td></tr>';
                }
                
                this.updateUniversalButtons('clientes');
            }

            filtrarOrcamentos(termo) {
                const tbody = document.getElementById('orcamentos-table');
                if (!tbody) return;
                
                const termoLower = termo.toLowerCase().trim();
                let orcamentosParaExibir = [...this.dados.orcamentos];
                
                // Aplicar filtro de status se existir
                if (state.filtroOrcamento === 'pendentes') {
                    orcamentosParaExibir = orcamentosParaExibir.filter(o => o.status === 'pendente');
                } else if (state.filtroOrcamento === 'aprovados') {
                    orcamentosParaExibir = orcamentosParaExibir.filter(o => o.status === 'aprovado');
                } else if (state.filtroOrcamento === 'finalizados') {
                    orcamentosParaExibir = orcamentosParaExibir.filter(o => o.status === 'finalizado');
                }
                
                // Aplicar busca
                if (termoLower) {
                    orcamentosParaExibir = orcamentosParaExibir.filter(orcamento => {
                        const numero = `#${orcamento.numero}`.toLowerCase();
                        const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                        const veiculo = this.dados.veiculos.find(v => v.id === orcamento.veiculoId);
                        const nomeCliente = (cliente?.nome || '').toLowerCase();
                        const infoVeiculo = veiculo ? `${veiculo.placa} ${veiculo.marca} ${veiculo.modelo}`.toLowerCase() : '';
                        return numero.includes(termoLower) || nomeCliente.includes(termoLower) || infoVeiculo.includes(termoLower);
                    });
                }
                
                orcamentosParaExibir = orcamentosParaExibir.sort((a, b) => {
                    const dataA = new Date(a.data || 0);
                    const dataB = new Date(b.data || 0);
                    return dataB - dataA;
                });
                
                if (orcamentosParaExibir.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">Nenhum or√ßamento encontrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = orcamentosParaExibir.map(orcamento => {
                    const cliente = this.dados.clientes.find(c => c.id === orcamento.clienteId);
                    const veiculo = this.dados.veiculos.find(v => v.id === orcamento.veiculoId);
                    
                    let statusBadge = '';
                    if (orcamento.status === 'pendente') statusBadge = 'badge-warning';
                    if (orcamento.status === 'em-servico') statusBadge = 'badge-info';
                    if (orcamento.status === 'aprovado') statusBadge = 'badge-success';
                    if (orcamento.status === 'finalizado') statusBadge = 'badge-success';
                    if (orcamento.status === 'recusado') statusBadge = 'badge-danger';
                    
                    return `
                        <tr onclick="sistema.visualizarOrcamento(${orcamento.id}); sistema.selectRow('orcamentos', ${orcamento.id}, this);" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${orcamento.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('orcamentos', ${orcamento.id})"></td>
                            <td>#${orcamento.numero}</td>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>R$ ${orcamento.total.toFixed(2)}</td>
                            <td>${new Date(orcamento.data).toLocaleDateString('pt-BR')}</td>
                            <td>${new Date(new Date(orcamento.data).getTime() + orcamento.validade * 24 * 60 * 60 * 1000).toLocaleDateString('pt-BR')}</td>
                            <td><span class="badge ${statusBadge}">${orcamento.status}</span></td>
                        </tr>
                    `;
                }).join('');
                
                this.updateUniversalButtons('orcamentos');
            }

            filtrarAgendamentos(termo) {
                const tbody = document.getElementById('agendamentos-table');
                if (!tbody) return;
                
                const termoLower = termo.toLowerCase().trim();
                let agendamentosParaExibir = [...this.dados.agendamentos];
                
                // Aplicar filtro de status se existir
                if (state.filtroAgendamento === 'pendente') {
                    agendamentosParaExibir = agendamentosParaExibir.filter(a => a.status === 'pendente');
                } else if (state.filtroAgendamento === 'em-servico') {
                    agendamentosParaExibir = agendamentosParaExibir.filter(a => a.status === 'em-servico');
                } else if (state.filtroAgendamento === 'finalizado') {
                    agendamentosParaExibir = agendamentosParaExibir.filter(a => a.status === 'finalizado');
                }
                
                // Aplicar busca
                if (termoLower) {
                    agendamentosParaExibir = agendamentosParaExibir.filter(agendamento => {
                        const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                        const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                        const nomeCliente = (cliente?.nome || '').toLowerCase();
                        const infoVeiculo = veiculo ? `${veiculo.placa} ${veiculo.marca} ${veiculo.modelo}`.toLowerCase() : '';
                        const problema = (agendamento.problema || '').toLowerCase();
                        return nomeCliente.includes(termoLower) || infoVeiculo.includes(termoLower) || problema.includes(termoLower);
                    });
                }
                
                const agendamentosOrdenados = agendamentosParaExibir
                    .sort((a, b) => {
                        const dataA = new Date(a.data + ' ' + (a.hora || '00:00'));
                        const dataB = new Date(b.data + ' ' + (b.hora || '00:00'));
                        return dataA - dataB;
                    });
                
                if (agendamentosOrdenados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhum agendamento encontrado</td></tr>';
                    return;
                }
                
                tbody.innerHTML = agendamentosOrdenados.map(agendamento => {
                    const cliente = this.dados.clientes.find(c => c.id === agendamento.clienteId);
                    const veiculo = this.buscarVeiculoPorId(agendamento.veiculoId);
                    
                    const dataHora = agendamento.data 
                        ? new Date(agendamento.data).toLocaleDateString('pt-BR') + 
                          (agendamento.hora ? ' ' + agendamento.hora.substring(0, 5) : '')
                        : '-';
                    
                    let statusBadge = 'badge-warning';
                    let statusTexto = 'Pendente';
                    if (agendamento.status === 'em-servico') {
                        statusBadge = 'badge-info';
                        statusTexto = 'Em Servi√ßo';
                    } else if (agendamento.status === 'finalizado') {
                        statusBadge = 'badge-success';
                        statusTexto = 'Finalizado';
                    } else {
                        statusTexto = 'Pendente';
                    }
                    
                    return `
                        <tr onclick="sistema.visualizarAgendamento(${agendamento.id}); sistema.selectRow('agendamentos', ${agendamento.id}, this);" style="cursor: pointer;">
                            <td><input type="checkbox" class="row-checkbox" data-id="${agendamento.id}" onclick="event.stopPropagation(); sistema.toggleRowSelection('agendamentos', ${agendamento.id})"></td>
                            <td>${dataHora}</td>
                            <td>${cliente?.nome || 'N/A'}</td>
                            <td>${veiculo ? `${veiculo.placa} - ${veiculo.marca} ${veiculo.modelo}` : 'N/A'}</td>
                            <td>${agendamento.problema || '-'}</td>
                            <td>${cliente?.whatsapp || '-'}</td>
                            <td><span class="badge ${statusBadge}">${statusTexto}</span></td>
                        </tr>
                    `;
                }).join('');
                
                this.updateUniversalButtons('agendamentos');
            }
        }

        // Fun√ß√µes auxiliares globais
        function adicionarVeiculo() {
            const container = document.getElementById('veiculos-container');
            const index = container.children.length;
            
            const veiculoHTML = `
                <div class="veiculo-item" data-veiculo-id="">
                    <div class="veiculo-header">
                        <h5>Ve√≠culo ${index + 1}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerVeiculo(this)">Remover</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Placa *</label>
                            <input type="text" class="veiculo-placa" required placeholder="ABC-1234">
                        </div>
                        <div class="form-group">
                            <label>Marca</label>
                            <input type="text" class="veiculo-marca" placeholder="Ex: Fiat">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Modelo *</label>
                            <input type="text" class="veiculo-modelo" required placeholder="Ex: Uno">
                        </div>
                        <div class="form-group">
                            <label>Ano</label>
                            <input type="number" class="veiculo-ano" placeholder="2020" min="1990" max="2024">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', veiculoHTML);
        }

        function removerVeiculo(button) {
            if (document.querySelectorAll('.veiculo-item').length > 1) {
                button.closest('.veiculo-item').remove();
            } else {
                alert('√â necess√°rio ter pelo menos um ve√≠culo cadastrado');
            }
        }

        function adicionarServicoOrcamento() {
            const container = document.getElementById('servicos-orcamento-container');
            const index = container.children.length;
            
            const servicoHTML = `
                <div class="servico-orcamento-item" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid var(--warning-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0;">Servi√ßo ${index + 1}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerServicoOrcamento(this)">Remover</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Descri√ß√£o do Servi√ßo *</label>
                            <input type="text" class="servico-descricao" required placeholder="Ex: Troca de √≥leo e filtro" oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <label>Quantidade *</label>
                            <input type="number" class="servico-quantidade" value="1" min="1" required oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <label>Valor Unit√°rio (R$) *</label>
                            <input type="number" class="servico-valor" step="0.01" min="0" required placeholder="0,00" oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', servicoHTML);
        }

        function adicionarPecaOrcamento() {
            const container = document.getElementById('pecas-orcamento-container');
            const index = container.children.length;
            
            const pecaHTML = `
                <div class="peca-orcamento-item" style="background: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 10px; border-left: 4px solid var(--info-color);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="margin: 0;">Pe√ßa ${index + 1}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerPecaOrcamento(this)">Remover</button>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>Item/Pe√ßa *</label>
                            <input type="text" class="peca-item" required placeholder="Ex: √ìleo W30" oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <label>Quantidade *</label>
                            <input type="number" class="peca-quantidade" value="1" min="1" required oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <label>Valor Unit√°rio (R$) *</label>
                            <input type="number" class="peca-valor" step="0.01" min="0" required placeholder="0,00" oninput="sistema.atualizarTotalOrcamento()">
                        </div>
                        <div class="form-group">
                            <label>Valor Total (R$)</label>
                            <input type="text" class="peca-total" readonly style="background: #e9ecef; font-weight: bold;" value="R$ 0,00">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', pecaHTML);
            sistema.atualizarTotalOrcamento();
        }

        function removerPecaOrcamento(button) {
            const pecas = document.querySelectorAll('.peca-orcamento-item');
            if (pecas.length > 1) {
                button.closest('.peca-orcamento-item').remove();
                sistema.atualizarTotalOrcamento();
            } else {
                // Se for a √∫ltima pe√ßa, apenas limpar os campos
                const pecaItem = button.closest('.peca-orcamento-item');
                pecaItem.querySelector('.peca-item').value = '';
                pecaItem.querySelector('.peca-quantidade').value = '1';
                pecaItem.querySelector('.peca-valor').value = '';
                sistema.atualizarTotalOrcamento();
            }
        }

        function removerServicoOrcamento(button) {
            const servicos = document.querySelectorAll('.servico-orcamento-item');
            if (servicos.length > 1) {
                button.closest('.servico-orcamento-item').remove();
                sistema.atualizarTotalOrcamento();
            } else {
                // Se for o √∫ltimo servi√ßo, apenas limpar os campos
                const servicoItem = button.closest('.servico-orcamento-item');
                servicoItem.querySelector('.servico-descricao').value = '';
                servicoItem.querySelector('.servico-quantidade').value = '1';
                servicoItem.querySelector('.servico-valor').value = '';
                sistema.atualizarTotalOrcamento();
            }
        }

        // Adicione esta fun√ß√£o para buscar o CEP
        async function buscarCEP(cep) {
            try {
                const cepLimpo = cep.replace(/\D/g, '');
                if (cepLimpo.length !== 8) return;

                const response = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
                const data = await response.json();

                if (data.erro) {
                    alert('CEP n√£o encontrado');
                    return;
                }

                // Preencher campos do endere√ßo
                document.getElementById('cliente-logradouro').value = data.logradouro || '';
                document.getElementById('cliente-bairro').value = data.bairro || '';
                document.getElementById('cliente-cidade').value = data.localidade || '';
                document.getElementById('cliente-estado').value = data.uf || '';
            } catch (error) {
                console.error('Erro ao buscar CEP:', error);
                alert('Erro ao buscar CEP');
            }
        }

        // Fun√ß√µes de modal
        function abrirModalCliente() {
            document.getElementById('modal-cliente').style.display = 'block';
        }

        function fecharModalCliente() {
            document.getElementById('modal-cliente').style.display = 'none';
            document.getElementById('form-cliente').reset();
            document.getElementById('veiculos-container').innerHTML = '';
            adicionarVeiculo(); // Adiciona o primeiro ve√≠culo por padr√£o
        }

        function abrirModalVeiculo() {
            document.getElementById('modal-veiculo').style.display = 'block';
        }

        function fecharModalVeiculo() {
            document.getElementById('modal-veiculo').style.display = 'none';
            document.getElementById('form-veiculo').reset();
        }

        function minimizarModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.toggle('minimized');
            }
        }

        function abrirModalOrcamento() {
            document.getElementById('modal-orcamento').style.display = 'block';
            document.getElementById('modal-orcamento').classList.remove('minimized');
            document.getElementById('servicos-lista-container').innerHTML = '';
            document.getElementById('pecas-lista-container').innerHTML = '';
            document.getElementById('orcamento-agendamento').innerHTML = '<option value="">Selecione um agendamento</option>';
            document.getElementById('orcamento-veiculo-info').style.display = 'none';
            document.getElementById('servico-descricao-input').value = '';
            document.getElementById('servico-valor-input').value = '';
            document.getElementById('peca-nome-input').value = '';
            document.getElementById('peca-qtde-input').value = '1';
            document.getElementById('peca-valor-unitario-input').value = '';
            document.getElementById('peca-total-input').value = '';
            sistema.atualizarTotalOrcamento();
        }

        function fecharModalOrcamento() {
            document.getElementById('modal-orcamento').style.display = 'none';
            document.getElementById('modal-orcamento').classList.remove('minimized');
            document.getElementById('form-orcamento').reset();
            document.getElementById('servicos-lista-container').innerHTML = '';
            document.getElementById('pecas-lista-container').innerHTML = '';
            document.getElementById('orcamento-agendamento').innerHTML = '<option value="">Selecione um agendamento</option>';
            document.getElementById('orcamento-veiculo-info').style.display = 'none';
            // Limpar estado de edi√ß√£o
            const form = document.getElementById('form-orcamento');
            delete form.dataset.editId;
            // Restaurar t√≠tulo do modal
            document.querySelector('#modal-orcamento .modal-title').textContent = 'Novo Or√ßamento';
        }

        function abrirModalVisualizarOrcamento() {
            document.getElementById('modal-visualizar-orcamento').style.display = 'block';
        }

        function fecharModalVisualizarOrcamento() {
            document.getElementById('modal-visualizar-orcamento').style.display = 'none';
            state.currentOrcamentoId = null;
        }

        function abrirModalVisualizarOS() {
            document.getElementById('modal-visualizar-os').style.display = 'block';
        }

        function fecharModalVisualizarOS() {
            document.getElementById('modal-visualizar-os').style.display = 'none';
            state.currentOSId = null;
        }

        function abrirModalAgendamento() {
            document.getElementById('modal-agendamento').style.display = 'block';
        }

        function fecharModalAgendamento() {
            document.getElementById('modal-agendamento').style.display = 'none';
            document.getElementById('form-agendamento').reset();
            // Remover estado de edi√ß√£o
            const form = document.getElementById('form-agendamento');
            delete form.dataset.editId;
            // Restaurar t√≠tulo do modal
            document.querySelector('#modal-agendamento .modal-title').textContent = 'Novo Agendamento';
            // Limpar busca de cliente
            const searchInput = document.getElementById('agendamento-cliente-search');
            searchInput.value = '';
            searchInput.disabled = false;
            searchInput.style.opacity = '1';
            searchInput.style.cursor = 'text';
            searchInput.placeholder = 'Digite o nome ou telefone do cliente...';
            document.getElementById('agendamento-cliente-lista').style.display = 'none';
            document.getElementById('cliente-selecionado-badge').style.display = 'none';
        }

        function abrirModalTransacao() {
            // Carregar categorias quando abrir modal
            if (sistema) {
                sistema.carregarCategoriasTransacao();
            }
            document.getElementById('modal-transacao').style.display = 'block';
            document.getElementById('transacao-data').value = new Date().toISOString().split('T')[0];
            
            // Inicializar t√≠tulo do modal
            const tituloModal = document.getElementById('modal-transacao-titulo');
            const iconModal = document.getElementById('modal-transacao-icon');
            const tipo = document.getElementById('transacao-tipo').value;
            
            if (tipo === 'receita') {
                tituloModal.textContent = 'Nova Receita (Duplicata)';
                iconModal.textContent = '+';
                sistema.alterarTipoTransacao();
            } else {
                tituloModal.textContent = 'Nova Transa√ß√£o';
                iconModal.textContent = '';
                document.getElementById('campos-receita').style.display = 'none';
            }
        }

        function fecharModalTransacao() {
            document.getElementById('modal-transacao').style.display = 'none';
            document.getElementById('form-transacao').reset();
            
            // Limpar campos de receita
            document.getElementById('campos-receita').style.display = 'none';
            document.getElementById('campos-despesa').style.display = 'none';
            document.getElementById('campo-orcamento').style.display = 'none';
            document.getElementById('campos-parcelas').style.display = 'none';
            // Limpar campo de cliente (agora √© input, n√£o select)
            const inputCliente = document.getElementById('transacao-cliente');
            if (inputCliente) {
                inputCliente.value = '';
            }
            // Limpar campo de or√ßamento (select)
            const selectOrcamento = document.getElementById('transacao-orcamento');
            if (selectOrcamento) {
                selectOrcamento.innerHTML = '<option value="">Selecione um or√ßamento</option>';
            }
        }

        function fecharModalCategorias() {
            if (sistema) {
                sistema.fecharModalCategorias();
            }
        }

        // Fun√ß√£o para mover entre campos de PIN
        function moverPinInput(pos, event, tipo = 'login') {
            const input = event.target;
            let value = input.value;
            
            // Permite apenas n√∫meros
            if (value && !/^\d$/.test(value)) {
                input.value = '';
                value = '';
                return;
            }
            
            // Mover para o pr√≥ximo campo se digitou um n√∫mero
            if (value && pos < 4) {
                let nextId = '';
                if (tipo === 'cadastro') {
                    nextId = `cadastro-pin-${pos + 1}`;
                } else if (tipo === 'confirm') {
                    nextId = `cadastro-pin-confirm-${pos + 1}`;
                } else if (tipo === 'verificar') {
                    nextId = `pin-verificar-${pos + 1}`;
                } else {
                    nextId = `login-pin-${pos + 1}`;
                }
                const nextInput = document.getElementById(nextId);
                if (nextInput) {
                    nextInput.focus();
                }
            }
            
            // Se pressionou backspace e o campo est√° vazio, voltar para o anterior
            if (event.key === 'Backspace' && !value && pos > 1) {
                let prevId = '';
                if (tipo === 'cadastro') {
                    prevId = `cadastro-pin-${pos - 1}`;
                } else if (tipo === 'confirm') {
                    prevId = `cadastro-pin-confirm-${pos - 1}`;
                } else if (tipo === 'verificar') {
                    prevId = `pin-verificar-${pos - 1}`;
                } else {
                    prevId = `login-pin-${pos - 1}`;
                }
                const prevInput = document.getElementById(prevId);
                if (prevInput) {
                    prevInput.focus();
                    prevInput.value = '';
                }
            }
        }
        function abrirModalVisualizarAgendamento() {
            document.getElementById('modal-visualizar-agendamento').style.display = 'block';
        }

        function fecharModalVisualizarAgendamento() {
            document.getElementById('modal-visualizar-agendamento').style.display = 'none';
            state.currentAgendamentoId = null;
        }
        // Fun√ß√µes auxiliares do m√≥dulo financeiro (ser√£o definidas ap√≥s inicializa√ß√£o)
        let verDetalhesTransacao, confirmarTransacao, marcarTransacaoPendente, excluirTransacaoFinanceiro;
        
        function inicializarFuncoesFinanceiro() {
            verDetalhesTransacao = function(id) {
                const transacao = sistema.dados.transacoes.find(t => t.id === id);
            if (!transacao) return;

            const cliente = sistema.dados.clientes.find(c => c.id === transacao.clienteId);
            const orcamento = sistema.dados.orcamentos.find(o => o.id === transacao.orcamentoId);

            const content = document.getElementById('detalhes-transacao-content');
            if (content) {
                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Informa√ß√µes da Transa√ß√£o</h4>
                        <p><strong>Descri√ß√£o:</strong> ${transacao.descricao}</p>
                        <p><strong>Tipo:</strong> ${transacao.tipo === 'receita' ? 'üí∞ Receita' : 'üí∏ Despesa'}</p>
                        <p><strong>Valor:</strong> R$ ${transacao.valor.toFixed(2)}</p>
                        <p><strong>Data:</strong> ${new Date(transacao.data).toLocaleDateString('pt-BR')}</p>
                        <p><strong>Status:</strong> 
                            <span class="badge ${transacao.status === 'confirmado' ? 'badge-success' : 'badge-warning'}">
                                ${transacao.status === 'confirmado' ? '‚úÖ Confirmado' : '‚è≥ Pendente'}
                            </span>
                        </p>
                        ${transacao.categoria ? `<p><strong>Categoria:</strong> ${transacao.categoria}</p>` : ''}
                    </div>

                    ${cliente ? `
                    <div style="margin-bottom: 20px;">
                        <h4>Cliente</h4>
                        <p><strong>Nome:</strong> ${cliente.nome}</p>
                        <p><strong>WhatsApp:</strong> ${cliente.whatsapp}</p>
                    </div>
                    ` : ''}

                    ${orcamento ? `
                    <div style="margin-bottom: 20px;">
                        <h4>Or√ßamento Relacionado</h4>
                        <p><strong>N√∫mero:</strong> #${orcamento.numero}</p>
                        <p><strong>Valor Total:</strong> R$ ${orcamento.total.toFixed(2)}</p>
                        <p><strong>Status:</strong> ${orcamento.status}</p>
                    </div>
                    ` : ''}

                    ${transacao.observacoes ? `
                    <div style="margin-bottom: 20px;">
                        <h4>Observa√ß√µes</h4>
                        <p>${transacao.observacoes}</p>
                    </div>
                    ` : ''}

                    ${transacao.isDuplicata ? `
                    <div style="margin-bottom: 20px;">
                        <h4>Informa√ß√µes da Duplicata</h4>
                        <p><strong>N√∫mero:</strong> ${transacao.numeroDuplicata || 'N/A'}</p>
                        ${transacao.numeroParcela ? `<p><strong>Parcela:</strong> ${transacao.numeroParcela}/${transacao.totalParcelas}</p>` : ''}
                    </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-success" onclick="confirmarTransacao(${transacao.id})" 
                                ${transacao.status === 'confirmado' ? 'disabled' : ''}>
                            ‚úÖ Confirmar
                        </button>
                        <button class="btn btn-warning" onclick="marcarTransacaoPendente(${transacao.id})" 
                                ${transacao.status === 'pendente' ? 'disabled' : ''}>
                            ‚è≥ Marcar Pendente
                        </button>
                        <button class="btn btn-danger" onclick="excluirTransacaoFinanceiro(${transacao.id})">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                `;
            }

                const modal = document.getElementById('modal-detalhes-transacao');
                if (modal) modal.style.display = 'block';
            };

            confirmarTransacao = async function(id) {
            try {
                await sistema.financeiro.atualizarTransacao(id, { status: 'confirmado' });
                sistema.atualizarFinanceiro();
                verDetalhesTransacao(id);
                sistema.log('Transa√ß√£o confirmada com sucesso', 'success');
            } catch (error) {
                sistema.log(`Erro ao confirmar transa√ß√£o: ${error.message}`, 'error');
            }
            };

            marcarTransacaoPendente = async function(id) {
            try {
                await sistema.financeiro.atualizarTransacao(id, { status: 'pendente' });
                sistema.atualizarFinanceiro();
                verDetalhesTransacao(id);
                sistema.log('Transa√ß√£o marcada como pendente', 'warning');
            } catch (error) {
                sistema.log(`Erro ao marcar transa√ß√£o como pendente: ${error.message}`, 'error');
            }
            };

            excluirTransacaoFinanceiro = async function(id) {
            if (!confirm('Tem certeza que deseja excluir esta transa√ß√£o?')) return;

            try {
                await sistema.financeiro.excluirTransacao(id);
                const modal = document.getElementById('modal-detalhes-transacao');
                if (modal) modal.style.display = 'none';
                sistema.atualizarFinanceiro();
            } catch (error) {
                sistema.log(`Erro ao excluir transa√ß√£o: ${error.message}`, 'error');
            }
            };

            // Adicionar ao objeto window
            window.verDetalhesTransacao = verDetalhesTransacao;
            window.confirmarTransacao = confirmarTransacao;
            window.marcarTransacaoPendente = marcarTransacaoPendente;
            window.excluirTransacaoFinanceiro = excluirTransacaoFinanceiro;
        }

        // Inicializa√ß√£o ass√≠ncrona garantindo sincroniza√ß√£o com o servidor
        let sistema = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar se admin est√° logado
            verificarStatusAdminAoCarregar();
            
            if (window.storageReady) {
                await window.storageReady;
                sincronizarStateComLocalStorage();
            }
            sistema = new NegoCarSystem();
            window.sistema = sistema;
            inicializarFuncoesFinanceiro();
            adicionarVeiculo();
            // listener para responder pedidos do m√≥dulo financeiro (aba filha)
            window.addEventListener('message', (e) => {
                if (!e.data) return;
                if (e.data.type === 'requestClients') {
                    const clients = (sistema && sistema.dados && sistema.dados.clientes) ? sistema.dados.clientes : JSON.parse(localStorage.getItem('clientes') || '[]');
                    e.source.postMessage({ type: 'clientsList', clients }, e.origin || '*');
                }
            });
        });

        // Abre o m√≥dulo financeiro em nova aba e mant√©m refer√™ncia
        function openFinanceiro() {
            const url = '/modulo-financeiro.html';
            const win = window.open(url, '_blank');
            if (!win) {
                alert('N√£o foi poss√≠vel abrir nova aba. Verifique o bloqueador de popups.');
            }
        }

        // Fun√ß√µes para Login Admin
        function abrirModalAdminLogin() {
            document.getElementById('modal-admin-login').style.display = 'block';
            document.getElementById('admin-username').focus();
        }

        function fecharModalAdminLogin() {
            document.getElementById('modal-admin-login').style.display = 'none';
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
        }

        async function fazerLoginAdmin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (!username || !password) {
                alert('Por favor, preencha usu√°rio e senha');
                return;
            }

            try {
                const resp = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    alert(data.error || 'Erro ao fazer login de admin');
                    return;
                }

                alert('Login de administrador realizado com sucesso!');
                fecharModalAdminLogin();
                
                // Inicializar sistema se n√£o estiver j√°
                if (!sistema) {
                    sistema = new NegoCarSystem();
                    window.sistema = sistema;
                    inicializarFuncoesFinanceiro();
                }
                
                // Mostrar modo admin na UI
                mostrarModoAdmin();
                
                // Entrar direto no app chamando entrarNoSistema para configurar tudo corretamente
                sistema.entrarNoSistema();
            } catch (err) {
                console.error('Erro ao fazer login:', err);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Permitir Enter no modal de login admin
        document.addEventListener('DOMContentLoaded', () => {
            const adminPasswordInput = document.getElementById('admin-password');
            if (adminPasswordInput) {
                adminPasswordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        fazerLoginAdmin();
                    }
                });
            }
        });

        // Mostrar indicador de modo admin
        function mostrarModoAdmin() {
            const badge = document.getElementById('admin-mode-badge');
            const logoutBtn = document.getElementById('btn-logout-admin');
            if (badge) badge.style.display = 'block';
            if (logoutBtn) logoutBtn.style.display = 'block';
        }

        // Ocultar indicador de modo admin
        function ocultarModoAdmin() {
            const badge = document.getElementById('admin-mode-badge');
            const logoutBtn = document.getElementById('btn-logout-admin');
            if (badge) badge.style.display = 'none';
            if (logoutBtn) logoutBtn.style.display = 'none';
        }

        // Fazer logout do modo admin
        async function fazerLogoutAdmin() {
            try {
                const resp = await fetch('/api/admin/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (resp.ok) {
                    ocultarModoAdmin();
                    alert('Sa√≠do do modo administrador');
                    // Voltar para tela de login
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('login-screen').style.display = 'flex';
                } else {
                    alert('Erro ao fazer logout');
                }
            } catch (err) {
                console.error('Erro ao fazer logout:', err);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Verificar se admin est√° logado ao carregar a p√°gina
        async function verificarStatusAdminAoCarregar() {
            try {
                const resp = await fetch('/api/admin/status');
                if (resp.ok) {
                    const data = await resp.json();
                    if (data.isAdmin) {
                        mostrarModoAdmin();
                    }
                }
            } catch (err) {
                console.error('Erro ao verificar status admin:', err);
            }
        }

        // Fun√ß√µes para Modal de Limpeza de Registros Antigos
        let cleanupRecordsList = []; // Armazena lista de registros para limpeza

        function abrirModalLimpezaFinanceiro() {
            document.getElementById('modal-limpeza-financeiro').style.display = 'block';
            document.getElementById('cleanup-module').focus();
            limparFormularioLimpeza();
        }

        function fecharModalLimpezaFinanceiro() {
            document.getElementById('modal-limpeza-financeiro').style.display = 'none';
            limparFormularioLimpeza();
        }

        function limparFormularioLimpeza() {
            document.getElementById('cleanup-module').value = '';
            document.getElementById('cleanup-from-date').value = '';
            document.getElementById('cleanup-to-date').value = '';
            document.getElementById('cleanup-confirm-admin').value = '';
            document.getElementById('cleanup-records-list').innerHTML = '';
            document.getElementById('cleanup-records-container').style.display = 'none';
            document.getElementById('cleanup-no-selection').style.display = 'block';
            document.getElementById('cleanup-delete-btn').style.display = 'none';
            document.getElementById('cleanup-select-all').checked = false;
            cleanupRecordsList = [];
        }

        async function atualizarListaRegistrosLimpeza() {
            const module = document.getElementById('cleanup-module').value;
            const fromDate = document.getElementById('cleanup-from-date').value;
            const toDate = document.getElementById('cleanup-to-date').value;

            if (!module) {
                alert('Por favor, selecione um m√≥dulo');
                return;
            }

            try {
                const resp = await fetch('/api/cleanup/list-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        module: module,
                        fromDate: fromDate || null,
                        toDate: toDate || null
                    })
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    alert('Erro: ' + (data.error || 'Erro ao carregar registros'));
                    return;
                }

                const data = await resp.json();
                cleanupRecordsList = data.records || [];
                exibirRegistrosLimpeza(cleanupRecordsList);
            } catch (err) {
                console.error('Erro ao carregar registros:', err);
                alert('Erro ao conectar com o servidor');
            }
        }

        function exibirRegistrosLimpeza(records) {
            const container = document.getElementById('cleanup-records-container');
            const noSelection = document.getElementById('cleanup-no-selection');
            const recordsList = document.getElementById('cleanup-records-list');
            const countEl = document.getElementById('cleanup-records-count');
            const deleteBtn = document.getElementById('cleanup-delete-btn');

            if (records.length === 0) {
                container.style.display = 'none';
                noSelection.innerHTML = '<p style="color: #999; padding: 20px;">Nenhum registro encontrado para o per√≠odo selecionado</p>';
                noSelection.style.display = 'block';
                deleteBtn.style.display = 'none';
                return;
            }

            noSelection.style.display = 'none';
            container.style.display = 'block';
            deleteBtn.style.display = 'block';
            countEl.textContent = `Total: ${records.length} registro(s)`;

            recordsList.innerHTML = records.map(record => `
                <div style="padding: 10px; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" class="cleanup-record-checkbox" value="${record.id}" 
                           onchange="atualizarSelecionados()">
                    <div style="flex: 1;">
                        <strong>#${record.id}</strong> - ${record.descricao || record.numero || record.problema || 'Sem descri√ß√£o'}
                        <br>
                        <small style="color: #999;">Data: ${new Date(record.data).toLocaleDateString('pt-BR')}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="excluirRegistroIndividual('${record.id}', '${document.getElementById('cleanup-module').value}')" 
                            style="padding: 5px 10px; font-size: 12px;">
                        Excluir
                    </button>
                </div>
            `).join('');
        }

        function selecionarTodosRegistrosLimpeza() {
            const checkboxes = document.querySelectorAll('.cleanup-record-checkbox');
            const selectAll = document.getElementById('cleanup-select-all').checked;
            checkboxes.forEach(cb => cb.checked = selectAll);
            atualizarSelecionados();
        }

        function atualizarSelecionados() {
            const checkboxes = document.querySelectorAll('.cleanup-record-checkbox:checked');
            const selectAllCheckbox = document.getElementById('cleanup-select-all');
            const totalCheckboxes = document.querySelectorAll('.cleanup-record-checkbox').length;
            
            selectAllCheckbox.checked = checkboxes.length === totalCheckboxes && totalCheckboxes > 0;
        }

        async function excluirRegistroIndividual(recordId, module) {
            if (!confirm('Tem certeza que deseja excluir este registro?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
                return;
            }

            try {
                const resp = await fetch('/api/cleanup/delete-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        module: module,
                        recordIds: [recordId],
                        confirm: true
                    })
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    alert('Erro: ' + (data.error || 'Erro ao deletar registro'));
                    return;
                }

                alert('‚úì Registro exclu√≠do com sucesso!');
                // Remover do cache local (localStorage) para evitar que sincroniza√ß√£o re-crie o registro
                try {
                    const mapKey = module === 'ordens_servico' ? 'ordensServico' : module;
                    if (sistema && sistema.dados && Array.isArray(sistema.dados[mapKey])) {
                        sistema.dados[mapKey] = sistema.dados[mapKey].filter(it => String(it.id) !== String(recordId));
                        sistema.salvarDados(mapKey);
                    }
                } catch (e) { console.warn('Falha ao atualizar cache local ap√≥s exclus√£o:', e); }

                atualizarListaRegistrosLimpeza(); // Recarregar lista
            } catch (err) {
                console.error('Erro ao excluir registro:', err);
                alert('Erro ao conectar com o servidor');
            }
        }

        async function executarLimpezaFinanceiro() {
            const module = document.getElementById('cleanup-module').value;
            const confirmText = document.getElementById('cleanup-confirm-admin').value;
            const checkboxes = document.querySelectorAll('.cleanup-record-checkbox:checked');

            if (!module) {
                alert('Selecione um m√≥dulo');
                return;
            }

            if (checkboxes.length === 0) {
                alert('Selecione pelo menos um registro para excluir');
                return;
            }

            if (confirmText !== 'DELETE') {
                alert('Digite "DELETE" para confirmar a exclus√£o');
                return;
            }

            const recordIds = Array.from(checkboxes).map(cb => cb.value);

            if (!confirm(`‚ö†Ô∏è Tem certeza que deseja excluir ${recordIds.length} registro(s)?\n\nEsta a√ß√£o n√£o pode ser desfeita!`)) {
                return;
            }

            try {
                const resp = await fetch('/api/cleanup/delete-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        module: module,
                        recordIds: recordIds,
                        confirm: true
                    })
                });

                if (!resp.ok) {
                    const data = await resp.json();
                    alert('Erro: ' + (data.error || 'Erro ao executar limpeza'));
                    return;
                }

                const data = await resp.json();
                alert(`‚úì Limpeza conclu√≠da!\n\nRegistros removidos: ${data.deleted}\nBackup: ${data.backup || 'Nenhum'}`);
                fecharModalLimpezaFinanceiro();
                
                // Recarregar dados se sistema estiver inicializado
                if (sistema && sistema.dados) {
                    // Atualizar cache local removendo os ids exclu√≠dos para evitar re-cria√ß√£o por sincroniza√ß√£o
                    try {
                        const mapKey = module === 'ordens_servico' ? 'ordensServico' : module;
                        const idsToRemove = recordIds.map(id => String(id));
                        if (Array.isArray(sistema.dados[mapKey])) {
                            sistema.dados[mapKey] = sistema.dados[mapKey].filter(it => !idsToRemove.includes(String(it.id)));
                            sistema.salvarDados(mapKey);
                        }
                    } catch (e) { console.warn('Erro ao atualizar cache local ap√≥s limpeza:', e); }

                    if (typeof sistema.carregarDados === 'function') sistema.carregarDados();
                }
            } catch (err) {
                console.error('Erro ao executar limpeza:', err);
                alert('Erro ao conectar com o servidor');
            }
        }
    </script>
</body>
</html>

