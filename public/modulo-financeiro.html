<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro Oficina</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset e variáveis */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --sidebar-width: 250px;
            --topbar-height: 70px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            transition: width 0.3s;
        }

        .logo {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .logo i {
            font-size: 24px;
            color: var(--secondary-color);
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .nav-menu {
            list-style: none;
            padding: 20px 0;
            flex: 1;
        }

        .nav-menu li {
            margin: 5px 0;
        }

        .nav-menu a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(52, 152, 219, 0.1);
            color: white;
            border-left-color: var(--secondary-color);
        }

        .nav-menu i {
            width: 20px;
            text-align: center;
        }

        .nav-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 25px;
        }

        .sync-status {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.1);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
        }

        .status-indicator.offline {
            background: var(--danger-color);
        }

        .btn-sync {
            background: var(--secondary-color);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            margin-left: auto;
            transition: background 0.3s;
        }

        .btn-sync:hover {
            background: #2980b9;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            height: var(--topbar-height);
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--light-color);
            padding: 10px 20px;
            border-radius: 25px;
            width: 400px;
        }

        .search-box input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            outline: none;
        }

        .search-box i {
            color: #7f8c8d;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--secondary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
        }

        .user-role {
            font-size: 12px;
            color: #7f8c8d;
        }

        /* Dashboard */
        .dashboard {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .dashboard h2 {
            margin-bottom: 30px;
            color: var(--primary-color);
        }

        /* Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .card-receber .card-icon {
            background: var(--success-color);
        }

        .card-pagar .card-icon {
            background: var(--danger-color);
        }

        .card-saldo .card-icon {
            background: var(--secondary-color);
        }

        .card-inadimplencia .card-icon {
            background: var(--warning-color);
        }

        .card-content h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .amount {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .trend {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .trend.positive {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .trend.negative {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .chart-container,
        .vencimentos-container,
        .recent-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-container {
            grid-row: span 2;
        }

        .vencimentos-list,
        .recent-list {
            margin-top: 15px;
        }

        .vencimento-item,
        .recent-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vencimento-item:last-child,
        .recent-item:last-child {
            border-bottom: none;
        }

        .vencimento-info h4,
        .recent-info h4 {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .vencimento-info span,
        .recent-info span {
            font-size: 12px;
            color: #7f8c8d;
        }

        .vencimento-valor,
        .recent-valor {
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #219653;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
        }

        .btn-whatsapp:hover {
            background: #1da851;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .badge-danger {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .badge-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .badge-info {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tabelas */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid var(--success-color);
        }

        .toast-error {
            border-left: 4px solid var(--danger-color);
        }

        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast-info {
            border-left: 4px solid var(--secondary-color);
        }

        /* Orçamento Info */
        .orcamento-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary-color);
        }

        .orcamento-info h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-label {
            color: #7f8c8d;
        }

        .info-value {
            font-weight: 600;
        }

        .total-row {
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            font-size: 16px;
        }

        /* Responsividade */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .logo h1,
            .nav-menu span,
            .sync-status span {
                display: none;
            }
            
            .nav-menu a {
                justify-content: center;
                padding: 15px;
            }
            
            .top-bar {
                padding: 0 15px;
            }
            
            .search-box {
                width: 200px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--secondary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Utilitários */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .ml-auto {
            margin-left: auto;
        }

        .d-flex {
            display: flex;
        }

        .align-center {
            align-items: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">
            <i class="fas fa-chart-line"></i>
            <h1>Financeiro</h1>
        </div>
        
        <ul class="nav-menu">
            <li><a href="#dashboard" class="active" onclick="showSection('dashboard')">
                <i class="fas fa-home"></i> <span>Dashboard</span>
            </a></li>
            <li><a href="#receber" onclick="showSection('receber')">
                <i class="fas fa-money-bill-wave"></i> <span>Contas a Receber</span>
            </a></li>
            <li><a href="#pagar" onclick="showSection('pagar')">
                <i class="fas fa-credit-card"></i> <span>Contas a Pagar</span>
            </a></li>
            <li><a href="#relatorios" onclick="showSection('relatorios')">
                <i class="fas fa-chart-bar"></i> <span>Relatórios</span>
            </a></li>
        </ul>
        
        <div class="sync-status">
            <div class="status-indicator" id="status-indicator"></div>
            <span id="status-text">Offline</span>
            <button class="btn-sync" onclick="syncManager.trySync()">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="Buscar cliente, OS ou orçamento...">
            </div>
            
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <span class="user-name" id="user-name">Admin</span>
                    <span class="user-role">Financeiro</span>
                </div>
            </div>
        </header>

        <!-- Dashboard Section -->
        <div class="dashboard active" id="dashboard-section">
            <h2>Dashboard Financeiro</h2>
            
            <div class="summary-cards">
                <div class="card card-receber">
                    <div class="card-icon">
                        <i class="fas fa-arrow-down"></i>
                    </div>
                    <div class="card-content">
                        <h3>Receber Hoje</h3>
                        <p class="amount" id="receber-hoje">R$ 0,00</p>
                        <span class="trend positive">+0% vs ontem</span>
                    </div>
                </div>
                
                <div class="card card-pagar">
                    <div class="card-icon">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="card-content">
                        <h3>Pagar Hoje</h3>
                        <p class="amount" id="pagar-hoje">R$ 0,00</p>
                        <span class="trend negative">-0% vs ontem</span>
                    </div>
                </div>
                
                <div class="card card-saldo">
                    <div class="card-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="card-content">
                        <h3>Saldo do Mês</h3>
                        <p class="amount" id="saldo-mes">R$ 0,00</p>
                        <span class="trend positive">+0% vs último mês</span>
                    </div>
                </div>
                
                <div class="card card-inadimplencia">
                    <div class="card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-content">
                        <h3>Inadimplência</h3>
                        <p class="amount" id="inadimplencia">0%</p>
                        <span class="trend positive">-0% vs último mês</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="chart-container">
                    <h3>Fluxo de Caixa (7 dias)</h3>
                    <canvas id="cashflow-chart"></canvas>
                </div>
                
                <div class="vencimentos-container">
                    <h3>Vencimentos Hoje</h3>
                    <div class="vencimentos-list" id="vencimentos-hoje">
                        <div class="vencimento-item">
                            <div class="vencimento-info">
                                <h4><span class="badge badge-warning">Aberto</span> Cliente Exemplo</h4>
                                <span>Vencimento: Hoje</span>
                            </div>
                            <div class="vencimento-valor">
                                R$ 1.250,00
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="recent-container">
                    <h3>Últimos Recebimentos</h3>
                    <div class="recent-list" id="ultimos-recebimentos">
                        <!-- Carregado via JS -->
                    </div>
                </div>
                
                <div class="recent-container">
                    <h3>Últimos Pagamentos</h3>
                    <div class="recent-list" id="ultimos-pagamentos">
                        <!-- Carregado via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Contas a Receber Section -->
        <div class="dashboard hidden" id="receber-section">
            <div class="d-flex justify-between align-center mb-20">
                <h2>Contas a Receber</h2>
                <button class="btn btn-success" onclick="showModal('modal-lancamento-receber')">
                    <i class="fas fa-plus"></i> Novo Recebimento
                </button>
            </div>

            <div class="filters mb-20">
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" id="filter-cliente" placeholder="Filtrar por cliente...">
                    </div>
                    <div class="form-group">
                        <select id="filter-status-receber">
                            <option value="">Todos os status</option>
                            <option value="aberto">Aberto</option>
                            <option value="pago">Pago</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="filtrarReceber()">
                        <i class="fas fa-filter"></i> Filtrar
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Descrição</th>
                            <th>Parcela</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-receber">
                        <!-- Carregado via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Contas a Pagar Section -->
        <div class="dashboard hidden" id="pagar-section">
            <div class="d-flex justify-between align-center mb-20">
                <h2>Contas a Pagar</h2>
                <div>
                    <button class="btn btn-danger" onclick="showModal('modal-lancamento-pagar')">
                        <i class="fas fa-plus"></i> Novo Pagamento
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Fornecedor</th>
                            <th>Descrição</th>
                            <th>Parcela</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-pagar">
                        <!-- Carregado via JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Relatórios Section -->
        <div class="dashboard hidden" id="relatorios-section">
            <h2>Relatórios</h2>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('rel-duplicatas')">Duplicatas Parceladas</div>
                <div class="tab" onclick="showTab('rel-pagar')">Contas a Pagar</div>
                <div class="tab" onclick="showTab('rel-inadimplencia')">Inadimplência</div>
            </div>

            <div class="tab-content active" id="rel-duplicatas">
                <div class="form-row mb-20">
                    <div class="form-group">
                        <label>Data Início</label>
                        <input type="date" id="rel-data-inicio">
                    </div>
                    <div class="form-group">
                        <label>Data Fim</label>
                        <input type="date" id="rel-data-fim">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="rel-status">
                            <option value="todos">Todos</option>
                            <option value="aberto">Aberto</option>
                            <option value="pago">Pago</option>
                            <option value="atrasado">Atrasado</option>
                        </select>
                    </div>
                    <div class="form-group align-center" style="align-self: flex-end;">
                        <button class="btn btn-primary" onclick="gerarRelatorio('duplicatas')">
                            <i class="fas fa-chart-bar"></i> Gerar Relatório
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="data-table" id="tabela-relatorio">
                        <!-- Carregado via JS -->
                    </table>
                </div>
            </div>

            <div class="tab-content" id="rel-pagar">
                <!-- Conteúdo similar para contas a pagar -->
            </div>

            <div class="tab-content" id="rel-inadimplencia">
                <!-- Conteúdo similar para inadimplência -->
            </div>
        </div>
    </main>

    <!-- Modal Lançamento Receber -->
    <div id="modal-lancamento-receber" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Lançar Recebimento</h3>
                <button class="modal-close" onclick="hideModal('modal-lancamento-receber')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-receber" onsubmit="salvarRecebimento(event)">
                    <div class="form-group" style="position: relative;">
                        <label for="buscar-cliente">Buscar Cliente *</label>
                        <input type="text" id="buscar-cliente" list="clientes-list" 
                               placeholder="Digite o nome do cliente" 
                               oninput="buscarCliente(this.value)"
                               onchange="selecionarClientePorNome(this.value)"
                               autocomplete="off" required>
                        <datalist id="clientes-list"></datalist>
                        <div id="sugestoes-cliente" style="position: absolute; background: white; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; z-index: 1000; display: none; width: calc(100% - 2px); margin-top: 2px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"></div>
                    </div>
                    
                    <div id="cliente-info" class="hidden">
                        <div class="orcamento-info">
                            <h4>Informações do Cliente</h4>
                            <div class="info-row">
                                <span class="info-label">Nome:</span>
                                <span class="info-value" id="info-cliente-nome"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Telefone:</span>
                                <span class="info-value" id="info-cliente-telefone"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Veículo:</span>
                                <span class="info-value" id="info-cliente-veiculo"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="orcamento">Orçamentos Aprovados (OS Finalizada) *</label>
                        <select id="orcamento" onchange="carregarDadosOrcamento(this.value)" required>
                            <option value="">Selecione um orçamento...</option>
                        </select>
                    </div>
                    
                    <div id="orcamento-info" class="hidden">
                        <div class="orcamento-info">
                            <h4>Detalhes do Orçamento</h4>
                            <div class="info-row">
                                <span class="info-label">Orçamento #:</span>
                                <span class="info-value" id="info-orcamento-numero"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Data:</span>
                                <span class="info-value" id="info-orcamento-data"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Serviços:</span>
                                <span class="info-value" id="info-orcamento-servicos"></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Peças:</span>
                                <span class="info-value" id="info-orcamento-pecas"></span>
                            </div>
                            <div class="info-row total-row">
                                <span class="info-label">Valor Total:</span>
                                <span class="info-value" id="info-orcamento-total"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo-pagamento">Forma de Pagamento *</label>
                        <select id="tipo-pagamento" required onchange="mudarTipoPagamento()">
                            <option value="">Selecione...</option>
                            <option value="avista">À Vista</option>
                            <option value="parcelado">Parcelado</option>
                            <option value="entrada">Entrada + Parcelas</option>
                        </select>
                    </div>
                    
                    <div id="campos-parcelado" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numero-parcelas">Número de Parcelas</label>
                                <input type="number" id="numero-parcelas" min="2" max="24" value="2" 
                                       onchange="calcularParcelas()">
                            </div>
                            <div class="form-group">
                                <label for="data-primeira-parcela">Data da 1ª Parcela</label>
                                <input type="date" id="data-primeira-parcela" onchange="calcularParcelas()">
                            </div>
                        </div>
                        
                        <div id="tabela-parcelas" class="hidden">
                            <h4>Plano de Parcelas</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-parcelas">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="campos-entrada" class="hidden">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="valor-entrada">Valor da Entrada (R$) *</label>
                                <input type="number" id="valor-entrada" step="0.01" min="0" 
                                       placeholder="0,00"
                                       oninput="calcularParcelasEntrada()"
                                       onchange="calcularParcelasEntrada()">
                            </div>
                            <div class="form-group">
                                <label for="numero-parcelas-entrada">Número de Parcelas *</label>
                                <input type="number" id="numero-parcelas-entrada" min="1" max="24" value="1" 
                                       onchange="calcularParcelasEntrada()">
                            </div>
                            <div class="form-group">
                                <label for="data-primeira-parcela-entrada">Data da 1ª Parcela *</label>
                                <input type="date" id="data-primeira-parcela-entrada" onchange="calcularParcelasEntrada()">
                            </div>
                        </div>
                        
                        <div id="tabela-entrada-parcelas" class="hidden">
                            <h4>Plano de Pagamento</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Vencimento</th>
                                        <th>Valor</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-entrada-parcelas">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes">Observações</label>
                        <textarea id="observacoes" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('modal-lancamento-receber')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Salvar Recebimento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Lançamento Pagar -->
    <div id="modal-lancamento-pagar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Lançar Pagamento</h3>
                <button class="modal-close" onclick="hideModal('modal-lancamento-pagar')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="form-pagar" onsubmit="salvarPagamento(event)">
                    <div class="form-group">
                        <label for="fornecedor">Fornecedor *</label>
                        <input type="text" id="fornecedor" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descricao-pagar">Descrição *</label>
                        <input type="text" id="descricao-pagar" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="valor-pagar">Valor *</label>
                            <input type="number" id="valor-pagar" step="0.01" min="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="vencimento-pagar">Vencimento *</label>
                            <input type="date" id="vencimento-pagar" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="tipo-pagar">Tipo</label>
                        <select id="tipo-pagar">
                            <option value="normal">Normal</option>
                            <option value="parcelado">Parcelado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes-pagar">Observações</label>
                        <textarea id="observacoes-pagar" rows="3"></textarea>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideModal('modal-lancamento-pagar')">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-save"></i> Salvar Pagamento
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp -->
    <div id="modal-whatsapp" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enviar WhatsApp</h3>
                <button class="modal-close" onclick="hideModal('modal-whatsapp')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="mensagem-whatsapp">Mensagem:</label>
                    <textarea id="mensagem-whatsapp" rows="8"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-whatsapp" onclick="abrirWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Abrir WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="hideModal('modal-whatsapp')">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Banco de Dados - Integrado com index.html via localStorage
        class Database {
            constructor() {
                // Usa localStorage compartilhado com index.html
                this.storageKeys = {
                    clientes: 'clientes',
                    orcamentos: 'orcamentos',
                    ordensServico: 'ordensServico',
                    receber: 'financeiro-receber',
                    pagar: 'financeiro-pagar'
                };
            }
            
            // Função auxiliar para normalizar IDs (pode ser string ou number)
            normalizarId(id) {
                if (id == null || id === undefined || id === '') return null;
                return String(id);
            }
            
            // Função auxiliar para comparar IDs
            idsIguais(id1, id2) {
                if (id1 == null || id2 == null) return false;
                return this.normalizarId(id1) === this.normalizarId(id2);
            }

            async init() {
                // Inicializar arrays vazios se não existirem
                if (!localStorage.getItem(this.storageKeys.receber)) {
                    localStorage.setItem(this.storageKeys.receber, JSON.stringify([]));
                }
                if (!localStorage.getItem(this.storageKeys.pagar)) {
                    localStorage.setItem(this.storageKeys.pagar, JSON.stringify([]));
                }
                console.log('Banco de dados inicializado (localStorage)');
                return Promise.resolve();
            }

            // Métodos para receber e pagar (armazenados no localStorage do módulo financeiro)
            async add(store, data) {
                const key = this.storageKeys[store];
                if (!key) throw new Error(`Store ${store} não encontrado`);
                
                const items = this.getAllSync(store);
                items.push(data);
                localStorage.setItem(key, JSON.stringify(items));
                return Promise.resolve(data.id);
            }

            async put(store, data) {
                const key = this.storageKeys[store];
                if (!key) throw new Error(`Store ${store} não encontrado`);
                
                const items = this.getAllSync(store);
                const index = items.findIndex(item => item.id === data.id);
                if (index >= 0) {
                    items[index] = data;
                } else {
                    items.push(data);
                }
                localStorage.setItem(key, JSON.stringify(items));
                return Promise.resolve(data.id);
            }

            async get(store, key) {
                if (store === 'clientes' || store === 'orcamentos' || store === 'ordensServico') {
                    // Buscar nos dados compartilhados do index.html
                    const items = this.getAllSync(store);
                    return Promise.resolve(items.find(item => item.id == key || item.id === key));
                }
                
                const items = this.getAllSync(store);
                return Promise.resolve(items.find(item => item.id == key || item.id === key));
            }

            getAllSync(store) {
                const key = this.storageKeys[store];
                if (!key) return [];
                
                try {
                    const stored = localStorage.getItem(key);
                    return stored ? JSON.parse(stored) : [];
                } catch (error) {
                    console.error(`Erro ao ler ${store} do localStorage:`, error);
                    return [];
                }
            }

            async getAll(store, index = null, value = null) {
                let items = this.getAllSync(store);
                
                // Filtrar por índice se fornecido
                if (index && value !== null) {
                    items = items.filter(item => {
                        if (index === 'vencimento') {
                            return item.vencimento === value;
                        }
                        return item[index] === value;
                    });
                }
                
                return Promise.resolve(items);
            }

            async delete(store, key) {
                const items = this.getAllSync(store);
                const filtered = items.filter(item => item.id != key && item.id !== key);
                const storageKey = this.storageKeys[store];
                localStorage.setItem(storageKey, JSON.stringify(filtered));
                return Promise.resolve();
            }

            // Métodos específicos
            async gerarId() {
                return Date.now().toString() + Math.random().toString(36).substr(2, 9);
            }

            async getTotalReceberHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const receber = await this.getAll('receber', 'vencimento', hoje);
                return receber
                    .filter(r => r.status === 'aberto')
                    .reduce((total, r) => total + (r.valor || 0), 0);
            }

            async getTotalPagarHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const pagar = await this.getAll('pagar', 'vencimento', hoje);
                return pagar
                    .filter(p => p.status === 'aberto')
                    .reduce((total, p) => total + (p.valor || 0), 0);
            }

            async getVencimentosHoje() {
                const hoje = new Date().toISOString().split('T')[0];
                const receber = await this.getAll('receber', 'vencimento', hoje);
                const pagar = await this.getAll('pagar', 'vencimento', hoje);
                
                return {
                    receber: receber.filter(r => r.status === 'aberto'),
                    pagar: pagar.filter(p => p.status === 'aberto')
                };
            }

            async getUltimosRecebimentos() {
                const receber = await this.getAll('receber');
                return receber
                    .filter(r => r.status === 'pago')
                    .sort((a, b) => new Date(b.dataPagamento || 0) - new Date(a.dataPagamento || 0))
                    .slice(0, 5);
            }

            async getUltimosPagamentos() {
                const pagar = await this.getAll('pagar');
                return pagar
                    .filter(p => p.status === 'pago')
                    .sort((a, b) => new Date(b.dataPagamento || 0) - new Date(a.dataPagamento || 0))
                    .slice(0, 5);
            }

            async getFluxoCaixa7Dias() {
                const hoje = new Date();
                const fluxo = [];
                
                for (let i = 0; i < 7; i++) {
                    const data = new Date(hoje);
                    data.setDate(hoje.getDate() + i);
                    const dataStr = data.toISOString().split('T')[0];
                    
                    const receber = await this.getAll('receber', 'vencimento', dataStr);
                    const pagar = await this.getAll('pagar', 'vencimento', dataStr);
                    
                    const totalReceber = receber
                        .filter(r => r.status === 'aberto')
                        .reduce((sum, r) => sum + (r.valor || 0), 0);
                        
                    const totalPagar = pagar
                        .filter(p => p.status === 'aberto')
                        .reduce((sum, p) => sum + (p.valor || 0), 0);
                    
                    fluxo.push({
                        data: dataStr,
                        receber: totalReceber,
                        pagar: totalPagar,
                        saldo: totalReceber - totalPagar
                    });
                }
                
                return fluxo;
            }

            async buscarClientesPorNome(nome) {
                // Buscar clientes do localStorage compartilhado com index.html
                const clientes = this.getAllSync('clientes');
                console.log('Total de clientes no localStorage:', clientes.length);
                
                if (!nome) return Promise.resolve(clientes);
                
                const clientesFiltrados = clientes.filter(cliente => 
                    cliente.nome && cliente.nome.toLowerCase().includes(nome.toLowerCase())
                );
                
                console.log('Clientes encontrados para:', nome, 'Total:', clientesFiltrados.length);
                
                return Promise.resolve(clientesFiltrados);
            }

            async getOrcamentosAprovadosPorCliente(clienteId) {
                // Forçar recarregamento dos dados do localStorage (pode ter sido atualizado no index.html)
                const orcamentosRaw = localStorage.getItem('orcamentos');
                const ordensServicoRaw = localStorage.getItem('ordensServico');
                
                let orcamentos = [];
                let ordensServico = [];
                
                try {
                    orcamentos = orcamentosRaw ? JSON.parse(orcamentosRaw) : [];
                    ordensServico = ordensServicoRaw ? JSON.parse(ordensServicoRaw) : [];
                } catch (error) {
                    console.error('Erro ao parsear dados do localStorage:', error);
                    return Promise.resolve([]);
                }
                
                // Normalizar clienteId para comparação
                const clienteIdNormalizado = this.normalizarId(clienteId);
                
                console.log('=== BUSCA DE ORÇAMENTOS ===');
                console.log('Cliente ID:', clienteId, 'Normalizado:', clienteIdNormalizado);
                console.log('Total de orçamentos no localStorage:', orcamentos.length);
                console.log('Total de OS no localStorage:', ordensServico.length);
                
                // Debug: mostrar todos os orçamentos
                console.log('Todos os orçamentos:', orcamentos.map(o => ({
                    id: o.id,
                    numero: o.numero,
                    clienteId: o.clienteId || o.cliente_id,
                    status: o.status
                })));
                
                // Debug: mostrar todas as OS
                console.log('Todas as OS:', ordensServico.map(os => ({
                    id: os.id,
                    numero: os.numero,
                    orcamentoId: os.orcamentoId || os.orcamento_id,
                    status: os.status
                })));
                
                if (orcamentos.length === 0) {
                    console.warn('⚠️ Nenhum orçamento encontrado no localStorage!');
                    return Promise.resolve([]);
                }
                
                // Filtrar orçamentos aprovados e finalizados do cliente
                // Verificar tanto clienteId quanto cliente_id (formato do servidor)
                const orcamentosAprovadosEFinalizados = orcamentos.filter(orcamento => {
                    const orcClienteId = this.normalizarId(orcamento.clienteId);
                    const orcClienteIdAlt = this.normalizarId(orcamento.cliente_id);
                    // Aceitar orçamentos aprovados OU finalizados
                    const statusOk = orcamento.status === 'aprovado' || orcamento.status === 'finalizado';
                    const clienteOk = this.idsIguais(orcClienteId, clienteIdNormalizado) || 
                                     this.idsIguais(orcClienteIdAlt, clienteIdNormalizado);
                    
                    if (clienteOk) {
                        console.log('Orçamento do cliente encontrado:', {
                            id: orcamento.id,
                            numero: orcamento.numero,
                            clienteId: orcamento.clienteId || orcamento.cliente_id,
                            status: orcamento.status,
                            statusOk: statusOk
                        });
                    }
                    
                    return clienteOk && statusOk;
                });
                
                console.log('✅ Orçamentos aprovados e finalizados encontrados:', orcamentosAprovadosEFinalizados.length);
                
                if (orcamentosAprovadosEFinalizados.length === 0) {
                    console.warn('⚠️ Nenhum orçamento aprovado ou finalizado encontrado para este cliente');
                    return Promise.resolve([]);
                }
                
                console.log('=== FIM DA BUSCA ===');
                
                return Promise.resolve(orcamentosAprovadosEFinalizados);
            }

            async getOrcamentoCompleto(orcamentoId) {
                const orcamentos = this.getAllSync('orcamentos');
                const orcamento = orcamentos.find(o => o.id == orcamentoId || o.id === orcamentoId);
                
                if (!orcamento) return Promise.resolve(null);
                
                // Calcular valores se não existirem
                if (!orcamento.valorTotal && orcamento.total) {
                    orcamento.valorTotal = orcamento.total;
                }
                
                // Buscar serviços e peças
                if (orcamento.servicos && typeof orcamento.servicos === 'string') {
                    try {
                        orcamento.servicos = JSON.parse(orcamento.servicos);
                    } catch (e) {
                        orcamento.servicos = [];
                    }
                }
                
                if (orcamento.pecas && typeof orcamento.pecas === 'string') {
                    try {
                        orcamento.pecas = JSON.parse(orcamento.pecas);
                    } catch (e) {
                        orcamento.pecas = [];
                    }
                }
                
                // Calcular totais se necessário
                if (!orcamento.valorTotal) {
                    const valorServicos = Array.isArray(orcamento.servicos) 
                        ? orcamento.servicos.reduce((sum, s) => sum + (parseFloat(s.valor) || 0), 0)
                        : 0;
                    const valorPecas = Array.isArray(orcamento.pecas)
                        ? orcamento.pecas.reduce((sum, p) => sum + (parseFloat(p.valor) || 0), 0)
                        : 0;
                    const desconto = parseFloat(orcamento.desconto) || 0;
                    orcamento.valorTotal = valorServicos + valorPecas - desconto;
                }
                
                return Promise.resolve(orcamento);
            }
        }

        // Sync Manager
        class SyncManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.updateStatus();
            }

            updateStatus() {
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                if (this.isOnline) {
                    indicator.className = 'status-indicator';
                    text.textContent = 'Online';
                } else {
                    indicator.className = 'status-indicator offline';
                    text.textContent = 'Offline';
                }
            }

            async trySync() {
                if (!this.isOnline) {
                    showToast('Você está offline. Sincronização adiada.', 'warning');
                    return;
                }

                showToast('Sincronizando...', 'info');
                // Simular sincronização
                await new Promise(resolve => setTimeout(resolve, 1000));
                showToast('Sincronização concluída!', 'success');
            }
        }

        // WhatsApp Manager
        class WhatsAppManager {
            getSaudacao() {
                const hora = new Date().getHours();
                
                if (hora >= 5 && hora < 12) return 'Bom dia';
                if (hora >= 12 && hora < 18) return 'Boa tarde';
                if (hora >= 18 && hora <= 23) return 'Boa noite';
                return 'Olá';
            }

            formatarTelefone(telefone) {
                if (!telefone) return '';
                return telefone.replace(/\D/g, '');
            }

            gerarMensagem(cliente, duplicata) {
                const saudacao = this.getSaudacao();
                const nomeCliente = cliente.nome.split(' ')[0];
                
                return `${saudacao}, ${nomeCliente}! Tudo bem?
Aqui é da Oficina Mecânica.
Passando para lembrar que hoje vence a parcela ${duplicata.parcela} referente a: ${duplicata.descricao}.

📅 Vencimento: ${this.formatarDataBR(duplicata.vencimento)}
💰 Valor: R$ ${duplicata.valor.toFixed(2)}

Se já realizou o pagamento, por favor nos avise.

Obrigado!`;
            }

            formatarDataBR(dataISO) {
                const [ano, mes, dia] = dataISO.split('-');
                return `${dia}/${mes}/${ano}`;
            }

            gerarLink(telefone, mensagem) {
                const tel = this.formatarTelefone(telefone);
                const msg = encodeURIComponent(mensagem);
                return `https://wa.me/55${tel}?text=${msg}`;
            }
        }

        // UI Manager
        class UIManager {
            constructor() {
                this.db = new Database();
                this.syncManager = new SyncManager();
                this.whatsappManager = new WhatsAppManager();
                this.duplicataAtual = null;
                this.clienteAtual = null;
                this.orcamentoAtual = null;
                this.clienteSelecionado = null;
            }

            async init() {
                await this.db.init();
                this.carregarDadosDashboard();
                this.carregarReceber();
                this.carregarPagar();
                this.verificarVencimentos();
                this.iniciarChart();

                // Verificar vencimentos periodicamente
                setInterval(() => this.verificarVencimentos(), 300000); // 5 minutos
                
                // Atualizar dados quando localStorage mudar (sincronização com index.html)
                window.addEventListener('storage', () => {
                    this.carregarDadosDashboard();
                    this.carregarReceber();
                });
            }

            // Dados vêm do index.html via localStorage, não precisa criar exemplos

            async carregarDadosDashboard() {
                const receberHoje = await this.db.getTotalReceberHoje();
                const pagarHoje = await this.db.getTotalPagarHoje();
                
                document.getElementById('receber-hoje').textContent = 
                    this.formatarMoeda(receberHoje);
                document.getElementById('pagar-hoje').textContent = 
                    this.formatarMoeda(pagarHoje);
                document.getElementById('saldo-mes').textContent = 
                    this.formatarMoeda(receberHoje - pagarHoje);
                
                // Carregar vencimentos hoje
                const vencimentos = await this.db.getVencimentosHoje();
                this.atualizarVencimentosHoje(vencimentos);
                
                // Carregar últimos recebimentos
                const ultimosRecebimentos = await this.db.getUltimosRecebimentos();
                this.atualizarUltimosRecebimentos(ultimosRecebimentos);
                
                // Carregar últimos pagamentos
                const ultimosPagamentos = await this.db.getUltimosPagamentos();
                this.atualizarUltimosPagamentos(ultimosPagamentos);
            }

            atualizarVencimentosHoje(vencimentos) {
                const container = document.getElementById('vencimentos-hoje');
                let html = '';
                
                vencimentos.receber.forEach(item => {
                    html += `
                        <div class="vencimento-item">
                            <div class="vencimento-info">
                                <h4><span class="badge badge-warning">A Receber</span> ${item.cliente}</h4>
                                <span>${item.descricao}</span>
                            </div>
                            <div class="vencimento-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                vencimentos.pagar.forEach(item => {
                    html += `
                        <div class="vencimento-item">
                            <div class="vencimento-info">
                                <h4><span class="badge badge-danger">A Pagar</span> ${item.fornecedor}</h4>
                                <span>${item.descricao}</span>
                            </div>
                            <div class="vencimento-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="text-center">Nenhum vencimento para hoje</div>';
                }
                
                container.innerHTML = html;
            }

            atualizarUltimosRecebimentos(recebimentos) {
                const container = document.getElementById('ultimos-recebimentos');
                let html = '';
                
                recebimentos.forEach(item => {
                    html += `
                        <div class="recent-item">
                            <div class="recent-info">
                                <h4>${item.cliente}</h4>
                                <span>${this.formatarData(item.dataPagamento)}</span>
                            </div>
                            <div class="recent-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="text-center">Nenhum recebimento recente</div>';
                }
                
                container.innerHTML = html;
            }

            atualizarUltimosPagamentos(pagamentos) {
                const container = document.getElementById('ultimos-pagamentos');
                let html = '';
                
                pagamentos.forEach(item => {
                    html += `
                        <div class="recent-item">
                            <div class="recent-info">
                                <h4>${item.fornecedor}</h4>
                                <span>${this.formatarData(item.dataPagamento)}</span>
                            </div>
                            <div class="recent-valor">
                                R$ ${item.valor.toFixed(2)}
                            </div>
                        </div>
                    `;
                });
                
                if (!html) {
                    html = '<div class="text-center">Nenhum pagamento recente</div>';
                }
                
                container.innerHTML = html;
            }

            async carregarReceber() {
                const receber = await this.db.getAll('receber');
                const tabela = document.getElementById('tabela-receber');
                let html = '';
                
                receber.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.cliente}</td>
                            <td>${item.descricao}</td>
                            <td>${item.parcela || '1/1'}</td>
                            <td>R$ ${item.valor.toFixed(2)}</td>
                            <td>${this.formatarData(item.vencimento)}</td>
                            <td>${this.criarBadgeStatus(item.status)}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="ui.marcarComoPago('${item.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-whatsapp btn-sm" onclick="ui.enviarWhatsAppDuplicata('${item.id}')">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tabela.innerHTML = html || '<tr><td colspan="7" class="text-center">Nenhuma conta a receber</td></tr>';
            }

            async carregarPagar() {
                const pagar = await this.db.getAll('pagar');
                const tabela = document.getElementById('tabela-pagar');
                let html = '';
                
                pagar.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.fornecedor}</td>
                            <td>${item.descricao}</td>
                            <td>${item.parcela || '1/1'}</td>
                            <td>R$ ${item.valor.toFixed(2)}</td>
                            <td>${this.formatarData(item.vencimento)}</td>
                            <td>${this.criarBadgeStatus(item.status)}</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="ui.marcarComoPagoPagar('${item.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tabela.innerHTML = html || '<tr><td colspan="7" class="text-center">Nenhuma conta a pagar</td></tr>';
            }

            criarBadgeStatus(status) {
                switch(status) {
                    case 'aberto': return '<span class="badge badge-warning">Aberto</span>';
                    case 'pago': return '<span class="badge badge-success">Pago</span>';
                    case 'atrasado': return '<span class="badge badge-danger">Atrasado</span>';
                    default: return '<span class="badge">' + status + '</span>';
                }
            }

            formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(valor);
            }

            formatarData(dataISO) {
                if (!dataISO) return '-';
                return new Date(dataISO).toLocaleDateString('pt-BR');
            }

            async verificarVencimentos() {
                const hoje = new Date().toISOString().split('T')[0];
                const receber = await this.db.getAll('receber', 'vencimento', hoje);
                
                const vencimentosHoje = receber.filter(r => r.status === 'aberto');
                
                if (vencimentosHoje.length > 0) {
                    const primeiro = vencimentosHoje[0];
                    // Buscar cliente do localStorage compartilhado
                    const clientes = this.db.getAllSync('clientes');
                    const cliente = clientes.find(c => c.id == primeiro.clienteId) || { nome: 'Cliente' };
                    
                    this.duplicataAtual = primeiro;
                    this.clienteAtual = cliente;
                    
                    // Mostrar notificação de vencimento
                    showToast(`${cliente.nome} tem uma duplicata vencendo hoje!`, 'warning');
                }
            }

            async marcarComoPago(id) {
                try {
                    const duplicata = await this.db.get('receber', id);
                    if (!duplicata) return;
                    
                    duplicata.status = 'pago';
                    duplicata.dataPagamento = new Date().toISOString().split('T')[0];
                    
                    await this.db.put('receber', duplicata);
                    
                    showToast('Duplicata marcada como paga!', 'success');
                    this.carregarReceber();
                    this.carregarDadosDashboard();
                    
                } catch (error) {
                    console.error('Erro ao marcar como pago:', error);
                    showToast('Erro ao marcar como pago', 'error');
                }
            }

            async marcarComoPagoPagar(id) {
                try {
                    const duplicata = await this.db.get('pagar', id);
                    if (!duplicata) return;
                    
                    duplicata.status = 'pago';
                    duplicata.dataPagamento = new Date().toISOString().split('T')[0];
                    
                    await this.db.put('pagar', duplicata);
                    
                    showToast('Conta marcada como paga!', 'success');
                    this.carregarPagar();
                    this.carregarDadosDashboard();
                    
                } catch (error) {
                    console.error('Erro ao marcar como pago:', error);
                    showToast('Erro ao marcar como pago', 'error');
                }
            }

            async enviarWhatsAppDuplicata(id) {
                const duplicata = await this.db.get('receber', id);
                if (!duplicata) return;
                
                // Buscar cliente do localStorage compartilhado
                const clientes = this.db.getAllSync('clientes');
                const cliente = clientes.find(c => c.id == duplicata.clienteId);
                
                if (!cliente || (!cliente.telefone && !cliente.whatsapp)) {
                    showToast('Cliente sem telefone cadastrado', 'warning');
                    return;
                }
                
                this.duplicataAtual = duplicata;
                this.clienteAtual = cliente;
                
                const mensagem = this.whatsappManager.gerarMensagem(cliente, duplicata);
                document.getElementById('mensagem-whatsapp').value = mensagem;
                
                showModal('modal-whatsapp');
            }

            async buscarCliente(nome) {
                if (!nome || nome.trim() === '') {
                    const datalist = document.getElementById('clientes-list');
                    datalist.innerHTML = '';
                    const sugestoes = document.getElementById('sugestoes-cliente');
                    if (sugestoes) sugestoes.style.display = 'none';
                    this.clienteSelecionado = null;
                    document.getElementById('cliente-info').classList.add('hidden');
                    document.getElementById('orcamento').innerHTML = '<option value="">Selecione um orçamento...</option>';
                    document.getElementById('orcamento-info').classList.add('hidden');
                    return;
                }
                
                const clientes = await this.db.buscarClientesPorNome(nome);
                const datalist = document.getElementById('clientes-list');
                const sugestoes = document.getElementById('sugestoes-cliente');
                
                // Limpar datalist
                datalist.innerHTML = '';
                
                // Limpar e preencher sugestões
                if (sugestoes) {
                    sugestoes.innerHTML = '';
                    if (clientes.length > 0) {
                        sugestoes.style.display = 'block';
                        clientes.forEach(cliente => {
                            const div = document.createElement('div');
                            div.style.padding = '10px';
                            div.style.cursor = 'pointer';
                            div.style.borderBottom = '1px solid #eee';
                            div.textContent = cliente.nome;
                            div.onmouseover = () => div.style.background = '#f0f0f0';
                            div.onmouseout = () => div.style.background = 'white';
                            div.onclick = () => {
                                document.getElementById('buscar-cliente').value = cliente.nome;
                                this.selecionarCliente(cliente);
                                sugestoes.style.display = 'none';
                            };
                            sugestoes.appendChild(div);
                        });
                    } else {
                        sugestoes.style.display = 'none';
                    }
                }
                
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nome;
                    option.dataset.id = cliente.id;
                    datalist.appendChild(option);
                });
                
                // Se encontrou exatamente um cliente com nome exato, preencher informações
                const clienteExato = clientes.find(c => c.nome.toLowerCase().trim() === nome.toLowerCase().trim());
                if (clienteExato) {
                    await this.selecionarCliente(clienteExato);
                    if (sugestoes) sugestoes.style.display = 'none';
                } else if (clientes.length === 0) {
                    this.clienteSelecionado = null;
                    document.getElementById('cliente-info').classList.add('hidden');
                    document.getElementById('orcamento').innerHTML = '<option value="">Selecione um orçamento...</option>';
                    document.getElementById('orcamento-info').classList.add('hidden');
                }
            }
            
            async selecionarClientePorNome(nome) {
                if (!nome || nome.trim() === '') return;
                
                const clientes = await this.db.buscarClientesPorNome(nome);
                const clienteExato = clientes.find(c => c.nome.toLowerCase().trim() === nome.toLowerCase().trim());
                
                if (clienteExato) {
                    await this.selecionarCliente(clienteExato);
                    const sugestoes = document.getElementById('sugestoes-cliente');
                    if (sugestoes) sugestoes.style.display = 'none';
                }
            }

            async selecionarCliente(cliente) {
                this.clienteSelecionado = cliente;
                
                console.log('=== CLIENTE SELECIONADO ===');
                console.log('Cliente completo:', cliente);
                console.log('Cliente ID:', cliente.id, 'Tipo:', typeof cliente.id);
                
                // Buscar veículos do cliente (do localStorage compartilhado)
                const veiculos = JSON.parse(localStorage.getItem('veiculos') || '[]');
                const clienteIdNormalizado = cliente.id != null ? String(cliente.id) : null;
                const veiculosCliente = veiculos.filter(v => {
                    const vClienteId = v.clienteId != null ? String(v.clienteId) : null;
                    return vClienteId === clienteIdNormalizado;
                });
                const veiculoTexto = veiculosCliente.length > 0 
                    ? veiculosCliente.map(v => `${v.marca || ''} ${v.modelo || ''} ${v.ano || ''}`.trim()).join(', ')
                    : 'Não informado';
                
                // Mostrar informações do cliente
                document.getElementById('info-cliente-nome').textContent = cliente.nome;
                document.getElementById('info-cliente-telefone').textContent = cliente.whatsapp || cliente.telefone || 'Não informado';
                document.getElementById('info-cliente-veiculo').textContent = veiculoTexto;
                document.getElementById('cliente-info').classList.remove('hidden');
                
                // Preencher campo de busca
                document.getElementById('buscar-cliente').value = cliente.nome;
                
                // Carregar orçamentos do cliente - usar o ID do cliente
                const clienteId = cliente.id;
                console.log('Iniciando carregamento de orçamentos para cliente ID:', clienteId);
                await this.carregarOrcamentosCliente(clienteId);
            }

            async carregarOrcamentosCliente(clienteId) {
                console.log('=== CARREGANDO ORÇAMENTOS ===');
                console.log('Cliente ID recebido:', clienteId, 'Tipo:', typeof clienteId);
                
                const orcamentos = await this.db.getOrcamentosAprovadosPorCliente(clienteId);
                const select = document.getElementById('orcamento');
                
                console.log('Orçamentos retornados:', orcamentos);
                console.log('Quantidade de orçamentos:', orcamentos ? orcamentos.length : 0);
                
                select.innerHTML = '<option value="">Selecione um orçamento...</option>';
                
                if (orcamentos && orcamentos.length > 0) {
                    console.log('✅ Preenchendo dropdown com', orcamentos.length, 'orçamentos');
                    orcamentos.forEach((orcamento, index) => {
                        const option = document.createElement('option');
                        option.value = orcamento.id;
                        // Usar total se valorTotal não existir
                        const valor = orcamento.valorTotal || orcamento.total || 0;
                        const numero = orcamento.numero || `#${orcamento.id}`;
                        option.textContent = `OS ${numero} - ${this.formatarMoeda(valor)}`;
                        select.appendChild(option);
                        console.log(`  ${index + 1}. Orçamento ${numero} - R$ ${valor}`);
                    });
                } else {
                    console.warn('⚠️ Nenhum orçamento encontrado, verificando detalhes...');
                    
                    // Verificar se há orçamentos aprovados ou finalizados
                    const todosOrcamentos = this.db.getAllSync('orcamentos');
                    const clienteIdNormalizado = clienteId != null ? String(clienteId) : null;
                    
                    console.log('Total de orçamentos no sistema:', todosOrcamentos.length);
                    
                    const orcamentosAprovadosEFinalizados = todosOrcamentos.filter(orcamento => {
                        const orcClienteId = orcamento.clienteId != null ? String(orcamento.clienteId) : null;
                        const orcClienteIdAlt = orcamento.cliente_id != null ? String(orcamento.cliente_id) : null;
                        const clienteOk = orcClienteId === clienteIdNormalizado || orcClienteIdAlt === clienteIdNormalizado;
                        // Aceitar orçamentos aprovados OU finalizados
                        const statusOk = orcamento.status === 'aprovado' || orcamento.status === 'finalizado';
                        
                        if (clienteOk) {
                            console.log('Orçamento do cliente encontrado:', {
                                id: orcamento.id,
                                numero: orcamento.numero,
                                status: orcamento.status,
                                statusOk: statusOk
                            });
                        }
                        
                        return clienteOk && statusOk;
                    });
                    
                    console.log('Orçamentos aprovados e finalizados do cliente:', orcamentosAprovadosEFinalizados.length);
                    
                    if (orcamentosAprovadosEFinalizados.length === 0) {
                        select.innerHTML = '<option value="">Nenhum orçamento aprovado ou finalizado encontrado para este cliente</option>';
                    } else {
                        select.innerHTML = '<option value="">Erro ao carregar orçamentos. Verifique o console.</option>';
                    }
                }
                
                console.log('=== FIM DO CARREGAMENTO ===');
            }

            async carregarDadosOrcamento(orcamentoId) {
                if (!orcamentoId) {
                    document.getElementById('orcamento-info').classList.add('hidden');
                    return;
                }
                
                const orcamento = await this.db.getOrcamentoCompleto(orcamentoId);
                if (!orcamento) return;
                
                this.orcamentoAtual = orcamento;
                
                // Formatar serviços e peças
                let servicosTexto = '';
                if (Array.isArray(orcamento.servicos)) {
                    servicosTexto = orcamento.servicos.map(s => {
                        if (typeof s === 'string') return s;
                        return s.descricao || s.nome || s.servico || JSON.stringify(s);
                    }).join(', ');
                } else if (typeof orcamento.servicos === 'string') {
                    servicosTexto = orcamento.servicos;
                }
                
                let pecasTexto = '';
                if (Array.isArray(orcamento.pecas)) {
                    pecasTexto = orcamento.pecas.map(p => {
                        if (typeof p === 'string') return p;
                        return p.descricao || p.nome || p.peca || JSON.stringify(p);
                    }).join(', ');
                } else if (typeof orcamento.pecas === 'string') {
                    pecasTexto = orcamento.pecas;
                }
                
                // Mostrar informações do orçamento
                document.getElementById('info-orcamento-numero').textContent = orcamento.numero || `#${orcamento.id}`;
                document.getElementById('info-orcamento-data').textContent = this.formatarData(orcamento.data);
                document.getElementById('info-orcamento-servicos').textContent = servicosTexto || 'Nenhum serviço';
                document.getElementById('info-orcamento-pecas').textContent = pecasTexto || 'Nenhuma peça';
                document.getElementById('info-orcamento-total').textContent = this.formatarMoeda(orcamento.valorTotal || 0);
                
                document.getElementById('orcamento-info').classList.remove('hidden');
                
                // Atualizar cálculo de parcelas
                this.calcularParcelas();
            }

            calcularParcelas() {
                if (!this.orcamentoAtual) return;
                
                const tipoPagamento = document.getElementById('tipo-pagamento').value;
                const valorTotal = this.orcamentoAtual.valorTotal;
                
                if (tipoPagamento === 'parcelado') {
                    const numParcelas = parseInt(document.getElementById('numero-parcelas').value);
                    const dataPrimeira = document.getElementById('data-primeira-parcela').value;
                    
                    if (!dataPrimeira) return;
                    
                    const valorParcela = valorTotal / numParcelas;
                    const tbody = document.getElementById('lista-parcelas');
                    tbody.innerHTML = '';
                    
                    for (let i = 1; i <= numParcelas; i++) {
                        const dataVencimento = new Date(dataPrimeira);
                        dataVencimento.setMonth(dataVencimento.getMonth() + (i - 1));
                        
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${i}/${numParcelas}</td>
                            <td>${dataVencimento.toLocaleDateString('pt-BR')}</td>
                            <td>${this.formatarMoeda(valorParcela)}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                    
                    document.getElementById('tabela-parcelas').classList.remove('hidden');
                    
                } else if (tipoPagamento === 'entrada') {
                    const valorEntrada = parseFloat(document.getElementById('valor-entrada').value) || 0;
                    const numParcelas = parseInt(document.getElementById('numero-parcelas-entrada').value) || 1;
                    const dataPrimeira = document.getElementById('data-primeira-parcela-entrada').value;
                    
                    if (!this.orcamentoAtual) return;
                    
                    const valorTotal = this.orcamentoAtual.valorTotal;
                    
                    if (valorEntrada <= 0) {
                        document.getElementById('tabela-entrada-parcelas').classList.add('hidden');
                        return;
                    }
                    
                    if (!dataPrimeira) {
                        // Definir data padrão se não estiver definida
                        const data30dias = new Date();
                        data30dias.setDate(data30dias.getDate() + 30);
                        document.getElementById('data-primeira-parcela-entrada').value = data30dias.toISOString().split('T')[0];
                        return;
                    }
                    
                    const valorRestante = valorTotal - valorEntrada;
                    
                    if (valorRestante < 0) {
                        showToast('O valor da entrada não pode ser maior que o valor total!', 'error');
                        document.getElementById('tabela-entrada-parcelas').classList.add('hidden');
                        return;
                    }
                    
                    const valorParcela = numParcelas > 0 ? valorRestante / numParcelas : 0;
                    const tbody = document.getElementById('lista-entrada-parcelas');
                    tbody.innerHTML = '';
                    
                    // Entrada
                    if (valorEntrada > 0) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><strong>Entrada</strong></td>
                            <td>${new Date().toLocaleDateString('pt-BR')}</td>
                            <td><strong>${this.formatarMoeda(valorEntrada)}</strong></td>
                        `;
                        tbody.appendChild(tr);
                    }
                    
                    // Parcelas
                    if (numParcelas > 0 && valorRestante > 0) {
                        for (let i = 1; i <= numParcelas; i++) {
                            const dataVencimento = new Date(dataPrimeira);
                            dataVencimento.setMonth(dataVencimento.getMonth() + (i - 1));
                            
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>Parcela ${i}/${numParcelas}</td>
                                <td>${dataVencimento.toLocaleDateString('pt-BR')}</td>
                                <td>${this.formatarMoeda(valorParcela)}</td>
                            `;
                            tbody.appendChild(tr);
                        }
                    }
                    
                    // Linha de total
                    const trTotal = document.createElement('tr');
                    trTotal.style.borderTop = '2px solid #ddd';
                    trTotal.style.fontWeight = 'bold';
                    trTotal.innerHTML = `
                        <td><strong>Total</strong></td>
                        <td></td>
                        <td><strong>${this.formatarMoeda(valorTotal)}</strong></td>
                    `;
                    tbody.appendChild(trTotal);
                    
                    document.getElementById('tabela-entrada-parcelas').classList.remove('hidden');
                }
            }

            calcularParcelasEntrada() {
                this.calcularParcelas();
            }

            async salvarRecebimento() {
                try {
                    if (!this.clienteSelecionado || !this.orcamentoAtual) {
                        showToast('Selecione cliente e orçamento', 'warning');
                        return;
                    }
                    
                    const tipoPagamento = document.getElementById('tipo-pagamento').value;
                    const observacoes = document.getElementById('observacoes').value;
                    
                    if (tipoPagamento === 'avista') {
                        // À vista
                        const duplicata = {
                            id: await this.db.gerarId(),
                            clienteId: this.clienteSelecionado.id,
                            cliente: this.clienteSelecionado.nome,
                            orcamentoId: this.orcamentoAtual.id,
                            descricao: `Orçamento ${this.orcamentoAtual.numero}`,
                            valor: this.orcamentoAtual.valorTotal,
                            vencimento: new Date().toISOString().split('T')[0],
                            status: 'pago',
                            dataPagamento: new Date().toISOString().split('T')[0],
                            parcela: '1/1',
                            tipo: 'avista',
                            observacoes: observacoes
                        };
                        
                        await this.db.add('receber', duplicata);
                        
                    } else if (tipoPagamento === 'parcelado') {
                        // Parcelado
                        const numParcelas = parseInt(document.getElementById('numero-parcelas').value);
                        const dataPrimeira = document.getElementById('data-primeira-parcela').value;
                        const valorParcela = this.orcamentoAtual.valorTotal / numParcelas;
                        
                        for (let i = 1; i <= numParcelas; i++) {
                            const dataVencimento = new Date(dataPrimeira);
                            dataVencimento.setMonth(dataVencimento.getMonth() + (i - 1));
                            
                            const duplicata = {
                                id: await this.db.gerarId(),
                                clienteId: this.clienteSelecionado.id,
                                cliente: this.clienteSelecionado.nome,
                                orcamentoId: this.orcamentoAtual.id,
                                descricao: `Orçamento ${this.orcamentoAtual.numero}`,
                                valor: valorParcela,
                                vencimento: dataVencimento.toISOString().split('T')[0],
                                status: 'aberto',
                                parcela: `${i}/${numParcelas}`,
                                tipo: 'parcelado',
                                observacoes: observacoes
                            };
                            
                            await this.db.add('receber', duplicata);
                        }
                        
                    } else if (tipoPagamento === 'entrada') {
                        // Entrada + Parcelas
                        const valorEntrada = parseFloat(document.getElementById('valor-entrada').value) || 0;
                        const numParcelas = parseInt(document.getElementById('numero-parcelas-entrada').value) || 1;
                        const dataPrimeira = document.getElementById('data-primeira-parcela-entrada').value;
                        
                        if (!valorEntrada || valorEntrada <= 0) {
                            showToast('Informe o valor da entrada!', 'warning');
                            return;
                        }
                        
                        if (!dataPrimeira) {
                            showToast('Informe a data da primeira parcela!', 'warning');
                            return;
                        }
                        
                        const valorRestante = this.orcamentoAtual.valorTotal - valorEntrada;
                        
                        if (valorRestante < 0) {
                            showToast('O valor da entrada não pode ser maior que o valor total!', 'error');
                            return;
                        }
                        
                        const valorParcela = numParcelas > 0 ? valorRestante / numParcelas : 0;
                        
                        // Entrada
                        if (valorEntrada > 0) {
                            const duplicataEntrada = {
                                id: await this.db.gerarId(),
                                clienteId: this.clienteSelecionado.id,
                                cliente: this.clienteSelecionado.nome,
                                orcamentoId: this.orcamentoAtual.id,
                                descricao: `Orçamento ${this.orcamentoAtual.numero} - Entrada`,
                                valor: valorEntrada,
                                vencimento: new Date().toISOString().split('T')[0],
                                status: 'pago',
                                dataPagamento: new Date().toISOString().split('T')[0],
                                parcela: 'Entrada',
                                tipo: 'entrada',
                                observacoes: observacoes
                            };
                            
                            await this.db.add('receber', duplicataEntrada);
                        }
                        
                        // Parcelas
                        if (numParcelas > 0 && valorRestante > 0) {
                            for (let i = 1; i <= numParcelas; i++) {
                                const dataVencimento = new Date(dataPrimeira);
                                dataVencimento.setMonth(dataVencimento.getMonth() + (i - 1));
                                
                                const duplicata = {
                                    id: await this.db.gerarId(),
                                    clienteId: this.clienteSelecionado.id,
                                    cliente: this.clienteSelecionado.nome,
                                    orcamentoId: this.orcamentoAtual.id,
                                    descricao: `Orçamento ${this.orcamentoAtual.numero}`,
                                    valor: valorParcela,
                                    vencimento: dataVencimento.toISOString().split('T')[0],
                                    status: 'aberto',
                                    parcela: `${i}/${numParcelas}`,
                                    tipo: 'parcelado',
                                    observacoes: observacoes
                                };
                                
                                await this.db.add('receber', duplicata);
                            }
                        }
                    }
                    
                    showToast('Recebimento salvo com sucesso!', 'success');
                    hideModal('modal-lancamento-receber');
                    this.carregarReceber();
                    this.carregarDadosDashboard();
                    
                    // Limpar formulário
                    this.limparFormularioRecebimento();
                    
                } catch (error) {
                    console.error('Erro ao salvar recebimento:', error);
                    showToast('Erro ao salvar recebimento', 'error');
                }
            }

            async salvarPagamento(formData) {
                try {
                    const fornecedor = document.getElementById('fornecedor').value;
                    const descricao = document.getElementById('descricao-pagar').value;
                    const valor = parseFloat(document.getElementById('valor-pagar').value);
                    const vencimento = document.getElementById('vencimento-pagar').value;
                    const tipo = document.getElementById('tipo-pagar').value;
                    const observacoes = document.getElementById('observacoes-pagar').value;
                    
                    const pagamento = {
                        id: await this.db.gerarId(),
                        fornecedor: fornecedor,
                        descricao: descricao,
                        valor: valor,
                        vencimento: vencimento,
                        status: 'aberto',
                        tipo: tipo,
                        observacoes: observacoes
                    };
                    
                    await this.db.add('pagar', pagamento);
                    
                    showToast('Pagamento salvo com sucesso!', 'success');
                    hideModal('modal-lancamento-pagar');
                    this.carregarPagar();
                    this.carregarDadosDashboard();
                    
                    // Limpar formulário
                    document.getElementById('form-pagar').reset();
                    
                } catch (error) {
                    console.error('Erro ao salvar pagamento:', error);
                    showToast('Erro ao salvar pagamento', 'error');
                }
            }

            limparFormularioRecebimento() {
                document.getElementById('form-receber').reset();
                document.getElementById('cliente-info').classList.add('hidden');
                document.getElementById('orcamento-info').classList.add('hidden');
                document.getElementById('tabela-parcelas').classList.add('hidden');
                document.getElementById('tabela-entrada-parcelas').classList.add('hidden');
                document.getElementById('campos-parcelado').classList.add('hidden');
                document.getElementById('campos-entrada').classList.add('hidden');
                this.clienteSelecionado = null;
                this.orcamentoAtual = null;
            }

            iniciarChart() {
                const ctx = document.getElementById('cashflow-chart').getContext('2d');
                
                // Dados de exemplo
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'],
                        datasets: [
                            {
                                label: 'A Receber',
                                data: [1200, 1900, 1500, 2500, 2200, 3000, 2800],
                                borderColor: '#27ae60',
                                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'A Pagar',
                                data: [800, 1200, 900, 1500, 1800, 1200, 1400],
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Saldo',
                                data: [400, 700, 600, 1000, 400, 1800, 1400],
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top' }
                        }
                    }
                });
            }
        }

        // Funções globais
        const ui = new UIManager();
        const syncManager = new SyncManager();
        const whatsappManager = new WhatsAppManager();

        // Inicializar quando o DOM carregar
        document.addEventListener('DOMContentLoaded', async () => {
            await ui.init();
            
            // Configurar eventos
            window.addEventListener('online', () => {
                syncManager.isOnline = true;
                syncManager.updateStatus();
            });
            
            window.addEventListener('offline', () => {
                syncManager.isOnline = false;
                syncManager.updateStatus();
            });
            
            // Configurar data padrão para primeira parcela (30 dias)
            const data30dias = new Date();
            data30dias.setDate(data30dias.getDate() + 30);
            const dataPrimeiraParcela = document.getElementById('data-primeira-parcela');
            if (dataPrimeiraParcela) {
                dataPrimeiraParcela.value = data30dias.toISOString().split('T')[0];
            }
            
            // Configurar data padrão para primeira parcela de entrada (30 dias)
            const dataPrimeiraParcelaEntrada = document.getElementById('data-primeira-parcela-entrada');
            if (dataPrimeiraParcelaEntrada) {
                dataPrimeiraParcelaEntrada.value = data30dias.toISOString().split('T')[0];
            }
            
            // Configurar data padrão para vencimento de pagamento (30 dias)
            const vencimentoPagar = document.getElementById('vencimento-pagar');
            if (vencimentoPagar) {
                vencimentoPagar.value = data30dias.toISOString().split('T')[0];
            }
            
            // Fechar sugestões ao clicar fora
            document.addEventListener('click', (e) => {
                const sugestoes = document.getElementById('sugestoes-cliente');
                const buscarCliente = document.getElementById('buscar-cliente');
                if (sugestoes && buscarCliente && !sugestoes.contains(e.target) && e.target !== buscarCliente) {
                    sugestoes.style.display = 'none';
                }
            });
        });

        // Funções de UI
        function showSection(sectionId) {
            // Esconder todas as seções
            document.querySelectorAll('.dashboard').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Mostrar seção selecionada
            document.getElementById(sectionId + '-section').classList.remove('hidden');
            
            // Atualizar menu ativo
            document.querySelectorAll('.nav-menu a').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelector(`a[href="#${sectionId}"]`).classList.add('active');
            
            // Atualizar dados da seção
            if (sectionId === 'dashboard') {
                ui.carregarDadosDashboard();
            } else if (sectionId === 'receber') {
                ui.carregarReceber();
            } else if (sectionId === 'pagar') {
                ui.carregarPagar();
            }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            
            // Configurar datas padrão
            if (modalId === 'modal-lancamento-receber') {
                const hoje = new Date();
                const data30dias = new Date();
                data30dias.setDate(hoje.getDate() + 30);
                
                const dataPrimeiraParcela = document.getElementById('data-primeira-parcela');
                if (dataPrimeiraParcela) {
                    dataPrimeiraParcela.value = data30dias.toISOString().split('T')[0];
                }
                
                const dataPrimeiraParcelaEntrada = document.getElementById('data-primeira-parcela-entrada');
                if (dataPrimeiraParcelaEntrada) {
                    dataPrimeiraParcelaEntrada.value = data30dias.toISOString().split('T')[0];
                }
                
                mudarTipoPagamento();
                
                // Se já houver um cliente selecionado, recarregar os orçamentos
                if (ui.clienteSelecionado) {
                    console.log('Recarregando orçamentos para cliente já selecionado:', ui.clienteSelecionado.id);
                    ui.carregarOrcamentosCliente(ui.clienteSelecionado.id);
                }
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showTab(tabId) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(el => {
                el.classList.remove('active');
            });
            
            // Mostrar tab selecionada
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function showToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;
            toast.innerHTML = `
                <i class="fas fa-${getIconeTipo(tipo)}"></i>
                <span>${mensagem}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function getIconeTipo(tipo) {
            switch(tipo) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        function mudarTipoPagamento() {
            const tipo = document.getElementById('tipo-pagamento').value;
            
            document.getElementById('campos-parcelado').classList.add('hidden');
            document.getElementById('campos-entrada').classList.add('hidden');
            document.getElementById('tabela-parcelas').classList.add('hidden');
            document.getElementById('tabela-entrada-parcelas').classList.add('hidden');
            
            if (tipo === 'parcelado') {
                document.getElementById('campos-parcelado').classList.remove('hidden');
                ui.calcularParcelas();
            } else if (tipo === 'entrada') {
                document.getElementById('campos-entrada').classList.remove('hidden');
                ui.calcularParcelas();
            }
        }

        function buscarCliente(nome) {
            ui.buscarCliente(nome);
        }
        
        function selecionarClientePorNome(nome) {
            ui.selecionarClientePorNome(nome);
        }

        function carregarDadosOrcamento(orcamentoId) {
            ui.carregarDadosOrcamento(orcamentoId);
        }

        function calcularParcelas() {
            ui.calcularParcelas();
        }

        function calcularParcelasEntrada() {
            ui.calcularParcelasEntrada();
        }

        function salvarRecebimento(event) {
            event.preventDefault();
            ui.salvarRecebimento();
        }

        function salvarPagamento(event) {
            event.preventDefault();
            ui.salvarPagamento();
        }

        function marcarComoPago() {
            if (ui.duplicataAtual) {
                ui.marcarComoPago(ui.duplicataAtual.id);
            }
        }

        function enviarWhatsApp() {
            if (ui.duplicataAtual && ui.clienteAtual) {
                const mensagem = whatsappManager.gerarMensagem(ui.clienteAtual, ui.duplicataAtual);
                document.getElementById('mensagem-whatsapp').value = mensagem;
                showModal('modal-whatsapp');
            }
        }

        function abrirWhatsApp() {
            const mensagem = document.getElementById('mensagem-whatsapp').value;
            const telefone = ui.clienteAtual.whatsapp || ui.clienteAtual.telefone;
            
            if (telefone && mensagem) {
                const link = whatsappManager.gerarLink(telefone, mensagem);
                window.open(link, '_blank');
                hideModal('modal-whatsapp');
                showToast('WhatsApp aberto com sucesso!', 'success');
            } else {
                showToast('Telefone ou mensagem inválidos', 'error');
            }
        }

        function filtrarReceber() {
            showToast('Filtro aplicado', 'info');
        }

        function gerarRelatorio(tipo) {
            showToast('Relatório gerado com sucesso!', 'success');
        }

        // Inicializar sync status
        syncManager.updateStatus();
    </script>
</body>
</html>